import{_ as s,o as a,c as n,a as p}from"./app.1e6146c3.js";const A=JSON.parse('{"title":"\u4F7F\u7528 Kubespray \u90E8\u7F72","description":"","frontmatter":{},"headers":[{"level":2,"title":"Kubespray \u7B80\u4ECB","slug":"kubespray-\u7B80\u4ECB"},{"level":2,"title":"\u521D\u59CB\u5316\u73AF\u5883","slug":"\u521D\u59CB\u5316\u73AF\u5883"},{"level":2,"title":"\u5B89\u88C5 Kubespray","slug":"\u5B89\u88C5-kubespray"},{"level":2,"title":"\u767B\u5F55 Dashboard","slug":"\u767B\u5F55-dashboard"},{"level":2,"title":"\u9A8C\u8BC1 K8s \u96C6\u7FA4","slug":"\u9A8C\u8BC1-k8s-\u96C6\u7FA4"},{"level":2,"title":"\u5176\u4ED6","slug":"\u5176\u4ED6"},{"level":2,"title":"\u53C2\u8003\u94FE\u63A5","slug":"\u53C2\u8003\u94FE\u63A5"}],"relativePath":"CloudNative/k8s/Installation/\u4F7F\u7528 Kubespray \u90E8\u7F72.md","lastUpdated":1657272051000}'),l={name:"CloudNative/k8s/Installation/\u4F7F\u7528 Kubespray \u90E8\u7F72.md"},e=p(`<h1 id="\u4F7F\u7528-kubespray-\u90E8\u7F72" tabindex="-1">\u4F7F\u7528 Kubespray \u90E8\u7F72 <a class="header-anchor" href="#\u4F7F\u7528-kubespray-\u90E8\u7F72" aria-hidden="true">#</a></h1><h2 id="kubespray-\u7B80\u4ECB" tabindex="-1">Kubespray \u7B80\u4ECB <a class="header-anchor" href="#kubespray-\u7B80\u4ECB" aria-hidden="true">#</a></h2><p><a href="https://github.com/kubernetes-incubator/kubespray" target="_blank" rel="noopener noreferrer">Kubespray</a> \u662F Kubernetes incubator \u4E2D\u7684\u9879\u76EE\uFF0C\u76EE\u6807\u662F\u63D0\u4F9B Production Ready Kubernetes \u90E8\u7F72\u65B9\u6848\uFF0C\u8BE5\u9879\u76EE\u57FA\u7840\u662F\u901A\u8FC7 Ansible Playbook \u6765\u5B9A\u4E49\u7CFB\u7EDF\u4E0E Kubernetes \u96C6\u7FA4\u90E8\u7F72\u7684\u4EFB\u52A1\uFF0C\u5177\u6709\u4EE5\u4E0B\u51E0\u4E2A\u7279\u70B9\uFF1A</p><ul><li>\u53EF\u4EE5\u90E8\u7F72\u5728 AWS, GCE, Azure, OpenStack \u4EE5\u53CA\u88F8\u673A\u4E0A.</li><li>\u90E8\u7F72 High Available Kubernetes \u96C6\u7FA4.</li><li>\u53EF\u7EC4\u5408\u6027 (Composable)\uFF0C\u53EF\u81EA\u884C\u9009\u62E9 Network Plugin (flannel, calico, canal, weave) \u6765\u90E8\u7F72.</li><li>\u652F\u6301\u591A\u79CD Linux distributions(CoreOS, Debian Jessie, Ubuntu 16.04, CentOS/RHEL7).</li></ul><p>Kubespray \u7531\u4E00\u7CFB\u5217\u7684 <a href="http://docs.ansible.com/" target="_blank" rel="noopener noreferrer">Ansible</a> playbook\u3001\u751F\u6210 <a href="https://github.com/kubernetes-incubator/kubespray/blob/master/docs/ansible.md" target="_blank" rel="noopener noreferrer">inventory</a> \u7684\u547D\u4EE4\u884C\u5DE5\u5177\u4EE5\u53CA\u751F\u6210 OS/Kubernetes \u96C6\u7FA4\u914D\u7F6E\u7BA1\u7406\u4EFB\u52A1\u7684\u4E13\u4E1A\u77E5\u8BC6\u6784\u6210\u3002</p><h2 id="\u521D\u59CB\u5316\u73AF\u5883" tabindex="-1">\u521D\u59CB\u5316\u73AF\u5883 <a class="header-anchor" href="#\u521D\u59CB\u5316\u73AF\u5883" aria-hidden="true">#</a></h2><p>\u4E3B\u673A\u73AF\u5883\uFF1A</p><table><thead><tr><th>\u89D2\u8272</th><th>IP</th></tr></thead><tbody><tr><td>master</td><td>172.16.1.128</td></tr><tr><td>node01</td><td>172.16.1.129</td></tr></tbody></table><p>\u7F16\u8F91<code>/etc/hosts</code>\u6587\u4EF6\uFF0C\u4F7F\u5404\u4E3B\u673A\u4E4B\u95F4\u53EF\u4EE5\u901A\u8FC7\u4E3B\u673A\u540D\u4E92\u76F8\u901A\u4FE1\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#758575;"># \u6DFB\u52A0\u4EE5\u4E0B\u5185\u5BB9</span></span>
<span class="line"><span style="color:#DBD7CA;">172.16.1.128 master master.agou-ops.com</span></span>
<span class="line"><span style="color:#DBD7CA;">172.16.1.129 node01 node01.agou-ops.com</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#A0ADA0;"># \u6DFB\u52A0\u4EE5\u4E0B\u5185\u5BB9</span></span>
<span class="line"><span style="color:#393A34;">172.16.1.128 master master.agou-ops.com</span></span>
<span class="line"><span style="color:#393A34;">172.16.1.129 node01 node01.agou-ops.com</span></span>
<span class="line"></span></code></pre></div><p>\u5173\u95ED SELinux \u548C\u9632\u706B\u5899\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">sed -i </span><span style="color:#C98A7D;">&#39;s/SELINUX=*/SELINUX=disabled/&#39;</span><span style="color:#DBD7CA;"> /etc/selinux/config</span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl disable firewalld </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CA;"> systemctl stop firewalld</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">sed -i </span><span style="color:#B56959;">&#39;s/SELINUX=*/SELINUX=disabled/&#39;</span><span style="color:#393A34;"> /etc/selinux/config</span></span>
<span class="line"><span style="color:#393A34;">systemctl disable firewalld </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> systemctl stop firewalld</span></span>
<span class="line"></span></code></pre></div><p>Kubernetes 1.8 \u5F00\u59CB\u8981\u6C42\u5173\u95ED\u7CFB\u7EDF\u7684 Swap \u4EA4\u6362\u5206\u533A\uFF0C\u65B9\u6CD5\u5982\u4E0B\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">swapoff -a </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CA;"> </span><span style="color:#E0A569;">echo</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;vm.swappiness=0&quot;</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">&gt;&gt;</span><span style="color:#DBD7CA;"> /etc/sysctl.conf </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CA;"> sysctl -p </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CA;"> free \u2013h</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">swapoff -a </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#B58451;">echo</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;vm.swappiness=0&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&gt;&gt;</span><span style="color:#393A34;"> /etc/sysctl.conf </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> sysctl -p </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> free \u2013h</span></span>
<span class="line"></span></code></pre></div><p>Docker \u4ECE 1.13 \u7248\u672C\u5F00\u59CB\u8C03\u6574\u4E86\u9ED8\u8BA4\u7684\u9632\u706B\u5899\u89C4\u5219\uFF0C\u7981\u7528\u4E86 <code>iptables filter </code>\u8868\u4E2D<code>FOWARD</code>\u94FE\uFF0C\u8FD9\u6837\u4F1A\u5F15\u8D77 Kubernetes \u96C6\u7FA4\u4E2D\u8DE8 Node \u7684 Pod \u65E0\u6CD5\u901A\u4FE1\uFF0C\u5728\u5404\u4E2A Docker \u8282\u70B9\u6267\u884C\u4E0B\u9762\u7684\u547D\u4EE4\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">iptables -P FORWARD ACCEPT</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">iptables -P FORWARD ACCEPT</span></span>
<span class="line"></span></code></pre></div><p>\u914D\u7F6E SSH Key \u8BA4\u8BC1\u3002\u786E\u4FDD\u672C\u673A\u4E5F\u53EF\u4EE5 SSH \u8FDE\u63A5\uFF0C\u5426\u5219\u4E0B\u9762\u90E8\u7F72\u5931\u8D25\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">ssh-keygen -t rsa -N </span><span style="color:#C98A7D;">&quot;&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">cat </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/.ssh/id_rsa.pub </span><span style="color:#CB7676;">&gt;&gt;</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/.ssh/authorized_keys</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">ssh-keygen -t rsa -N </span><span style="color:#B56959;">&quot;&quot;</span></span>
<span class="line"><span style="color:#393A34;">cat </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/.ssh/id_rsa.pub </span><span style="color:#AB5959;">&gt;&gt;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/.ssh/authorized_keys</span></span>
<span class="line"></span></code></pre></div><p>\u66F4\u65B0\u7CFB\u7EDF\u5185\u6838\u4E3A 4.4.x , CentOS \u9ED8\u8BA4\u4E3A 3.10.x \u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span>
<span class="line"><span style="color:#DBD7CA;">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span></span>
<span class="line"><span style="color:#DBD7CA;">yum --enablerepo=elrepo-kernel install -y kernel-lt kernel-lt-devel </span></span>
<span class="line"><span style="color:#DBD7CA;">grub2-set-default 0</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span>
<span class="line"><span style="color:#393A34;">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span></span>
<span class="line"><span style="color:#393A34;">yum --enablerepo=elrepo-kernel install -y kernel-lt kernel-lt-devel </span></span>
<span class="line"><span style="color:#393A34;">grub2-set-default 0</span></span>
<span class="line"></span></code></pre></div><p>\u91CD\u542F\u7CFB\u7EDF\uFF1A<code>reboot</code></p><p>\u589E\u52A0\u5185\u6838\u914D\u7F6E\uFF0C\u7F16\u8F91<code>/etc/sysctl.conf</code>\u6587\u4EF6\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#758575;"># \u589E\u52A0\u4EE5\u4E0B\u5185\u5BB9</span></span>
<span class="line"><span style="color:#DBD7CA;">net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span style="color:#DBD7CA;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#A0ADA0;"># \u589E\u52A0\u4EE5\u4E0B\u5185\u5BB9</span></span>
<span class="line"><span style="color:#393A34;">net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span style="color:#393A34;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"></span></code></pre></div><p>\u4F7F\u5176\u5185\u6838\u914D\u7F6E\u751F\u6548\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">sysctl -p</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">sysctl -p</span></span>
<span class="line"></span></code></pre></div><h2 id="\u5B89\u88C5-kubespray" tabindex="-1">\u5B89\u88C5 Kubespray <a class="header-anchor" href="#\u5B89\u88C5-kubespray" aria-hidden="true">#</a></h2><p>\u5B89\u88C5 Centos \u7684 EPEL \u6E90\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;"> yum -y install epel-release</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;"> yum -y install epel-release</span></span>
<span class="line"></span></code></pre></div><p>\u66F4\u65B0\u7F13\u5B58\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;"> yum clean all </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CA;"> yum makecache</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;"> yum clean all </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> yum makecache</span></span>
<span class="line"></span></code></pre></div><p>\u5B89\u88C5\u76F8\u5173\u8F6F\u4EF6\uFF08Ansible \u7248\u672C\u5FC5\u987B &gt;= 2.7\uFF09\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;"> yum install -y python-pip python3 python-netaddr python3-pip ansible git</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;"> yum install -y python-pip python3 python-netaddr python3-pip ansible git</span></span>
<span class="line"></span></code></pre></div><p>\u4E0B\u8F7D\u6E90\u7801\uFF0C\u5F53\u524D Kubespray \u9879\u76EE\u7684 Master \u5206\u652F\u9ED8\u8BA4\u5B89\u88C5 K8s 1.13.1 \u7248\u672C\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">git clone https://github.com/kubernetes-sigs/kubespray.git</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">git clone https://github.com/kubernetes-sigs/kubespray.git</span></span>
<span class="line"></span></code></pre></div><p>\u5B89\u88C5 Kubespray \u4F9D\u8D56\uFF0C\u82E5\u65E0\u7279\u6B8A\u8BF4\u660E\uFF0C\u540E\u7EED\u64CD\u4F5C\u5747\u5728 ~/kubespray \`\u76EE\u5F55\u4E0B\u6267\u884C\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;"> </span><span style="color:#E0A569;">cd</span><span style="color:#DBD7CA;"> kubespray </span></span>
<span class="line"><span style="color:#DBD7CA;"> pip3 install -r requirements.txt</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;"> </span><span style="color:#B58451;">cd</span><span style="color:#393A34;"> kubespray </span></span>
<span class="line"><span style="color:#393A34;"> pip3 install -r requirements.txt</span></span>
<span class="line"></span></code></pre></div><p>\u914D\u7F6E Kubespray\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;"> cp -rfp inventory/sample inventory/mycluster</span></span>
<span class="line"><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#858585;"> </span><span style="color:#758575;"># Update Ansible inventory file with inventory builder</span></span>
<span class="line"><span style="color:#CB7676;">declare</span><span style="color:#DBD7CA;"> -a IPS=</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">10.10.1.3 10.10.1.4 10.10.1.5</span><span style="color:#858585;">)</span></span>
<span class="line"><span style="color:#DBD7CA;">CONFIG_FILE=inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py </span><span style="color:#858585;">\${</span><span style="color:#B8A965;">IPS</span><span style="color:#858585;">[</span><span style="color:#B8A965;">@</span><span style="color:#858585;">]}</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;"> cp -rfp inventory/sample inventory/mycluster</span></span>
<span class="line"><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#8E8F8B;"> </span><span style="color:#A0ADA0;"># Update Ansible inventory file with inventory builder</span></span>
<span class="line"><span style="color:#AB5959;">declare</span><span style="color:#393A34;"> -a IPS=</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">10.10.1.3 10.10.1.4 10.10.1.5</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"><span style="color:#393A34;">CONFIG_FILE=inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py </span><span style="color:#8E8F8B;">\${</span><span style="color:#8C862B;">IPS</span><span style="color:#8E8F8B;">[</span><span style="color:#8C862B;">@</span><span style="color:#8E8F8B;">]}</span></span>
<span class="line"></span></code></pre></div><p>\u4FEE\u6539\u914D\u7F6E\u6587\u4EF6 <code>inventory/mycluster/hosts.ini </code>\uFF1A</p><div class="language-ini"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#A1B567;">all</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">master </span><span style="color:#4D9375;">ansible_host</span><span style="color:#858585;">=</span><span style="color:#DBD7CA;">master </span><span style="color:#4D9375;">ip</span><span style="color:#858585;">=</span><span style="color:#DBD7CA;">172.16.1.128</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#A1B567;">kube-master</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#A1B567;">etcd</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#A1B567;">kube-node</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">node01</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#A1B567;">k8s-cluster:children</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">kube-master</span></span>
<span class="line"><span style="color:#DBD7CA;">kube-node</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#A1B567;">calico-rr</span><span style="color:#858585;">]</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#6C7834;">all</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">master </span><span style="color:#1C6B48;">ansible_host</span><span style="color:#8E8F8B;">=</span><span style="color:#393A34;">master </span><span style="color:#1C6B48;">ip</span><span style="color:#8E8F8B;">=</span><span style="color:#393A34;">172.16.1.128</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#6C7834;">kube-master</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#6C7834;">etcd</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#6C7834;">kube-node</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">node01</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#6C7834;">k8s-cluster:children</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">kube-master</span></span>
<span class="line"><span style="color:#393A34;">kube-node</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#6C7834;">calico-rr</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"></span></code></pre></div><p>\u2139\uFE0F\u6B64\u5904\u4E5F\u53EF\u4EE5\u7528\uFF1A<code>kubespray prepare --masters master1 --etcds master1 --nodes node1 node2 node3</code>\u6765\u81EA\u52A8\u751F\u6210<code>inventory</code>\u6587\u4EF6</p><p>\u4FEE\u6539\u914D\u7F6E\u6587\u4EF6<code> inventory/mycluster/group_vars/all/all.yml</code>\uFF1A</p><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#758575;"># \u4FEE\u6539\u5982\u4E0B\u914D\u7F6E:</span></span>
<span class="line"><span style="color:#429988;">loadbalancer_apiserver_localhost</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#4D9375;">true</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#758575;"># \u52A0\u8F7D\u5185\u6838\u6A21\u5757\uFF0C\u5426\u5219 ceph, gfs \u7B49\u65E0\u6CD5\u6302\u8F7D\u5BA2\u6237\u7AEF</span></span>
<span class="line"><span style="color:#429988;">kubelet_load_modules</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#4D9375;">true</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#A0ADA0;"># \u4FEE\u6539\u5982\u4E0B\u914D\u7F6E:</span></span>
<span class="line"><span style="color:#2F8A89;">loadbalancer_apiserver_localhost</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#1C6B48;">true</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#A0ADA0;"># \u52A0\u8F7D\u5185\u6838\u6A21\u5757\uFF0C\u5426\u5219 ceph, gfs \u7B49\u65E0\u6CD5\u6302\u8F7D\u5BA2\u6237\u7AEF</span></span>
<span class="line"><span style="color:#2F8A89;">kubelet_load_modules</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#1C6B48;">true</span></span>
<span class="line"></span></code></pre></div><p>\u4FEE\u6539\u955C\u50CF\u9ED8\u8BA4\u7684 Repo \u5730\u5740\uFF0C\u4F7F\u7528 Calico \u4E09\u5C42\u7F51\u7EDC\uFF0C\u540C\u65F6\u53EF\u4EE5\u6307\u5B9A\u5B89\u88C5\u7684 K8s\u7248\u672C\uFF0C\u53C2\u6570\u4E3A<code> kube_version</code>\u3002\u7F16\u8F91\u6587\u4EF6<code>inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml</code>(\u5728\u8FD9\u91CC\u6211\u80FD\u591F\u79D1\u5B66\u4E0A\u7F51\u5C31\u4E0D\u505A\u4FEE\u6539\u4E86)\uFF1A</p><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#429988;">kube_image_repo</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;gcr.io/google-containers&quot;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#2F8A89;">kube_image_repo</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;gcr.io/google-containers&quot;</span></span>
<span class="line"></span></code></pre></div><p>\u5982\u9700\u8BBE\u7F6E\u4EE3\u7406\uFF0C\u5728<code> cluster.yml</code>\u4E2D\u7F16\u8F91 default \u503C\u5373\u53EF\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">...</span></span>
<span class="line"><span style="color:#DBD7CA;">proxy_env:</span></span>
<span class="line"><span style="color:#DBD7CA;">          http_proxy: </span><span style="color:#C98A7D;">&quot;\u3010\u3010 http_proxy | default (&#39;192.168.43.37:8888&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          HTTP_PROXY: </span><span style="color:#C98A7D;">&quot;\u3010\u3010 http_proxy | default (&#39;192.168.43.37:8888&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          https_proxy: </span><span style="color:#C98A7D;">&quot;\u3010\u3010 https_proxy | default (&#39;192.168.43.37:8888&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          HTTPS_PROXY: </span><span style="color:#C98A7D;">&quot;\u3010\u3010 https_proxy | default (&#39;192.168.43.37:8888&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          no_proxy: </span><span style="color:#C98A7D;">&quot;\u3010\u3010 no_proxy | default (&#39;&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          NO_PROXY: </span><span style="color:#C98A7D;">&quot;\u3010\u3010 no_proxy | default (&#39;&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      no_log: </span><span style="color:#E0A569;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">...</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">...</span></span>
<span class="line"><span style="color:#393A34;">proxy_env:</span></span>
<span class="line"><span style="color:#393A34;">          http_proxy: </span><span style="color:#B56959;">&quot;\u3010\u3010 http_proxy | default (&#39;192.168.43.37:8888&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#393A34;">          HTTP_PROXY: </span><span style="color:#B56959;">&quot;\u3010\u3010 http_proxy | default (&#39;192.168.43.37:8888&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#393A34;">          https_proxy: </span><span style="color:#B56959;">&quot;\u3010\u3010 https_proxy | default (&#39;192.168.43.37:8888&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#393A34;">          HTTPS_PROXY: </span><span style="color:#B56959;">&quot;\u3010\u3010 https_proxy | default (&#39;192.168.43.37:8888&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#393A34;">          no_proxy: </span><span style="color:#B56959;">&quot;\u3010\u3010 no_proxy | default (&#39;&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#393A34;">          NO_PROXY: </span><span style="color:#B56959;">&quot;\u3010\u3010 no_proxy | default (&#39;&#39;) \u3011\u3011&quot;</span></span>
<span class="line"><span style="color:#393A34;">      no_log: </span><span style="color:#B58451;">true</span></span>
<span class="line"><span style="color:#393A34;">...</span></span>
<span class="line"></span></code></pre></div><p>\u5982\u9700\u8BBE\u7F6E<code>docker pull</code> \u4EE3\u7406\uFF0C\u65B0\u5EFA<code>/etc/systemd/system/docker.service.d/http-proxy.conf</code>\u6587\u4EF6\uFF0C\u6DFB\u52A0\u4EE5\u4E0B\u5185\u5BB9\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Environment=</span><span style="color:#C98A7D;">&quot;http_proxy=192.168.43.37:8888&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">Environment=</span><span style="color:#C98A7D;">&quot;https_proxy=192.168.43.37:8888&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">Environment=</span><span style="color:#C98A7D;">&quot;NO_PROXY= hostname.example.com,172.10.10.10&quot;</span></span>
<span class="line"><span style="color:#758575;"># \u6700\u540E\u91CD\u542Fdocker</span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl daemon-reload</span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl restart docker</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Environment=</span><span style="color:#B56959;">&quot;http_proxy=192.168.43.37:8888&quot;</span></span>
<span class="line"><span style="color:#393A34;">Environment=</span><span style="color:#B56959;">&quot;https_proxy=192.168.43.37:8888&quot;</span></span>
<span class="line"><span style="color:#393A34;">Environment=</span><span style="color:#B56959;">&quot;NO_PROXY= hostname.example.com,172.10.10.10&quot;</span></span>
<span class="line"><span style="color:#A0ADA0;"># \u6700\u540E\u91CD\u542Fdocker</span></span>
<span class="line"><span style="color:#393A34;">systemctl daemon-reload</span></span>
<span class="line"><span style="color:#393A34;">systemctl restart docker</span></span>
<span class="line"></span></code></pre></div><p>\u4FEE\u6539<code>./roles/kubernetes-apps/ansible/templates/dashboard.yml.j2</code>\u6587\u4EF6\uFF0C\u4F7F\u7528 <code>NodePort</code> \u65B9\u5F0F\u8BBF\u95EE Dashboard\uFF1A</p><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#758575;"># ------------------- Dashboard Service ------------------- #\u2026\u2026\u2026\u2026      </span></span>
<span class="line"><span style="color:#429988;">targetPort</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8443</span><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#429988;">type</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">NodePort    //\u6DFB\u52A0\u8FD9\u4E00\u884C</span><span style="color:#DBD7CA;">      </span></span>
<span class="line"><span style="color:#429988;">selector</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#429988;">k8s-app</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">kubernetes-dashboard</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#A0ADA0;"># ------------------- Dashboard Service ------------------- #\u2026\u2026\u2026\u2026      </span></span>
<span class="line"><span style="color:#2F8A89;">targetPort</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8443</span><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#2F8A89;">type</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">NodePort    //\u6DFB\u52A0\u8FD9\u4E00\u884C</span><span style="color:#393A34;">      </span></span>
<span class="line"><span style="color:#2F8A89;">selector</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#2F8A89;">k8s-app</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">kubernetes-dashboard</span></span>
<span class="line"></span></code></pre></div><p>\u26A0\uFE0F \u6CE8\u610F\uFF1A\u5982\u679C\u662F\u5355\u8282\u70B9\u90E8\u7F72 K8s\uFF0CKubespray \u9ED8\u8BA4\u4F1A\u521B\u5EFA 2 \u4E2A coredns Pod\uFF0C\u4F46 Deployment \u4E2D\u53C8\u7528\u5230\u4E86 podAntiAffinity\uFF0C\u56E0\u6B64\u4F1A\u5BFC\u81F4\u5176\u4E2D\u4E00\u4E2A coredns pod pending\uFF0C\u6240\u4EE5\u9700\u8981\u4FEE\u6539<code>./roles/kubernetes-apps/ansible/templates/coredns-deployment.yml.j2</code>\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#758575;"># \u6CE8\u91CA\u6389\u4EE5\u4E0B\u51E0\u884C\u4EE3\u7801</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">affinity</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#858585;">        </span><span style="color:#758575;">#podAntiAffinity:</span></span>
<span class="line"><span style="color:#858585;">        </span><span style="color:#758575;">#  requiredDuringSchedulingIgnoredDuringExecution:</span></span>
<span class="line"><span style="color:#858585;">        </span><span style="color:#758575;">#  - topologyKey: &quot;kubernetes.io/hostname&quot;</span></span>
<span class="line"><span style="color:#858585;">        </span><span style="color:#758575;">#    labelSelector:</span></span>
<span class="line"><span style="color:#858585;">        </span><span style="color:#758575;">#      matchLabels:</span></span>
<span class="line"><span style="color:#858585;">        </span><span style="color:#758575;">#        k8s-app: coredns\u3010\u3010 coredns_ordinal_suffix | default(&#39;&#39;) \u3011\u3011</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;"># \u6216\u8005\u5728spec\u4E00\u884C\u6DFB\u52A0\u4EE3\u7801\uFF1A</span></span>
<span class="line"><span style="color:#429988;">spec</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">replicas</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">1   //\u6307\u5B9Apod\u4E3A1\u4E2A\u526F\u672C</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#A0ADA0;"># \u6CE8\u91CA\u6389\u4EE5\u4E0B\u51E0\u884C\u4EE3\u7801</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">affinity</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#8E8F8B;">        </span><span style="color:#A0ADA0;">#podAntiAffinity:</span></span>
<span class="line"><span style="color:#8E8F8B;">        </span><span style="color:#A0ADA0;">#  requiredDuringSchedulingIgnoredDuringExecution:</span></span>
<span class="line"><span style="color:#8E8F8B;">        </span><span style="color:#A0ADA0;">#  - topologyKey: &quot;kubernetes.io/hostname&quot;</span></span>
<span class="line"><span style="color:#8E8F8B;">        </span><span style="color:#A0ADA0;">#    labelSelector:</span></span>
<span class="line"><span style="color:#8E8F8B;">        </span><span style="color:#A0ADA0;">#      matchLabels:</span></span>
<span class="line"><span style="color:#8E8F8B;">        </span><span style="color:#A0ADA0;">#        k8s-app: coredns\u3010\u3010 coredns_ordinal_suffix | default(&#39;&#39;) \u3011\u3011</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;"># \u6216\u8005\u5728spec\u4E00\u884C\u6DFB\u52A0\u4EE3\u7801\uFF1A</span></span>
<span class="line"><span style="color:#2F8A89;">spec</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">replicas</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">1   //\u6307\u5B9Apod\u4E3A1\u4E2A\u526F\u672C</span></span>
<span class="line"></span></code></pre></div><p>\u6700\u540E\u6267\u884C\u90E8\u7F72\u547D\u4EE4\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">ansible-playbook -i inventory/mycluster/hosts.ini  --become --become-user=root cluster.yml -b -v</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">ansible-playbook -i inventory/mycluster/hosts.ini  --become --become-user=root cluster.yml -b -v</span></span>
<span class="line"></span></code></pre></div><h2 id="\u767B\u5F55-dashboard" tabindex="-1">\u767B\u5F55 Dashboard <a class="header-anchor" href="#\u767B\u5F55-dashboard" aria-hidden="true">#</a></h2><p>\u767B\u9646 Dashboard \u652F\u6301 kubeconfig \u548C token \u4E24\u79CD\u8BA4\u8BC1\u65B9\u5F0F\uFF0Ckubeconfig \u4E5F\u4F9D\u8D56 token \u5B57\u6BB5\uFF0C\u6240\u4EE5\u751F\u6210 token \u8FD9\u4E00\u6B65\u662F\u5FC5\u4E0D\u53EF\u5C11\u7684\u3002\u6B64\u5904\uFF0C\u6211\u4EEC\u83B7\u53D6\u96C6\u7FA4\u7BA1\u7406\u5458\uFF08\u62E5\u6709\u6240\u6709\u547D\u540D\u7A7A\u95F4\u7684 admin \u6743\u9650\uFF09\u7684 token\u3002</p><p>\u67E5\u770B kubernetes-dashboard \u66B4\u9732\u7684\u7AEF\u53E3\uFF0C\u5982\u4E0B\u6240\u793A\uFF0C\u8FD9\u91CC\u662F31777\u7AEF\u53E3\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@master kubespray</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;">  kubectl get svc --all-namespaces </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kubernetes-dashboard</span></span>
<span class="line"><span style="color:#DBD7CA;">kube-system   kubernetes-dashboard        NodePort    10.233.41.202   </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">        443:30548/TCP            8m16s</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@master kubespray</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;">  kubectl get svc --all-namespaces </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kubernetes-dashboard</span></span>
<span class="line"><span style="color:#393A34;">kube-system   kubernetes-dashboard        NodePort    10.233.41.202   </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">        443:30548/TCP            8m16s</span></span>
<span class="line"></span></code></pre></div><p>\u83B7\u53D6 admin \u7684 token</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@master kubespray</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;">  kubectl -n kube-system describe </span><span style="color:#C98A7D;">$(kubectl -n kube-system get secret -n kube-system -o name </span><span style="color:#CB7676;">|</span><span style="color:#C98A7D;"> grep namespace)</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep token</span></span>
<span class="line"><span style="color:#DBD7CA;">Name:         namespace-controller-token-ksdvp</span></span>
<span class="line"><span style="color:#DBD7CA;">Type:  kubernetes.io/service-account-token</span></span>
<span class="line"><span style="color:#DBD7CA;">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkV0N0pLMXVqMzNxS2xCNXRlTkxpRTlOYnNMVzRiajNrLU9kdi1qRW5jTDQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlci10b2tlbi1rc2R2cCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImZiM2NkMDBhLTE4ZjAtNGI4OC1hZGNiLWYwNGVjZWNlZTUzNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpuYW1lc3BhY2UtY29udHJvbGxlciJ9.bYWcoopcYFC6EYNMNPkoiZeUQqfidC9NwlrMzzkZD3T9e-PbDd37pmTeWAcU_E4DCDzeVc9CXfWPhWCfr3syZKWiIXPNtDrNrIgnGs34Id2evsh7evVTgOjQtWkRoqX9UFdjWZdQPxvJChLZacRqbUp718umCzhR9evuE0zq8JeruBCTrcilQDDYobavfYs72HrwZ5xlIj2GMb66FeS7mYZacP-2-M3oVsziIWLs_kfBIaN_OkpImUPpvJxF-8xMmVP2BCKWyHWaLPIUdVsF8FkiLWH7bIS8f0cm8D4wEcMZ4IYkVe2FMcmMaiFJx5HEXrwA4YT7bMVy4PJhR71Thg</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@master kubespray</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;">  kubectl -n kube-system describe </span><span style="color:#B56959;">$(kubectl -n kube-system get secret -n kube-system -o name </span><span style="color:#AB5959;">|</span><span style="color:#B56959;"> grep namespace)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep token</span></span>
<span class="line"><span style="color:#393A34;">Name:         namespace-controller-token-ksdvp</span></span>
<span class="line"><span style="color:#393A34;">Type:  kubernetes.io/service-account-token</span></span>
<span class="line"><span style="color:#393A34;">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkV0N0pLMXVqMzNxS2xCNXRlTkxpRTlOYnNMVzRiajNrLU9kdi1qRW5jTDQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlci10b2tlbi1rc2R2cCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImZiM2NkMDBhLTE4ZjAtNGI4OC1hZGNiLWYwNGVjZWNlZTUzNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpuYW1lc3BhY2UtY29udHJvbGxlciJ9.bYWcoopcYFC6EYNMNPkoiZeUQqfidC9NwlrMzzkZD3T9e-PbDd37pmTeWAcU_E4DCDzeVc9CXfWPhWCfr3syZKWiIXPNtDrNrIgnGs34Id2evsh7evVTgOjQtWkRoqX9UFdjWZdQPxvJChLZacRqbUp718umCzhR9evuE0zq8JeruBCTrcilQDDYobavfYs72HrwZ5xlIj2GMb66FeS7mYZacP-2-M3oVsziIWLs_kfBIaN_OkpImUPpvJxF-8xMmVP2BCKWyHWaLPIUdVsF8FkiLWH7bIS8f0cm8D4wEcMZ4IYkVe2FMcmMaiFJx5HEXrwA4YT7bMVy4PJhR71Thg</span></span>
<span class="line"></span></code></pre></div><p>\u5728 dashboard \u767B\u5F55\u9875\u9762\u4E0A\u4F7F\u7528\u4E0A\u9762\u8F93\u51FA\u4E2D\u7684\u90A3\u4E2A\u975E\u5E38\u957F\u7684\u5B57\u7B26\u4E32\u4F5C\u4E3A token \u767B\u5F55\uFF0C\u5373\u53EF\u4EE5\u62E5\u6709\u7BA1\u7406\u5458\u6743\u9650\u64CD\u4F5C\u6574\u4E2A kubernetes \u96C6\u7FA4\u4E2D\u7684\u5BF9\u8C61\u3002\u5F53\u7136\u60A8\u4E5F\u53EF\u4EE5\u5C06\u8FD9\u4E32 token \u52A0\u5230 admin \u7528\u6237\u7684 kubeconfig \u6587\u4EF6\u4E2D\uFF0C\u7EE7\u7EED\u4F7F\u7528 kubeconfig \u767B\u5F55\uFF0C\u4E24\u79CD\u8BA4\u8BC1\u65B9\u5F0F\u4EFB\u60A8\u9009\u62E9\u3002</p><p>\u767B\u5F55 dashboard\uFF1A<a href="https://172.16.1.128:30548" target="_blank" rel="noopener noreferrer">https://172.16.1.128:30548</a></p><blockquote><p>\u6CE8\u610F\uFF1A\u7531\u4E8E\u8FD9\u91CC\u4F7F\u7528\u7684 HTTPS\uFF0C\u5E76\u672A\u4F7F\u7528\u8BC1\u4E66\uFF0C\u56E0\u6B64\u4F7F\u7528 Google \u7B49\u6D4F\u89C8\u5668\u4F1A\u7EC8\u6B62\u8BBF\u95EE\u3002</p></blockquote><h2 id="\u9A8C\u8BC1-k8s-\u96C6\u7FA4" tabindex="-1">\u9A8C\u8BC1 K8s \u96C6\u7FA4 <a class="header-anchor" href="#\u9A8C\u8BC1-k8s-\u96C6\u7FA4" aria-hidden="true">#</a></h2><ul><li>\u67E5\u770B\u96C6\u7FA4\u7248\u672C</li></ul><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@master </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubelet --version</span></span>
<span class="line"><span style="color:#DBD7CA;">Kubernetes v1.18.2</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@master </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubelet --version</span></span>
<span class="line"><span style="color:#393A34;">Kubernetes v1.18.2</span></span>
<span class="line"></span></code></pre></div><ul><li>\u67E5\u770B\u96C6\u7FA4\u72B6\u6001</li></ul><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;"> kubectl get nodes</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;"> kubectl get nodes</span></span>
<span class="line"></span></code></pre></div><ul><li>\u67E5\u770B\u96C6\u7FA4 Pod</li></ul><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;"> kubectl get pods --all-namespaces</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;"> kubectl get pods --all-namespaces</span></span>
<span class="line"></span></code></pre></div><ul><li>\u67E5\u770B IPVS</li></ul><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;"> ipvsadm -L -n</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;"> ipvsadm -L -n</span></span>
<span class="line"></span></code></pre></div><h2 id="\u5176\u4ED6" tabindex="-1">\u5176\u4ED6 <a class="header-anchor" href="#\u5176\u4ED6" aria-hidden="true">#</a></h2><p>\u589E\u52A0 node \u8282\u70B9\uFF08\u63D0\u524D\u5728<code>hosts.ini</code>\u6587\u4EF6\u4E2D\u589E\u52A0\u4E3B\u673A\u8282\u70B9\uFF09\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">ansible-playbook -i inventory/mycluster/hosts.ini scale.yml -b -v -k</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">ansible-playbook -i inventory/mycluster/hosts.ini scale.yml -b -v -k</span></span>
<span class="line"></span></code></pre></div><p>\u5C06<code> hosts.ini</code> \u6587\u4EF6\u4E2D\u7684 master \u548C etcd \u7684\u673A\u5668\u589E\u52A0\u5230\u591A\u53F0\uFF0C\u6267\u884C\u90E8\u7F72\u547D\u4EE4\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">ansible-playbook -i inventory/mycluster/hosts.ini cluster.yml -b -vvv</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">ansible-playbook -i inventory/mycluster/hosts.ini cluster.yml -b -vvv</span></span>
<span class="line"></span></code></pre></div><p>\u522A\u9664\u8282\u70B9\uFF0C\u5982\u679C\u4E0D\u6307\u5B9A\u8282\u70B9\u5C31\u662F\u522A\u9664\u6574\u4E2A\u96C6\u7FA4\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">ansible-playbook -i inventory/mycluster/hosts.ini remove-node.yml -b -v</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">ansible-playbook -i inventory/mycluster/hosts.ini remove-node.yml -b -v</span></span>
<span class="line"></span></code></pre></div><p>\u5982\u679C\u9700\u8981\u5378\u8F7D\uFF0C\u53EF\u4EE5\u6267\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">ansible-playbook -i inventory/mycluster/hosts.ini reset.yml -b \u2013vvv</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">ansible-playbook -i inventory/mycluster/hosts.ini reset.yml -b \u2013vvv</span></span>
<span class="line"></span></code></pre></div><p>\u5347\u7EA7 K8s \u96C6\u7FA4\uFF0C\u9009\u62E9\u5BF9\u5E94\u7684 K8s \u7248\u672C\u4FE1\u606F\uFF0C\u6267\u884C\u5347\u7EA7\u547D\u4EE4\u3002\u6D89\u53CA\u6587\u4EF6\u4E3A <code>upgrade-cluster.yml</code>\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">ansible-playbook upgrade-cluster.yml -b -i inventory/mycluster/hosts.ini -e kube_version=vX.XX.XX -vvv</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">ansible-playbook upgrade-cluster.yml -b -i inventory/mycluster/hosts.ini -e kube_version=vX.XX.XX -vvv</span></span>
<span class="line"></span></code></pre></div><h2 id="\u53C2\u8003\u94FE\u63A5" tabindex="-1">\u53C2\u8003\u94FE\u63A5 <a class="header-anchor" href="#\u53C2\u8003\u94FE\u63A5" aria-hidden="true">#</a></h2><ul><li><p>kubespray GetStarted\uFF1A<a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md</a></p></li><li><p>\u4F7F\u7528 Kubespray \u5728\u57FA\u7840\u8BBE\u65BD\u6216\u4E91\u5E73\u53F0\u4E0A\u5B89\u88C5 Kubernetes\uFF1A<a href="https://k8smeetup.github.io/docs/getting-started-guides/kubespray/" target="_blank" rel="noopener noreferrer">https://k8smeetup.github.io/docs/getting-started-guides/kubespray/</a></p></li></ul>`,86),o=[e];function c(r,t,i,y,d,u){return a(),n("div",null,o)}var h=s(l,[["render",c]]);export{A as __pageData,h as default};
