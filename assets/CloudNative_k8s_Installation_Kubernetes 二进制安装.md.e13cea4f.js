import{_ as s,o as n,c as a,a as l}from"./app.1e6146c3.js";const u=JSON.parse('{"title":"1.\u73AF\u5883\u51C6\u5907","description":"","frontmatter":{},"headers":[{"level":2,"title":"1.\u73AF\u5883\u51C6\u5907","slug":"_1-\u73AF\u5883\u51C6\u5907"},{"level":3,"title":"1.1.Kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4\u90E8\u7F72\u65B9\u5F0F","slug":"_1-1-kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4\u90E8\u7F72\u65B9\u5F0F"},{"level":3,"title":"1.2.Kubernetes\u96C6\u7FA4\u5F03\u7528docker\u5BB9\u5668","slug":"_1-2-kubernetes\u96C6\u7FA4\u5F03\u7528docker\u5BB9\u5668"},{"level":3,"title":"1.3.Kubernetes\u96C6\u7FA4\u6240\u9700\u7684\u8BC1\u4E66","slug":"_1-3-kubernetes\u96C6\u7FA4\u6240\u9700\u7684\u8BC1\u4E66"},{"level":3,"title":"1.4.\u73AF\u5883\u51C6\u5907","slug":"_1-4-\u73AF\u5883\u51C6\u5907"},{"level":3,"title":"1.5.\u5B89\u88C5cfssl\u8BC1\u4E66\u751F\u6210\u5DE5\u5177","slug":"_1-5-\u5B89\u88C5cfssl\u8BC1\u4E66\u751F\u6210\u5DE5\u5177"},{"level":2,"title":"2.\u64CD\u4F5C\u7CFB\u7EDF\u521D\u59CB\u5316\u914D\u7F6E","slug":"_2-\u64CD\u4F5C\u7CFB\u7EDF\u521D\u59CB\u5316\u914D\u7F6E"},{"level":2,"title":"3.\u90E8\u7F72Etcd\u96C6\u7FA4","slug":"_3-\u90E8\u7F72etcd\u96C6\u7FA4"},{"level":3,"title":"3.1.\u4F7F\u7528cfssl\u8BC1\u4E66\u5DE5\u5177\u751F\u6210etcd\u8BC1\u4E66","slug":"_3-1-\u4F7F\u7528cfssl\u8BC1\u4E66\u5DE5\u5177\u751F\u6210etcd\u8BC1\u4E66"},{"level":3,"title":"3.2.\u90E8\u7F72etcd\u96C6\u7FA4","slug":"_3-2-\u90E8\u7F72etcd\u96C6\u7FA4"},{"level":2,"title":"4.\u90E8\u7F72Docker\u670D\u52A1","slug":"_4-\u90E8\u7F72docker\u670D\u52A1"},{"level":3,"title":"4.1.\u5B89\u88C5docker","slug":"_4-1-\u5B89\u88C5docker"},{"level":3,"title":"4.2.\u4E3Adocker\u521B\u5EFAsystemctl\u542F\u52A8\u811A\u672C","slug":"_4-2-\u4E3Adocker\u521B\u5EFAsystemctl\u542F\u52A8\u811A\u672C"},{"level":2,"title":"5.\u90E8\u7F72kubernetes master\u8282\u70B9","slug":"_5-\u90E8\u7F72kubernetes-master\u8282\u70B9"},{"level":3,"title":"5.1.\u4F7F\u7528cfssl\u751F\u6210apiserver\u7684\u8BC1\u4E66\u6587\u4EF6","slug":"_5-1-\u4F7F\u7528cfssl\u751F\u6210apiserver\u7684\u8BC1\u4E66\u6587\u4EF6"},{"level":3,"title":"5.2.\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F","slug":"_5-2-\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F"},{"level":3,"title":"5.3.\u90E8\u7F72kube-apiserver\u7EC4\u4EF6","slug":"_5-3-\u90E8\u7F72kube-apiserver\u7EC4\u4EF6"},{"level":3,"title":"5.4.\u90E8\u7F72kube-controller-manage\u7EC4\u4EF6","slug":"_5-4-\u90E8\u7F72kube-controller-manage\u7EC4\u4EF6"},{"level":3,"title":"5.5.\u90E8\u7F72kube-scheduler\u7EC4\u4EF6","slug":"_5-5-\u90E8\u7F72kube-scheduler\u7EC4\u4EF6"},{"level":3,"title":"5.6.\u51C6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4EF6\u8FDE\u63A5\u96C6\u7FA4","slug":"_5-6-\u51C6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4EF6\u8FDE\u63A5\u96C6\u7FA4"},{"level":2,"title":"6.\u5728master\u8282\u70B9\u90E8\u7F72node\u8282\u70B9\u76F8\u5173\u7EC4\u4EF6","slug":"_6-\u5728master\u8282\u70B9\u90E8\u7F72node\u8282\u70B9\u76F8\u5173\u7EC4\u4EF6"},{"level":3,"title":"6.1.\u5728\u96C6\u7FA4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8BB8\u8BF7\u6C42\u8BC1\u4E66","slug":"_6-1-\u5728\u96C6\u7FA4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8BB8\u8BF7\u6C42\u8BC1\u4E66"},{"level":3,"title":"6.2.\u5728master\u8282\u70B9\u90E8\u7F72kubelet\u7EC4\u4EF6","slug":"_6-2-\u5728master\u8282\u70B9\u90E8\u7F72kubelet\u7EC4\u4EF6"},{"level":3,"title":"6.3.\u5728master\u8282\u70B9\u90E8\u7F72kube-proxy","slug":"_6-3-\u5728master\u8282\u70B9\u90E8\u7F72kube-proxy"},{"level":3,"title":"6.4.\u6388\u6743apiserver\u8BBF\u95EEkubelet","slug":"_6-4-\u6388\u6743apiserver\u8BBF\u95EEkubelet"},{"level":2,"title":"7.\u90E8\u7F72kubernetes calico\u7F51\u7EDC\u7EC4\u4EF6","slug":"_7-\u90E8\u7F72kubernetes-calico\u7F51\u7EDC\u7EC4\u4EF6"},{"level":2,"title":"8.\u90E8\u7F72kubernetes node\u8282\u70B9","slug":"_8-\u90E8\u7F72kubernetes-node\u8282\u70B9"},{"level":3,"title":"8.1.\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F","slug":"_8-1-\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F"},{"level":3,"title":"8.2.\u90E8\u7F72kubelet\u7EC4\u4EF6","slug":"_8-2-\u90E8\u7F72kubelet\u7EC4\u4EF6"},{"level":3,"title":"8.3.\u90E8\u7F72kube-proxy\u7EC4\u4EF6","slug":"_8-3-\u90E8\u7F72kube-proxy\u7EC4\u4EF6"},{"level":3,"title":"8.4.\u5FEB\u901F\u589E\u52A0\u65B0\u7684node\u8282\u70B9","slug":"_8-4-\u5FEB\u901F\u589E\u52A0\u65B0\u7684node\u8282\u70B9"},{"level":2,"title":"9.\u4E3A\u96C6\u7FA4\u90E8\u7F72coredns\u7EC4\u4EF6","slug":"_9-\u4E3A\u96C6\u7FA4\u90E8\u7F72coredns\u7EC4\u4EF6"},{"level":3,"title":"9.1.\u90E8\u7F72coredns\u7EC4\u4EF6","slug":"_9-1-\u90E8\u7F72coredns\u7EC4\u4EF6"},{"level":3,"title":"9.2.\u8FD0\u884C\u4E00\u4E2Abusybox\u5BB9\u5668\u6D4B\u8BD5dns","slug":"_9-2-\u8FD0\u884C\u4E00\u4E2Abusybox\u5BB9\u5668\u6D4B\u8BD5dns"},{"level":2,"title":"10.\u6269\u5BB9master\u8282\u70B9\u7EC4\u5EFAkubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4","slug":"_10-\u6269\u5BB9master\u8282\u70B9\u7EC4\u5EFAkubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4"},{"level":3,"title":"10.1.kubernetes\u9AD8\u53EF\u7528\u67B6\u6784\u6982\u5FF5","slug":"_10-1-kubernetes\u9AD8\u53EF\u7528\u67B6\u6784\u6982\u5FF5"},{"level":3,"title":"10.2.\u5728\u96C6\u7FA4\u4E2D\u65B0\u589E\u4E00\u4E2Aetcd\u8282\u70B9","slug":"_10-2-\u5728\u96C6\u7FA4\u4E2D\u65B0\u589E\u4E00\u4E2Aetcd\u8282\u70B9"},{"level":3,"title":"10.3.\u90E8\u7F72master-2\u8282\u70B9","slug":"_10-3-\u90E8\u7F72master-2\u8282\u70B9"},{"level":3,"title":"10.4.\u90E8\u7F72Nginx+Keepalived\u5B9E\u73B0kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4","slug":"_10-4-\u90E8\u7F72nginx-keepalived\u5B9E\u73B0kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4"},{"level":3,"title":"10.5.\u5207\u6362kubernetes\u96C6\u7FA4\u4E3A\u9AD8\u53EF\u7528\u6A21\u5F0F","slug":"_10-5-\u5207\u6362kubernetes\u96C6\u7FA4\u4E3A\u9AD8\u53EF\u7528\u6A21\u5F0F"},{"level":2,"title":"11.\u6D4B\u8BD5kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4","slug":"_11-\u6D4B\u8BD5kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4"},{"level":2,"title":"12.\u5728kubernetes\u96C6\u7FA4\u8FD0\u884C\u4E00\u5957\u670D\u52A1\u9A8C\u8BC1\u96C6\u7FA4\u7684\u53EF\u7528\u6027","slug":"_12-\u5728kubernetes\u96C6\u7FA4\u8FD0\u884C\u4E00\u5957\u670D\u52A1\u9A8C\u8BC1\u96C6\u7FA4\u7684\u53EF\u7528\u6027"},{"level":3,"title":"12.1.\u521B\u5EFA\u8D44\u6E90yaml\u6587\u4EF6","slug":"_12-1-\u521B\u5EFA\u8D44\u6E90yaml\u6587\u4EF6"},{"level":3,"title":"12.2.\u521B\u5EFA\u8D44\u6E90\u5E76\u8FDB\u884C\u6D4B\u8BD5","slug":"_12-2-\u521B\u5EFA\u8D44\u6E90\u5E76\u8FDB\u884C\u6D4B\u8BD5"},{"level":2,"title":"13.\u90E8\u7F72kubernetes dashboard","slug":"_13-\u90E8\u7F72kubernetes-dashboard"},{"level":3,"title":"13.1.\u90E8\u7F72dashboard","slug":"_13-1-\u90E8\u7F72dashboard"},{"level":3,"title":"13.2.\u8BBF\u95EEdashboard","slug":"_13-2-\u8BBF\u95EEdashboard"}],"relativePath":"CloudNative/k8s/Installation/Kubernetes \u4E8C\u8FDB\u5236\u5B89\u88C5.md","lastUpdated":1657272051000}'),p={name:"CloudNative/k8s/Installation/Kubernetes \u4E8C\u8FDB\u5236\u5B89\u88C5.md"},o=l(`<nav class="table-of-contents"><ul><li><a href="#_1-\u73AF\u5883\u51C6\u5907">1.\u73AF\u5883\u51C6\u5907</a><ul><li><a href="#_1-1-kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4\u90E8\u7F72\u65B9\u5F0F">1.1.Kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4\u90E8\u7F72\u65B9\u5F0F</a></li><li><a href="#_1-2-kubernetes\u96C6\u7FA4\u5F03\u7528docker\u5BB9\u5668">1.2.Kubernetes\u96C6\u7FA4\u5F03\u7528docker\u5BB9\u5668</a></li><li><a href="#_1-3-kubernetes\u96C6\u7FA4\u6240\u9700\u7684\u8BC1\u4E66">1.3.Kubernetes\u96C6\u7FA4\u6240\u9700\u7684\u8BC1\u4E66</a></li><li><a href="#_1-4-\u73AF\u5883\u51C6\u5907">1.4.\u73AF\u5883\u51C6\u5907</a></li><li><a href="#_1-5-\u5B89\u88C5cfssl\u8BC1\u4E66\u751F\u6210\u5DE5\u5177">1.5.\u5B89\u88C5cfssl\u8BC1\u4E66\u751F\u6210\u5DE5\u5177</a></li></ul></li><li><a href="#_2-\u64CD\u4F5C\u7CFB\u7EDF\u521D\u59CB\u5316\u914D\u7F6E">2.\u64CD\u4F5C\u7CFB\u7EDF\u521D\u59CB\u5316\u914D\u7F6E</a></li><li><a href="#_3-\u90E8\u7F72etcd\u96C6\u7FA4">3.\u90E8\u7F72Etcd\u96C6\u7FA4</a><ul><li><a href="#_3-1-\u4F7F\u7528cfssl\u8BC1\u4E66\u5DE5\u5177\u751F\u6210etcd\u8BC1\u4E66">3.1.\u4F7F\u7528cfssl\u8BC1\u4E66\u5DE5\u5177\u751F\u6210etcd\u8BC1\u4E66</a></li><li><a href="#_3-2-\u90E8\u7F72etcd\u96C6\u7FA4">3.2.\u90E8\u7F72etcd\u96C6\u7FA4</a></li></ul></li><li><a href="#_4-\u90E8\u7F72docker\u670D\u52A1">4.\u90E8\u7F72Docker\u670D\u52A1</a><ul><li><a href="#_4-1-\u5B89\u88C5docker">4.1.\u5B89\u88C5docker</a></li><li><a href="#_4-2-\u4E3Adocker\u521B\u5EFAsystemctl\u542F\u52A8\u811A\u672C">4.2.\u4E3Adocker\u521B\u5EFAsystemctl\u542F\u52A8\u811A\u672C</a></li></ul></li><li><a href="#_5-\u90E8\u7F72kubernetes-master\u8282\u70B9">5.\u90E8\u7F72kubernetes master\u8282\u70B9</a><ul><li><a href="#_5-1-\u4F7F\u7528cfssl\u751F\u6210apiserver\u7684\u8BC1\u4E66\u6587\u4EF6">5.1.\u4F7F\u7528cfssl\u751F\u6210apiserver\u7684\u8BC1\u4E66\u6587\u4EF6</a></li><li><a href="#_5-2-\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F">5.2.\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F</a></li><li><a href="#_5-3-\u90E8\u7F72kube-apiserver\u7EC4\u4EF6">5.3.\u90E8\u7F72kube-apiserver\u7EC4\u4EF6</a><ul></ul></li><li><a href="#_5-4-\u90E8\u7F72kube-controller-manage\u7EC4\u4EF6">5.4.\u90E8\u7F72kube-controller-manage\u7EC4\u4EF6</a><ul></ul></li><li><a href="#_5-5-\u90E8\u7F72kube-scheduler\u7EC4\u4EF6">5.5.\u90E8\u7F72kube-scheduler\u7EC4\u4EF6</a><ul></ul></li><li><a href="#_5-6-\u51C6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4EF6\u8FDE\u63A5\u96C6\u7FA4">5.6.\u51C6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4EF6\u8FDE\u63A5\u96C6\u7FA4</a><ul></ul></li></ul></li><li><a href="#_6-\u5728master\u8282\u70B9\u90E8\u7F72node\u8282\u70B9\u76F8\u5173\u7EC4\u4EF6">6.\u5728master\u8282\u70B9\u90E8\u7F72node\u8282\u70B9\u76F8\u5173\u7EC4\u4EF6</a><ul><li><a href="#_6-1-\u5728\u96C6\u7FA4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8BB8\u8BF7\u6C42\u8BC1\u4E66">6.1.\u5728\u96C6\u7FA4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8BB8\u8BF7\u6C42\u8BC1\u4E66</a></li><li><a href="#_6-2-\u5728master\u8282\u70B9\u90E8\u7F72kubelet\u7EC4\u4EF6">6.2.\u5728master\u8282\u70B9\u90E8\u7F72kubelet\u7EC4\u4EF6</a><ul></ul></li><li><a href="#_6-3-\u5728master\u8282\u70B9\u90E8\u7F72kube-proxy">6.3.\u5728master\u8282\u70B9\u90E8\u7F72kube-proxy</a><ul></ul></li><li><a href="#_6-4-\u6388\u6743apiserver\u8BBF\u95EEkubelet">6.4.\u6388\u6743apiserver\u8BBF\u95EEkubelet</a></li></ul></li><li><a href="#_7-\u90E8\u7F72kubernetes-calico\u7F51\u7EDC\u7EC4\u4EF6">7.\u90E8\u7F72kubernetes calico\u7F51\u7EDC\u7EC4\u4EF6</a></li><li><a href="#_8-\u90E8\u7F72kubernetes-node\u8282\u70B9">8.\u90E8\u7F72kubernetes node\u8282\u70B9</a><ul><li><a href="#_8-1-\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F">8.1.\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F</a></li><li><a href="#_8-2-\u90E8\u7F72kubelet\u7EC4\u4EF6">8.2.\u90E8\u7F72kubelet\u7EC4\u4EF6</a><ul></ul></li><li><a href="#_8-3-\u90E8\u7F72kube-proxy\u7EC4\u4EF6">8.3.\u90E8\u7F72kube-proxy\u7EC4\u4EF6</a><ul></ul></li><li><a href="#_8-4-\u5FEB\u901F\u589E\u52A0\u65B0\u7684node\u8282\u70B9">8.4.\u5FEB\u901F\u589E\u52A0\u65B0\u7684node\u8282\u70B9</a><ul></ul></li></ul></li><li><a href="#_9-\u4E3A\u96C6\u7FA4\u90E8\u7F72coredns\u7EC4\u4EF6">9.\u4E3A\u96C6\u7FA4\u90E8\u7F72coredns\u7EC4\u4EF6</a><ul><li><a href="#_9-1-\u90E8\u7F72coredns\u7EC4\u4EF6">9.1.\u90E8\u7F72coredns\u7EC4\u4EF6</a></li><li><a href="#_9-2-\u8FD0\u884C\u4E00\u4E2Abusybox\u5BB9\u5668\u6D4B\u8BD5dns">9.2.\u8FD0\u884C\u4E00\u4E2Abusybox\u5BB9\u5668\u6D4B\u8BD5dns</a></li></ul></li><li><a href="#_10-\u6269\u5BB9master\u8282\u70B9\u7EC4\u5EFAkubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4">10.\u6269\u5BB9master\u8282\u70B9\u7EC4\u5EFAkubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4</a><ul><li><a href="#_10-1-kubernetes\u9AD8\u53EF\u7528\u67B6\u6784\u6982\u5FF5">10.1.kubernetes\u9AD8\u53EF\u7528\u67B6\u6784\u6982\u5FF5</a></li><li><a href="#_10-2-\u5728\u96C6\u7FA4\u4E2D\u65B0\u589E\u4E00\u4E2Aetcd\u8282\u70B9">10.2.\u5728\u96C6\u7FA4\u4E2D\u65B0\u589E\u4E00\u4E2Aetcd\u8282\u70B9</a><ul></ul></li><li><a href="#_10-3-\u90E8\u7F72master-2\u8282\u70B9">10.3.\u90E8\u7F72master-2\u8282\u70B9</a><ul></ul></li><li><a href="#_10-4-\u90E8\u7F72nginx-keepalived\u5B9E\u73B0kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4">10.4.\u90E8\u7F72Nginx+Keepalived\u5B9E\u73B0kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4</a><ul></ul></li><li><a href="#_10-5-\u5207\u6362kubernetes\u96C6\u7FA4\u4E3A\u9AD8\u53EF\u7528\u6A21\u5F0F">10.5.\u5207\u6362kubernetes\u96C6\u7FA4\u4E3A\u9AD8\u53EF\u7528\u6A21\u5F0F</a></li></ul></li><li><a href="#_11-\u6D4B\u8BD5kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4">11.\u6D4B\u8BD5kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4</a></li><li><a href="#_12-\u5728kubernetes\u96C6\u7FA4\u8FD0\u884C\u4E00\u5957\u670D\u52A1\u9A8C\u8BC1\u96C6\u7FA4\u7684\u53EF\u7528\u6027">12.\u5728kubernetes\u96C6\u7FA4\u8FD0\u884C\u4E00\u5957\u670D\u52A1\u9A8C\u8BC1\u96C6\u7FA4\u7684\u53EF\u7528\u6027</a><ul><li><a href="#_12-1-\u521B\u5EFA\u8D44\u6E90yaml\u6587\u4EF6">12.1.\u521B\u5EFA\u8D44\u6E90yaml\u6587\u4EF6</a></li><li><a href="#_12-2-\u521B\u5EFA\u8D44\u6E90\u5E76\u8FDB\u884C\u6D4B\u8BD5">12.2.\u521B\u5EFA\u8D44\u6E90\u5E76\u8FDB\u884C\u6D4B\u8BD5</a></li></ul></li><li><a href="#_13-\u90E8\u7F72kubernetes-dashboard">13.\u90E8\u7F72kubernetes dashboard</a><ul><li><a href="#_13-1-\u90E8\u7F72dashboard">13.1.\u90E8\u7F72dashboard</a></li><li><a href="#_13-2-\u8BBF\u95EEdashboard">13.2.\u8BBF\u95EEdashboard</a></li></ul></li></ul></nav><h2 id="_1-\u73AF\u5883\u51C6\u5907" tabindex="-1">1.\u73AF\u5883\u51C6\u5907 <a class="header-anchor" href="#_1-\u73AF\u5883\u51C6\u5907" aria-hidden="true">#</a></h2><h3 id="_1-1-kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4\u90E8\u7F72\u65B9\u5F0F" tabindex="-1">1.1.Kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4\u90E8\u7F72\u65B9\u5F0F <a class="header-anchor" href="#_1-1-kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4\u90E8\u7F72\u65B9\u5F0F" aria-hidden="true">#</a></h3><blockquote><p>\u76EE\u524D\u751F\u4EA7\u73AF\u5883\u90E8\u7F72Kubernetes\u5EFA\u4E3B\u8981\u6709\u4E24\u79CD\u65B9\u5F0F\uFF1A</p><p>kubeadm\uFF1A\u63D0\u4F9Bkubeadm init\u548Ckubeadm join\uFF0C\u7528\u4E8E\u5FEB\u901F\u90E8\u7F72Kubernetes\u96C6\u7FA4\uFF0Ckubeadm\u5B89\u88C5\u7684k8s\u96C6\u7FA4\uFF0C\u6240\u6709\u7684k8s\u7EC4\u4EF6\u90FD\u662F\u4EE5pod\u5F62\u5F0F\u8FD0\u884C\u3002</p><p>\u4E8C\u8FDB\u5236\u5305\uFF1A\u4ECEgithub\u4E0A\u4E0B\u8F7D\u53D1\u884C\u7248\u7684\u4E8C\u8FDB\u5236\u5305\uFF0C\u624B\u52A8\u90E8\u7F72\u6BCF\u4E2A\u7EC4\u4EF6\uFF0C\u7EC4\u6210kubernetes\u96C6\u7FA4\u3002</p><p>Kubeadm\u964D\u4F4E\u90E8\u7F72\u6210\u672C\uFF0C\u4ECE\u800C\u5C4F\u853D\u4E86\u5F88\u591A\u7EC6\u8282\uFF0C\u9047\u5230\u95EE\u9898\u5F88\u96BE\u6392\u67E5\uFF0C\u5982\u679C\u60F3\u66F4\u5BB9\u6613\u53EF\u63A7\uFF0C\u63A8\u8350\u4F7F\u7528\u4E8C\u8FDB\u5236\u5305\u90E8\u7F72Kubernetes\u96C6\u7FA4\uFF0C\u867D\u7136\u624B\u52A8\u90E8\u7F72\u9EBB\u70E6\u70B9\uFF0C\u671F\u95F4\u53EF\u4EE5\u5B66\u4E60\u5F88\u591A\u5DE5\u4F5C\u539F\u7406\uFF0C\u4E5F\u5229\u4E8E\u540E\u671F\u7EF4\u62A4\u3002</p></blockquote><h3 id="_1-2-kubernetes\u96C6\u7FA4\u5F03\u7528docker\u5BB9\u5668" tabindex="-1">1.2.Kubernetes\u96C6\u7FA4\u5F03\u7528docker\u5BB9\u5668 <a class="header-anchor" href="#_1-2-kubernetes\u96C6\u7FA4\u5F03\u7528docker\u5BB9\u5668" aria-hidden="true">#</a></h3><blockquote><p>\u5728k8s\u5E73\u53F0\u4E2D\uFF0C\u4E3A\u4E86\u89E3\u51B3\u4E0E\u5BB9\u5668\u8FD0\u884C\u65F6\uFF0C\u6BD4\u5982docker\u7684\u96C6\u6210\u95EE\u9898\uFF0C\u5728\u65E9\u671F\u793E\u533A\u63A8\u51FACRI\u63A5\u53E3\uFF0C\u4EE5\u652F\u6301\u66F4\u591A\u7684\u5BB9\u5668\uFF0C\u5F53\u6211\u4EEC\u4F7F\u7528Docker\u4F5C\u4E3A\u5BB9\u5668\u8FD0\u884C\u65F6\uFF0C\u9996\u5148kubelet\u8C03\u7528dockershim\u7684CRI\u5BB9\u5668\u63A5\u53E3\u8FDE\u63A5docker\u8FDB\u7A0B\uFF0C\u6700\u540E\u7531docker\u542F\u52A8\u5BB9\u5668\u3002</p><p>\u5728k8s1.23\u7248\u672C\u4E2D\uFF0Ck8s\u8BA1\u5212\u5F03\u7528kubelet\u4E2D\u7684dockershim\u63A5\u53E3\uFF0Cdockershim\u63A5\u53E3\u4E00\u65E6\u5F03\u7528\uFF0Ckubelet\u53BB\u8C03\u7528CRL\u65F6\u5C31\u6CA1\u6709\u53EF\u4EE5\u4E0Edocker\u5EFA\u7ACB\u8FDE\u63A5\u7684\u4E00\u4E2A\u63A5\u53E3\uFF0C\u4ECE\u800C\u5BFC\u81F4k8s\u5F03\u7528docker\u5BB9\u5668\u3002</p></blockquote><h3 id="_1-3-kubernetes\u96C6\u7FA4\u6240\u9700\u7684\u8BC1\u4E66" tabindex="-1">1.3.Kubernetes\u96C6\u7FA4\u6240\u9700\u7684\u8BC1\u4E66 <a class="header-anchor" href="#_1-3-kubernetes\u96C6\u7FA4\u6240\u9700\u7684\u8BC1\u4E66" aria-hidden="true">#</a></h3><blockquote><p>k8s\u6240\u6709\u7EC4\u4EF6\u5747\u91C7\u7528https\u52A0\u5BC6\u901A\u4FE1\uFF0C\u8FD9\u4E9B\u7EC4\u4EF6\u4E00\u822C\u7531\u4E24\u5957\u6839\u8BC1\u4E66\u751F\u6210\uFF1A\u4E00\u4E2A\u7528\u4E8Ek8s apiserver\u4E00\u4E2A\u7528\u4E8Eetcd\u6570\u636E\u5E93\u3002</p><p>\u6309\u7167\u89D2\u8272\u6765\u5206\uFF0C\u8BC1\u4E66\u5206\u4E3A\u7BA1\u7406\u8282\u70B9\u548C\u5DE5\u4F5C\u8282\u70B9\u3002</p><ul><li>\u7BA1\u7406\u8282\u70B9\uFF1A\u6307controller-manager\u548Cscheduler\u8FDE\u63A5apiserver\u6240\u9700\u7684\u5BA2\u6237\u7AEF\u8BC1\u4E66\u3002</li><li>\u5DE5\u4F5C\u8282\u70B9\uFF1A\u6307kubelet\u548Ckube-proxy\u8FDE\u63A5apiserver\u6240\u9700\u8981\u7684\u5BA2\u6237\u7AEF\u8BC1\u4E66\uFF0C\u800C\u4E00\u822C\u90FD\u4F1A\u542F\u7528Bootstrap TLS\u673A\u5236\uFF0C\u6240\u4EE5kubelet\u7684\u8BC1\u4E66\u521D\u6B21\u542F\u52A8\u4F1A\u5411apiserver\u7533\u8BF7\u9881\u53D1\u8BC1\u4E66\uFF0C\u7531controller-manager\u7EC4\u4EF6\u81EA\u52A8\u9881\u53D1\u3002</li><li>\u56FE\u4E2D\u7EA2\u7EBF\u662Fk8s\u5404\u4E2A\u7EC4\u4EF6\u901A\u8FC7\u643A\u5E26k8s\u81EA\u5EFA\u8BC1\u4E66\u9881\u53D1\u673A\u6784\u751F\u6210\u7684\u5BA2\u6237\u7AEF\u8BC1\u4E66\u8BBF\u95EEapiserver\uFF0C\u56FE\u4E2D\u84DD\u7EBF\u662Fk8sapiserver\u7EC4\u4EF6\u901A\u8FC7etcd\u9881\u53D1\u7684\u5BA2\u6237\u7AEF\u8BC1\u4E66\u4E0Eetcd\u5EFA\u7ACB\u8FDE\u63A5\u3002</li></ul><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/3b600f8680a443168cb556a183c19b3f.png" alt="\u8BF7\u6DFB\u52A0\u56FE\u7247\u63CF\u8FF0"></p></blockquote><h3 id="_1-4-\u73AF\u5883\u51C6\u5907" tabindex="-1">1.4.\u73AF\u5883\u51C6\u5907 <a class="header-anchor" href="#_1-4-\u73AF\u5883\u51C6\u5907" aria-hidden="true">#</a></h3><table><thead><tr><th>\u89D2\u8272</th><th>IP</th><th>\u7EC4\u4EF6</th></tr></thead><tbody><tr><td>binary-k8s-master1</td><td>192.168.20.10</td><td>kube-apiserver\u3001kube-controller-manage\u3001kube-scheduler\u3001kubelet\u3001kube-proxy\u3001docker\u3001etcd\u3001nginx\u3001keepalived</td></tr><tr><td>binary-k8s-master2</td><td>192.168.20.11</td><td>kube-apiserver\u3001kube-controller-manage\u3001kube-scheduler\u3001kubelet\u3001kube-proxy\u3001docker\u3001nginx\u3001keepalived\u3001etcd\uFF08\u6269\u5BB9\u8282\u70B9\uFF09</td></tr><tr><td>binary-k8s-node1</td><td>192.168.20.12</td><td>kubelet\u3001kube-proxy\u3001docker\u3001etcd</td></tr><tr><td>binary-k8s-node2</td><td>192.168.20.13</td><td>kubelet\u3001kube-proxy\u3001docker\u3001etcd</td></tr><tr><td>\u8D1F\u8F7D\u5747\u8861\u5668IP</td><td>192.168.20.9</td><td>\uFF08\u4F5C\u7528\u4E8Ekube-apiserver\u7684\u5730\u5740\uFF09</td></tr></tbody></table><p>\u9996\u5148\u90E8\u7F72\u4E00\u5957\u5355master\u8282\u70B9\u7684kubernetes\u96C6\u7FA4\uFF0C\u7136\u540E\u5728\u589E\u52A0\u4E00\u53F0master\u8282\u70B9\uFF0C\u5F62\u6210\u9AD8\u53EF\u7528\u96C6\u7FA4\u3002</p><p>\u5355master\u8282\u70B9\u7684kubernetes\u96C6\u7FA4\u670D\u52A1\u5668\u89C4\u5212\u3002</p><table><thead><tr><th>\u89D2\u8272</th><th>IP</th><th>\u7EC4\u4EF6</th></tr></thead><tbody><tr><td>binary-k8s-master1</td><td>192.168.20.10</td><td>kube-apiserver\u3001kube-controller-manage\u3001kube-schedule\u3001etcd</td></tr><tr><td>binary-k8s-node1</td><td>192.168.20.12</td><td>kubelet\u3001kube-proxy\u3001docker\u3001etcd</td></tr><tr><td>binary-k8s-node2</td><td>192.168.20.13</td><td>kubelet\u3001kube-proxy\u3001docker\u3001etcd</td></tr></tbody></table><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/ea0354a4d3cc4b6397ee9397f42e35dc.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_1-5-\u5B89\u88C5cfssl\u8BC1\u4E66\u751F\u6210\u5DE5\u5177" tabindex="-1">1.5.\u5B89\u88C5cfssl\u8BC1\u4E66\u751F\u6210\u5DE5\u5177 <a class="header-anchor" href="#_1-5-\u5B89\u88C5cfssl\u8BC1\u4E66\u751F\u6210\u5DE5\u5177" aria-hidden="true">#</a></h3><p>cfssl\u662F\u4E00\u4E2A\u5F00\u6E90\u7684\u8BC1\u4E66\u7BA1\u7406\u5DE5\u5177\uFF0C\u4F7F\u7528json\u6587\u4EF6\u751F\u6210\u8BC1\u4E66\uFF0C\u76F8\u6BD4openssl\u66F4\u65B9\u4FBF\u4F7F\u7528\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mv cfssl_linux-amd64 /usr/local/bin/cfssl</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mv cfssl_linux-amd64 /usr/local/bin/cfssl</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span></span>
<span class="line"></span></code></pre></div><h2 id="_2-\u64CD\u4F5C\u7CFB\u7EDF\u521D\u59CB\u5316\u914D\u7F6E" tabindex="-1">2.\u64CD\u4F5C\u7CFB\u7EDF\u521D\u59CB\u5316\u914D\u7F6E <a class="header-anchor" href="#_2-\u64CD\u4F5C\u7CFB\u7EDF\u521D\u59CB\u5316\u914D\u7F6E" aria-hidden="true">#</a></h2><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5173\u95ED\u9632\u706B\u5899</span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl stop firewalld </span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl disable firewalld</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5173\u95EDselinux</span></span>
<span class="line"><span style="color:#DBD7CA;">sed -i </span><span style="color:#C98A7D;">&#39;s/enforcing/disabled/&#39;</span><span style="color:#DBD7CA;"> /etc/selinux/config </span></span>
<span class="line"><span style="color:#DBD7CA;">setenforce 0 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u5173\u95ED\u4EA4\u6362\u5206\u533A</span></span>
<span class="line"><span style="color:#DBD7CA;">swapoff -a</span></span>
<span class="line"><span style="color:#DBD7CA;">sed -ri </span><span style="color:#C98A7D;">&#39;s/.*swap.*/#&amp;/&#39;</span><span style="color:#DBD7CA;"> /etc/fstab</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u914D\u7F6Ehosts</span></span>
<span class="line"><span style="color:#DBD7CA;">cat </span><span style="color:#CB7676;">&gt;&gt;</span><span style="color:#DBD7CA;"> /etc/hosts </span><span style="color:#CB7676;">&lt;&lt;</span><span style="color:#C98A7D;"> </span><span style="color:#4D9375;">EOF</span><span style="color:#C98A7D;"> </span></span>
<span class="line"><span style="color:#C98A7D;">192.168.20.10 binary-k8s-master1</span></span>
<span class="line"><span style="color:#C98A7D;">192.168.20.12 binary-k8s-node1</span></span>
<span class="line"><span style="color:#C98A7D;">192.168.20.13 binary-k8s-node2</span></span>
<span class="line"><span style="color:#4D9375;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.\u4F18\u5316\u5185\u6838\u53C2\u6570</span></span>
<span class="line"><span style="color:#DBD7CA;">cat </span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;"> /etc/sysctl.d/k8s.conf </span><span style="color:#CB7676;">&lt;&lt;</span><span style="color:#C98A7D;"> </span><span style="color:#4D9375;">EOF</span><span style="color:#C98A7D;"> </span></span>
<span class="line"><span style="color:#C98A7D;">net.bridge.bridge-nf-call-ip6tables = 1 </span></span>
<span class="line"><span style="color:#C98A7D;">net.bridge.bridge-nf-call-iptables = 1 </span></span>
<span class="line"><span style="color:#4D9375;">EOF</span></span>
<span class="line"><span style="color:#DBD7CA;">sysctl --system</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5173\u95ED\u9632\u706B\u5899</span></span>
<span class="line"><span style="color:#393A34;">systemctl stop firewalld </span></span>
<span class="line"><span style="color:#393A34;">systemctl disable firewalld</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u5173\u95EDselinux</span></span>
<span class="line"><span style="color:#393A34;">sed -i </span><span style="color:#B56959;">&#39;s/enforcing/disabled/&#39;</span><span style="color:#393A34;"> /etc/selinux/config </span></span>
<span class="line"><span style="color:#393A34;">setenforce 0 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u5173\u95ED\u4EA4\u6362\u5206\u533A</span></span>
<span class="line"><span style="color:#393A34;">swapoff -a</span></span>
<span class="line"><span style="color:#393A34;">sed -ri </span><span style="color:#B56959;">&#39;s/.*swap.*/#&amp;/&#39;</span><span style="color:#393A34;"> /etc/fstab</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u914D\u7F6Ehosts</span></span>
<span class="line"><span style="color:#393A34;">cat </span><span style="color:#AB5959;">&gt;&gt;</span><span style="color:#393A34;"> /etc/hosts </span><span style="color:#AB5959;">&lt;&lt;</span><span style="color:#B56959;"> </span><span style="color:#1C6B48;">EOF</span><span style="color:#B56959;"> </span></span>
<span class="line"><span style="color:#B56959;">192.168.20.10 binary-k8s-master1</span></span>
<span class="line"><span style="color:#B56959;">192.168.20.12 binary-k8s-node1</span></span>
<span class="line"><span style="color:#B56959;">192.168.20.13 binary-k8s-node2</span></span>
<span class="line"><span style="color:#1C6B48;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.\u4F18\u5316\u5185\u6838\u53C2\u6570</span></span>
<span class="line"><span style="color:#393A34;">cat </span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> /etc/sysctl.d/k8s.conf </span><span style="color:#AB5959;">&lt;&lt;</span><span style="color:#B56959;"> </span><span style="color:#1C6B48;">EOF</span><span style="color:#B56959;"> </span></span>
<span class="line"><span style="color:#B56959;">net.bridge.bridge-nf-call-ip6tables = 1 </span></span>
<span class="line"><span style="color:#B56959;">net.bridge.bridge-nf-call-iptables = 1 </span></span>
<span class="line"><span style="color:#1C6B48;">EOF</span></span>
<span class="line"><span style="color:#393A34;">sysctl --system</span></span>
<span class="line"></span></code></pre></div><h2 id="_3-\u90E8\u7F72etcd\u96C6\u7FA4" tabindex="-1">3.\u90E8\u7F72Etcd\u96C6\u7FA4 <a class="header-anchor" href="#_3-\u90E8\u7F72etcd\u96C6\u7FA4" aria-hidden="true">#</a></h2><p>etcd\u662F\u4E00\u4E2A\u5206\u5E03\u5F0F\u952E\u503C\u5B58\u50A8\u7CFB\u7EDF\uFF0Ckubernetes\u4F7F\u7528etcd\u8FDB\u884C\u6570\u636E\u5B58\u50A8\uFF0C\u4E3A\u89E3\u51B3etcd\u5355\u70B9\u6545\u969C\uFF0C\u91C7\u7528\u96C6\u7FA4\u65B9\u5F0F\u90E8\u7F72\uFF0C3\u53F0\u7EC4\u7EC4\u5EFA\u96C6\u7FA4\uFF0C\u53EF\u4EE5\u574F1\u53F0\uFF0C\u5982\u679C\u67095\u53F0\u53EF\u4EE5\u574F2\u53F0\u3002</p><table><thead><tr><th>\u8282\u70B9\u540D\u79F0</th><th>IP</th></tr></thead><tbody><tr><td>etcd-1</td><td>192.168.20.10</td></tr><tr><td>etcd-2</td><td>192.168.20.12</td></tr><tr><td>etcd-3</td><td>192.168.20.13</td></tr></tbody></table><h3 id="_3-1-\u4F7F\u7528cfssl\u8BC1\u4E66\u5DE5\u5177\u751F\u6210etcd\u8BC1\u4E66" tabindex="-1">3.1.\u4F7F\u7528cfssl\u8BC1\u4E66\u5DE5\u5177\u751F\u6210etcd\u8BC1\u4E66 <a class="header-anchor" href="#_3-1-\u4F7F\u7528cfssl\u8BC1\u4E66\u5DE5\u5177\u751F\u6210etcd\u8BC1\u4E66" aria-hidden="true">#</a></h3><p><strong>1.\u751F\u6210CA\u81EA\u7B7E\u9881\u53D1\u673A\u6784\u8BC1\u4E66</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/etcd</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim ca-config.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;signing&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;default&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;expiry&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;87600h&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;profiles&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;www&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">         </span><span style="color:#C98A7D;">&quot;expiry&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;87600h&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">         </span><span style="color:#C98A7D;">&quot;usages&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;signing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;key encipherment&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;server auth&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;client auth&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/etcd</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim ca-csr.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;etcd CA&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;key&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#C98A7D;">&quot;algo&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;rsa&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#C98A7D;">&quot;size&quot;</span><span style="color:#DBD7CA;">: 2048</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;names&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;C&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;L&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;Beijing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;ST&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;Beijing&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/etcd</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cfssl gencert -initca ca-csr.json </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> cfssljson -bare ca -</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:16:49 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating a new CA key and certificate from CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:16:49 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generate received request</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:16:49 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> received CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:16:49 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:16:49 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> encoded CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:16:49 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> signed certificate with serial number 595276170535764345591605360849177409156623041535</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/etcd</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim ca-config.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;signing&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;default&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;expiry&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;87600h&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;profiles&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;www&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">         </span><span style="color:#B56959;">&quot;expiry&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;87600h&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">         </span><span style="color:#B56959;">&quot;usages&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;signing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;key encipherment&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;server auth&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;client auth&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/etcd</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim ca-csr.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;etcd CA&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;key&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959;">&quot;algo&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;rsa&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959;">&quot;size&quot;</span><span style="color:#393A34;">: 2048</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;names&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;C&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;L&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;Beijing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;ST&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;Beijing&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/etcd</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cfssl gencert -initca ca-csr.json </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> cfssljson -bare ca -</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:16:49 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating a new CA key and certificate from CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:16:49 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generate received request</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:16:49 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> received CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:16:49 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:16:49 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> encoded CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:16:49 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> signed certificate with serial number 595276170535764345591605360849177409156623041535</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><strong>2.\u4F7F\u7528\u81EA\u7B7ECA\u7B7E\u53D1Etcd HTTPS\u8BC1\u4E66</strong></p><p>\u7533\u8BF7\u8BC1\u4E66\u7684json\u6587\u4EF6\u4E2D\u6709\u4E00\u4E2Ahosts\u5B57\u6BB5\uFF0C\u8FD9\u4E2A\u5B57\u6BB5\u7684\u503C\u5C31\u662Fetcd\u96C6\u7FA4\u7684IP\u5730\u5740\uFF0C\u53EF\u4EE5\u591A\u5199\u51E0\u4E2AIP\uFF0C\u4F5C\u4E3A\u9884\u7559IP\uFF0C\u65B9\u4FBF\u6269\u5BB9etcd\u96C6\u7FA4\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u521B\u5EFA\u8BC1\u4E66\u7533\u8BF7\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/etcd</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim server-csr.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;etcd&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;192.168.20.10&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;192.168.20.11&quot;</span><span style="color:#DBD7CA;">,			</span><span style="color:#758575;">#\u9884\u7559ip</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;192.168.20.12&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;192.168.20.13&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;key&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#C98A7D;">&quot;algo&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;rsa&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#C98A7D;">&quot;size&quot;</span><span style="color:#DBD7CA;">: 2048</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;names&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;C&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;L&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;ST&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u751F\u6210\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/etcd</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> cfssljson -bare server</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:17:08 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generate received request</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:17:08 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> received CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:17:08 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:17:08 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> encoded CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:17:08 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> signed certificate with serial number 390637014214409356442509482537912246480465374076</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/08/27 17:17:08 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">WARNING</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> This certificate lacks a </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;"> field. This makes it unsuitable </span><span style="color:#4D9375;">for</span></span>
<span class="line"><span style="color:#DBD7CA;">websites. For more information see the Baseline Requirements </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CA;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#DBD7CA;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">https://cabforum.org</span><span style="color:#858585;">)</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">specifically, section 10.2.3 </span><span style="color:#858585;">(</span><span style="color:#C98A7D;">&quot;Information Requirements&quot;</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;">.</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u521B\u5EFA\u8BC1\u4E66\u7533\u8BF7\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/etcd</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim server-csr.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;etcd&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;192.168.20.10&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;192.168.20.11&quot;</span><span style="color:#393A34;">,			</span><span style="color:#A0ADA0;">#\u9884\u7559ip</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;192.168.20.12&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;192.168.20.13&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;key&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959;">&quot;algo&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;rsa&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959;">&quot;size&quot;</span><span style="color:#393A34;">: 2048</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;names&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;C&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;L&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;ST&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u751F\u6210\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/etcd</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> cfssljson -bare server</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:17:08 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generate received request</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:17:08 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> received CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:17:08 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:17:08 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> encoded CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:17:08 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> signed certificate with serial number 390637014214409356442509482537912246480465374076</span></span>
<span class="line"><span style="color:#393A34;">2021/08/27 17:17:08 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">WARNING</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> This certificate lacks a </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;"> field. This makes it unsuitable </span><span style="color:#1C6B48;">for</span></span>
<span class="line"><span style="color:#393A34;">websites. For more information see the Baseline Requirements </span><span style="color:#1C6B48;">for</span><span style="color:#393A34;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#393A34;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">https://cabforum.org</span><span style="color:#8E8F8B;">)</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">specifically, section 10.2.3 </span><span style="color:#8E8F8B;">(</span><span style="color:#B56959;">&quot;Information Requirements&quot;</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;">.</span></span>
<span class="line"></span></code></pre></div><p><strong>3.\u67E5\u770B\u751F\u4EA7\u7684\u8BC1\u4E66\u6587\u4EF6</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/etcd</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ll</span></span>
<span class="line"><span style="color:#DBD7CA;">\u603B\u7528\u91CF 36</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  288 8\u6708  27 17:16 ca-config.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  956 8\u6708  27 17:16 ca.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  210 8\u6708  27 17:16 ca-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1675 8\u6708  27 17:16 ca-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1265 8\u6708  27 17:16 ca.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1021 8\u6708  27 17:17 server.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  311 8\u6708  27 17:17 server-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1679 8\u6708  27 17:17 server-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1346 8\u6708  27 17:17 server.pem</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/etcd</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ll</span></span>
<span class="line"><span style="color:#393A34;">\u603B\u7528\u91CF 36</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  288 8\u6708  27 17:16 ca-config.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  956 8\u6708  27 17:16 ca.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  210 8\u6708  27 17:16 ca-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1675 8\u6708  27 17:16 ca-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1265 8\u6708  27 17:16 ca.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1021 8\u6708  27 17:17 server.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  311 8\u6708  27 17:17 server-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1679 8\u6708  27 17:17 server-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1346 8\u6708  27 17:17 server.pem</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-2-\u90E8\u7F72etcd\u96C6\u7FA4" tabindex="-1">3.2.\u90E8\u7F72etcd\u96C6\u7FA4 <a class="header-anchor" href="#_3-2-\u90E8\u7F72etcd\u96C6\u7FA4" aria-hidden="true">#</a></h3><p><strong>1.\u4E0B\u8F7Detcd\u4E8C\u8FDB\u5236\u6587\u4EF6</strong></p><p>\u4E0B\u8F7D\u5730\u5740\uFF1A<a href="https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz" target="_blank" rel="noopener noreferrer">https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</a></p><p>\u90E8\u7F72\u4E8C\u8FDB\u5236\u7684\u7A0B\u5E8F\u96C6\u7FA4\u6700\u7B80\u5355\u7684\u65B9\u5F0F\u5C31\u662F\u5728\u5176\u4E2D\u4E00\u53F0\u4E0A\u9762\u90E8\u7F72\uFF0C\u7136\u540E\u5C06\u6240\u6709\u7684\u6587\u4EF6scp\u5230\u5176\u4ED6\u673A\u5668\u4E0A\u4FEE\u6539\u914D\u7F6E\uFF0C\u4E00\u5957\u96C6\u7FA4\u4E5F\u5C31\u5B8C\u6210\u4E86\u3002</p><p>\u5C06\u4E0B\u8F7D\u597D\u7684\u6587\u4EF6\u4E0A\u4F20\u81F3\u6240\u6709etcd\u8282\u70B9\u3002</p><p>etcd\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#758575;">#[Member]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_NAME=</span><span style="color:#C98A7D;">&quot;etcd-1&quot;</span><span style="color:#DBD7CA;">							</span><span style="color:#758575;">#\u8282\u70B9\u540D\u79F0</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_DATA_DIR=</span><span style="color:#C98A7D;">&quot;/data/etcd/data&quot;</span><span style="color:#DBD7CA;">					</span><span style="color:#758575;">#\u6570\u636E\u76EE\u5F55</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:2380&quot;</span><span style="color:#DBD7CA;">			</span><span style="color:#758575;">#\u96C6\u7FA4\u901A\u4FE1\u5730\u5740</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span><span style="color:#DBD7CA;">		</span><span style="color:#758575;">#\u5BA2\u6237\u7AEF\u8BBF\u95EE\u7684\u76D1\u542C\u5730\u5740\uFF0C\u5728\u8FD9\u91CC\u52A0\u4E00\u4E2Ahttp://127.0.0.1:2379\uFF0C\u5728\u5F53\u524D\u8282\u70B9\u67E5\u96C6\u7FA4\u4FE1\u606F\u65F6\u5C31\u4E0D\u9700\u8981\u6307\u5B9A\u8BC1\u4E66\u53BB\u67E5\u8BE2\u4E86</span></span>
<span class="line"><span style="color:#DBD7CA;">	</span></span>
<span class="line"><span style="color:#758575;">#[Clustering]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:2380&quot;</span><span style="color:#DBD7CA;">			</span><span style="color:#758575;">#\u96C6\u7FA4\u901A\u544A\u5730\u5740</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span><span style="color:#DBD7CA;">					</span><span style="color:#758575;">#\u5BA2\u6237\u7AEF\u901A\u544A\u5730\u5740\uFF0C\uFF0C\u5728\u8FD9\u91CC\u52A0\u4E00\u4E2Ahttp://127.0.0.1:2379\uFF0C\u5728\u5F53\u524D\u8282\u70B9\u67E5\u96C6\u7FA4\u4FE1\u606F\u65F6\u5C31\u4E0D\u9700\u8981\u6307\u5B9A\u8BC1\u4E66\u53BB\u67E5\u8BE2\u4E86</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER=</span><span style="color:#C98A7D;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span><span style="color:#DBD7CA;">						</span><span style="color:#758575;">#\u96C6\u7FA4\u8282\u70B9\u5730\u5740</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#C98A7D;">&quot;etcd-cluster&quot;</span><span style="color:#DBD7CA;">				</span><span style="color:#758575;">#\u96C6\u7FA4\u7684\u552F\u4E00\u6807\u8BC6</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#C98A7D;">&quot;new&quot;</span><span style="color:#DBD7CA;">						</span><span style="color:#758575;">#\u52A0\u5165\u96C6\u7FA4\u7684\u72B6\u6001\uFF0Cnew\u4E3A\u65B0\u96C6\u7FA4\uFF0Cexisting\u8868\u793A\u52A0\u5165\u73B0\u6709\u96C6\u7FA4</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">#[Member]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_NAME=</span><span style="color:#B56959;">&quot;etcd-1&quot;</span><span style="color:#393A34;">							</span><span style="color:#A0ADA0;">#\u8282\u70B9\u540D\u79F0</span></span>
<span class="line"><span style="color:#393A34;">ETCD_DATA_DIR=</span><span style="color:#B56959;">&quot;/data/etcd/data&quot;</span><span style="color:#393A34;">					</span><span style="color:#A0ADA0;">#\u6570\u636E\u76EE\u5F55</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.10:2380&quot;</span><span style="color:#393A34;">			</span><span style="color:#A0ADA0;">#\u96C6\u7FA4\u901A\u4FE1\u5730\u5740</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span><span style="color:#393A34;">		</span><span style="color:#A0ADA0;">#\u5BA2\u6237\u7AEF\u8BBF\u95EE\u7684\u76D1\u542C\u5730\u5740\uFF0C\u5728\u8FD9\u91CC\u52A0\u4E00\u4E2Ahttp://127.0.0.1:2379\uFF0C\u5728\u5F53\u524D\u8282\u70B9\u67E5\u96C6\u7FA4\u4FE1\u606F\u65F6\u5C31\u4E0D\u9700\u8981\u6307\u5B9A\u8BC1\u4E66\u53BB\u67E5\u8BE2\u4E86</span></span>
<span class="line"><span style="color:#393A34;">	</span></span>
<span class="line"><span style="color:#A0ADA0;">#[Clustering]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.10:2380&quot;</span><span style="color:#393A34;">			</span><span style="color:#A0ADA0;">#\u96C6\u7FA4\u901A\u544A\u5730\u5740</span></span>
<span class="line"><span style="color:#393A34;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span><span style="color:#393A34;">					</span><span style="color:#A0ADA0;">#\u5BA2\u6237\u7AEF\u901A\u544A\u5730\u5740\uFF0C\uFF0C\u5728\u8FD9\u91CC\u52A0\u4E00\u4E2Ahttp://127.0.0.1:2379\uFF0C\u5728\u5F53\u524D\u8282\u70B9\u67E5\u96C6\u7FA4\u4FE1\u606F\u65F6\u5C31\u4E0D\u9700\u8981\u6307\u5B9A\u8BC1\u4E66\u53BB\u67E5\u8BE2\u4E86</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER=</span><span style="color:#B56959;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span><span style="color:#393A34;">						</span><span style="color:#A0ADA0;">#\u96C6\u7FA4\u8282\u70B9\u5730\u5740</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#B56959;">&quot;etcd-cluster&quot;</span><span style="color:#393A34;">				</span><span style="color:#A0ADA0;">#\u96C6\u7FA4\u7684\u552F\u4E00\u6807\u8BC6</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#B56959;">&quot;new&quot;</span><span style="color:#393A34;">						</span><span style="color:#A0ADA0;">#\u52A0\u5165\u96C6\u7FA4\u7684\u72B6\u6001\uFF0Cnew\u4E3A\u65B0\u96C6\u7FA4\uFF0Cexisting\u8868\u793A\u52A0\u5165\u73B0\u6709\u96C6\u7FA4</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><strong>2.\u90E8\u7F72etcd-1\u8282\u70B9</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u521B\u5EFA\u7A0B\u5E8F\u76EE\u5F55</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mkdir /data/etcd/{bin,conf,ssl,data} -p</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> tar xf etcd-v3.4.9-linux-amd64.tar.gz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u5C06\u4E8C\u8FDB\u5236\u547D\u4EE4\u79FB\u52A8\u5230\u5236\u5B9A\u51FA\u7A0B\u5E8F\u76EE\u5F55</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mv etcd-v3.4.9-linux-amd64/etcd</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;"> /data/etcd/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u7F16\u8F91\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#758575;">#[Member]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_NAME=</span><span style="color:#C98A7D;">&quot;etcd-1&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_DATA_DIR=</span><span style="color:#C98A7D;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;">#[Clustering]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER=</span><span style="color:#C98A7D;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#C98A7D;">&quot;etcd-cluster&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#C98A7D;">&quot;new&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.\u7F16\u5199systemctl\u63A7\u5236\u811A\u672C</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /usr/lib/systemd/system/etcd.service</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Unit</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Description=Etcd Server</span></span>
<span class="line"><span style="color:#DBD7CA;">After=network.target</span></span>
<span class="line"><span style="color:#DBD7CA;">After=network-online.target</span></span>
<span class="line"><span style="color:#DBD7CA;">Wants=network-online.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Type=notify</span></span>
<span class="line"><span style="color:#DBD7CA;">EnvironmentFile=/data/etcd/conf/etcd.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecStart=/data/etcd/bin/etcd \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--cert-file=/data/etcd/ssl/server.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--key-file=/data/etcd/ssl/server-key.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--peer-cert-file=/data/etcd/ssl/server.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--peer-key-file=/data/etcd/ssl/server-key.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--trusted-ca-file=/data/etcd/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--peer-trusted-ca-file=/data/etcd/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--logger=zap</span></span>
<span class="line"><span style="color:#DBD7CA;">Restart=on-failure</span></span>
<span class="line"><span style="color:#DBD7CA;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Install</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">6.\u590D\u5236\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp TLS/etcd/</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">.pem /data/etcd/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">7.\u542F\u52A8etcd-1\u8282\u70B9</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start etcd</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;">#\u7B2C\u4E00\u4E2A\u8282\u70B9\u542F\u52A8\u4F1A\u4E00\u76F4\u5904\u4E8E\u5176\u4E2D\u4E2D\u7684\u72B6\u6001\uFF0C\u53EA\u6709\u5F53\u7B2C\u4E8C\u4E2A\u8282\u70B9\u4E5F\u542F\u52A8\u4E86\uFF0C\u7B2C\u4E00\u4E2A\u8282\u70B9\u624D\u80FD\u542F\u52A8\u6210\u529F\uFF0C\u56E0\u4E3A\u96C6\u7FA4\u7248\u7684etcd\u81F3\u5C11\u9700\u89812\u4E2A\u8282\u70B9\u624D\u80FD\u6210\u529F\u8FD0\u884C</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u521B\u5EFA\u7A0B\u5E8F\u76EE\u5F55</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mkdir /data/etcd/{bin,conf,ssl,data} -p</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> tar xf etcd-v3.4.9-linux-amd64.tar.gz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u5C06\u4E8C\u8FDB\u5236\u547D\u4EE4\u79FB\u52A8\u5230\u5236\u5B9A\u51FA\u7A0B\u5E8F\u76EE\u5F55</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mv etcd-v3.4.9-linux-amd64/etcd</span><span style="color:#AB5959;">*</span><span style="color:#393A34;"> /data/etcd/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u7F16\u8F91\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#A0ADA0;">#[Member]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_NAME=</span><span style="color:#B56959;">&quot;etcd-1&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_DATA_DIR=</span><span style="color:#B56959;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.10:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">#[Clustering]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.10:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER=</span><span style="color:#B56959;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#B56959;">&quot;etcd-cluster&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#B56959;">&quot;new&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.\u7F16\u5199systemctl\u63A7\u5236\u811A\u672C</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /usr/lib/systemd/system/etcd.service</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Unit</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Description=Etcd Server</span></span>
<span class="line"><span style="color:#393A34;">After=network.target</span></span>
<span class="line"><span style="color:#393A34;">After=network-online.target</span></span>
<span class="line"><span style="color:#393A34;">Wants=network-online.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Type=notify</span></span>
<span class="line"><span style="color:#393A34;">EnvironmentFile=/data/etcd/conf/etcd.conf</span></span>
<span class="line"><span style="color:#393A34;">ExecStart=/data/etcd/bin/etcd \\</span></span>
<span class="line"><span style="color:#393A34;">--cert-file=/data/etcd/ssl/server.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--key-file=/data/etcd/ssl/server-key.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--peer-cert-file=/data/etcd/ssl/server.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--peer-key-file=/data/etcd/ssl/server-key.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--trusted-ca-file=/data/etcd/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--peer-trusted-ca-file=/data/etcd/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--logger=zap</span></span>
<span class="line"><span style="color:#393A34;">Restart=on-failure</span></span>
<span class="line"><span style="color:#393A34;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Install</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">6.\u590D\u5236\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp TLS/etcd/</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">.pem /data/etcd/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">7.\u542F\u52A8etcd-1\u8282\u70B9</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start etcd</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">#\u7B2C\u4E00\u4E2A\u8282\u70B9\u542F\u52A8\u4F1A\u4E00\u76F4\u5904\u4E8E\u5176\u4E2D\u4E2D\u7684\u72B6\u6001\uFF0C\u53EA\u6709\u5F53\u7B2C\u4E8C\u4E2A\u8282\u70B9\u4E5F\u542F\u52A8\u4E86\uFF0C\u7B2C\u4E00\u4E2A\u8282\u70B9\u624D\u80FD\u542F\u52A8\u6210\u529F\uFF0C\u56E0\u4E3A\u96C6\u7FA4\u7248\u7684etcd\u81F3\u5C11\u9700\u89812\u4E2A\u8282\u70B9\u624D\u80FD\u6210\u529F\u8FD0\u884C</span></span>
<span class="line"></span></code></pre></div><p><strong>3.\u914D\u7F6Eetcd-2\u8282\u70B9\u548Cetcd-3\u8282\u70B9</strong></p><p>\u90E8\u7F72\u5B8C\u4E00\u4E2A\u8282\u70B9\uFF0C\u53EF\u4EE5\u76F4\u63A5\u5C06\u76EE\u5F55\u62F7\u8D1D\u81F3\u5176\u4ED6\u8282\u70B9\uFF0C\u7701\u53BB\u5B89\u88C5\u7684\u4E00\u4E9B\u6B65\u9AA4\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u63A8\u9001etcd\u76EE\u5F55</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /data/etcd root@192.168.20.12:/data</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /data/etcd root@192.168.20.13:/data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u63A8\u9001systemctl\u542F\u52A8\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /usr/lib/systemd/system/etcd.service root@192.168.20.12:/usr/lib/systemd/system/</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /usr/lib/systemd/system/etcd.service root@192.168.20.13:/usr/lib/systemd/system/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u4FEE\u6539etcd-2\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#758575;">#[Member]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_NAME=</span><span style="color:#C98A7D;">&quot;etcd-2&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_DATA_DIR=</span><span style="color:#C98A7D;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.12:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;">#[Clustering]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.12:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER=</span><span style="color:#C98A7D;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#C98A7D;">&quot;etcd-cluster&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#C98A7D;">&quot;new&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u4FEE\u6539etcd-3\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#758575;">#[Member]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_NAME=</span><span style="color:#C98A7D;">&quot;etcd-3&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_DATA_DIR=</span><span style="color:#C98A7D;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;">#[Clustering]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER=</span><span style="color:#C98A7D;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#C98A7D;">&quot;etcd-cluster&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#C98A7D;">&quot;new&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.\u542F\u52A8etcd-1\u548Cetcd-2</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start etcd</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> etcd</span></span>
<span class="line"><span style="color:#DBD7CA;">------------</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start etcd</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> etcd</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u63A8\u9001etcd\u76EE\u5F55</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /data/etcd root@192.168.20.12:/data</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /data/etcd root@192.168.20.13:/data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u63A8\u9001systemctl\u542F\u52A8\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /usr/lib/systemd/system/etcd.service root@192.168.20.12:/usr/lib/systemd/system/</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /usr/lib/systemd/system/etcd.service root@192.168.20.13:/usr/lib/systemd/system/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u4FEE\u6539etcd-2\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#A0ADA0;">#[Member]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_NAME=</span><span style="color:#B56959;">&quot;etcd-2&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_DATA_DIR=</span><span style="color:#B56959;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.12:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">#[Clustering]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.12:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER=</span><span style="color:#B56959;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#B56959;">&quot;etcd-cluster&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#B56959;">&quot;new&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u4FEE\u6539etcd-3\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#A0ADA0;">#[Member]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_NAME=</span><span style="color:#B56959;">&quot;etcd-3&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_DATA_DIR=</span><span style="color:#B56959;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">#[Clustering]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER=</span><span style="color:#B56959;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#B56959;">&quot;etcd-cluster&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#B56959;">&quot;new&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.\u542F\u52A8etcd-1\u548Cetcd-2</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start etcd</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> etcd</span></span>
<span class="line"><span style="color:#393A34;">------------</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start etcd</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> etcd</span></span>
<span class="line"></span></code></pre></div><p><strong>4.\u67E5\u770B\u96C6\u7FA4\u72B6\u6001</strong><br> etcd-1\u542F\u52A8\u65F6\u4F1A\u4E00\u76F4\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\uFF0C\u5F53etcd-2\u6267\u884C\u542F\u52A8\u547D\u4EE4\u65F6\u4F1A\u7ACB\u5373\u542F\u52A8\u6210\u529F\uFF0C\u5E76\u4E14etcd-1\u4E5F\u4F1A\u7ACB\u523B\u542F\u52A8\u6210\u529F\u3002</p><p>\u67E5\u770Betcd\u7684\u65E5\u5FD7\u53EF\u4EE5\u4F7F\u7528\u8FD9\u4E2A\u547D\u4EE4\uFF1A<code>[root@binary-k8s-master1 ~]\\# journalctl -u etcd -f</code></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u67E5\u770B\u670D\u52A1\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep etcd</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.10:2379      0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      9625/etcd           </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.10:2380      0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      9625/etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u67E5\u770B\u96C6\u7FA4\u72B6\u6001</span></span>
<span class="line"><span style="color:#758575;">#\u5982\u679C\u914D\u7F6E\u6587\u4EF6\u4E2D2379\u7AEF\u53E3\u6CA1\u6709\u52A0\u4E00\u4E2A127.0.0.1\u5219\u8FD9\u6837\u67E5\u770B\u96C6\u7FA4\u72B6\u6001</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ETCDCTL_API=3 /data/etcd/bin/etcdctl --cacert=/data/etcd/ssl/ca.pem --cert=/data/etcd/ssl/server.pem --key=/data/etcd/ssl/server-key.pem --endpoints=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379&quot;</span><span style="color:#DBD7CA;"> endpoint health --write-out=table</span></span>
<span class="line"><span style="color:#DBD7CA;">+----------------------------+--------+-------------+-------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">          ENDPOINT          </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> HEALTH </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">    TOOK     </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> ERROR </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+----------------------------+--------+-------------+-------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.10:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">   </span><span style="color:#E0A569;">true</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 32.322714ms </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">       </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.12:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">   </span><span style="color:#E0A569;">true</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 31.524079ms </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">       </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.13:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">   </span><span style="color:#E0A569;">true</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 38.985949ms </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">       </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+----------------------------+--------+-------------+-------+</span></span>
<span class="line"><span style="color:#758575;">#\u5982\u679C\u914D\u7F6E\u6587\u4EF6\u6C47\u603B2379\u7AEF\u53E3\u52A0\u4E86\u4E00\u4E2A127.0.0.1\u5219\u53EF\u4EE5\u4F7F\u7528\u5982\u4E0B\u65B9\u5F0F\u67E5\u770B\u96C6\u7FA4\u4FE1\u606F\u65E0\u9700\u6307\u5B9A\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 /data/etcd/conf</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;">  /data/etcd/bin/etcdctl member list --write-out=table</span></span>
<span class="line"><span style="color:#DBD7CA;">+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">        ID        </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> STATUS  </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">  NAME  </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">         PEER ADDRS         </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">                   CLIENT ADDRS                    </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> IS LEARNER </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 12446003b2a53d43 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-2 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.12:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://127.0.0.1:2379,https://192.168.20.12:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 51ae3f86f3783687 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-1 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.10:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">  http://127.0.0.1:2379,https://192.168.20.10:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 667c9c7ba890c3f7 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-3 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.13:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">  http://127.0.0.1:2379,https://192.168.20.13:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u67E5\u770B\u670D\u52A1\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep etcd</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.10:2379      0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      9625/etcd           </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.10:2380      0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      9625/etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u67E5\u770B\u96C6\u7FA4\u72B6\u6001</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5982\u679C\u914D\u7F6E\u6587\u4EF6\u4E2D2379\u7AEF\u53E3\u6CA1\u6709\u52A0\u4E00\u4E2A127.0.0.1\u5219\u8FD9\u6837\u67E5\u770B\u96C6\u7FA4\u72B6\u6001</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ETCDCTL_API=3 /data/etcd/bin/etcdctl --cacert=/data/etcd/ssl/ca.pem --cert=/data/etcd/ssl/server.pem --key=/data/etcd/ssl/server-key.pem --endpoints=</span><span style="color:#B56959;">&quot;https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379&quot;</span><span style="color:#393A34;"> endpoint health --write-out=table</span></span>
<span class="line"><span style="color:#393A34;">+----------------------------+--------+-------------+-------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;">          ENDPOINT          </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> HEALTH </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">    TOOK     </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> ERROR </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+----------------------------+--------+-------------+-------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.10:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">   </span><span style="color:#B58451;">true</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 32.322714ms </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">       </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.12:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">   </span><span style="color:#B58451;">true</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 31.524079ms </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">       </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.13:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">   </span><span style="color:#B58451;">true</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 38.985949ms </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">       </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+----------------------------+--------+-------------+-------+</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5982\u679C\u914D\u7F6E\u6587\u4EF6\u6C47\u603B2379\u7AEF\u53E3\u52A0\u4E86\u4E00\u4E2A127.0.0.1\u5219\u53EF\u4EE5\u4F7F\u7528\u5982\u4E0B\u65B9\u5F0F\u67E5\u770B\u96C6\u7FA4\u4FE1\u606F\u65E0\u9700\u6307\u5B9A\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 /data/etcd/conf</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;">  /data/etcd/bin/etcdctl member list --write-out=table</span></span>
<span class="line"><span style="color:#393A34;">+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;">        ID        </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> STATUS  </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">  NAME  </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">         PEER ADDRS         </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">                   CLIENT ADDRS                    </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> IS LEARNER </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 12446003b2a53d43 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-2 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.12:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://127.0.0.1:2379,https://192.168.20.12:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 51ae3f86f3783687 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-1 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.10:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">  http://127.0.0.1:2379,https://192.168.20.10:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 667c9c7ba890c3f7 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-3 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.13:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">  http://127.0.0.1:2379,https://192.168.20.13:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+</span></span>
<span class="line"></span></code></pre></div><p>\u914D\u7F6E\u6587\u4EF6\u72B6\u6001<br><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/da2f8ef902c04e77a4e555d67cc32273.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>etcd\u542F\u52A8\u6210\u529F\u7684\u65E5\u5FD7</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/25e40829361b4c78b782ae1b180a90b7.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h2 id="_4-\u90E8\u7F72docker\u670D\u52A1" tabindex="-1">4.\u90E8\u7F72Docker\u670D\u52A1 <a class="header-anchor" href="#_4-\u90E8\u7F72docker\u670D\u52A1" aria-hidden="true">#</a></h2><p>\u6240\u6709kubernetes\u8282\u70B9\u90FD\u9700\u8981\u5B89\u88C5docker\u670D\u52A1\uFF0C\u5305\u62ECmaster\u548Cnode\u8282\u70B9\u3002</p><p>docker\u4E8C\u8FDB\u5236\u6587\u4EF6\u4E0B\u8F7D\u5730\u5740\uFF1A<a href="https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz" target="_blank" rel="noopener noreferrer">https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz</a></p><h3 id="_4-1-\u5B89\u88C5docker" tabindex="-1">4.1.\u5B89\u88C5docker <a class="header-anchor" href="#_4-1-\u5B89\u88C5docker" aria-hidden="true">#</a></h3><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u89E3\u538B\u4E8C\u8FDB\u5236\u5305</span></span>
<span class="line"><span style="color:#DBD7CA;">tar zxf docker-19.03.9.tgz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5C06\u53EF\u6267\u884C\u547D\u4EE4\u79FB\u52A8\u5230\u7CFB\u7EDF\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#DBD7CA;">mv docker/</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;"> /usr/bin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u521B\u5EFA\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#DBD7CA;">mkdir /etc/docker</span></span>
<span class="line"><span style="color:#DBD7CA;">vim /etc/docker/daemon.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;registry-mirrors&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span><span style="color:#C98A7D;">&quot;https://9wn5tbfh.mirror.aliyuncs.com&quot;</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u89E3\u538B\u4E8C\u8FDB\u5236\u5305</span></span>
<span class="line"><span style="color:#393A34;">tar zxf docker-19.03.9.tgz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u5C06\u53EF\u6267\u884C\u547D\u4EE4\u79FB\u52A8\u5230\u7CFB\u7EDF\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#393A34;">mv docker/</span><span style="color:#AB5959;">*</span><span style="color:#393A34;"> /usr/bin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u521B\u5EFA\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#393A34;">mkdir /etc/docker</span></span>
<span class="line"><span style="color:#393A34;">vim /etc/docker/daemon.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;registry-mirrors&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span><span style="color:#B56959;">&quot;https://9wn5tbfh.mirror.aliyuncs.com&quot;</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-2-\u4E3Adocker\u521B\u5EFAsystemctl\u542F\u52A8\u811A\u672C" tabindex="-1">4.2.\u4E3Adocker\u521B\u5EFAsystemctl\u542F\u52A8\u811A\u672C <a class="header-anchor" href="#_4-2-\u4E3Adocker\u521B\u5EFAsystemctl\u542F\u52A8\u811A\u672C" aria-hidden="true">#</a></h3><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u7F16\u5199\u542F\u52A8\u811A\u672C</span></span>
<span class="line"><span style="color:#DBD7CA;">vim /usr/lib/systemd/system/docker.service</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Unit</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Description=Docker Application Container Engine</span></span>
<span class="line"><span style="color:#DBD7CA;">Documentation=https://docs.docker.com</span></span>
<span class="line"><span style="color:#DBD7CA;">After=network-online.target firewalld.service</span></span>
<span class="line"><span style="color:#DBD7CA;">Wants=network-online.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Type=notify</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecStart=/usr/bin/dockerd</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecReload=/bin/kill -s HUP </span></span>
<span class="line"><span style="color:#DBD7CA;">LimitNOFILE=infinity</span></span>
<span class="line"><span style="color:#DBD7CA;">LimitNPROC=infinity</span></span>
<span class="line"><span style="color:#DBD7CA;">LimitCORE=infinity</span></span>
<span class="line"><span style="color:#DBD7CA;">TimeoutStartSec=0</span></span>
<span class="line"><span style="color:#DBD7CA;">Delegate=yes</span></span>
<span class="line"><span style="color:#DBD7CA;">KillMode=process</span></span>
<span class="line"><span style="color:#DBD7CA;">Restart=on-failure</span></span>
<span class="line"><span style="color:#DBD7CA;">StartLimitBurst=3</span></span>
<span class="line"><span style="color:#DBD7CA;">StartLimitInterval=60s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Install</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u542F\u52A8docker</span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl daemon-reload </span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl start docker</span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> docker</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u7F16\u5199\u542F\u52A8\u811A\u672C</span></span>
<span class="line"><span style="color:#393A34;">vim /usr/lib/systemd/system/docker.service</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Unit</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Description=Docker Application Container Engine</span></span>
<span class="line"><span style="color:#393A34;">Documentation=https://docs.docker.com</span></span>
<span class="line"><span style="color:#393A34;">After=network-online.target firewalld.service</span></span>
<span class="line"><span style="color:#393A34;">Wants=network-online.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Type=notify</span></span>
<span class="line"><span style="color:#393A34;">ExecStart=/usr/bin/dockerd</span></span>
<span class="line"><span style="color:#393A34;">ExecReload=/bin/kill -s HUP </span></span>
<span class="line"><span style="color:#393A34;">LimitNOFILE=infinity</span></span>
<span class="line"><span style="color:#393A34;">LimitNPROC=infinity</span></span>
<span class="line"><span style="color:#393A34;">LimitCORE=infinity</span></span>
<span class="line"><span style="color:#393A34;">TimeoutStartSec=0</span></span>
<span class="line"><span style="color:#393A34;">Delegate=yes</span></span>
<span class="line"><span style="color:#393A34;">KillMode=process</span></span>
<span class="line"><span style="color:#393A34;">Restart=on-failure</span></span>
<span class="line"><span style="color:#393A34;">StartLimitBurst=3</span></span>
<span class="line"><span style="color:#393A34;">StartLimitInterval=60s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Install</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u542F\u52A8docker</span></span>
<span class="line"><span style="color:#393A34;">systemctl daemon-reload </span></span>
<span class="line"><span style="color:#393A34;">systemctl start docker</span></span>
<span class="line"><span style="color:#393A34;">systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> docker</span></span>
<span class="line"></span></code></pre></div><h2 id="_5-\u90E8\u7F72kubernetes-master\u8282\u70B9" tabindex="-1">5.\u90E8\u7F72kubernetes master\u8282\u70B9 <a class="header-anchor" href="#_5-\u90E8\u7F72kubernetes-master\u8282\u70B9" aria-hidden="true">#</a></h2><p>\u90E8\u7F72\u4E8C\u8FDB\u5236\u7684kubernetes\u7EC4\u4EF6\u5927\u81F4\u53EF\u5206\u4E3A\u5982\u4E0B\u51E0\u4E2A\u6B65\u9AA4\uFF1A</p><ul><li>1.\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6</li><li>2.\u590D\u5236\u4E8C\u8FDB\u5236\u7A0B\u5E8F\u5230\u6307\u5B9A\u76EE\u5F55</li><li>3.\u521B\u5EFA\u7EC4\u4EF6\u914D\u7F6E\u6587\u4EF6</li><li>4.\u751F\u6210\u7EC4\u4EF6\u7684kubeconfig\u6587\u4EF6</li><li>5.\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1</li><li>6.\u542F\u52A8\u7EC4\u4EF6</li></ul><p>kubernetes\u96C6\u7FA4\u7684master\u8282\u70B9\u548Cnode\u8282\u70B9\u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\u90FD\u4ECEgithub\u4E0A\u4E0B\u8F7D\uFF0Cmaster\u548Cnode\u76F8\u5173\u7684\u6240\u6709\u7EC4\u4EF6\u90FD\u5728\u4E00\u4E2A\u7A0B\u5E8F\u5305\u4E2D\u3002</p><p>\u4E0B\u8F7D\u5730\u5740\uFF1A <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md</a></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/36b71f10da9442808c7a950d2dedd254.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_5-1-\u4F7F\u7528cfssl\u751F\u6210apiserver\u7684\u8BC1\u4E66\u6587\u4EF6" tabindex="-1">5.1.\u4F7F\u7528cfssl\u751F\u6210apiserver\u7684\u8BC1\u4E66\u6587\u4EF6 <a class="header-anchor" href="#_5-1-\u4F7F\u7528cfssl\u751F\u6210apiserver\u7684\u8BC1\u4E66\u6587\u4EF6" aria-hidden="true">#</a></h3><p><strong>1.\u751F\u6210CA\u81EA\u7B7E\u9881\u53D1\u673A\u6784\u8BC1\u4E66</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u51C6\u5907CA\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim ca-config.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;signing&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;default&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;expiry&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;87600h&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;profiles&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;kubernetes&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">         </span><span style="color:#C98A7D;">&quot;expiry&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;87600h&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">         </span><span style="color:#C98A7D;">&quot;usages&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;signing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;key encipherment&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;server auth&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;client auth&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim ca-csr.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;kubernetes&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;key&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#C98A7D;">&quot;algo&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;rsa&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#C98A7D;">&quot;size&quot;</span><span style="color:#DBD7CA;">: 2048</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;names&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;C&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;L&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;Beijing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;ST&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;Beijing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;O&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;k8s&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;OU&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u751F\u6210\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cfssl gencert -initca ca-csr.json </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> cfssljson -bare ca -</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:20:42 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating a new CA key and certificate from CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:20:42 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generate received request</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:20:42 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> received CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:20:42 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:20:43 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> encoded CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:20:43 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> signed certificate with serial number 90951268335404710707183639990677546638148434604</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u51C6\u5907CA\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim ca-config.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;signing&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;default&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;expiry&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;87600h&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;profiles&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;kubernetes&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">         </span><span style="color:#B56959;">&quot;expiry&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;87600h&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">         </span><span style="color:#B56959;">&quot;usages&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;signing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;key encipherment&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;server auth&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;client auth&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim ca-csr.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;kubernetes&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;key&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959;">&quot;algo&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;rsa&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959;">&quot;size&quot;</span><span style="color:#393A34;">: 2048</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;names&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;C&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;L&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;Beijing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;ST&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;Beijing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;O&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;k8s&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;OU&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u751F\u6210\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cfssl gencert -initca ca-csr.json </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> cfssljson -bare ca -</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:20:42 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating a new CA key and certificate from CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:20:42 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generate received request</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:20:42 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> received CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:20:42 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:20:43 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> encoded CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:20:43 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> signed certificate with serial number 90951268335404710707183639990677546638148434604</span></span>
<span class="line"></span></code></pre></div><p><strong>2.\u4F7F\u7528\u81EA\u7B7ECA\u7B7E\u53D1apiserver HTTPS\u8BC1\u4E66</strong></p><p>\u7B7E\u53D1\u7684\u5BA2\u6237\u7AEF\u8BC1\u4E66\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684hosts\u5B57\u6BB5\u8981\u5305\u542B\u6240\u6709Master/LB/VIP\u7684IP\u5730\u5740\uFF0CNode\u8282\u70B9\u7684\u5730\u5740\u53EF\u5199\u53EF\u4E0D\u5199\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u51C6\u5907\u5BA2\u6237\u7AEF\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim kube-apiserver-csr.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;kubernetes&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;10.0.0.1&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;127.0.0.1&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;192.168.20.10&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;192.168.20.11&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;192.168.20.12&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;192.168.20.13&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;192.168.20.9&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;kubernetes&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;kubernetes.default&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;kubernetes.default.svc&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;kubernetes.default.svc.cluster&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;kubernetes.default.svc.cluster.local&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;key&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#C98A7D;">&quot;algo&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;rsa&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#C98A7D;">&quot;size&quot;</span><span style="color:#DBD7CA;">: 2048</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;names&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;C&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;L&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;ST&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;O&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;k8s&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#C98A7D;">&quot;OU&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u751F\u6210\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> cfssljson -bare kube-apiserver</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:30:24 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generate received request</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:30:24 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> received CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:30:24 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:30:25 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> encoded CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:30:25 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> signed certificate with serial number 714472722509814799589567099679496298525490716083</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:30:25 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">WARNING</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> This certificate lacks a </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;"> field. This makes it unsuitable </span><span style="color:#4D9375;">for</span></span>
<span class="line"><span style="color:#DBD7CA;">websites. For more information see the Baseline Requirements </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CA;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#DBD7CA;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">https://cabforum.org</span><span style="color:#858585;">)</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">specifically, section 10.2.3 </span><span style="color:#858585;">(</span><span style="color:#C98A7D;">&quot;Information Requirements&quot;</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;">.</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u51C6\u5907\u5BA2\u6237\u7AEF\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim kube-apiserver-csr.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;kubernetes&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;10.0.0.1&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;127.0.0.1&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;192.168.20.10&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;192.168.20.11&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;192.168.20.12&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;192.168.20.13&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;192.168.20.9&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;kubernetes&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;kubernetes.default&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;kubernetes.default.svc&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;kubernetes.default.svc.cluster&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;kubernetes.default.svc.cluster.local&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;key&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959;">&quot;algo&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;rsa&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959;">&quot;size&quot;</span><span style="color:#393A34;">: 2048</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;names&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;C&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;L&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;ST&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;O&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;k8s&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959;">&quot;OU&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u751F\u6210\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> cfssljson -bare kube-apiserver</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:30:24 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generate received request</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:30:24 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> received CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:30:24 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:30:25 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> encoded CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:30:25 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> signed certificate with serial number 714472722509814799589567099679496298525490716083</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:30:25 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">WARNING</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> This certificate lacks a </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;"> field. This makes it unsuitable </span><span style="color:#1C6B48;">for</span></span>
<span class="line"><span style="color:#393A34;">websites. For more information see the Baseline Requirements </span><span style="color:#1C6B48;">for</span><span style="color:#393A34;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#393A34;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">https://cabforum.org</span><span style="color:#8E8F8B;">)</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">specifically, section 10.2.3 </span><span style="color:#8E8F8B;">(</span><span style="color:#B56959;">&quot;Information Requirements&quot;</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;">.</span></span>
<span class="line"></span></code></pre></div><p><strong>3.\u67E5\u770B\u751F\u4EA7\u7684\u8BC1\u4E66\u6587\u4EF6</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ll</span></span>
<span class="line"><span style="color:#DBD7CA;">\u603B\u7528\u91CF 36</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  294 9\u6708   1 16:20 ca-config.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1001 9\u6708   1 16:20 ca.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  264 9\u6708   1 16:20 ca-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1679 9\u6708   1 16:20 ca-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1359 9\u6708   1 16:20 ca.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1277 9\u6708   1 16:30 kube-apiserver.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  602 9\u6708   1 16:30 kube-apiserver-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1679 9\u6708   1 16:30 kube-apiserver-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1643 9\u6708   1 16:30 kube-apiserver.pem</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ll</span></span>
<span class="line"><span style="color:#393A34;">\u603B\u7528\u91CF 36</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  294 9\u6708   1 16:20 ca-config.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1001 9\u6708   1 16:20 ca.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  264 9\u6708   1 16:20 ca-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1679 9\u6708   1 16:20 ca-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1359 9\u6708   1 16:20 ca.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1277 9\u6708   1 16:30 kube-apiserver.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  602 9\u6708   1 16:30 kube-apiserver-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1679 9\u6708   1 16:30 kube-apiserver-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1643 9\u6708   1 16:30 kube-apiserver.pem</span></span>
<span class="line"></span></code></pre></div><h3 id="_5-2-\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F" tabindex="-1">5.2.\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F <a class="header-anchor" href="#_5-2-\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F" aria-hidden="true">#</a></h3><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mkdir /data/kubernetes/{bin,config,ssl,logs} -p</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> tar xf kubernetes-server-linux-amd64.tar.gz </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> </span><span style="color:#E0A569;">cd</span><span style="color:#DBD7CA;"> kubernetes/server/bin/</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/kubernetes/server/bin</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp kube-apiserver kube-scheduler kube-controller-manager /data/kubernetes/bin/</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/kubernetes/server/bin</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp kubectl /usr/bin/</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mkdir /data/kubernetes/{bin,config,ssl,logs} -p</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> tar xf kubernetes-server-linux-amd64.tar.gz </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> </span><span style="color:#B58451;">cd</span><span style="color:#393A34;"> kubernetes/server/bin/</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/kubernetes/server/bin</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp kube-apiserver kube-scheduler kube-controller-manager /data/kubernetes/bin/</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/kubernetes/server/bin</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp kubectl /usr/bin/</span></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/e7c7eb9ad3ae4b0a8800c575d4e86023.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_5-3-\u90E8\u7F72kube-apiserver\u7EC4\u4EF6" tabindex="-1">5.3.\u90E8\u7F72kube-apiserver\u7EC4\u4EF6 <a class="header-anchor" href="#_5-3-\u90E8\u7F72kube-apiserver\u7EC4\u4EF6" aria-hidden="true">#</a></h3><h4 id="_5-3-1-\u521B\u5EFAkube-apiserver\u914D\u7F6E\u6587\u4EF6" tabindex="-1">5.3.1.\u521B\u5EFAkube-apiserver\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_5-3-1-\u521B\u5EFAkube-apiserver\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-apiserver.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">KUBE_APISERVER_OPTS=</span><span style="color:#C98A7D;">&quot;--logtostderr=false </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--v=2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--log-dir=/data/kubernetes/logs </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--etcd-servers=https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--bind-address=192.168.20.10 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--secure-port=6443 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--advertise-address=192.168.20.10 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--allow-privileged=true </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--service-cluster-ip-range=10.0.0.0/24 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--authorization-mode=RBAC,Node </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--enable-bootstrap-token-auth=true </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--token-auth-file=/data/kubernetes/config/token.csv </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--service-node-port-range=30000-32767 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--kubelet-client-certificate=/data/kubernetes/ssl/kube-apiserver.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--kubelet-client-key=/data/kubernetes/ssl/kube-apiserver-key.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--tls-cert-file=/data/kubernetes/ssl/kube-apiserver.pem  </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--tls-private-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--client-ca-file=/data/kubernetes/ssl/ca.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--service-account-key-file=/data/kubernetes/ssl/ca-key.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--service-account-issuer=api </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--service-account-signing-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--etcd-cafile=/data/etcd/ssl/ca.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--etcd-certfile=/data/etcd/ssl/server.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--etcd-keyfile=/data/etcd/ssl/server-key.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--requestheader-client-ca-file=/data/kubernetes/ssl/ca.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--proxy-client-cert-file=/data/kubernetes/ssl/kube-apiserver.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--proxy-client-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--requestheader-allowed-names=kubernetes </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--requestheader-extra-headers-prefix=X-Remote-Extra- </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--requestheader-group-headers=X-Remote-Group </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--requestheader-username-headers=X-Remote-User </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--enable-aggregator-routing=true </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--audit-log-maxage=30 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--audit-log-maxbackup=3 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--audit-log-maxsize=100 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--audit-log-path=/data/kubernetes/logs/k8s-audit.log&quot;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-apiserver.conf</span></span>
<span class="line"><span style="color:#393A34;">KUBE_APISERVER_OPTS=</span><span style="color:#B56959;">&quot;--logtostderr=false </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--v=2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--log-dir=/data/kubernetes/logs </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--etcd-servers=https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--bind-address=192.168.20.10 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--secure-port=6443 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--advertise-address=192.168.20.10 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--allow-privileged=true </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--service-cluster-ip-range=10.0.0.0/24 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--authorization-mode=RBAC,Node </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--enable-bootstrap-token-auth=true </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--token-auth-file=/data/kubernetes/config/token.csv </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--service-node-port-range=30000-32767 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--kubelet-client-certificate=/data/kubernetes/ssl/kube-apiserver.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--kubelet-client-key=/data/kubernetes/ssl/kube-apiserver-key.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--tls-cert-file=/data/kubernetes/ssl/kube-apiserver.pem  </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--tls-private-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--client-ca-file=/data/kubernetes/ssl/ca.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--service-account-key-file=/data/kubernetes/ssl/ca-key.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--service-account-issuer=api </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--service-account-signing-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--etcd-cafile=/data/etcd/ssl/ca.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--etcd-certfile=/data/etcd/ssl/server.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--etcd-keyfile=/data/etcd/ssl/server-key.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--requestheader-client-ca-file=/data/kubernetes/ssl/ca.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--proxy-client-cert-file=/data/kubernetes/ssl/kube-apiserver.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--proxy-client-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--requestheader-allowed-names=kubernetes </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--requestheader-extra-headers-prefix=X-Remote-Extra- </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--requestheader-group-headers=X-Remote-Group </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--requestheader-username-headers=X-Remote-User </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--enable-aggregator-routing=true </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--audit-log-maxage=30 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--audit-log-maxbackup=3 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--audit-log-maxsize=100 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--audit-log-path=/data/kubernetes/logs/k8s-audit.log&quot;</span></span>
<span class="line"></span></code></pre></div><p><strong>\u914D\u7F6E\u6587\u4EF6\u5404\u53C2\u6570\u542B\u4E49</strong></p><table><thead><tr><th>\u914D\u7F6E\u53C2\u6570</th><th>\u542B\u4E49</th></tr></thead><tbody><tr><td>\u2013logtostderr</td><td>\u662F\u5426\u5F00\u542F\u65E5\u5FD7</td></tr><tr><td>\u2013v</td><td>\u65E5\u5FD7\u7684\u7B49\u7EA7\uFF0C\u7B49\u7EA7\u8D8A\u9AD8\u5185\u5BB9\u8D8A\u8BE6\u7EC6</td></tr><tr><td>\u2013log-dir</td><td>\u65E5\u5FD7\u5B58\u653E\u8DEF\u5F84</td></tr><tr><td>\u2013etcd-servers</td><td>etcd\u96C6\u7FA4\u5730\u5740</td></tr><tr><td>\u2013bind-address</td><td>\u76D1\u542C\u5730\u5740\uFF0C\u4E5F\u5C31\u662F\u672C\u673A</td></tr><tr><td>\u2013secure-port</td><td>https\u5B89\u5168\u7AEF\u53E3</td></tr><tr><td>\u2013advertise-address</td><td>\u96C6\u7FA4\u901A\u544A\u5730\u5740</td></tr><tr><td>\u2013allow-privileged</td><td>\u4F01\u4E1A\u6388\u6743</td></tr><tr><td>\u2013service-cluster-ip-range</td><td>service\u8D44\u6E90IP\u5730\u5740\u6BB5</td></tr><tr><td>\u2013enable-admission-plugins</td><td>\u51C6\u5165\u63A7\u5236\u6A21\u5757</td></tr><tr><td>\u2013authorization-mode</td><td>\u8BA4\u8BC1\u6388\u6743\uFF0C\u542F\u7528RBAC\u6388\u6743\u548C\u8282\u70B9\u81EA\u7BA1\u7406</td></tr><tr><td>\u2013enable-bootstrap-token-auth</td><td>\u542F\u7528TLS bootstrap\u673A\u5236\uFF0C\u542F\u7528\u4E4B\u540Ekubelet\u53EF\u4EE5\u81EA\u52A8\u7ED9node\u8282\u9881\u53D1\u8BC1\u4E66</td></tr><tr><td>\u2013token-auth-file</td><td>bootstrap token\u6587\u4EF6\u8DEF\u5F84</td></tr><tr><td>\u2013service-node-port-range</td><td>Service nodeport\u7C7B\u578B\u9ED8\u8BA4\u5206\u914D\u7AEF\u53E3\u8303\u56F4</td></tr><tr><td>\u2013kubelet-client-certificate</td><td>apiserver\u8BBF\u95EEkubelet\u7684\u5BA2\u6237\u7AEF\u8BC1\u4E66\u6587\u4EF6</td></tr><tr><td>\u2013kubelet-client-key</td><td>apiserver\u8BBF\u95EEkubelet\u7684\u5BA2\u6237\u7AEF\u79C1\u94A5\u6587\u4EF6</td></tr><tr><td>\u2013tls-cert-file</td><td>apiserver https\u8BC1\u4E66</td></tr><tr><td>\u2013tls-private-key-file</td><td>apiserver https\u8BC1\u4E66</td></tr><tr><td>\u2013client-ca-file</td><td>ca\u8BC1\u4E66\u8DEF\u5F84</td></tr><tr><td>\u2013service-account-key-file</td><td>ca\u79C1\u94A5\u8DEF\u5F84</td></tr><tr><td>\u2013service-account-issuer</td><td>sa\u8D26\u53F7\u6388\u6743\u8FC7\u671F\u65F6\u95F4\u7684\u4E00\u4E2A\u914D\u7F6E\uFF0C1.20\u4EE5\u540E\u624D\u6709\u7684\u7279\u6027</td></tr><tr><td>\u2013service-account-signing-key-file</td><td>\u8BC1\u4E66\u6587\u4EF6\u8DEF\u5F84</td></tr><tr><td>\u2013etcd-cafile</td><td>etcd ca\u8BC1\u4E66\u6587\u4EF6\u8DEF\u5F84</td></tr><tr><td>\u2013etcd-certfile</td><td>etcd \u5BA2\u6237\u7AEF\u8BC1\u4E66\u6587\u4EF6\u8DEF\u5F84</td></tr><tr><td>\u2013etcd-keyfile</td><td>etcd \u5BA2\u6237\u7AEF\u79C1\u94A5\u6587\u4EF6\u8DEF\u5F84</td></tr><tr><td>\u2013requestheader-client-ca-file</td><td>\u805A\u5408\u5C42\u76F8\u5173\u914D\u7F6E</td></tr><tr><td>\u2013proxy-client-cert-file</td><td>\u805A\u5408\u5C42\u76F8\u5173\u914D\u7F6E</td></tr><tr><td>\u2013proxy-client-key-file</td><td>\u805A\u5408\u5C42\u76F8\u5173\u914D\u7F6E</td></tr><tr><td>\u2013requestheader-allowed-names</td><td>\u805A\u5408\u5C42\u76F8\u5173\u914D\u7F6E</td></tr><tr><td>\u2013requestheader-extra-headers-prefix</td><td>\u805A\u5408\u5C42\u76F8\u5173\u914D\u7F6E</td></tr><tr><td>\u2013enable-aggregator-routing</td><td>\u805A\u5408\u5C42\u76F8\u5173\u914D\u7F6E</td></tr></tbody></table><h4 id="_5-3-2-\u521B\u5EFAtls-bootstrapping\u6587\u4EF6" tabindex="-1">5.3.2.\u521B\u5EFATLS Bootstrapping\u6587\u4EF6 <a class="header-anchor" href="#_5-3-2-\u521B\u5EFAtls-bootstrapping\u6587\u4EF6" aria-hidden="true">#</a></h4><p>TLS Bootstraping\uFF1AMaster apiserver\u542F\u7528TLS\u8BA4\u8BC1\u540E\uFF0CNode\u8282\u70B9kubelet\u548Ckube-proxy\u8981\u4E0Ekube-apiserver\u8FDB\u884C\u901A\u4FE1\uFF0C\u5FC5\u987B\u4F7F\u7528CA\u7B7E\u53D1\u7684\u6709\u6548\u8BC1\u4E66\u624D\u53EF\u4EE5\uFF0C\u5F53Node\u8282\u70B9\u5F88\u591A\u65F6\uFF0C\u8FD9\u79CD\u5BA2\u6237\u7AEF\u8BC1\u4E66\u9881\u53D1\u9700\u8981\u5927\u91CF\u5DE5\u4F5C\uFF0C\u540C\u6837\u4E5F\u4F1A\u589E\u52A0\u96C6\u7FA4\u6269\u5C55\u590D\u6742\u5EA6\u3002\u4E3A\u4E86\u7B80\u5316\u6D41\u7A0B\uFF0CKubernetes\u5F15\u5165\u4E86TLS bootstraping\u673A\u5236\u6765\u81EA\u52A8\u9881\u53D1\u5BA2\u6237\u7AEF\u8BC1\u4E66\uFF0Ckubelet\u4F1A\u4EE5\u4E00\u4E2A\u4F4E\u6743\u9650\u7528\u6237\u81EA\u52A8\u5411apiserver\u7533\u8BF7\u8BC1\u4E66\uFF0Ckubelet\u7684\u8BC1\u4E66\u7531apiserver\u52A8\u6001\u7B7E\u7F72\u3002\u6240\u4EE5\u5F3A\u70C8\u5EFA\u8BAE\u5728Node\u4E0A\u4F7F\u7528\u8FD9\u79CD\u65B9\u5F0F\uFF0C\u76EE\u524D\u4E3B\u8981\u7528\u4E8Ekubelet\uFF0Ckube-proxy\u8FD8\u662F\u7531\u6211\u4EEC\u7EDF\u4E00\u9881\u53D1\u4E00\u4E2A\u8BC1\u4E66\u3002</p><p>TLS bootstraping \u5DE5\u4F5C\u6D41\u7A0B\uFF1A</p><p>kubelet\u9996\u5148\u53D6\u67E5\u627Ebootstraping\u914D\u7F6E\u6587\u4EF6\uFF0C\u7136\u540E\u53BB\u8FDE\u63A5apiserver\uFF0C\u5F00\u59CB\u9A8C\u8BC1bootstrap token\u6587\u4EF6\uFF0C\u518D\u9A8C\u8BC1\u8BC1\u4E66\u6587\u4EF6\uFF0C\u6700\u540E\u9881\u53D1\u8BC1\u4E66\u542F\u52A8\u6210\u529F\uFF0C\u5426\u5219\u5C31\u4F1A\u542F\u52A8\u5931\u8D25\u3002<br><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/17a18dfd43ae4604863e590283b63ebd.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u751F\u6210\u4E00\u4E2Atoken\u503C</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> head -c 16 /dev/urandom </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> od -An -t x </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> tr -d </span><span style="color:#C98A7D;">&#39; &#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">d7f96b0d86c574d0f64a713608db092</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u521B\u5EFAtoken\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/token.csv</span></span>
<span class="line"><span style="color:#DBD7CA;">d7f96b0d86c574d0f64a713608db0922,kubelet-bootstrap,10001,</span><span style="color:#C98A7D;">&quot;system:node-bootstrapper&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;">#\u683C\u5F0F\uFF1Atoken\uFF0C\u7528\u6237\u540D\uFF0CUID\uFF0C\u7528\u6237\u7EC4</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u751F\u6210\u4E00\u4E2Atoken\u503C</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> head -c 16 /dev/urandom </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> od -An -t x </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> tr -d </span><span style="color:#B56959;">&#39; &#39;</span></span>
<span class="line"><span style="color:#393A34;">d7f96b0d86c574d0f64a713608db092</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u521B\u5EFAtoken\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/token.csv</span></span>
<span class="line"><span style="color:#393A34;">d7f96b0d86c574d0f64a713608db0922,kubelet-bootstrap,10001,</span><span style="color:#B56959;">&quot;system:node-bootstrapper&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">#\u683C\u5F0F\uFF1Atoken\uFF0C\u7528\u6237\u540D\uFF0CUID\uFF0C\u7528\u6237\u7EC4</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-3-4-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406apiserver" tabindex="-1">5.3.4.\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406apiserver <a class="header-anchor" href="#_5-3-4-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406apiserver" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /usr/lib/systemd/system/kube-apiserver.service </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Unit</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Description=Kubernetes API Server</span></span>
<span class="line"><span style="color:#DBD7CA;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">EnvironmentFile=/data/kubernetes/config/kube-apiserver.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecStart=/data/kubernetes/bin/kube-apiserver </span><span style="color:#858585;">$</span><span style="color:#B8A965;">KUBE_APISERVER_OPTS</span></span>
<span class="line"><span style="color:#DBD7CA;">Restart=on-failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Install</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">WantedBy=multi-user.target</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /usr/lib/systemd/system/kube-apiserver.service </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Unit</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Description=Kubernetes API Server</span></span>
<span class="line"><span style="color:#393A34;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">EnvironmentFile=/data/kubernetes/config/kube-apiserver.conf</span></span>
<span class="line"><span style="color:#393A34;">ExecStart=/data/kubernetes/bin/kube-apiserver </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">KUBE_APISERVER_OPTS</span></span>
<span class="line"><span style="color:#393A34;">Restart=on-failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Install</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">WantedBy=multi-user.target</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-3-5-\u542F\u52A8kube-apiserver\u7EC4\u4EF6" tabindex="-1">5.3.5.\u542F\u52A8kube-apiserver\u7EC4\u4EF6 <a class="header-anchor" href="#_5-3-5-\u542F\u52A8kube-apiserver\u7EC4\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u62F7\u8D1D\u6211\u4EEC\u9700\u8981\u7684\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp TLS/k8s/</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">.pem /data/kubernetes/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u542F\u52A8kube-apiserver</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-apiserver </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-apiserver</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kube</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.10:6443      0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      28546/kube-apiserve </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u62F7\u8D1D\u6211\u4EEC\u9700\u8981\u7684\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp TLS/k8s/</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">.pem /data/kubernetes/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u542F\u52A8kube-apiserver</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-apiserver </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-apiserver</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kube</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.10:6443      0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      28546/kube-apiserve </span></span>
<span class="line"></span></code></pre></div><h3 id="_5-4-\u90E8\u7F72kube-controller-manage\u7EC4\u4EF6" tabindex="-1">5.4.\u90E8\u7F72kube-controller-manage\u7EC4\u4EF6 <a class="header-anchor" href="#_5-4-\u90E8\u7F72kube-controller-manage\u7EC4\u4EF6" aria-hidden="true">#</a></h3><h4 id="_5-4-1-\u521B\u5EFAkube-controller-manage\u914D\u7F6E\u6587\u4EF6" tabindex="-1">5.4.1.\u521B\u5EFAkube-controller-manage\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_5-4-1-\u521B\u5EFAkube-controller-manage\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><blockquote><p><strong>\u914D\u7F6E\u6587\u4EF6\u542B\u4E49</strong></p><p>\u2013kubeconfig\uFF1A\u6307\u5B9A\u7528\u4E8E\u8FDE\u63A5apiserver\u7684kubeconfig\u914D\u7F6E\u6587\u4EF6</p><p>\u2013leader-elect\uFF1A\u7528\u4E8E\u9AD8\u53EF\u7528\u96C6\u7FA4\uFF0C\u81EA\u52A8\u9009\u4E3E</p><p>\u2013cluster-signing-cert-file\uFF1A\u6307\u5B9ACA\u8BC1\u4E66\u6587\u4EF6\uFF0C\u4E3Akubelet\u81EA\u52A8\u9881\u53D1\u8BC1\u4E66</p><p>\u2013cluster-signing-key-file\uFF1A\u6307\u5B9ACA\u79C1\u94A5\u6587\u4EF6\uFF0C\u4E3Akubelet\u81EA\u52A8\u9881\u53D1\u8BC1\u4E66</p><p>\u2013cluster-signing-duration\uFF1A\u8BC1\u4E66\u8FC7\u671F\u65F6\u95F4</p></blockquote><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-controller-manager.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">KUBE_CONTROLLER_MANAGER_OPTS=</span><span style="color:#C98A7D;">&quot;--logtostderr=false </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--v=2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--log-dir=/data/kubernetes/logs </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--leader-elect=true </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--bind-address=192.168.20.10 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--allocate-node-cidrs=true </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--cluster-cidr=10.244.0.0/16 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--service-cluster-ip-range=10.0.0.0/24 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--cluster-signing-cert-file=/data/kubernetes/ssl/ca.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--cluster-signing-key-file=/data/kubernetes/ssl/ca-key.pem  </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--root-ca-file=/data/kubernetes/ssl/ca.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--service-account-private-key-file=/data/kubernetes/ssl/ca-key.pem </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--cluster-signing-duration=87600h0m0s&quot;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-controller-manager.conf </span></span>
<span class="line"><span style="color:#393A34;">KUBE_CONTROLLER_MANAGER_OPTS=</span><span style="color:#B56959;">&quot;--logtostderr=false </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--v=2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--log-dir=/data/kubernetes/logs </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--leader-elect=true </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--bind-address=192.168.20.10 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--allocate-node-cidrs=true </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--cluster-cidr=10.244.0.0/16 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--service-cluster-ip-range=10.0.0.0/24 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--cluster-signing-cert-file=/data/kubernetes/ssl/ca.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--cluster-signing-key-file=/data/kubernetes/ssl/ca-key.pem  </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--root-ca-file=/data/kubernetes/ssl/ca.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--service-account-private-key-file=/data/kubernetes/ssl/ca-key.pem </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--cluster-signing-duration=87600h0m0s&quot;</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-4-2-\u751F\u6210kubeconfig\u6587\u4EF6" tabindex="-1">5.4.2.\u751F\u6210kubeconfig\u6587\u4EF6 <a class="header-anchor" href="#_5-4-2-\u751F\u6210kubeconfig\u6587\u4EF6" aria-hidden="true">#</a></h4><p>kube-controller-manage\u5229\u7528kubeconfig\u914D\u7F6E\u6587\u4EF6\u8FDE\u63A5apiserver\u3002</p><p>kubeconfig\u6587\u4EF6\u4E2D\u5305\u62EC\u96C6\u7FA4apiserver\u5730\u5740\u3001\u8BC1\u4E66\u6587\u4EF6\u3001\u7528\u6237\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u7531\u4E8Ekubeconfig\u9700\u8981\u8BC1\u4E66\u6587\u4EF6\u7684\u652F\u6301\uFF0C\u56E0\u6B64\u8981\u751F\u6210\u4E00\u4E2A\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim kube-controller-manager-csr.json </span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;system:kube-controller-manager&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;key&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;algo&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;rsa&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;size&quot;</span><span style="color:#DBD7CA;">: 2048</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;names&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;C&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;L&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;ST&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;O&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;system:masters&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;OU&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> cfssljson -bare kube-controller-manager</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:36:18 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generate received request</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:36:18 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> received CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:36:18 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#DBD7CA;">l2021/09/01 16:36:19 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> encoded CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:36:19 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> signed certificate with serial number 719101376219834763931271155238486242405063666906</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/01 16:36:19 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">WARNING</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> This certificate lacks a </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;"> field. This makes it unsuitable </span><span style="color:#4D9375;">for</span></span>
<span class="line"><span style="color:#DBD7CA;">websites. For more information see the Baseline Requirements </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CA;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#DBD7CA;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">https://cabforum.org</span><span style="color:#858585;">)</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">specifically, section 10.2.3 </span><span style="color:#858585;">(</span><span style="color:#C98A7D;">&quot;Information Requirements&quot;</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp kube-controller-manager</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">pem /data/kubernetes/ssl/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u751F\u6210kubeconfig\u6587\u4EF6</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--server=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F  </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-credentials kube-controller-manager \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-certificate=/data/kubernetes/ssl/kube-controller-manager.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-key=/data/kubernetes/ssl/kube-controller-manager-key.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F  </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--user=kube-controller-manager \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig  </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u7531\u4E8Ekubeconfig\u9700\u8981\u8BC1\u4E66\u6587\u4EF6\u7684\u652F\u6301\uFF0C\u56E0\u6B64\u8981\u751F\u6210\u4E00\u4E2A\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim kube-controller-manager-csr.json </span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;system:kube-controller-manager&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;key&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;algo&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;rsa&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;size&quot;</span><span style="color:#393A34;">: 2048</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;names&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;C&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;L&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;ST&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;O&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;system:masters&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;OU&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> cfssljson -bare kube-controller-manager</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:36:18 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generate received request</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:36:18 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> received CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:36:18 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#393A34;">l2021/09/01 16:36:19 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> encoded CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:36:19 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> signed certificate with serial number 719101376219834763931271155238486242405063666906</span></span>
<span class="line"><span style="color:#393A34;">2021/09/01 16:36:19 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">WARNING</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> This certificate lacks a </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;"> field. This makes it unsuitable </span><span style="color:#1C6B48;">for</span></span>
<span class="line"><span style="color:#393A34;">websites. For more information see the Baseline Requirements </span><span style="color:#1C6B48;">for</span><span style="color:#393A34;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#393A34;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">https://cabforum.org</span><span style="color:#8E8F8B;">)</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">specifically, section 10.2.3 </span><span style="color:#8E8F8B;">(</span><span style="color:#B56959;">&quot;Information Requirements&quot;</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp kube-controller-manager</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">pem /data/kubernetes/ssl/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u751F\u6210kubeconfig\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--server=</span><span style="color:#B56959;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F  </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-credentials kube-controller-manager \\</span></span>
<span class="line"><span style="color:#393A34;">--client-certificate=/data/kubernetes/ssl/kube-controller-manager.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--client-key=/data/kubernetes/ssl/kube-controller-manager-key.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F  </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#393A34;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--user=kube-controller-manager \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig  </span></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/877a98a70b2f47919bcaae2d9d02a4d1.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h4 id="_5-4-3-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1" tabindex="-1">5.4.3.\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1 <a class="header-anchor" href="#_5-4-3-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /usr/lib/systemd/system/kube-controller-manager.service</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Unit</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Description=Kubernetes Controller Manager</span></span>
<span class="line"><span style="color:#DBD7CA;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">EnvironmentFile=/data/kubernetes/config/kube-controller-manager.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecStart=/data/kubernetes/bin/kube-controller-manager </span><span style="color:#858585;">$</span><span style="color:#B8A965;">KUBE_CONTROLLER_MANAGER_OPTS</span></span>
<span class="line"><span style="color:#DBD7CA;">Restart=on-failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Install</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">WantedBy=multi-user.target</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /usr/lib/systemd/system/kube-controller-manager.service</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Unit</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Description=Kubernetes Controller Manager</span></span>
<span class="line"><span style="color:#393A34;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">EnvironmentFile=/data/kubernetes/config/kube-controller-manager.conf</span></span>
<span class="line"><span style="color:#393A34;">ExecStart=/data/kubernetes/bin/kube-controller-manager </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">KUBE_CONTROLLER_MANAGER_OPTS</span></span>
<span class="line"><span style="color:#393A34;">Restart=on-failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Install</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">WantedBy=multi-user.target</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-4-4-\u542F\u52A8kube-controller-manage\u7EC4\u4EF6" tabindex="-1">5.4.4.\u542F\u52A8kube-controller-manage\u7EC4\u4EF6 <a class="header-anchor" href="#_5-4-4-\u542F\u52A8kube-controller-manage\u7EC4\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u542F\u52A8\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-controller-manager</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-controller-manager</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kube</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.10:6443      0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      28546/kube-apiserve </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.10:10257     0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      28941/kube-controll </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10252                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      28941/kube-controll </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u542F\u52A8\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-controller-manager</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-controller-manager</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kube</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.10:6443      0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      28546/kube-apiserve </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.10:10257     0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      28941/kube-controll </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10252                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      28941/kube-controll </span></span>
<span class="line"></span></code></pre></div><h3 id="_5-5-\u90E8\u7F72kube-scheduler\u7EC4\u4EF6" tabindex="-1">5.5.\u90E8\u7F72kube-scheduler\u7EC4\u4EF6 <a class="header-anchor" href="#_5-5-\u90E8\u7F72kube-scheduler\u7EC4\u4EF6" aria-hidden="true">#</a></h3><h4 id="_5-5-1-\u521B\u5EFAkube-scheduler\u914D\u7F6E\u6587\u4EF6" tabindex="-1">5.5.1.\u521B\u5EFAkube-scheduler\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_5-5-1-\u521B\u5EFAkube-scheduler\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><blockquote><p>\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA</p><p>\u2013kubeconfig\uFF1A\u6307\u5B9Akubeconfig\u6587\u4EF6</p><p>\u2013leader-elect\uFF1A\u9009\u4E3E</p></blockquote><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-scheduler.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">KUBE_SCHEDULER_OPTS=</span><span style="color:#C98A7D;">&quot;--logtostderr=false </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--v=2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--log-dir=/data/kubernetes/logs </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--leader-elect </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--bind-address=192.168.20.10&quot;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-scheduler.conf </span></span>
<span class="line"><span style="color:#393A34;">KUBE_SCHEDULER_OPTS=</span><span style="color:#B56959;">&quot;--logtostderr=false </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--v=2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--log-dir=/data/kubernetes/logs </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--leader-elect </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--bind-address=192.168.20.10&quot;</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-5-2-\u751F\u6210kubeconfig\u6587\u4EF6" tabindex="-1">5.5.2.\u751F\u6210kubeconfig\u6587\u4EF6 <a class="header-anchor" href="#_5-5-2-\u751F\u6210kubeconfig\u6587\u4EF6" aria-hidden="true">#</a></h4><p>\u751F\u6210kubeconfig\u8FDE\u63A5\u96C6\u7FA4apiserver\u3002</p><p>kube-schedule\u5229\u7528kubeconfig\u914D\u7F6E\u6587\u4EF6\u8FDE\u63A5apiserver\u3002</p><p>kubeconfig\u6587\u4EF6\u4E2D\u5305\u62EC\u96C6\u7FA4apiserver\u5730\u5740\u3001\u8BC1\u4E66\u6587\u4EF6\u3001\u7528\u6237\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u521B\u5EFA\u8BC1\u4E66\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim kube-scheduler-csr.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;system:kube-scheduler&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;key&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;algo&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;rsa&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;size&quot;</span><span style="color:#DBD7CA;">: 2048</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;names&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;C&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;L&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;ST&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;O&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;system:masters&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;OU&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u751F\u6210\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> cfssljson -bare kube-scheduler</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 14:50:40 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generate received request</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 14:50:40 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> received CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 14:50:40 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 14:50:42 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> encoded CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 14:50:42 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> signed certificate with serial number 91388852050290848663498441480862532526947759393</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 14:50:42 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">WARNING</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> This certificate lacks a </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;"> field. This makes it unsuitable </span><span style="color:#4D9375;">for</span></span>
<span class="line"><span style="color:#DBD7CA;">websites. For more information see the Baseline Requirements </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CA;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#DBD7CA;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">https://cabforum.org</span><span style="color:#858585;">)</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">specifically, section 10.2.3 </span><span style="color:#858585;">(</span><span style="color:#C98A7D;">&quot;Information Requirements&quot;</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u67E5\u770B\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ll</span></span>
<span class="line"><span style="color:#DBD7CA;">\u603B\u7528\u91CF 68</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  294 9\u6708   1 16:20 ca-config.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1001 9\u6708   1 16:20 ca.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  264 9\u6708   1 16:20 ca-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1679 9\u6708   1 16:20 ca-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1359 9\u6708   1 16:20 ca.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1277 9\u6708   1 16:30 kube-apiserver.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  602 9\u6708   1 16:30 kube-apiserver-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1679 9\u6708   1 16:30 kube-apiserver-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1643 9\u6708   1 16:30 kube-apiserver.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1045 9\u6708   1 16:36 kube-controller-manager.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  255 9\u6708   1 16:46 kube-controller-manager-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1675 9\u6708   1 16:36 kube-controller-manager-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1436 9\u6708   1 16:36 kube-controller-manager.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1029 9\u6708   2 14:50 kube-scheduler.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  245 9\u6708   2 14:50 kube-scheduler-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1675 9\u6708   2 14:50 kube-scheduler-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1424 9\u6708   2 14:50 kube-scheduler.pem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u62F7\u8D1D\u8BC1\u4E66\u6587\u4EF6\u81F3\u6307\u5B9A\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp kube-scheduler</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">.pem /data/kubernetes/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.\u751F\u6210kubeconfig\u6587\u4EF6</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--server=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-credentials kube-scheduler \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-certificate=/data/kubernetes/ssl/kube-scheduler.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-key=/data/kubernetes/ssl/kube-scheduler-key.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--user=kube-scheduler \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">6.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u521B\u5EFA\u8BC1\u4E66\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim kube-scheduler-csr.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;system:kube-scheduler&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;key&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;algo&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;rsa&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;size&quot;</span><span style="color:#393A34;">: 2048</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;names&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;C&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;L&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;ST&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;O&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;system:masters&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;OU&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u751F\u6210\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> cfssljson -bare kube-scheduler</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 14:50:40 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generate received request</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 14:50:40 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> received CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 14:50:40 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 14:50:42 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> encoded CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 14:50:42 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> signed certificate with serial number 91388852050290848663498441480862532526947759393</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 14:50:42 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">WARNING</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> This certificate lacks a </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;"> field. This makes it unsuitable </span><span style="color:#1C6B48;">for</span></span>
<span class="line"><span style="color:#393A34;">websites. For more information see the Baseline Requirements </span><span style="color:#1C6B48;">for</span><span style="color:#393A34;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#393A34;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">https://cabforum.org</span><span style="color:#8E8F8B;">)</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">specifically, section 10.2.3 </span><span style="color:#8E8F8B;">(</span><span style="color:#B56959;">&quot;Information Requirements&quot;</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u67E5\u770B\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ll</span></span>
<span class="line"><span style="color:#393A34;">\u603B\u7528\u91CF 68</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  294 9\u6708   1 16:20 ca-config.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1001 9\u6708   1 16:20 ca.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  264 9\u6708   1 16:20 ca-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1679 9\u6708   1 16:20 ca-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1359 9\u6708   1 16:20 ca.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1277 9\u6708   1 16:30 kube-apiserver.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  602 9\u6708   1 16:30 kube-apiserver-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1679 9\u6708   1 16:30 kube-apiserver-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1643 9\u6708   1 16:30 kube-apiserver.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1045 9\u6708   1 16:36 kube-controller-manager.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  255 9\u6708   1 16:46 kube-controller-manager-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1675 9\u6708   1 16:36 kube-controller-manager-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1436 9\u6708   1 16:36 kube-controller-manager.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1029 9\u6708   2 14:50 kube-scheduler.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  245 9\u6708   2 14:50 kube-scheduler-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1675 9\u6708   2 14:50 kube-scheduler-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1424 9\u6708   2 14:50 kube-scheduler.pem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u62F7\u8D1D\u8BC1\u4E66\u6587\u4EF6\u81F3\u6307\u5B9A\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp kube-scheduler</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">.pem /data/kubernetes/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.\u751F\u6210kubeconfig\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--server=</span><span style="color:#B56959;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-credentials kube-scheduler \\</span></span>
<span class="line"><span style="color:#393A34;">--client-certificate=/data/kubernetes/ssl/kube-scheduler.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--client-key=/data/kubernetes/ssl/kube-scheduler-key.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#393A34;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--user=kube-scheduler \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">6.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-5-3-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1" tabindex="-1">5.5.3.\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1 <a class="header-anchor" href="#_5-5-3-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /usr/lib/systemd/system/kube-scheduler.service</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Unit</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Description=Kubernetes Scheduler</span></span>
<span class="line"><span style="color:#DBD7CA;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">EnvironmentFile=/data/kubernetes/config/kube-scheduler.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecStart=/data/kubernetes/bin/kube-scheduler </span><span style="color:#858585;">$</span><span style="color:#B8A965;">KUBE_SCHEDULER_OPTS</span></span>
<span class="line"><span style="color:#DBD7CA;">Restart=on-failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Install</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">WantedBy=multi-user.target</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /usr/lib/systemd/system/kube-scheduler.service</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Unit</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Description=Kubernetes Scheduler</span></span>
<span class="line"><span style="color:#393A34;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">EnvironmentFile=/data/kubernetes/config/kube-scheduler.conf</span></span>
<span class="line"><span style="color:#393A34;">ExecStart=/data/kubernetes/bin/kube-scheduler </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">KUBE_SCHEDULER_OPTS</span></span>
<span class="line"><span style="color:#393A34;">Restart=on-failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Install</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">WantedBy=multi-user.target</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-5-4-\u542F\u52A8kube-scheduler\u7EC4\u4EF6" tabindex="-1">5.5.4.\u542F\u52A8kube-scheduler\u7EC4\u4EF6 <a class="header-anchor" href="#_5-5-4-\u542F\u52A8kube-scheduler\u7EC4\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u542F\u52A8\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-scheduler</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-scheduler</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kube</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.10:6443      0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      28546/kube-apiserve </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.10:10257     0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      28941/kube-controll </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.10:10259     0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      6127/kube-scheduler </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10251                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      6127/kube-scheduler </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10252                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      28941/kube-controll </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u542F\u52A8\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-scheduler</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-scheduler</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kube</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.10:6443      0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      28546/kube-apiserve </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.10:10257     0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      28941/kube-controll </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.10:10259     0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      6127/kube-scheduler </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10251                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      6127/kube-scheduler </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10252                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      28941/kube-controll </span></span>
<span class="line"></span></code></pre></div><h3 id="_5-6-\u51C6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4EF6\u8FDE\u63A5\u96C6\u7FA4" tabindex="-1">5.6.\u51C6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4EF6\u8FDE\u63A5\u96C6\u7FA4 <a class="header-anchor" href="#_5-6-\u51C6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4EF6\u8FDE\u63A5\u96C6\u7FA4" aria-hidden="true">#</a></h3><p>kubectl\u60F3\u8981\u8FDE\u63A5\u96C6\u7FA4\u5BF9\u5404\u79CD\u8D44\u6E90\u8FDB\u884C\u64CD\u4F5C\uFF0C\u9700\u8981\u6709\u4E00\u4E2Akubeconfig\u6587\u4EF6\u8FDE\u63A5apiserver\u624D\u53EF\u4EE5\u5BF9\u96C6\u7FA4\u8FDB\u884C\u64CD\u4F5C\uFF0C\u4E5F\u5C31\u662Fkubeadm\u5B89\u88C5k8s\u96C6\u7FA4\u540E\u5728master\u8282\u70B9\u751F\u6210\u7684/root/.kube\u76EE\u5F55\uFF0C\u8FD9\u4E2A\u76EE\u5F55\u4E2D\u7684config\u6587\u4EF6\u5C31\u662Fkubectl\u7528\u4E8E\u8FDE\u63A5apiserver\u7684kubeconfig\u6587\u4EF6\u3002</p><h4 id="_5-6-1-\u751F\u6210\u8BC1\u4E66\u6587\u4EF6" tabindex="-1">5.6.1.\u751F\u6210\u8BC1\u4E66\u6587\u4EF6 <a class="header-anchor" href="#_5-6-1-\u751F\u6210\u8BC1\u4E66\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u521B\u5EFA\u8BC1\u4E66\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim kubectl-csr.json </span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;kubectl&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;key&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;algo&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;rsa&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;size&quot;</span><span style="color:#DBD7CA;">: 2048</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;names&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;C&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;L&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;ST&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;O&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;system:masters&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;OU&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u751F\u6210\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubectl-csr.json </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> cfssljson -bare kubectl</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 17:20:44 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generate received request</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 17:20:44 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> received CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 17:20:44 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 17:20:45 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> encoded CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 17:20:45 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> signed certificate with serial number 398472525484598388169457456772550114435870340604</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/02 17:20:45 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">WARNING</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> This certificate lacks a </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;"> field. This makes it unsuitable </span><span style="color:#4D9375;">for</span></span>
<span class="line"><span style="color:#DBD7CA;">websites. For more information see the Baseline Requirements </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CA;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#DBD7CA;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">https://cabforum.org</span><span style="color:#858585;">)</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">specifically, section 10.2.3 </span><span style="color:#858585;">(</span><span style="color:#C98A7D;">&quot;Information Requirements&quot;</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u67E5\u770B\u751F\u6210\u7684\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ll</span></span>
<span class="line"><span style="color:#DBD7CA;">\u603B\u7528\u91CF 84</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  294 9\u6708   1 16:20 ca-config.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1001 9\u6708   1 16:20 ca.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  264 9\u6708   1 16:20 ca-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1679 9\u6708   1 16:20 ca-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1359 9\u6708   1 16:20 ca.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1277 9\u6708   1 16:30 kube-apiserver.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  602 9\u6708   1 16:30 kube-apiserver-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1679 9\u6708   1 16:30 kube-apiserver-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1643 9\u6708   1 16:30 kube-apiserver.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1045 9\u6708   1 16:36 kube-controller-manager.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  255 9\u6708   1 16:46 kube-controller-manager-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1675 9\u6708   1 16:36 kube-controller-manager-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1436 9\u6708   1 16:36 kube-controller-manager.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1013 9\u6708   2 17:20 kubectl.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  231 9\u6708   2 17:20 kubectl-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1679 9\u6708   2 17:20 kubectl-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1403 9\u6708   2 17:20 kubectl.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1029 9\u6708   2 14:50 kube-scheduler.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  245 9\u6708   2 14:50 kube-scheduler-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1675 9\u6708   2 14:50 kube-scheduler-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1424 9\u6708   2 14:50 kube-scheduler.pem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u62F7\u8D1D\u8BC1\u4E66\u6587\u4EF6\u5230\u6307\u5B9A\u76EE\u5F55</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> </span><span style="color:#D4976C;">\\c</span><span style="color:#DBD7CA;">p kubectl</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">.pem /data/kubernetes/ssl/</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u521B\u5EFA\u8BC1\u4E66\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim kubectl-csr.json </span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;kubectl&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;key&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;algo&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;rsa&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;size&quot;</span><span style="color:#393A34;">: 2048</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;names&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;C&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;L&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;ST&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;O&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;system:masters&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;OU&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u751F\u6210\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubectl-csr.json </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> cfssljson -bare kubectl</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 17:20:44 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generate received request</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 17:20:44 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> received CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 17:20:44 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 17:20:45 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> encoded CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 17:20:45 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> signed certificate with serial number 398472525484598388169457456772550114435870340604</span></span>
<span class="line"><span style="color:#393A34;">2021/09/02 17:20:45 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">WARNING</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> This certificate lacks a </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;"> field. This makes it unsuitable </span><span style="color:#1C6B48;">for</span></span>
<span class="line"><span style="color:#393A34;">websites. For more information see the Baseline Requirements </span><span style="color:#1C6B48;">for</span><span style="color:#393A34;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#393A34;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">https://cabforum.org</span><span style="color:#8E8F8B;">)</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">specifically, section 10.2.3 </span><span style="color:#8E8F8B;">(</span><span style="color:#B56959;">&quot;Information Requirements&quot;</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u67E5\u770B\u751F\u6210\u7684\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ll</span></span>
<span class="line"><span style="color:#393A34;">\u603B\u7528\u91CF 84</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  294 9\u6708   1 16:20 ca-config.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1001 9\u6708   1 16:20 ca.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  264 9\u6708   1 16:20 ca-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1679 9\u6708   1 16:20 ca-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1359 9\u6708   1 16:20 ca.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1277 9\u6708   1 16:30 kube-apiserver.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  602 9\u6708   1 16:30 kube-apiserver-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1679 9\u6708   1 16:30 kube-apiserver-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1643 9\u6708   1 16:30 kube-apiserver.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1045 9\u6708   1 16:36 kube-controller-manager.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  255 9\u6708   1 16:46 kube-controller-manager-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1675 9\u6708   1 16:36 kube-controller-manager-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1436 9\u6708   1 16:36 kube-controller-manager.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1013 9\u6708   2 17:20 kubectl.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  231 9\u6708   2 17:20 kubectl-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1679 9\u6708   2 17:20 kubectl-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1403 9\u6708   2 17:20 kubectl.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1029 9\u6708   2 14:50 kube-scheduler.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  245 9\u6708   2 14:50 kube-scheduler-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1675 9\u6708   2 14:50 kube-scheduler-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1424 9\u6708   2 14:50 kube-scheduler.pem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u62F7\u8D1D\u8BC1\u4E66\u6587\u4EF6\u5230\u6307\u5B9A\u76EE\u5F55</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">\\c</span><span style="color:#393A34;">p kubectl</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">.pem /data/kubernetes/ssl/</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-6-2-\u751F\u6210kubeconfig\u6587\u4EF6" tabindex="-1">5.6.2.\u751F\u6210kubeconfig\u6587\u4EF6 <a class="header-anchor" href="#_5-6-2-\u751F\u6210kubeconfig\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--server=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/root/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-credentials cluster-admin \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-certificate=/data/kubernetes/ssl/kubectl.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-key=/data/kubernetes/ssl/kubectl-key.pem  \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/root/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--user=cluster-admin \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/root/.kube/config</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">4.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config use-context default --kubeconfig=/root/.kube/config</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--server=</span><span style="color:#B56959;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/root/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-credentials cluster-admin \\</span></span>
<span class="line"><span style="color:#393A34;">--client-certificate=/data/kubernetes/ssl/kubectl.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--client-key=/data/kubernetes/ssl/kubectl-key.pem  \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/root/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#393A34;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--user=cluster-admin \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/root/.kube/config</span></span>
<span class="line"><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">4.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config use-context default --kubeconfig=/root/.kube/config</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-6-3-\u4F7F\u7528kubectl\u67E5\u770B\u96C6\u7FA4\u8FDE\u63A5\u4FE1\u606F" tabindex="-1">5.6.3.\u4F7F\u7528kubectl\u67E5\u770B\u96C6\u7FA4\u8FDE\u63A5\u4FE1\u606F <a class="header-anchor" href="#_5-6-3-\u4F7F\u7528kubectl\u67E5\u770B\u96C6\u7FA4\u8FDE\u63A5\u4FE1\u606F" aria-hidden="true">#</a></h4><p>\u81F3\u6B64master\u8282\u70B9\u76F8\u5173\u7EC4\u4EF6\u90E8\u7F72\u5B8C\u6210\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get node</span></span>
<span class="line"><span style="color:#DBD7CA;">No resources found</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get cs</span></span>
<span class="line"><span style="color:#DBD7CA;">Warning: v1 ComponentStatus is deprecated </span><span style="color:#4D9375;">in</span><span style="color:#DBD7CA;"> v1.19+</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 STATUS    MESSAGE             ERROR</span></span>
<span class="line"><span style="color:#DBD7CA;">scheduler            Healthy   ok                  </span></span>
<span class="line"><span style="color:#DBD7CA;">controller-manager   Healthy   ok                  </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-1               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-0               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-2               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}  </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get node</span></span>
<span class="line"><span style="color:#393A34;">No resources found</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get cs</span></span>
<span class="line"><span style="color:#393A34;">Warning: v1 ComponentStatus is deprecated </span><span style="color:#1C6B48;">in</span><span style="color:#393A34;"> v1.19+</span></span>
<span class="line"><span style="color:#393A34;">NAME                 STATUS    MESSAGE             ERROR</span></span>
<span class="line"><span style="color:#393A34;">scheduler            Healthy   ok                  </span></span>
<span class="line"><span style="color:#393A34;">controller-manager   Healthy   ok                  </span></span>
<span class="line"><span style="color:#393A34;">etcd-1               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"><span style="color:#393A34;">etcd-0               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"><span style="color:#393A34;">etcd-2               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}  </span></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/8ea5953c67f6460facc684905acb502c.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h2 id="_6-\u5728master\u8282\u70B9\u90E8\u7F72node\u8282\u70B9\u76F8\u5173\u7EC4\u4EF6" tabindex="-1">6.\u5728master\u8282\u70B9\u90E8\u7F72node\u8282\u70B9\u76F8\u5173\u7EC4\u4EF6 <a class="header-anchor" href="#_6-\u5728master\u8282\u70B9\u90E8\u7F72node\u8282\u70B9\u76F8\u5173\u7EC4\u4EF6" aria-hidden="true">#</a></h2><h3 id="_6-1-\u5728\u96C6\u7FA4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8BB8\u8BF7\u6C42\u8BC1\u4E66" tabindex="-1">6.1.\u5728\u96C6\u7FA4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8BB8\u8BF7\u6C42\u8BC1\u4E66 <a class="header-anchor" href="#_6-1-\u5728\u96C6\u7FA4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8BB8\u8BF7\u6C42\u8BC1\u4E66" aria-hidden="true">#</a></h3><p>\u5728\u6B64\u5904\u505A\u4E86\u8FD9\u4E00\u6B65\u4E4B\u540E\uFF0Cnode\u8282\u70B9\u52A0\u5165\u96C6\u7FA4\u65F6\u5C31\u4E0D\u9700\u8981\u505A\u4E86\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create clusterrolebinding kubelet-bootstrap \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--clusterrole=system:node-bootstrapper \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--user=kubelet-bootstrap</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create clusterrolebinding kubelet-bootstrap \\</span></span>
<span class="line"><span style="color:#393A34;">--clusterrole=system:node-bootstrapper \\</span></span>
<span class="line"><span style="color:#393A34;">--user=kubelet-bootstrap</span></span>
<span class="line"></span></code></pre></div><h3 id="_6-2-\u5728master\u8282\u70B9\u90E8\u7F72kubelet\u7EC4\u4EF6" tabindex="-1">6.2.\u5728master\u8282\u70B9\u90E8\u7F72kubelet\u7EC4\u4EF6 <a class="header-anchor" href="#_6-2-\u5728master\u8282\u70B9\u90E8\u7F72kubelet\u7EC4\u4EF6" aria-hidden="true">#</a></h3><p>\u7531\u4E8Emaster\u4E5F\u9700\u8981\u542F\u52A8\u67D0\u4E9Bpod\uFF0C\u6BD4\u5982calico\u7EC4\u4EF6\u90FD\u662F\u4EE5pod\u65B9\u5F0F\u8FD0\u884C\u7684\uFF0C\u56E0\u6B64\u5728master\u8282\u70B9\u4E5F\u9700\u8981kubelet\u548Ckube-proxy\u7EC4\u4EF6\u3002</p><h4 id="_6-2-1-\u5C06kubelet\u548Ckube-proxy\u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\u62F7\u8D1D\u81F3\u5BF9\u5E94\u76EE\u5F55" tabindex="-1">6.2.1.\u5C06kubelet\u548Ckube-proxy\u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\u62F7\u8D1D\u81F3\u5BF9\u5E94\u76EE\u5F55 <a class="header-anchor" href="#_6-2-1-\u5C06kubelet\u548Ckube-proxy\u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\u62F7\u8D1D\u81F3\u5BF9\u5E94\u76EE\u5F55" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp kubernetes/server/bin/{kubelet,kube-proxy} /data/kubernetes/bin/</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp kubernetes/server/bin/{kubelet,kube-proxy} /data/kubernetes/bin/</span></span>
<span class="line"></span></code></pre></div><h4 id="_6-2-2-\u521B\u5EFAkubelet\u914D\u7F6E\u6587\u4EF6" tabindex="-1">6.2.2.\u521B\u5EFAkubelet\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_6-2-2-\u521B\u5EFAkubelet\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><blockquote><p>\u914D\u7F6E\u6587\u4EF6\u542B\u4E49\uFF1A</p><p>\u2013hostname-override\uFF1A\u8282\u70B9\u540D\u79F0\uFF0C\u96C6\u7FA4\u4E2D\u552F\u4E00</p><p>\u2013network-plugin\uFF1A\u542F\u7528CNI\u7F51\u7EDC</p><p>\u2013kubeconfig\uFF1A\u6307\u5B9A\u81EA\u52A8\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u8DEF\u5F84\uFF0C\u7528\u4E8E\u8FDE\u63A5apiserver</p><p>\u2013bootstrap-kubeconfig\uFF1A\u6307\u5B9A\u9996\u6B21\u542F\u52A8\u5411apiserver\u7533\u8BF7\u8BC1\u4E66\u7684kubeconfig\u6587\u4EF6\u8DEF\u5F84</p><p>\u2013config\uFF1A\u914D\u7F6E\u53C2\u6570\u6587\u4EF6\u8DEF\u5F84</p><p>\u2013cert-dir\uFF1Akubelet\u8BC1\u4E66\u751F\u6210\u76EE\u5F55\u8DEF\u5F84</p><p>\u2013pod-infra-container-image\uFF1Apod\u5BB9\u5668\u7684\u6839\u5BB9\u5668</p></blockquote><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kubelet.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">KUBELET_OPTS=</span><span style="color:#C98A7D;">&quot;--logtostderr=false </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--v=2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--log-dir=/data/kubernetes/logs </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--hostname-override=binary-k8s-master1 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--network-plugin=cni </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--config=/data/kubernetes/config/kubelet-config.yml </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--cert-dir=/data/kubernetes/ssl </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--pod-infra-container-image=pause-amd64:3.0&quot;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kubelet.conf</span></span>
<span class="line"><span style="color:#393A34;">KUBELET_OPTS=</span><span style="color:#B56959;">&quot;--logtostderr=false </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--v=2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--log-dir=/data/kubernetes/logs </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--hostname-override=binary-k8s-master1 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--network-plugin=cni </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--config=/data/kubernetes/config/kubelet-config.yml </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--cert-dir=/data/kubernetes/ssl </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--pod-infra-container-image=pause-amd64:3.0&quot;</span></span>
<span class="line"></span></code></pre></div><h4 id="_6-2-3-\u521B\u5EFAkubelet-config-yaml\u53C2\u6570\u914D\u7F6E\u6587\u4EF6" tabindex="-1">6.2.3.\u521B\u5EFAkubelet-config.yaml\u53C2\u6570\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_6-2-3-\u521B\u5EFAkubelet-config-yaml\u53C2\u6570\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><p>kubelet\u548Ckube-proxy\u670D\u52A1\u7684\u53C2\u6570\u914D\u7F6E\u662F\u4EE5yaml\u5F62\u5F0F\u6765\u914D\u7F6E\u7684</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kubelet-config.yml</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: KubeletConfiguration</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#DBD7CA;">address: 0.0.0.0				</span><span style="color:#758575;">#\u76D1\u542C\u5730\u5740</span></span>
<span class="line"><span style="color:#DBD7CA;">port: 10250						</span><span style="color:#758575;">#\u76D1\u542C\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#DBD7CA;">readOnlyPort: 10255</span></span>
<span class="line"><span style="color:#DBD7CA;">cgroupDriver: cgroupfs			</span><span style="color:#758575;">#\u9A71\u52A8\u5F15\u64CE</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterDNS:</span></span>
<span class="line"><span style="color:#DBD7CA;">- 10.0.0.2</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterDomain: cluster.local</span></span>
<span class="line"><span style="color:#DBD7CA;">failSwapOn: </span><span style="color:#E0A569;">false</span></span>
<span class="line"><span style="color:#DBD7CA;">authentication:</span></span>
<span class="line"><span style="color:#DBD7CA;">  anonymous:</span></span>
<span class="line"><span style="color:#DBD7CA;">    enabled: </span><span style="color:#E0A569;">false</span></span>
<span class="line"><span style="color:#DBD7CA;">  webhook:</span></span>
<span class="line"><span style="color:#DBD7CA;">    cacheTTL: 2m0s</span></span>
<span class="line"><span style="color:#DBD7CA;">    enabled: </span><span style="color:#E0A569;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">  x509:</span></span>
<span class="line"><span style="color:#DBD7CA;">    clientCAFile: /data/kubernetes/ssl/ca.pem		</span><span style="color:#758575;">#ca\u8BC1\u4E66\u6587\u4EF6\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#DBD7CA;">authorization:</span></span>
<span class="line"><span style="color:#DBD7CA;">  mode: Webhook</span></span>
<span class="line"><span style="color:#DBD7CA;">  webhook:</span></span>
<span class="line"><span style="color:#DBD7CA;">    cacheAuthorizedTTL: 5m0s</span></span>
<span class="line"><span style="color:#DBD7CA;">    cacheUnauthorizedTTL: 30s</span></span>
<span class="line"><span style="color:#DBD7CA;">evictionHard:</span></span>
<span class="line"><span style="color:#DBD7CA;">  imagefs.available: 15%</span></span>
<span class="line"><span style="color:#DBD7CA;">  memory.available: 100Mi</span></span>
<span class="line"><span style="color:#DBD7CA;">  nodefs.available: 10%</span></span>
<span class="line"><span style="color:#DBD7CA;">  nodefs.inodesFree: 5%</span></span>
<span class="line"><span style="color:#DBD7CA;">maxOpenFiles: 1000000</span></span>
<span class="line"><span style="color:#DBD7CA;">maxPods: 110				</span><span style="color:#758575;">#\u53EF\u8FD0\u884C\u7684pod\u7684\u6570\u91CF</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kubelet-config.yml</span></span>
<span class="line"><span style="color:#393A34;">kind: KubeletConfiguration</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#393A34;">address: 0.0.0.0				</span><span style="color:#A0ADA0;">#\u76D1\u542C\u5730\u5740</span></span>
<span class="line"><span style="color:#393A34;">port: 10250						</span><span style="color:#A0ADA0;">#\u76D1\u542C\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#393A34;">readOnlyPort: 10255</span></span>
<span class="line"><span style="color:#393A34;">cgroupDriver: cgroupfs			</span><span style="color:#A0ADA0;">#\u9A71\u52A8\u5F15\u64CE</span></span>
<span class="line"><span style="color:#393A34;">clusterDNS:</span></span>
<span class="line"><span style="color:#393A34;">- 10.0.0.2</span></span>
<span class="line"><span style="color:#393A34;">clusterDomain: cluster.local</span></span>
<span class="line"><span style="color:#393A34;">failSwapOn: </span><span style="color:#B58451;">false</span></span>
<span class="line"><span style="color:#393A34;">authentication:</span></span>
<span class="line"><span style="color:#393A34;">  anonymous:</span></span>
<span class="line"><span style="color:#393A34;">    enabled: </span><span style="color:#B58451;">false</span></span>
<span class="line"><span style="color:#393A34;">  webhook:</span></span>
<span class="line"><span style="color:#393A34;">    cacheTTL: 2m0s</span></span>
<span class="line"><span style="color:#393A34;">    enabled: </span><span style="color:#B58451;">true</span></span>
<span class="line"><span style="color:#393A34;">  x509:</span></span>
<span class="line"><span style="color:#393A34;">    clientCAFile: /data/kubernetes/ssl/ca.pem		</span><span style="color:#A0ADA0;">#ca\u8BC1\u4E66\u6587\u4EF6\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#393A34;">authorization:</span></span>
<span class="line"><span style="color:#393A34;">  mode: Webhook</span></span>
<span class="line"><span style="color:#393A34;">  webhook:</span></span>
<span class="line"><span style="color:#393A34;">    cacheAuthorizedTTL: 5m0s</span></span>
<span class="line"><span style="color:#393A34;">    cacheUnauthorizedTTL: 30s</span></span>
<span class="line"><span style="color:#393A34;">evictionHard:</span></span>
<span class="line"><span style="color:#393A34;">  imagefs.available: 15%</span></span>
<span class="line"><span style="color:#393A34;">  memory.available: 100Mi</span></span>
<span class="line"><span style="color:#393A34;">  nodefs.available: 10%</span></span>
<span class="line"><span style="color:#393A34;">  nodefs.inodesFree: 5%</span></span>
<span class="line"><span style="color:#393A34;">maxOpenFiles: 1000000</span></span>
<span class="line"><span style="color:#393A34;">maxPods: 110				</span><span style="color:#A0ADA0;">#\u53EF\u8FD0\u884C\u7684pod\u7684\u6570\u91CF</span></span>
<span class="line"></span></code></pre></div><h4 id="_6-2-4-\u521B\u5EFAbootstrap-kubeconfig\u6587\u4EF6" tabindex="-1">6.2.4.\u521B\u5EFAbootstrap-kubeconfig\u6587\u4EF6 <a class="header-anchor" href="#_6-2-4-\u521B\u5EFAbootstrap-kubeconfig\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--server=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0token\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-credentials </span><span style="color:#C98A7D;">&quot;kubelet-bootstrap&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--token=d7f96b0d86c574d0f64a713608db0922 \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u8FD9\u4E2Atoken\u5C31\u662F\u4E4B\u524D\u751F\u6210\u7684/data/kubernetes/config/token.csv\u4E2D\u7684token</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">3.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--user=</span><span style="color:#C98A7D;">&quot;kubelet-bootstrap&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--server=</span><span style="color:#B56959;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">2.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0token\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-credentials </span><span style="color:#B56959;">&quot;kubelet-bootstrap&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--token=d7f96b0d86c574d0f64a713608db0922 \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u8FD9\u4E2Atoken\u5C31\u662F\u4E4B\u524D\u751F\u6210\u7684/data/kubernetes/config/token.csv\u4E2D\u7684token</span></span>
<span class="line"><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">3.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#393A34;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--user=</span><span style="color:#B56959;">&quot;kubelet-bootstrap&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"></span></code></pre></div><h4 id="_6-2-5-\u521B\u5EFAsystemctl\u811A\u672C\u5E76\u542F\u52A8\u670D\u52A1" tabindex="-1">6.2.5.\u521B\u5EFAsystemctl\u811A\u672C\u5E76\u542F\u52A8\u670D\u52A1 <a class="header-anchor" href="#_6-2-5-\u521B\u5EFAsystemctl\u811A\u672C\u5E76\u542F\u52A8\u670D\u52A1" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u521B\u5EFAsystemctl\u811A\u672C</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /usr/lib/systemd/system/kubelet.service</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Unit</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Description=Kubernetes Kubelet</span></span>
<span class="line"><span style="color:#DBD7CA;">After=docker.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">EnvironmentFile=/data/kubernetes/config/kubelet.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecStart=/data/kubernetes/bin/kubelet </span><span style="color:#858585;">$</span><span style="color:#B8A965;">KUBELET_OPTS</span></span>
<span class="line"><span style="color:#DBD7CA;">Restart=on-failure</span></span>
<span class="line"><span style="color:#DBD7CA;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Install</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u542F\u52A8kubelet\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kubelet</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kubelet</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u521B\u5EFAsystemctl\u811A\u672C</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /usr/lib/systemd/system/kubelet.service</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Unit</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Description=Kubernetes Kubelet</span></span>
<span class="line"><span style="color:#393A34;">After=docker.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">EnvironmentFile=/data/kubernetes/config/kubelet.conf</span></span>
<span class="line"><span style="color:#393A34;">ExecStart=/data/kubernetes/bin/kubelet </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">KUBELET_OPTS</span></span>
<span class="line"><span style="color:#393A34;">Restart=on-failure</span></span>
<span class="line"><span style="color:#393A34;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Install</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u542F\u52A8kubelet\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kubelet</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kubelet</span></span>
<span class="line"></span></code></pre></div><h4 id="_6-2-6-\u5C06master\u8282\u70B9\u4F5C\u4E3Anode\u52A0\u5165\u96C6\u7FA4\u5185\u90E8" tabindex="-1">6.2.6.\u5C06master\u8282\u70B9\u4F5C\u4E3Anode\u52A0\u5165\u96C6\u7FA4\u5185\u90E8 <a class="header-anchor" href="#_6-2-6-\u5C06master\u8282\u70B9\u4F5C\u4E3Anode\u52A0\u5165\u96C6\u7FA4\u5185\u90E8" aria-hidden="true">#</a></h4><p>\u5F53kubelet\u7EC4\u4EF6\u542F\u52A8\u6210\u529F\u540E\uFF0C\u5C31\u4F1A\u60F3apiserver\u53D1\u9001\u4E00\u4E2A\u8BF7\u6C42\u52A0\u5165\u96C6\u7FA4\u7684\u4FE1\u606F\uFF0C\u53EA\u6709\u5F53master\u8282\u70B9\u6388\u6743\u540C\u610F\u540E\uFF0C\u624D\u53EF\u4EE5\u6B63\u5E38\u52A0\u5165\uFF0C\u867D\u7136\u662Fmaster\u8282\u70B9\u90E8\u7F72\u7684node\u7EC4\u4EF6\uFF0C\u4F46\u662F\u4E5F\u4F1A\u53D1\u751F\u4E00\u4E2A\u52A0\u5165\u96C6\u7FA4\u7684\u4FE1\u606F\uFF0C\u9700\u8981master\u540C\u610F\u3002</p><p>\u5F53kubelet\u542F\u52A8\u4E4B\u540E\uFF0C\u9996\u5148\u4F1A\u5728\u8BC1\u4E66\u76EE\u5F55\u751F\u6210\u4E00\u4E2Akubelet-client.key.tmp\u8FD9\u4E2A\u6587\u4EF6\uFF0C\u5F53\u4F7F\u7528kubectl certificate approve\u547D\u4EE4\u6388\u6743\u6210\u529Fnode\u7684\u8BF7\u6C42\u4E4B\u540E\uFF0Ckubelet-client.key.tmp\u5C0F\u65F6\uFF0C\u968F\u4E4B\u4F1A\u751F\u6210\u4E00\u4E2Akubelet-client-current.pem\u7684\u8BC1\u4E66\u6587\u4EF6\uFF0C\u7528\u4E8E\u4E0Eapiserver\u5EFA\u7ACB\u8FDE\u63A5\uFF0C\u6B64\u65F6\u518D\u4F7F\u7528kubectl get node\u5C31\u4F1A\u770B\u5230\u8282\u70B9\u4FE1\u606F\u4E86\u3002</p><p>\u6269\u5C55\uFF1A\u5982\u679C\u540E\u671F\u60F3\u8981\u4FEE\u6539node\u7684\u540D\u79F0\uFF0C\u90A3\u4E48\u5C31\u628A\u751F\u6210\u7684kubelet\u8BC1\u4E66\u6587\u4EF6\u5168\u90E8\u5220\u9664\uFF0C\u7136\u540E\u4F7F\u7528kubectl delete node\u5220\u9664\u8BE5\u8282\u70B9\uFF0C\u5728\u4FEE\u6539kubelet\u914D\u7F6E\u6587\u4EF6\u4E2D\u8BE5\u8282\u70B9\u7684\u540D\u79F0\uFF0C\u7136\u540E\u4F7F\u7528kubectl delete csr\u5220\u9664\u6388\u6743\u4FE1\u606F\uFF0C\u518D\u91CD\u542Fkubelet\u751F\u6210\u65B0\u7684\u6388\u6743\u4FE1\u606F\uFF0C\u7136\u540E\u6388\u6743\u901A\u8FC7\u5373\u53EF\u770B\u5230\u65B0\u7684\u540D\u5B57\u7684node\u8282\u70B9\u3002</p><p>\u53EA\u6709\u5F53\u6388\u6743\u901A\u8FC7\u540E\uFF0Ckubelet\u751F\u6210\u4E86\u8BC1\u4E66\u6587\u4EF6\uFF0Ckubelet\u7684\u7AEF\u53E3\u624D\u4F1A\u88AB\u542F\u52A8</p><p>\u6CE8\u610F\uFF1A\u5F53kubelet\u7684\u6388\u6743\u88ABmaster\u8BF7\u6C42\u901A\u540E\uFF0Ckube-proxy\u542F\u52A8\u6210\u529F\u540E\uFF0C\u8282\u70B9\u624D\u4F1A\u6B63\u771F\u7684\u52A0\u5165\u96C6\u7FA4\uFF0C\u5373\u4F7Fkubectl get node\u770B\u5230\u7684\u8282\u70B9\u662FReady\uFF0C\u8BE5\u8282\u70B9\u4E5F\u662F\u4E0D\u53EF\u7528\u7684\uFF0C\u5FC5\u987B\u5F53kube-proxy\u542F\u52A8\u5B8C\u6BD5\u540E\uFF0C\u8FD9\u4E2A\u8282\u70B9\u624D\u7B97\u6B63\u771F\u7684\u542F\u52A8\u5B8C\u6BD5&lt;</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u76F4\u63A5\u5728master\u8282\u70B9\u4E0A\u6267\u884C\u5982\u4E0B\u547D\u4EE4\u83B7\u53D6\u8BF7\u6C42\u5217\u8868</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get csr</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span></span>
<span class="line"><span style="color:#DBD7CA;">node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4   4s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u6388\u6743\u540C\u610F\u6B64\u8282\u70B9\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl certificate approve node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4</span></span>
<span class="line"><span style="color:#DBD7CA;">certificatesigningrequest.certificates.k8s.io/node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4 approved</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u67E5\u770Bnode\u8282\u70B9</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get node</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 STATUS     ROLES    AGE   VERSION</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-master1   NotReady   </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   6s    v1.20.4</span></span>
<span class="line"><span style="color:#758575;">#\u6B64\u65F6master\u8282\u70B9\u5DF2\u7ECF\u51FA\u73B0\u5728\u96C6\u7FA4\u8282\u70B9\u5217\u8868\u4E2D\u4E86</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u67E5\u770Bkubelet\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kubelet</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 127.0.0.1:10248         0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      29092/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 127.0.0.1:41132         0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      29092/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10250                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      29092/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10255                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      29092/kubelet </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u76F4\u63A5\u5728master\u8282\u70B9\u4E0A\u6267\u884C\u5982\u4E0B\u547D\u4EE4\u83B7\u53D6\u8BF7\u6C42\u5217\u8868</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get csr</span></span>
<span class="line"><span style="color:#393A34;">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span></span>
<span class="line"><span style="color:#393A34;">node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4   4s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u6388\u6743\u540C\u610F\u6B64\u8282\u70B9\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl certificate approve node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4</span></span>
<span class="line"><span style="color:#393A34;">certificatesigningrequest.certificates.k8s.io/node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4 approved</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u67E5\u770Bnode\u8282\u70B9</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get node</span></span>
<span class="line"><span style="color:#393A34;">NAME                 STATUS     ROLES    AGE   VERSION</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-master1   NotReady   </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   6s    v1.20.4</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u6B64\u65F6master\u8282\u70B9\u5DF2\u7ECF\u51FA\u73B0\u5728\u96C6\u7FA4\u8282\u70B9\u5217\u8868\u4E2D\u4E86</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u67E5\u770Bkubelet\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kubelet</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 127.0.0.1:10248         0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      29092/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 127.0.0.1:41132         0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      29092/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10250                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      29092/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10255                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      29092/kubelet </span></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/857b38edfb4c46e99ccd40e7fa296628.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_6-3-\u5728master\u8282\u70B9\u90E8\u7F72kube-proxy" tabindex="-1">6.3.\u5728master\u8282\u70B9\u90E8\u7F72kube-proxy <a class="header-anchor" href="#_6-3-\u5728master\u8282\u70B9\u90E8\u7F72kube-proxy" aria-hidden="true">#</a></h3><h4 id="_6-3-1-\u521B\u5EFAkube-proxy\u914D\u7F6E\u6587\u4EF6" tabindex="-1">6.3.1.\u521B\u5EFAkube-proxy\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_6-3-1-\u521B\u5EFAkube-proxy\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-proxy.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">KUBE_PROXY_OPTS=</span><span style="color:#C98A7D;">&quot;--logtostderr=false </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--v=2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--log-dir=/data/kubernetes/logs </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-proxy.conf</span></span>
<span class="line"><span style="color:#393A34;">KUBE_PROXY_OPTS=</span><span style="color:#B56959;">&quot;--logtostderr=false </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--v=2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--log-dir=/data/kubernetes/logs </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span></span>
<span class="line"></span></code></pre></div><h4 id="_6-3-2-\u521B\u5EFAkube-proxy\u53C2\u6570\u914D\u7F6E\u6587\u4EF6" tabindex="-1">6.3.2.\u521B\u5EFAkube-proxy\u53C2\u6570\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_6-3-2-\u521B\u5EFAkube-proxy\u53C2\u6570\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-proxy-config.yml</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: KubeProxyConfiguration</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span>
<span class="line"><span style="color:#DBD7CA;">bindAddress: 0.0.0.0									</span><span style="color:#758575;">#\u76D1\u542C\u5730\u5740</span></span>
<span class="line"><span style="color:#DBD7CA;">metricsBindAddress: 0.0.0.0:10249							</span><span style="color:#758575;">#\u76D1\u542C\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#DBD7CA;">clientConnection:</span></span>
<span class="line"><span style="color:#DBD7CA;">  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig			</span><span style="color:#758575;">#kubeconfig\u6587\u4EF6\u7528\u4E8E\u548Capiserver\u901A\u4FE1</span></span>
<span class="line"><span style="color:#DBD7CA;">hostnameOverride: binary-k8s-master1				</span><span style="color:#758575;">#\u5F53\u524D\u8282\u70B9\u540D\u79F0</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterCIDR: 10.244.0.0/16</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-proxy-config.yml</span></span>
<span class="line"><span style="color:#393A34;">kind: KubeProxyConfiguration</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span>
<span class="line"><span style="color:#393A34;">bindAddress: 0.0.0.0									</span><span style="color:#A0ADA0;">#\u76D1\u542C\u5730\u5740</span></span>
<span class="line"><span style="color:#393A34;">metricsBindAddress: 0.0.0.0:10249							</span><span style="color:#A0ADA0;">#\u76D1\u542C\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#393A34;">clientConnection:</span></span>
<span class="line"><span style="color:#393A34;">  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig			</span><span style="color:#A0ADA0;">#kubeconfig\u6587\u4EF6\u7528\u4E8E\u548Capiserver\u901A\u4FE1</span></span>
<span class="line"><span style="color:#393A34;">hostnameOverride: binary-k8s-master1				</span><span style="color:#A0ADA0;">#\u5F53\u524D\u8282\u70B9\u540D\u79F0</span></span>
<span class="line"><span style="color:#393A34;">clusterCIDR: 10.244.0.0/16</span></span>
<span class="line"></span></code></pre></div><h4 id="_6-3-3-\u751F\u6210kubeconfig\u6587\u4EF6" tabindex="-1">6.3.3.\u751F\u6210kubeconfig\u6587\u4EF6 <a class="header-anchor" href="#_6-3-3-\u751F\u6210kubeconfig\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u521B\u5EFA\u8BC1\u4E66\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim kube-proxy-csr.json </span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;system:kube-proxy&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;key&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;algo&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;rsa&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;size&quot;</span><span style="color:#DBD7CA;">: 2048</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;names&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;C&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;CN&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;L&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;ST&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;BeiJing&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;O&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;k8s&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#C98A7D;">&quot;OU&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u751F\u6210\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> cfssljson -bare kube-proxy</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/03 16:04:23 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generate received request</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/03 16:04:23 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> received CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/03 16:04:23 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/03 16:04:24 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> encoded CSR</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/03 16:04:24 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">INFO</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> signed certificate with serial number 677418055440191127932354470575565723194258386145</span></span>
<span class="line"><span style="color:#DBD7CA;">2021/09/03 16:04:24 </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">WARNING</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> This certificate lacks a </span><span style="color:#C98A7D;">&quot;hosts&quot;</span><span style="color:#DBD7CA;"> field. This makes it unsuitable </span><span style="color:#4D9375;">for</span></span>
<span class="line"><span style="color:#DBD7CA;">websites. For more information see the Baseline Requirements </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CA;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#DBD7CA;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">https://cabforum.org</span><span style="color:#858585;">)</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">specifically, section 10.2.3 </span><span style="color:#858585;">(</span><span style="color:#C98A7D;">&quot;Information Requirements&quot;</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u67E5\u770B\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ll </span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">proxy</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1009 9\u6708   3 16:04 kube-proxy.csr</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root  230 9\u6708   3 16:04 kube-proxy-csr.json</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1679 9\u6708   3 16:04 kube-proxy-key.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-r--r--. 1 root root 1403 9\u6708   3 16:04 kube-proxy.pem</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u62F7\u8D1D\u8BC1\u4E66\u6587\u4EF6\u81F3\u6307\u5B9A\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/TLS/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp kube-proxy</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">.pem /data/kubernetes/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.\u751F\u6210kubeconfig\u6587\u4EF6</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--server=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-credentials kube-proxy \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-certificate=/data/kubernetes/ssl/kube-proxy.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-key=/data/kubernetes/ssl/kube-proxy-key.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--user=kube-proxy \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">6.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u521B\u5EFA\u8BC1\u4E66\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim kube-proxy-csr.json </span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;system:kube-proxy&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;key&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;algo&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;rsa&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;size&quot;</span><span style="color:#393A34;">: 2048</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;names&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;C&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;CN&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;L&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;ST&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;BeiJing&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;O&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;k8s&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959;">&quot;OU&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;System&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u751F\u6210\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> cfssljson -bare kube-proxy</span></span>
<span class="line"><span style="color:#393A34;">2021/09/03 16:04:23 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generate received request</span></span>
<span class="line"><span style="color:#393A34;">2021/09/03 16:04:23 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> received CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/03 16:04:23 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> generating key: rsa-2048</span></span>
<span class="line"><span style="color:#393A34;">2021/09/03 16:04:24 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> encoded CSR</span></span>
<span class="line"><span style="color:#393A34;">2021/09/03 16:04:24 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">INFO</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> signed certificate with serial number 677418055440191127932354470575565723194258386145</span></span>
<span class="line"><span style="color:#393A34;">2021/09/03 16:04:24 </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">WARNING</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> This certificate lacks a </span><span style="color:#B56959;">&quot;hosts&quot;</span><span style="color:#393A34;"> field. This makes it unsuitable </span><span style="color:#1C6B48;">for</span></span>
<span class="line"><span style="color:#393A34;">websites. For more information see the Baseline Requirements </span><span style="color:#1C6B48;">for</span><span style="color:#393A34;"> the Issuance and Management</span></span>
<span class="line"><span style="color:#393A34;">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">https://cabforum.org</span><span style="color:#8E8F8B;">)</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">specifically, section 10.2.3 </span><span style="color:#8E8F8B;">(</span><span style="color:#B56959;">&quot;Information Requirements&quot;</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u67E5\u770B\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ll </span><span style="color:#AB5959;">*</span><span style="color:#393A34;">proxy</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1009 9\u6708   3 16:04 kube-proxy.csr</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root  230 9\u6708   3 16:04 kube-proxy-csr.json</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1679 9\u6708   3 16:04 kube-proxy-key.pem</span></span>
<span class="line"><span style="color:#393A34;">-rw-r--r--. 1 root root 1403 9\u6708   3 16:04 kube-proxy.pem</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u62F7\u8D1D\u8BC1\u4E66\u6587\u4EF6\u81F3\u6307\u5B9A\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/TLS/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp kube-proxy</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">.pem /data/kubernetes/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.\u751F\u6210kubeconfig\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--server=</span><span style="color:#B56959;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-credentials kube-proxy \\</span></span>
<span class="line"><span style="color:#393A34;">--client-certificate=/data/kubernetes/ssl/kube-proxy.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--client-key=/data/kubernetes/ssl/kube-proxy-key.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#393A34;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--user=kube-proxy \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">6.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"></span></code></pre></div><h4 id="_6-3-4-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1" tabindex="-1">6.3.4.\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1 <a class="header-anchor" href="#_6-3-4-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /usr/lib/systemd/system/kube-proxy.service</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Unit</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Description=Kubernetes Proxy</span></span>
<span class="line"><span style="color:#DBD7CA;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">EnvironmentFile=/data/kubernetes/config/kube-proxy.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecStart=/data/kubernetes/bin/kube-proxy </span><span style="color:#858585;">$</span><span style="color:#B8A965;">KUBE_PROXY_OPTS</span></span>
<span class="line"><span style="color:#DBD7CA;">Restart=on-failure</span></span>
<span class="line"><span style="color:#DBD7CA;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Install</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">WantedBy=multi-user.target</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /usr/lib/systemd/system/kube-proxy.service</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Unit</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Description=Kubernetes Proxy</span></span>
<span class="line"><span style="color:#393A34;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">EnvironmentFile=/data/kubernetes/config/kube-proxy.conf</span></span>
<span class="line"><span style="color:#393A34;">ExecStart=/data/kubernetes/bin/kube-proxy </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">KUBE_PROXY_OPTS</span></span>
<span class="line"><span style="color:#393A34;">Restart=on-failure</span></span>
<span class="line"><span style="color:#393A34;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Install</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">WantedBy=multi-user.target</span></span>
<span class="line"></span></code></pre></div><h4 id="_6-3-4-\u542F\u52A8kube-proxy\u7EC4\u4EF6" tabindex="-1">6.3.4.\u542F\u52A8kube-proxy\u7EC4\u4EF6 <a class="header-anchor" href="#_6-3-4-\u542F\u52A8kube-proxy\u7EC4\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u542F\u52A8\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-proxy</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kube-proxy</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10249                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      29354/kube-proxy    </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10256                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      29354/kube-proxy </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u542F\u52A8\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-proxy</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kube-proxy</span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10249                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      29354/kube-proxy    </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10256                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      29354/kube-proxy </span></span>
<span class="line"></span></code></pre></div><h3 id="_6-4-\u6388\u6743apiserver\u8BBF\u95EEkubelet" tabindex="-1">6.4.\u6388\u6743apiserver\u8BBF\u95EEkubelet <a class="header-anchor" href="#_6-4-\u6388\u6743apiserver\u8BBF\u95EEkubelet" aria-hidden="true">#</a></h3><p>\u5982\u679C\u4E0D\u6536\u53D6apiserver\u8BBF\u95EEkubelet\uFF0C\u90A3\u4E48\u5C06\u65E0\u6CD5\u4F7F\u7528kubectl\u67E5\u770B\u96C6\u7FA4\u7684\u4E00\u4E9B\u4FE1\u606F\uFF0C\u6BD4\u5982kubectl logs\u5C31\u65E0\u6CD5\u4F7F\u7528\u3002</p><p>\u5B9E\u9645\u4E0A\u5C31\u662F\u521B\u5EFA\u4E00\u4E2Arbac\u8D44\u6E90\u8BA9apiserver\u80FD\u5426\u8BBF\u95EEkubelet\u7684\u8D44\u6E90\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u7F16\u5199\u8D44\u6E90yaml\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim apiserver-to-kubelet-rbac.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: ClusterRole</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  annotations:</span></span>
<span class="line"><span style="color:#DBD7CA;">    rbac.authorization.kubernetes.io/autoupdate: </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    kubernetes.io/bootstrapping: rbac-defaults</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: system:kube-apiserver-to-kubelet</span></span>
<span class="line"><span style="color:#DBD7CA;">rules:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - apiGroups:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - </span><span style="color:#C98A7D;">&quot;&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    resources:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - nodes/proxy</span></span>
<span class="line"><span style="color:#DBD7CA;">      - nodes/stats</span></span>
<span class="line"><span style="color:#DBD7CA;">      - nodes/log</span></span>
<span class="line"><span style="color:#DBD7CA;">      - nodes/spec</span></span>
<span class="line"><span style="color:#DBD7CA;">      - nodes/metrics</span></span>
<span class="line"><span style="color:#DBD7CA;">      - pods/log</span></span>
<span class="line"><span style="color:#DBD7CA;">    verbs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - </span><span style="color:#C98A7D;">&quot;*&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">---</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: ClusterRoleBinding</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: system:kube-apiserver</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: </span><span style="color:#C98A7D;">&quot;&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">roleRef:</span></span>
<span class="line"><span style="color:#DBD7CA;">  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#DBD7CA;">  kind: ClusterRole</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: system:kube-apiserver-to-kubelet</span></span>
<span class="line"><span style="color:#DBD7CA;">subjects:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#DBD7CA;">    kind: User</span></span>
<span class="line"><span style="color:#DBD7CA;">    name: kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u521B\u5EFA\u8D44\u6E90</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl apply -f apiserver-to-kubelet-rbac.yaml</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u7F16\u5199\u8D44\u6E90yaml\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim apiserver-to-kubelet-rbac.yaml </span></span>
<span class="line"><span style="color:#393A34;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#393A34;">kind: ClusterRole</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  annotations:</span></span>
<span class="line"><span style="color:#393A34;">    rbac.authorization.kubernetes.io/autoupdate: </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">    kubernetes.io/bootstrapping: rbac-defaults</span></span>
<span class="line"><span style="color:#393A34;">  name: system:kube-apiserver-to-kubelet</span></span>
<span class="line"><span style="color:#393A34;">rules:</span></span>
<span class="line"><span style="color:#393A34;">  - apiGroups:</span></span>
<span class="line"><span style="color:#393A34;">      - </span><span style="color:#B56959;">&quot;&quot;</span></span>
<span class="line"><span style="color:#393A34;">    resources:</span></span>
<span class="line"><span style="color:#393A34;">      - nodes/proxy</span></span>
<span class="line"><span style="color:#393A34;">      - nodes/stats</span></span>
<span class="line"><span style="color:#393A34;">      - nodes/log</span></span>
<span class="line"><span style="color:#393A34;">      - nodes/spec</span></span>
<span class="line"><span style="color:#393A34;">      - nodes/metrics</span></span>
<span class="line"><span style="color:#393A34;">      - pods/log</span></span>
<span class="line"><span style="color:#393A34;">    verbs:</span></span>
<span class="line"><span style="color:#393A34;">      - </span><span style="color:#B56959;">&quot;*&quot;</span></span>
<span class="line"><span style="color:#393A34;">---</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#393A34;">kind: ClusterRoleBinding</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: system:kube-apiserver</span></span>
<span class="line"><span style="color:#393A34;">  namespace: </span><span style="color:#B56959;">&quot;&quot;</span></span>
<span class="line"><span style="color:#393A34;">roleRef:</span></span>
<span class="line"><span style="color:#393A34;">  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#393A34;">  kind: ClusterRole</span></span>
<span class="line"><span style="color:#393A34;">  name: system:kube-apiserver-to-kubelet</span></span>
<span class="line"><span style="color:#393A34;">subjects:</span></span>
<span class="line"><span style="color:#393A34;">  - apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#393A34;">    kind: User</span></span>
<span class="line"><span style="color:#393A34;">    name: kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u521B\u5EFA\u8D44\u6E90</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl apply -f apiserver-to-kubelet-rbac.yaml</span></span>
<span class="line"><span style="color:#393A34;">clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created</span></span>
<span class="line"><span style="color:#393A34;">clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</span></span>
<span class="line"></span></code></pre></div><h2 id="_7-\u90E8\u7F72kubernetes-calico\u7F51\u7EDC\u7EC4\u4EF6" tabindex="-1">7.\u90E8\u7F72kubernetes calico\u7F51\u7EDC\u7EC4\u4EF6 <a class="header-anchor" href="#_7-\u90E8\u7F72kubernetes-calico\u7F51\u7EDC\u7EC4\u4EF6" aria-hidden="true">#</a></h2><p>\u57286\u4E2Dmaster\u8282\u70B9\u5DF2\u7ECF\u52A0\u5165\u96C6\u7FA4\uFF0C\u4F46\u662F\u72B6\u6001\u4E00\u76F4\u5904\u4E8ENotReady\u72B6\u6001\uFF0C\u5C31\u662F\u7531\u4E8E\u96C6\u7FA4\u6CA1\u6709\u7F51\u7EDC\u7EC4\u4EF6\u5BFC\u81F4\u7684\uFF0C\u90E8\u7F72\u597D\u7F51\u7EDC\u7EC4\u4EF6\uFF0Cmaster\u8282\u70B9\u7ACB\u9A6C\u4F1A\u6210\u4E3AReady\u72B6\u6001\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u90E8\u7F72calico</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl apply -f calico.yaml</span></span>
<span class="line"><span style="color:#DBD7CA;">configmap/calico-config created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrole.rbac.authorization.k8s.io/calico-node created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span></span>
<span class="line"><span style="color:#DBD7CA;">daemonset.apps/calico-node created</span></span>
<span class="line"><span style="color:#DBD7CA;">serviceaccount/calico-node created</span></span>
<span class="line"><span style="color:#DBD7CA;">deployment.apps/calico-kube-controllers created</span></span>
<span class="line"><span style="color:#DBD7CA;">serviceaccount/calico-kube-controllers created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u67E5\u770B\u8D44\u6E90\u72B6\u6001</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get pod -n kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                      READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">calico-kube-controllers-97769f7c7-bnwcl   1/1     Running   0          11m</span></span>
<span class="line"><span style="color:#DBD7CA;">calico-node-mghdj                         1/1     Running   0          11m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u67E5\u770Bmaster\u8282\u70B9\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get node</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME          STATUS   ROLES    AGE   VERSION</span></span>
<span class="line"><span style="color:#DBD7CA;">k8s-master1   Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   99m   v1.20.4</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u90E8\u7F72calico</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl apply -f calico.yaml</span></span>
<span class="line"><span style="color:#393A34;">configmap/calico-config created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span></span>
<span class="line"><span style="color:#393A34;">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span></span>
<span class="line"><span style="color:#393A34;">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span></span>
<span class="line"><span style="color:#393A34;">clusterrole.rbac.authorization.k8s.io/calico-node created</span></span>
<span class="line"><span style="color:#393A34;">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span></span>
<span class="line"><span style="color:#393A34;">daemonset.apps/calico-node created</span></span>
<span class="line"><span style="color:#393A34;">serviceaccount/calico-node created</span></span>
<span class="line"><span style="color:#393A34;">deployment.apps/calico-kube-controllers created</span></span>
<span class="line"><span style="color:#393A34;">serviceaccount/calico-kube-controllers created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u67E5\u770B\u8D44\u6E90\u72B6\u6001</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get pod -n kube-system</span></span>
<span class="line"><span style="color:#393A34;">NAME                                      READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#393A34;">calico-kube-controllers-97769f7c7-bnwcl   1/1     Running   0          11m</span></span>
<span class="line"><span style="color:#393A34;">calico-node-mghdj                         1/1     Running   0          11m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u67E5\u770Bmaster\u8282\u70B9\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get node</span></span>
<span class="line"><span style="color:#393A34;">NAME          STATUS   ROLES    AGE   VERSION</span></span>
<span class="line"><span style="color:#393A34;">k8s-master1   Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   99m   v1.20.4</span></span>
<span class="line"></span></code></pre></div><h2 id="_8-\u90E8\u7F72kubernetes-node\u8282\u70B9" tabindex="-1">8.\u90E8\u7F72kubernetes node\u8282\u70B9 <a class="header-anchor" href="#_8-\u90E8\u7F72kubernetes-node\u8282\u70B9" aria-hidden="true">#</a></h2><h3 id="_8-1-\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F" tabindex="-1">8.1.\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F <a class="header-anchor" href="#_8-1-\u89E3\u538B\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u76F8\u5173\u7EC4\u4EF6\u7A0B\u5E8F" aria-hidden="true">#</a></h3><p>\u4EE5\u4E0B\u64CD\u4F5C\u4EC5\u5728node1\u8282\u70B9\u64CD\u4F5C\u5373\u53EF\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u51C6\u5907\u4E8C\u8FDB\u5236\u7A0B\u5E8F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> tar xf kubernetes-server-linux-amd64.tar.gz </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mkdir -p /data/kubernetes/{bin,config,ssl,logs} </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp kubernetes/server/bin/{kubelet,kube-proxy} /data/kubernetes/bin/</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp kubernetes/server/bin/kubectl /usr/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5C06master\u8282\u70B9\u4E0A\u7684\u8BC1\u4E66\u6587\u4EF6\u62F7\u8D1D\u81F3node\u8282\u70B9</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /data/kubernetes/ssl/</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;"> binary-k8s-node1:/data/kubernetes/ssl/</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /data/kubernetes/config/token.csv root@binary-k8s-node1:/data/kubernetes/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u5220\u9664\u4ECEmaster\u8282\u70B9\u4E0A\u62F7\u8D1D\u8FC7\u6765\u7684kubelet\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> rm -rf /data/kubernetes/ssl/kubelet-client-</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#758575;">#kubelet\u8BC1\u4E66\u9700\u8981\u5220\u9664\uFF0C\u5F53node\u8282\u70B9\u7684kubelet\u542F\u52A8\u540E\u4F1A\u751F\u6210\u4E34\u65F6\u8BC1\u4E66\u6587\u4EF6\uFF0C\u5F53master\u6388\u6743\u901A\u8FC7\u540E\uFF0C\u8BC1\u4E66\u6587\u4EF6\u4EA7\u751F</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u51C6\u5907\u4E8C\u8FDB\u5236\u7A0B\u5E8F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> tar xf kubernetes-server-linux-amd64.tar.gz </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mkdir -p /data/kubernetes/{bin,config,ssl,logs} </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp kubernetes/server/bin/{kubelet,kube-proxy} /data/kubernetes/bin/</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp kubernetes/server/bin/kubectl /usr/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u5C06master\u8282\u70B9\u4E0A\u7684\u8BC1\u4E66\u6587\u4EF6\u62F7\u8D1D\u81F3node\u8282\u70B9</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /data/kubernetes/ssl/</span><span style="color:#AB5959;">*</span><span style="color:#393A34;"> binary-k8s-node1:/data/kubernetes/ssl/</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /data/kubernetes/config/token.csv root@binary-k8s-node1:/data/kubernetes/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u5220\u9664\u4ECEmaster\u8282\u70B9\u4E0A\u62F7\u8D1D\u8FC7\u6765\u7684kubelet\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> rm -rf /data/kubernetes/ssl/kubelet-client-</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#A0ADA0;">#kubelet\u8BC1\u4E66\u9700\u8981\u5220\u9664\uFF0C\u5F53node\u8282\u70B9\u7684kubelet\u542F\u52A8\u540E\u4F1A\u751F\u6210\u4E34\u65F6\u8BC1\u4E66\u6587\u4EF6\uFF0C\u5F53master\u6388\u6743\u901A\u8FC7\u540E\uFF0C\u8BC1\u4E66\u6587\u4EF6\u4EA7\u751F</span></span>
<span class="line"></span></code></pre></div><h3 id="_8-2-\u90E8\u7F72kubelet\u7EC4\u4EF6" tabindex="-1">8.2.\u90E8\u7F72kubelet\u7EC4\u4EF6 <a class="header-anchor" href="#_8-2-\u90E8\u7F72kubelet\u7EC4\u4EF6" aria-hidden="true">#</a></h3><h4 id="_8-2-1-\u521B\u5EFAkubelet\u914D\u7F6E\u6587\u4EF6" tabindex="-1">8.2.1.\u521B\u5EFAkubelet\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_8-2-1-\u521B\u5EFAkubelet\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kubelet.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">KUBELET_OPTS=</span><span style="color:#C98A7D;">&quot;--logtostderr=false </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--v=2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--log-dir=/data/kubernetes/logs </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--hostname-override=binary-k8s-node1		#\u6CE8\u610F\u4FEE\u6539\u8282\u70B9\u540D\u79F0 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--network-plugin=cni </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--config=/data/kubernetes/config/kubelet-config.yml </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--cert-dir=/data/kubernetes/ssl </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--pod-infra-container-image=pause-amd64:3.0&quot;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kubelet.conf </span></span>
<span class="line"><span style="color:#393A34;">KUBELET_OPTS=</span><span style="color:#B56959;">&quot;--logtostderr=false </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--v=2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--log-dir=/data/kubernetes/logs </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--hostname-override=binary-k8s-node1		#\u6CE8\u610F\u4FEE\u6539\u8282\u70B9\u540D\u79F0 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--network-plugin=cni </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--config=/data/kubernetes/config/kubelet-config.yml </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--cert-dir=/data/kubernetes/ssl </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--pod-infra-container-image=pause-amd64:3.0&quot;</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-2-2-\u521B\u5EFAkubelet\u53C2\u6570\u914D\u7F6E\u6587\u4EF6" tabindex="-1">8.2.2.\u521B\u5EFAkubelet\u53C2\u6570\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_8-2-2-\u521B\u5EFAkubelet\u53C2\u6570\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kubelet-config.yml</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: KubeletConfiguration</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#DBD7CA;">address: 0.0.0.0</span></span>
<span class="line"><span style="color:#DBD7CA;">port: 10250</span></span>
<span class="line"><span style="color:#DBD7CA;">readOnlyPort: 10255</span></span>
<span class="line"><span style="color:#DBD7CA;">cgroupDriver: cgroupfs</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterDNS:</span></span>
<span class="line"><span style="color:#DBD7CA;">- 10.0.0.2</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterDomain: cluster.local</span></span>
<span class="line"><span style="color:#DBD7CA;">failSwapOn: </span><span style="color:#E0A569;">false</span></span>
<span class="line"><span style="color:#DBD7CA;">authentication:</span></span>
<span class="line"><span style="color:#DBD7CA;">  anonymous:</span></span>
<span class="line"><span style="color:#DBD7CA;">    enabled: </span><span style="color:#E0A569;">false</span></span>
<span class="line"><span style="color:#DBD7CA;">  webhook:</span></span>
<span class="line"><span style="color:#DBD7CA;">    cacheTTL: 2m0s</span></span>
<span class="line"><span style="color:#DBD7CA;">    enabled: </span><span style="color:#E0A569;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">  x509:</span></span>
<span class="line"><span style="color:#DBD7CA;">    clientCAFile: /data/kubernetes/ssl/ca.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">authorization:</span></span>
<span class="line"><span style="color:#DBD7CA;">  mode: Webhook</span></span>
<span class="line"><span style="color:#DBD7CA;">  webhook:</span></span>
<span class="line"><span style="color:#DBD7CA;">    cacheAuthorizedTTL: 5m0s</span></span>
<span class="line"><span style="color:#DBD7CA;">    cacheUnauthorizedTTL: 30s</span></span>
<span class="line"><span style="color:#DBD7CA;">evictionHard:</span></span>
<span class="line"><span style="color:#DBD7CA;">  imagefs.available: 15%</span></span>
<span class="line"><span style="color:#DBD7CA;">  memory.available: 100Mi</span></span>
<span class="line"><span style="color:#DBD7CA;">  nodefs.available: 10%</span></span>
<span class="line"><span style="color:#DBD7CA;">  nodefs.inodesFree: 5%</span></span>
<span class="line"><span style="color:#DBD7CA;">maxOpenFiles: 1000000</span></span>
<span class="line"><span style="color:#DBD7CA;">maxPods: 110</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kubelet-config.yml</span></span>
<span class="line"><span style="color:#393A34;">kind: KubeletConfiguration</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#393A34;">address: 0.0.0.0</span></span>
<span class="line"><span style="color:#393A34;">port: 10250</span></span>
<span class="line"><span style="color:#393A34;">readOnlyPort: 10255</span></span>
<span class="line"><span style="color:#393A34;">cgroupDriver: cgroupfs</span></span>
<span class="line"><span style="color:#393A34;">clusterDNS:</span></span>
<span class="line"><span style="color:#393A34;">- 10.0.0.2</span></span>
<span class="line"><span style="color:#393A34;">clusterDomain: cluster.local</span></span>
<span class="line"><span style="color:#393A34;">failSwapOn: </span><span style="color:#B58451;">false</span></span>
<span class="line"><span style="color:#393A34;">authentication:</span></span>
<span class="line"><span style="color:#393A34;">  anonymous:</span></span>
<span class="line"><span style="color:#393A34;">    enabled: </span><span style="color:#B58451;">false</span></span>
<span class="line"><span style="color:#393A34;">  webhook:</span></span>
<span class="line"><span style="color:#393A34;">    cacheTTL: 2m0s</span></span>
<span class="line"><span style="color:#393A34;">    enabled: </span><span style="color:#B58451;">true</span></span>
<span class="line"><span style="color:#393A34;">  x509:</span></span>
<span class="line"><span style="color:#393A34;">    clientCAFile: /data/kubernetes/ssl/ca.pem</span></span>
<span class="line"><span style="color:#393A34;">authorization:</span></span>
<span class="line"><span style="color:#393A34;">  mode: Webhook</span></span>
<span class="line"><span style="color:#393A34;">  webhook:</span></span>
<span class="line"><span style="color:#393A34;">    cacheAuthorizedTTL: 5m0s</span></span>
<span class="line"><span style="color:#393A34;">    cacheUnauthorizedTTL: 30s</span></span>
<span class="line"><span style="color:#393A34;">evictionHard:</span></span>
<span class="line"><span style="color:#393A34;">  imagefs.available: 15%</span></span>
<span class="line"><span style="color:#393A34;">  memory.available: 100Mi</span></span>
<span class="line"><span style="color:#393A34;">  nodefs.available: 10%</span></span>
<span class="line"><span style="color:#393A34;">  nodefs.inodesFree: 5%</span></span>
<span class="line"><span style="color:#393A34;">maxOpenFiles: 1000000</span></span>
<span class="line"><span style="color:#393A34;">maxPods: 110</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-2-3-\u521B\u5EFAbootstrap-kubeconfig\u6587\u4EF6" tabindex="-1">8.2.3.\u521B\u5EFAbootstrap-kubeconfig\u6587\u4EF6 <a class="header-anchor" href="#_8-2-3-\u521B\u5EFAbootstrap-kubeconfig\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--server=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0token\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-credentials </span><span style="color:#C98A7D;">&quot;kubelet-bootstrap&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--token=d7f96b0d86c574d0f64a713608db0922 \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u8FD9\u4E2Atoken\u5C31\u662F\u4E4B\u524D\u751F\u6210\u7684/data/kubernetes/config/token.csv\u4E2D\u7684token</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">3.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--user=</span><span style="color:#C98A7D;">&quot;kubelet-bootstrap&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--server=</span><span style="color:#B56959;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">2.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0token\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-credentials </span><span style="color:#B56959;">&quot;kubelet-bootstrap&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--token=d7f96b0d86c574d0f64a713608db0922 \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u8FD9\u4E2Atoken\u5C31\u662F\u4E4B\u524D\u751F\u6210\u7684/data/kubernetes/config/token.csv\u4E2D\u7684token</span></span>
<span class="line"><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">3.\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#393A34;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--user=</span><span style="color:#B56959;">&quot;kubelet-bootstrap&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-2-4-\u521B\u5EFAsystemctl\u811A\u672C\u5E76\u542F\u52A8\u670D\u52A1" tabindex="-1">8.2.4.\u521B\u5EFAsystemctl\u811A\u672C\u5E76\u542F\u52A8\u670D\u52A1 <a class="header-anchor" href="#_8-2-4-\u521B\u5EFAsystemctl\u811A\u672C\u5E76\u542F\u52A8\u670D\u52A1" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u7F16\u5199systemctl\u670D\u52A1\u811A\u672C</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /usr/lib/systemd/system/kubelet.service</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Unit</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Description=Kubernetes Kubelet</span></span>
<span class="line"><span style="color:#DBD7CA;">After=docker.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">EnvironmentFile=/data/kubernetes/config/kubelet.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecStart=/data/kubernetes/bin/kubelet </span><span style="color:#858585;">$</span><span style="color:#B8A965;">KUBELET_OPTS</span></span>
<span class="line"><span style="color:#DBD7CA;">Restart=on-failure</span></span>
<span class="line"><span style="color:#DBD7CA;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Install</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u542F\u52A8kubelet\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kubelet</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kubelet</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl status kubelet</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u7F16\u5199systemctl\u670D\u52A1\u811A\u672C</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /usr/lib/systemd/system/kubelet.service</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Unit</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Description=Kubernetes Kubelet</span></span>
<span class="line"><span style="color:#393A34;">After=docker.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">EnvironmentFile=/data/kubernetes/config/kubelet.conf</span></span>
<span class="line"><span style="color:#393A34;">ExecStart=/data/kubernetes/bin/kubelet </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">KUBELET_OPTS</span></span>
<span class="line"><span style="color:#393A34;">Restart=on-failure</span></span>
<span class="line"><span style="color:#393A34;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Install</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u542F\u52A8kubelet\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kubelet</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kubelet</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl status kubelet</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-2-5-master\u8282\u70B9\u6388\u6743\u540C\u610Fnode\u8282\u70B9\u52A0\u5165\u96C6\u7FA4" tabindex="-1">8.2.5.master\u8282\u70B9\u6388\u6743\u540C\u610Fnode\u8282\u70B9\u52A0\u5165\u96C6\u7FA4 <a class="header-anchor" href="#_8-2-5-master\u8282\u70B9\u6388\u6743\u540C\u610Fnode\u8282\u70B9\u52A0\u5165\u96C6\u7FA4" aria-hidden="true">#</a></h4><p>kubelet\u670D\u52A1\u542F\u52A8\u540E\uFF0C\u4F1A\u751F\u6210\u4E00\u4E2A\u4E34\u65F6\u8BC1\u4E66\u6587\u4EF6\uFF0C\u7136\u540E\u5411master\u8282\u70B9\u53D1\u9001\u4E00\u4E2Acsr\u6388\u6743\u8BF7\u6C42\uFF0C\u5F53master\u8282\u70B9\u6388\u6743\u540C\u610F\u540E\uFF0Ckubelet-clinet\u8BC1\u4E66\u6587\u4EF6\u751F\u6210\uFF0C\u7AEF\u53E3\u4E5F\u968F\u4E4B\u542F\u52A8\uFF0C\u8282\u70B9\u6B63\u5E38\u52A0\u5165\u96C6\u7FA4\u3002</p><p>csr\u5217\u8868\u7684\u6388\u6743\u4FE1\u606F\u4E5F\u4F1A\u81EA\u52A8\u6E05\u7A7A\uFF0C\u5982\u679Cmaster\u8282\u70B9\u7684\u6388\u6743\u4E0D\u53CA\u65F6\uFF0C\u4E5F\u53EF\u4EE5\u91CD\u542F\u4E00\u4E0Bkubelet\u91CD\u65B0\u53D1\u9001\u4E00\u4E2Acsr\u8BF7\u6C42\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5728node\u8282\u70B9\u67E5\u770B\u4E34\u65F6\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ll /data/kubernetes/ssl/</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">.tmp</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root  227 9\u6708   6 11:28 kubelet-client.key.tmp</span></span>
<span class="line"><span style="color:#758575;">#\u53EA\u8981kubelet\u542F\u52A8\u5C31\u4F1A\u4EA7\u751F\u4E00\u4E2A\u4E34\u65F6\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5728master\u8282\u70B9\u67E5\u770Bcsr\u6388\u6743\u8BF7\u6C42\u5217\u8868</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get csr</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION</span></span>
<span class="line"><span style="color:#DBD7CA;">node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI   11s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u6388\u6743\u901A\u8FC7</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl certificate approve node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI</span></span>
<span class="line"><span style="color:#DBD7CA;">certificatesigningrequest.certificates.k8s.io/node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI approved</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u6B64\u65F6\u4E34\u65F6\u6587\u4EF6\u5DF2\u5220\u9664\uFF0C\u5DF2\u7ECF\u751F\u6210kubelet\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ll /data/kubernetes/ssl/kubelet-client</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#DBD7CA;">-rw-------. 1 root root 1236 9\u6708   6 11:28 kubelet-client-2021-09-06-11-28-54.pem</span></span>
<span class="line"><span style="color:#DBD7CA;">lrwxrwxrwx. 1 root root   59 9\u6708   6 11:28 kubelet-client-current.pem -</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;"> /data/kubernetes/ssl/kubelet-client-2021-09-06-11-28-54.pem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.node1\u8282\u70B9\u6210\u529F\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get node</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 STATUS   ROLES    AGE     VERSION</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-master1   Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   2d22h   v1.20.4</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-node1     Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   4h59m   v1.20.4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">6.\u5728node\u8282\u70B9\u67E5\u770Bkubelet\u670D\u52A1\u7684\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kubelet</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 127.0.0.1:10248         0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      29220/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 127.0.0.1:44151         0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      29220/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10250                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      29220/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10255                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      29220/kubelet</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5728node\u8282\u70B9\u67E5\u770B\u4E34\u65F6\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ll /data/kubernetes/ssl/</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">.tmp</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root  227 9\u6708   6 11:28 kubelet-client.key.tmp</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u53EA\u8981kubelet\u542F\u52A8\u5C31\u4F1A\u4EA7\u751F\u4E00\u4E2A\u4E34\u65F6\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u5728master\u8282\u70B9\u67E5\u770Bcsr\u6388\u6743\u8BF7\u6C42\u5217\u8868</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get csr</span></span>
<span class="line"><span style="color:#393A34;">NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION</span></span>
<span class="line"><span style="color:#393A34;">node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI   11s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u6388\u6743\u901A\u8FC7</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl certificate approve node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI</span></span>
<span class="line"><span style="color:#393A34;">certificatesigningrequest.certificates.k8s.io/node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI approved</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u6B64\u65F6\u4E34\u65F6\u6587\u4EF6\u5DF2\u5220\u9664\uFF0C\u5DF2\u7ECF\u751F\u6210kubelet\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ll /data/kubernetes/ssl/kubelet-client</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#393A34;">-rw-------. 1 root root 1236 9\u6708   6 11:28 kubelet-client-2021-09-06-11-28-54.pem</span></span>
<span class="line"><span style="color:#393A34;">lrwxrwxrwx. 1 root root   59 9\u6708   6 11:28 kubelet-client-current.pem -</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> /data/kubernetes/ssl/kubelet-client-2021-09-06-11-28-54.pem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.node1\u8282\u70B9\u6210\u529F\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get node</span></span>
<span class="line"><span style="color:#393A34;">NAME                 STATUS   ROLES    AGE     VERSION</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-master1   Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   2d22h   v1.20.4</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-node1     Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   4h59m   v1.20.4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">6.\u5728node\u8282\u70B9\u67E5\u770Bkubelet\u670D\u52A1\u7684\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kubelet</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 127.0.0.1:10248         0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      29220/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 127.0.0.1:44151         0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      29220/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10250                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      29220/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10255                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      29220/kubelet</span></span>
<span class="line"></span></code></pre></div><h3 id="_8-3-\u90E8\u7F72kube-proxy\u7EC4\u4EF6" tabindex="-1">8.3.\u90E8\u7F72kube-proxy\u7EC4\u4EF6 <a class="header-anchor" href="#_8-3-\u90E8\u7F72kube-proxy\u7EC4\u4EF6" aria-hidden="true">#</a></h3><h4 id="_8-3-1-\u521B\u5EFAkube-proxy\u914D\u7F6E\u6587\u4EF6" tabindex="-1">8.3.1.\u521B\u5EFAkube-proxy\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_8-3-1-\u521B\u5EFAkube-proxy\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-proxy.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">KUBE_PROXY_OPTS=</span><span style="color:#C98A7D;">&quot;--logtostderr=false </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--v=2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--log-dir=/data/kubernetes/logs </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-proxy.conf</span></span>
<span class="line"><span style="color:#393A34;">KUBE_PROXY_OPTS=</span><span style="color:#B56959;">&quot;--logtostderr=false </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--v=2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--log-dir=/data/kubernetes/logs </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-3-2-\u521B\u5EFAkube-proxy\u53C2\u6570\u914D\u7F6E\u6587\u4EF6" tabindex="-1">8.3.2.\u521B\u5EFAkube-proxy\u53C2\u6570\u914D\u7F6E\u6587\u4EF6 <a class="header-anchor" href="#_8-3-2-\u521B\u5EFAkube-proxy\u53C2\u6570\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-proxy-config.yml</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: KubeProxyConfiguration</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span>
<span class="line"><span style="color:#DBD7CA;">bindAddress: 0.0.0.0									</span><span style="color:#758575;">#\u76D1\u542C\u5730\u5740</span></span>
<span class="line"><span style="color:#DBD7CA;">metricsBindAddress: 0.0.0.0:10249							</span><span style="color:#758575;">#\u76D1\u542C\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#DBD7CA;">clientConnection:</span></span>
<span class="line"><span style="color:#DBD7CA;">  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig			</span><span style="color:#758575;">#kubeconfig\u6587\u4EF6\u7528\u4E8E\u548Capiserver\u901A\u4FE1</span></span>
<span class="line"><span style="color:#DBD7CA;">hostnameOverride: binary-k8s-node1				</span><span style="color:#758575;">#\u5F53\u524D\u8282\u70B9\u540D\u79F0</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterCIDR: 10.244.0.0/16</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-proxy-config.yml</span></span>
<span class="line"><span style="color:#393A34;">kind: KubeProxyConfiguration</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span>
<span class="line"><span style="color:#393A34;">bindAddress: 0.0.0.0									</span><span style="color:#A0ADA0;">#\u76D1\u542C\u5730\u5740</span></span>
<span class="line"><span style="color:#393A34;">metricsBindAddress: 0.0.0.0:10249							</span><span style="color:#A0ADA0;">#\u76D1\u542C\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#393A34;">clientConnection:</span></span>
<span class="line"><span style="color:#393A34;">  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig			</span><span style="color:#A0ADA0;">#kubeconfig\u6587\u4EF6\u7528\u4E8E\u548Capiserver\u901A\u4FE1</span></span>
<span class="line"><span style="color:#393A34;">hostnameOverride: binary-k8s-node1				</span><span style="color:#A0ADA0;">#\u5F53\u524D\u8282\u70B9\u540D\u79F0</span></span>
<span class="line"><span style="color:#393A34;">clusterCIDR: 10.244.0.0/16</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-3-3-\u751F\u6210kube-config\u6587\u4EF6" tabindex="-1">8.3.3.\u751F\u6210kube-config\u6587\u4EF6 <a class="header-anchor" href="#_8-3-3-\u751F\u6210kube-config\u6587\u4EF6" aria-hidden="true">#</a></h4><p>\u7531\u4E8Ekube-proxy\u7684\u8BC1\u4E66\u6587\u4EF6\u57288.1\u4E2D\u5DF2\u7ECF\u4ECEmaster\u8282\u70B9\u62F7\u8D1D\u5230node\u8282\u70B9\u4E86\uFF0C\u56E0\u6B64\u76F4\u63A5\u751F\u6210kubeconfig\u6587\u4EF6\u5373\u53EF\u3002</p><p>\u96C6\u7FA4\u4E2D\u4E0D\u540C\u8282\u70B9\u7684\u7EC4\u4EF6\u90FD\u8981\u7528\u540C\u4E00\u4E2A\u8BC1\u4E66\u6587\u4EF6\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u751F\u6210kubeconfig\u6587\u4EF6</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--server=</span><span style="color:#C98A7D;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#DBD7CA;"> \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-credentials kube-proxy \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-certificate=/data/kubernetes/ssl/kube-proxy.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--client-key=/data/kubernetes/ssl/kube-proxy-key.pem \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#758575;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--user=kube-proxy \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u751F\u6210kubeconfig\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u96C6\u7FA4apiserver\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-cluster kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--certificate-authority=/data/kubernetes/ssl/ca.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--server=</span><span style="color:#B56959;">&quot;https://192.168.20.10:6443&quot;</span><span style="color:#393A34;"> \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u8BC1\u4E66\u6587\u4EF6\u4FE1\u606F </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-credentials kube-proxy \\</span></span>
<span class="line"><span style="color:#393A34;">--client-certificate=/data/kubernetes/ssl/kube-proxy.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--client-key=/data/kubernetes/ssl/kube-proxy-key.pem \\</span></span>
<span class="line"><span style="color:#393A34;">--embed-certs=true \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5728kubeconfig\u6587\u4EF6\u4E2D\u589E\u52A0\u7528\u6237\u4FE1\u606F </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config set-context default \\</span></span>
<span class="line"><span style="color:#393A34;">--cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#393A34;">--user=kube-proxy \\</span></span>
<span class="line"><span style="color:#393A34;">--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u6307\u5B9A\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E3A\u96C6\u7FA4\u4F7F\u7528</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-3-4-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1" tabindex="-1">8.3.4.\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1 <a class="header-anchor" href="#_8-3-4-\u521B\u5EFAsystemctl\u811A\u672C\u7BA1\u7406\u670D\u52A1" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /usr/lib/systemd/system/kube-proxy.service</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Unit</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">Description=Kubernetes Proxy</span></span>
<span class="line"><span style="color:#DBD7CA;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Service</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">EnvironmentFile=/data/kubernetes/config/kube-proxy.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">ExecStart=/data/kubernetes/bin/kube-proxy </span><span style="color:#858585;">$</span><span style="color:#B8A965;">KUBE_PROXY_OPTS</span></span>
<span class="line"><span style="color:#DBD7CA;">Restart=on-failure</span></span>
<span class="line"><span style="color:#DBD7CA;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">Install</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">WantedBy=multi-user.targ</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /usr/lib/systemd/system/kube-proxy.service</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Unit</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">Description=Kubernetes Proxy</span></span>
<span class="line"><span style="color:#393A34;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Service</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">EnvironmentFile=/data/kubernetes/config/kube-proxy.conf</span></span>
<span class="line"><span style="color:#393A34;">ExecStart=/data/kubernetes/bin/kube-proxy </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">KUBE_PROXY_OPTS</span></span>
<span class="line"><span style="color:#393A34;">Restart=on-failure</span></span>
<span class="line"><span style="color:#393A34;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">Install</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">WantedBy=multi-user.targ</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-3-5-\u542F\u52A8kube-proxy\u7EC4\u4EF6" tabindex="-1">8.3.5.\u542F\u52A8kube-proxy\u7EC4\u4EF6 <a class="header-anchor" href="#_8-3-5-\u542F\u52A8kube-proxy\u7EC4\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u542F\u52A8\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-proxy</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kube-proxy</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10249                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      26954/kube-proxy    </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10256                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      26954/kube-proxy  </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u542F\u52A8\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-proxy</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kube-proxy</span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10249                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      26954/kube-proxy    </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10256                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      26954/kube-proxy  </span></span>
<span class="line"></span></code></pre></div><h3 id="_8-4-\u5FEB\u901F\u589E\u52A0\u65B0\u7684node\u8282\u70B9" tabindex="-1">8.4.\u5FEB\u901F\u589E\u52A0\u65B0\u7684node\u8282\u70B9 <a class="header-anchor" href="#_8-4-\u5FEB\u901F\u589E\u52A0\u65B0\u7684node\u8282\u70B9" aria-hidden="true">#</a></h3><p>\u4E8C\u8FDB\u5236\u90E8\u7F72\u7684\u7A0B\u5E8F\u7279\u522B\u597D\u7684\u4E00\u4E2A\u5730\u65B9\u5C31\u5728\u4E8E\uFF0C\u80FD\u591F\u5FEB\u901F\u90E8\u7F72\u4E00\u4E2A\u65B0\u7684\u670D\u52A1\uFF0C\u505A\u6CD5\u5C31\u662F\u76F4\u63A5\u62F7\u8D1D\u5DF2\u7ECF\u90E8\u7F72\u597D\u7684\u76EE\u5F55\u5230\u4E00\u4E2A\u65B0\u7684\u4F4D\u7F6E\uFF0C\u6539\u6539\u5176\u4E2D\u7684\u53C2\u6570\u5373\u53EF\u542F\u52A8\u4F7F\u7528\u4E86\u3002</p><h4 id="_8-4-1-\u5C06kubelet\u548Ckube-proxy\u76EE\u5F55\u62F7\u8D1D\u81F3\u65B0\u7684node\u8282\u70B9" tabindex="-1">8.4.1.\u5C06kubelet\u548Ckube-proxy\u76EE\u5F55\u62F7\u8D1D\u81F3\u65B0\u7684node\u8282\u70B9 <a class="header-anchor" href="#_8-4-1-\u5C06kubelet\u548Ckube-proxy\u76EE\u5F55\u62F7\u8D1D\u81F3\u65B0\u7684node\u8282\u70B9" aria-hidden="true">#</a></h4><p>\u8981\u62F7\u8D1Dkubelet\u548Ckube-proxy\u90E8\u7F72\u76EE\u5F55\u4EE5\u53CAsystemctl\u542F\u52A8\u811A\u672C\u6587\u4EF6\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /data/kubernetes root@binary-k8s-node2:/data</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp /usr/lib/systemd/system/kube</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;"> root@binary-k8s-node2:/usr/lib/systemd/system/</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /data/kubernetes root@binary-k8s-node2:/data</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp /usr/lib/systemd/system/kube</span><span style="color:#AB5959;">*</span><span style="color:#393A34;"> root@binary-k8s-node2:/usr/lib/systemd/system/</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-4-2-\u914D\u7F6E\u5E76\u542F\u52A8kubelet\u7EC4\u4EF6" tabindex="-1">8.4.2.\u914D\u7F6E\u5E76\u542F\u52A8kubelet\u7EC4\u4EF6 <a class="header-anchor" href="#_8-4-2-\u914D\u7F6E\u5E76\u542F\u52A8kubelet\u7EC4\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5220\u9664\u6CA1\u7528\u7684\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> rm -rf /data/kubernetes/ssl/kubelet-client-</span><span style="color:#CB7676;">*</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u4FEE\u6539kubelet\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684\u8282\u70B9\u540D\u79F0</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kubelet.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">KUBELET_OPTS=</span><span style="color:#C98A7D;">&quot;--logtostderr=false </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--v=2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--log-dir=/data/kubernetes/logs </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--hostname-override=binary-k8s-node2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--network-plugin=cni </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--config=/data/kubernetes/config/kubelet-config.yml </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--cert-dir=/data/kubernetes/ssl </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">--pod-infra-container-image=pause-amd64:3.0&quot;</span></span>
<span class="line"><span style="color:#758575;">#\u5C06--hostname-override\u503C\u4FEE\u6539\u4E3A\u5F53\u524D\u8282\u70B9\u540D\u79F0\u5373\u53EF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u542F\u52A8kubelet</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kubelet</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kubelet</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5220\u9664\u6CA1\u7528\u7684\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> rm -rf /data/kubernetes/ssl/kubelet-client-</span><span style="color:#AB5959;">*</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u4FEE\u6539kubelet\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684\u8282\u70B9\u540D\u79F0</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kubelet.conf </span></span>
<span class="line"><span style="color:#393A34;">KUBELET_OPTS=</span><span style="color:#B56959;">&quot;--logtostderr=false </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--v=2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--log-dir=/data/kubernetes/logs </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--hostname-override=binary-k8s-node2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--network-plugin=cni </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--config=/data/kubernetes/config/kubelet-config.yml </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--cert-dir=/data/kubernetes/ssl </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">--pod-infra-container-image=pause-amd64:3.0&quot;</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5C06--hostname-override\u503C\u4FEE\u6539\u4E3A\u5F53\u524D\u8282\u70B9\u540D\u79F0\u5373\u53EF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u542F\u52A8kubelet</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kubelet</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kubelet</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-4-3-master\u8282\u70B9\u6388\u6743\u65B0node\u8282\u70B9\u7684\u8BF7\u6C42" tabindex="-1">8.4.3.master\u8282\u70B9\u6388\u6743\u65B0node\u8282\u70B9\u7684\u8BF7\u6C42 <a class="header-anchor" href="#_8-4-3-master\u8282\u70B9\u6388\u6743\u65B0node\u8282\u70B9\u7684\u8BF7\u6C42" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.master\u8282\u70B9\u67E5\u770B\u6388\u6743\u4FE1\u606F\u5217\u8868</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get csr</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span></span>
<span class="line"><span style="color:#DBD7CA;">node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE   48s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u6388\u6743\u901A\u8FC7node\u8282\u70B9\u7684kubelet</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl certificate approve node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE</span></span>
<span class="line"><span style="color:#DBD7CA;">certificatesigningrequest.certificates.k8s.io/node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE approved</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u6210\u529F\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get node</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 STATUS   ROLES    AGE     VERSION</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-master1   Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   2d23h   v1.20.4</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-node1     Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   5h54m   v1.20.4</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-node2     Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   1s      v1.20.4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u67E5\u770Bkubelet\u7684\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kube</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 127.0.0.1:41121         0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 127.0.0.1:10248         0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10250                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10255                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      16694/kubelet</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.master\u8282\u70B9\u67E5\u770B\u6388\u6743\u4FE1\u606F\u5217\u8868</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get csr</span></span>
<span class="line"><span style="color:#393A34;">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span></span>
<span class="line"><span style="color:#393A34;">node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE   48s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u6388\u6743\u901A\u8FC7node\u8282\u70B9\u7684kubelet</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl certificate approve node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE</span></span>
<span class="line"><span style="color:#393A34;">certificatesigningrequest.certificates.k8s.io/node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE approved</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u6210\u529F\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get node</span></span>
<span class="line"><span style="color:#393A34;">NAME                 STATUS   ROLES    AGE     VERSION</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-master1   Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   2d23h   v1.20.4</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-node1     Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   5h54m   v1.20.4</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-node2     Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   1s      v1.20.4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u67E5\u770Bkubelet\u7684\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kube</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 127.0.0.1:41121         0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 127.0.0.1:10248         0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10250                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10255                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      16694/kubelet</span></span>
<span class="line"></span></code></pre></div><h4 id="_8-4-4-\u914D\u7F6E\u5E76\u542F\u52A8kube-proxy\u7EC4\u4EF6" tabindex="-1">8.4.4.\u914D\u7F6E\u5E76\u542F\u52A8kube-proxy\u7EC4\u4EF6 <a class="header-anchor" href="#_8-4-4-\u914D\u7F6E\u5E76\u542F\u52A8kube-proxy\u7EC4\u4EF6" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u4FEE\u6539kube-proxy\u53C2\u6570\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684\u4E3B\u673A\u540D</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-proxy-config.yml </span></span>
<span class="line"><span style="color:#DBD7CA;">kind: KubeProxyConfiguration</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span>
<span class="line"><span style="color:#DBD7CA;">bindAddress: 0.0.0.0</span></span>
<span class="line"><span style="color:#DBD7CA;">metricsBindAddress: 0.0.0.0:10249</span></span>
<span class="line"><span style="color:#DBD7CA;">clientConnection:</span></span>
<span class="line"><span style="color:#DBD7CA;">  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#DBD7CA;">hostnameOverride: binary-k8s-node2</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterCIDR: 10.244.0.0/16</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u542F\u52A8kubelet</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-proxy</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3\u67E5\u770Bkube-proxy\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kube</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 127.0.0.1:41121         0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 127.0.0.1:10248         0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10249                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      20410/kube-proxy    </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10250                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10255                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::10256                :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      20410/kube-proxy</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u4FEE\u6539kube-proxy\u53C2\u6570\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684\u4E3B\u673A\u540D</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-proxy-config.yml </span></span>
<span class="line"><span style="color:#393A34;">kind: KubeProxyConfiguration</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span>
<span class="line"><span style="color:#393A34;">bindAddress: 0.0.0.0</span></span>
<span class="line"><span style="color:#393A34;">metricsBindAddress: 0.0.0.0:10249</span></span>
<span class="line"><span style="color:#393A34;">clientConnection:</span></span>
<span class="line"><span style="color:#393A34;">  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="color:#393A34;">hostnameOverride: binary-k8s-node2</span></span>
<span class="line"><span style="color:#393A34;">clusterCIDR: 10.244.0.0/16</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u542F\u52A8kubelet</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-proxy</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3\u67E5\u770Bkube-proxy\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kube</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 127.0.0.1:41121         0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 127.0.0.1:10248         0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10249                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      20410/kube-proxy    </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10250                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10255                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      16694/kubelet       </span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::10256                :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      20410/kube-proxy</span></span>
<span class="line"></span></code></pre></div><h2 id="_9-\u4E3A\u96C6\u7FA4\u90E8\u7F72coredns\u7EC4\u4EF6" tabindex="-1">9.\u4E3A\u96C6\u7FA4\u90E8\u7F72coredns\u7EC4\u4EF6 <a class="header-anchor" href="#_9-\u4E3A\u96C6\u7FA4\u90E8\u7F72coredns\u7EC4\u4EF6" aria-hidden="true">#</a></h2><h3 id="_9-1-\u90E8\u7F72coredns\u7EC4\u4EF6" tabindex="-1">9.1.\u90E8\u7F72coredns\u7EC4\u4EF6 <a class="header-anchor" href="#_9-1-\u90E8\u7F72coredns\u7EC4\u4EF6" aria-hidden="true">#</a></h3><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.coredns.yaml\u6587\u4EF6\u5185\u5BB9</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cat coredns.yaml </span></span>
<span class="line"><span style="color:#758575;"># Warning: This is a file generated from the base underscore template file: coredns.yaml.base</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: ServiceAccount</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">      kubernetes.io/cluster-service: </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      addonmanager.kubernetes.io/mode: Reconcile</span></span>
<span class="line"><span style="color:#DBD7CA;">---</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: ClusterRole</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    kubernetes.io/bootstrapping: rbac-defaults</span></span>
<span class="line"><span style="color:#DBD7CA;">    addonmanager.kubernetes.io/mode: Reconcile</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: system:coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">rules:</span></span>
<span class="line"><span style="color:#DBD7CA;">- apiGroups:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - </span><span style="color:#C98A7D;">&quot;&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  resources:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - endpoints</span></span>
<span class="line"><span style="color:#DBD7CA;">  - services</span></span>
<span class="line"><span style="color:#DBD7CA;">  - pods</span></span>
<span class="line"><span style="color:#DBD7CA;">  - namespaces</span></span>
<span class="line"><span style="color:#DBD7CA;">  verbs:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - list</span></span>
<span class="line"><span style="color:#DBD7CA;">  - watch</span></span>
<span class="line"><span style="color:#DBD7CA;">- apiGroups:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - </span><span style="color:#C98A7D;">&quot;&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  resources:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - nodes</span></span>
<span class="line"><span style="color:#DBD7CA;">  verbs:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - get</span></span>
<span class="line"><span style="color:#DBD7CA;">---</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: ClusterRoleBinding</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  annotations:</span></span>
<span class="line"><span style="color:#DBD7CA;">    rbac.authorization.kubernetes.io/autoupdate: </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    kubernetes.io/bootstrapping: rbac-defaults</span></span>
<span class="line"><span style="color:#DBD7CA;">    addonmanager.kubernetes.io/mode: EnsureExists</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: system:coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">roleRef:</span></span>
<span class="line"><span style="color:#DBD7CA;">  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#DBD7CA;">  kind: ClusterRole</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: system:coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">subjects:</span></span>
<span class="line"><span style="color:#DBD7CA;">- kind: ServiceAccount</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">---</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: ConfigMap</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">      addonmanager.kubernetes.io/mode: EnsureExists</span></span>
<span class="line"><span style="color:#DBD7CA;">data:</span></span>
<span class="line"><span style="color:#DBD7CA;">  Corefile: </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">    .:53 </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        log</span></span>
<span class="line"><span style="color:#DBD7CA;">        errors</span></span>
<span class="line"><span style="color:#DBD7CA;">        health </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">            lameduck 5s</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">        ready</span></span>
<span class="line"><span style="color:#DBD7CA;">        kubernetes cluster.local in-addr.arpa ip6.arpa </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">            pods insecure</span></span>
<span class="line"><span style="color:#DBD7CA;">            fallthrough in-addr.arpa ip6.arpa</span></span>
<span class="line"><span style="color:#DBD7CA;">            ttl 30</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">        prometheus :9153</span></span>
<span class="line"><span style="color:#DBD7CA;">        forward </span><span style="color:#E0A569;">.</span><span style="color:#DBD7CA;"> /etc/resolv.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">        cache 30</span></span>
<span class="line"><span style="color:#DBD7CA;">        loop</span></span>
<span class="line"><span style="color:#DBD7CA;">        reload</span></span>
<span class="line"><span style="color:#DBD7CA;">        loadbalance</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">---</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: apps/v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: Deployment</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#DBD7CA;">    kubernetes.io/cluster-service: </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    addonmanager.kubernetes.io/mode: Reconcile</span></span>
<span class="line"><span style="color:#DBD7CA;">    kubernetes.io/name: </span><span style="color:#C98A7D;">&quot;CoreDNS&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#858585;">  </span><span style="color:#758575;"># replicas: not specified here:</span></span>
<span class="line"><span style="color:#858585;">  </span><span style="color:#758575;"># 1. In order to make Addon Manager do not reconcile this replicas parameter.</span></span>
<span class="line"><span style="color:#858585;">  </span><span style="color:#758575;"># 2. Default is 1.</span></span>
<span class="line"><span style="color:#858585;">  </span><span style="color:#758575;"># 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span>
<span class="line"><span style="color:#DBD7CA;">  strategy:</span></span>
<span class="line"><span style="color:#DBD7CA;">    type: RollingUpdate</span></span>
<span class="line"><span style="color:#DBD7CA;">    rollingUpdate:</span></span>
<span class="line"><span style="color:#DBD7CA;">      maxUnavailable: 1</span></span>
<span class="line"><span style="color:#DBD7CA;">  selector:</span></span>
<span class="line"><span style="color:#DBD7CA;">    matchLabels:</span></span>
<span class="line"><span style="color:#DBD7CA;">      k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#DBD7CA;">  template:</span></span>
<span class="line"><span style="color:#DBD7CA;">    metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">      labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">        k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#DBD7CA;">      annotations:</span></span>
<span class="line"><span style="color:#DBD7CA;">        seccomp.security.alpha.kubernetes.io/pod: </span><span style="color:#C98A7D;">&#39;runtime/default&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">    spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">      priorityClassName: system-cluster-critical</span></span>
<span class="line"><span style="color:#DBD7CA;">      serviceAccountName: coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">      tolerations:</span></span>
<span class="line"><span style="color:#DBD7CA;">        - key: </span><span style="color:#C98A7D;">&quot;CriticalAddonsOnly&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          operator: </span><span style="color:#C98A7D;">&quot;Exists&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      nodeSelector:</span></span>
<span class="line"><span style="color:#DBD7CA;">        kubernetes.io/os: linux</span></span>
<span class="line"><span style="color:#DBD7CA;">      containers:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - name: coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">        image: coredns:1.6.7</span></span>
<span class="line"><span style="color:#DBD7CA;">        imagePullPolicy: IfNotPresent</span></span>
<span class="line"><span style="color:#DBD7CA;">        resources:</span></span>
<span class="line"><span style="color:#DBD7CA;">          limits:</span></span>
<span class="line"><span style="color:#DBD7CA;">            memory: 512Mi </span></span>
<span class="line"><span style="color:#DBD7CA;">          requests:</span></span>
<span class="line"><span style="color:#DBD7CA;">            cpu: 100m</span></span>
<span class="line"><span style="color:#DBD7CA;">            memory: 70Mi</span></span>
<span class="line"><span style="color:#DBD7CA;">        args: </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;-conf&quot;</span><span style="color:#DBD7CA;">, </span><span style="color:#C98A7D;">&quot;/etc/coredns/Corefile&quot;</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">        volumeMounts:</span></span>
<span class="line"><span style="color:#DBD7CA;">        - name: config-volume</span></span>
<span class="line"><span style="color:#DBD7CA;">          mountPath: /etc/coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">          readOnly: </span><span style="color:#E0A569;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">        ports:</span></span>
<span class="line"><span style="color:#DBD7CA;">        - containerPort: 53</span></span>
<span class="line"><span style="color:#DBD7CA;">          name: dns</span></span>
<span class="line"><span style="color:#DBD7CA;">          protocol: UDP</span></span>
<span class="line"><span style="color:#DBD7CA;">        - containerPort: 53</span></span>
<span class="line"><span style="color:#DBD7CA;">          name: dns-tcp</span></span>
<span class="line"><span style="color:#DBD7CA;">          protocol: TCP</span></span>
<span class="line"><span style="color:#DBD7CA;">        - containerPort: 9153</span></span>
<span class="line"><span style="color:#DBD7CA;">          name: metrics</span></span>
<span class="line"><span style="color:#DBD7CA;">          protocol: TCP</span></span>
<span class="line"><span style="color:#DBD7CA;">        livenessProbe:</span></span>
<span class="line"><span style="color:#DBD7CA;">          httpGet:</span></span>
<span class="line"><span style="color:#DBD7CA;">            path: /health</span></span>
<span class="line"><span style="color:#DBD7CA;">            port: 8080</span></span>
<span class="line"><span style="color:#DBD7CA;">            scheme: HTTP</span></span>
<span class="line"><span style="color:#DBD7CA;">          initialDelaySeconds: 60</span></span>
<span class="line"><span style="color:#DBD7CA;">          timeoutSeconds: 5</span></span>
<span class="line"><span style="color:#DBD7CA;">          successThreshold: 1</span></span>
<span class="line"><span style="color:#DBD7CA;">          failureThreshold: 5</span></span>
<span class="line"><span style="color:#DBD7CA;">        readinessProbe:</span></span>
<span class="line"><span style="color:#DBD7CA;">          httpGet:</span></span>
<span class="line"><span style="color:#DBD7CA;">            path: /ready</span></span>
<span class="line"><span style="color:#DBD7CA;">            port: 8181</span></span>
<span class="line"><span style="color:#DBD7CA;">            scheme: HTTP</span></span>
<span class="line"><span style="color:#DBD7CA;">        securityContext:</span></span>
<span class="line"><span style="color:#DBD7CA;">          allowPrivilegeEscalation: </span><span style="color:#E0A569;">false</span></span>
<span class="line"><span style="color:#DBD7CA;">          capabilities:</span></span>
<span class="line"><span style="color:#DBD7CA;">            add:</span></span>
<span class="line"><span style="color:#DBD7CA;">            - NET_BIND_SERVICE</span></span>
<span class="line"><span style="color:#DBD7CA;">            drop:</span></span>
<span class="line"><span style="color:#DBD7CA;">            - all</span></span>
<span class="line"><span style="color:#DBD7CA;">          readOnlyRootFilesystem: </span><span style="color:#E0A569;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">      dnsPolicy: Default</span></span>
<span class="line"><span style="color:#DBD7CA;">      volumes:</span></span>
<span class="line"><span style="color:#DBD7CA;">        - name: config-volume</span></span>
<span class="line"><span style="color:#DBD7CA;">          configMap:</span></span>
<span class="line"><span style="color:#DBD7CA;">            name: coredns</span></span>
<span class="line"><span style="color:#DBD7CA;">            items:</span></span>
<span class="line"><span style="color:#DBD7CA;">            - key: Corefile</span></span>
<span class="line"><span style="color:#DBD7CA;">              path: Corefile</span></span>
<span class="line"><span style="color:#DBD7CA;">---</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: Service</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: kube-dns</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">  annotations:</span></span>
<span class="line"><span style="color:#DBD7CA;">    prometheus.io/port: </span><span style="color:#C98A7D;">&quot;9153&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    prometheus.io/scrape: </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#DBD7CA;">    kubernetes.io/cluster-service: </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    addonmanager.kubernetes.io/mode: Reconcile</span></span>
<span class="line"><span style="color:#DBD7CA;">    kubernetes.io/name: </span><span style="color:#C98A7D;">&quot;CoreDNS&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">  selector:</span></span>
<span class="line"><span style="color:#DBD7CA;">    k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#DBD7CA;">  clusterIP: 10.0.0.2 </span></span>
<span class="line"><span style="color:#DBD7CA;">  ports:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - name: dns</span></span>
<span class="line"><span style="color:#DBD7CA;">    port: 53</span></span>
<span class="line"><span style="color:#DBD7CA;">    protocol: UDP</span></span>
<span class="line"><span style="color:#DBD7CA;">  - name: dns-tcp</span></span>
<span class="line"><span style="color:#DBD7CA;">    port: 53</span></span>
<span class="line"><span style="color:#DBD7CA;">    protocol: TCP</span></span>
<span class="line"><span style="color:#DBD7CA;">  - name: metrics</span></span>
<span class="line"><span style="color:#DBD7CA;">    port: 9153</span></span>
<span class="line"><span style="color:#DBD7CA;">    protocol: TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u90E8\u7F72coredns</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl apply -f coredns.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">serviceaccount/coredns created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrole.rbac.authorization.k8s.io/system:coredns created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span></span>
<span class="line"><span style="color:#DBD7CA;">configmap/coredns created</span></span>
<span class="line"><span style="color:#DBD7CA;">deployment.apps/coredns created</span></span>
<span class="line"><span style="color:#DBD7CA;">service/kube-dns created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.coredns.yaml\u6587\u4EF6\u5185\u5BB9</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cat coredns.yaml </span></span>
<span class="line"><span style="color:#A0ADA0;"># Warning: This is a file generated from the base underscore template file: coredns.yaml.base</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: ServiceAccount</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: coredns</span></span>
<span class="line"><span style="color:#393A34;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">      kubernetes.io/cluster-service: </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">      addonmanager.kubernetes.io/mode: Reconcile</span></span>
<span class="line"><span style="color:#393A34;">---</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#393A34;">kind: ClusterRole</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">    kubernetes.io/bootstrapping: rbac-defaults</span></span>
<span class="line"><span style="color:#393A34;">    addonmanager.kubernetes.io/mode: Reconcile</span></span>
<span class="line"><span style="color:#393A34;">  name: system:coredns</span></span>
<span class="line"><span style="color:#393A34;">rules:</span></span>
<span class="line"><span style="color:#393A34;">- apiGroups:</span></span>
<span class="line"><span style="color:#393A34;">  - </span><span style="color:#B56959;">&quot;&quot;</span></span>
<span class="line"><span style="color:#393A34;">  resources:</span></span>
<span class="line"><span style="color:#393A34;">  - endpoints</span></span>
<span class="line"><span style="color:#393A34;">  - services</span></span>
<span class="line"><span style="color:#393A34;">  - pods</span></span>
<span class="line"><span style="color:#393A34;">  - namespaces</span></span>
<span class="line"><span style="color:#393A34;">  verbs:</span></span>
<span class="line"><span style="color:#393A34;">  - list</span></span>
<span class="line"><span style="color:#393A34;">  - watch</span></span>
<span class="line"><span style="color:#393A34;">- apiGroups:</span></span>
<span class="line"><span style="color:#393A34;">  - </span><span style="color:#B56959;">&quot;&quot;</span></span>
<span class="line"><span style="color:#393A34;">  resources:</span></span>
<span class="line"><span style="color:#393A34;">  - nodes</span></span>
<span class="line"><span style="color:#393A34;">  verbs:</span></span>
<span class="line"><span style="color:#393A34;">  - get</span></span>
<span class="line"><span style="color:#393A34;">---</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#393A34;">kind: ClusterRoleBinding</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  annotations:</span></span>
<span class="line"><span style="color:#393A34;">    rbac.authorization.kubernetes.io/autoupdate: </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">    kubernetes.io/bootstrapping: rbac-defaults</span></span>
<span class="line"><span style="color:#393A34;">    addonmanager.kubernetes.io/mode: EnsureExists</span></span>
<span class="line"><span style="color:#393A34;">  name: system:coredns</span></span>
<span class="line"><span style="color:#393A34;">roleRef:</span></span>
<span class="line"><span style="color:#393A34;">  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#393A34;">  kind: ClusterRole</span></span>
<span class="line"><span style="color:#393A34;">  name: system:coredns</span></span>
<span class="line"><span style="color:#393A34;">subjects:</span></span>
<span class="line"><span style="color:#393A34;">- kind: ServiceAccount</span></span>
<span class="line"><span style="color:#393A34;">  name: coredns</span></span>
<span class="line"><span style="color:#393A34;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#393A34;">---</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: ConfigMap</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: coredns</span></span>
<span class="line"><span style="color:#393A34;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">      addonmanager.kubernetes.io/mode: EnsureExists</span></span>
<span class="line"><span style="color:#393A34;">data:</span></span>
<span class="line"><span style="color:#393A34;">  Corefile: </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">    .:53 </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        log</span></span>
<span class="line"><span style="color:#393A34;">        errors</span></span>
<span class="line"><span style="color:#393A34;">        health </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">            lameduck 5s</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">        ready</span></span>
<span class="line"><span style="color:#393A34;">        kubernetes cluster.local in-addr.arpa ip6.arpa </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">            pods insecure</span></span>
<span class="line"><span style="color:#393A34;">            fallthrough in-addr.arpa ip6.arpa</span></span>
<span class="line"><span style="color:#393A34;">            ttl 30</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">        prometheus :9153</span></span>
<span class="line"><span style="color:#393A34;">        forward </span><span style="color:#B58451;">.</span><span style="color:#393A34;"> /etc/resolv.conf</span></span>
<span class="line"><span style="color:#393A34;">        cache 30</span></span>
<span class="line"><span style="color:#393A34;">        loop</span></span>
<span class="line"><span style="color:#393A34;">        reload</span></span>
<span class="line"><span style="color:#393A34;">        loadbalance</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">---</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: apps/v1</span></span>
<span class="line"><span style="color:#393A34;">kind: Deployment</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: coredns</span></span>
<span class="line"><span style="color:#393A34;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">    k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#393A34;">    kubernetes.io/cluster-service: </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">    addonmanager.kubernetes.io/mode: Reconcile</span></span>
<span class="line"><span style="color:#393A34;">    kubernetes.io/name: </span><span style="color:#B56959;">&quot;CoreDNS&quot;</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#8E8F8B;">  </span><span style="color:#A0ADA0;"># replicas: not specified here:</span></span>
<span class="line"><span style="color:#8E8F8B;">  </span><span style="color:#A0ADA0;"># 1. In order to make Addon Manager do not reconcile this replicas parameter.</span></span>
<span class="line"><span style="color:#8E8F8B;">  </span><span style="color:#A0ADA0;"># 2. Default is 1.</span></span>
<span class="line"><span style="color:#8E8F8B;">  </span><span style="color:#A0ADA0;"># 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span>
<span class="line"><span style="color:#393A34;">  strategy:</span></span>
<span class="line"><span style="color:#393A34;">    type: RollingUpdate</span></span>
<span class="line"><span style="color:#393A34;">    rollingUpdate:</span></span>
<span class="line"><span style="color:#393A34;">      maxUnavailable: 1</span></span>
<span class="line"><span style="color:#393A34;">  selector:</span></span>
<span class="line"><span style="color:#393A34;">    matchLabels:</span></span>
<span class="line"><span style="color:#393A34;">      k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#393A34;">  template:</span></span>
<span class="line"><span style="color:#393A34;">    metadata:</span></span>
<span class="line"><span style="color:#393A34;">      labels:</span></span>
<span class="line"><span style="color:#393A34;">        k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#393A34;">      annotations:</span></span>
<span class="line"><span style="color:#393A34;">        seccomp.security.alpha.kubernetes.io/pod: </span><span style="color:#B56959;">&#39;runtime/default&#39;</span></span>
<span class="line"><span style="color:#393A34;">    spec:</span></span>
<span class="line"><span style="color:#393A34;">      priorityClassName: system-cluster-critical</span></span>
<span class="line"><span style="color:#393A34;">      serviceAccountName: coredns</span></span>
<span class="line"><span style="color:#393A34;">      tolerations:</span></span>
<span class="line"><span style="color:#393A34;">        - key: </span><span style="color:#B56959;">&quot;CriticalAddonsOnly&quot;</span></span>
<span class="line"><span style="color:#393A34;">          operator: </span><span style="color:#B56959;">&quot;Exists&quot;</span></span>
<span class="line"><span style="color:#393A34;">      nodeSelector:</span></span>
<span class="line"><span style="color:#393A34;">        kubernetes.io/os: linux</span></span>
<span class="line"><span style="color:#393A34;">      containers:</span></span>
<span class="line"><span style="color:#393A34;">      - name: coredns</span></span>
<span class="line"><span style="color:#393A34;">        image: coredns:1.6.7</span></span>
<span class="line"><span style="color:#393A34;">        imagePullPolicy: IfNotPresent</span></span>
<span class="line"><span style="color:#393A34;">        resources:</span></span>
<span class="line"><span style="color:#393A34;">          limits:</span></span>
<span class="line"><span style="color:#393A34;">            memory: 512Mi </span></span>
<span class="line"><span style="color:#393A34;">          requests:</span></span>
<span class="line"><span style="color:#393A34;">            cpu: 100m</span></span>
<span class="line"><span style="color:#393A34;">            memory: 70Mi</span></span>
<span class="line"><span style="color:#393A34;">        args: </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;-conf&quot;</span><span style="color:#393A34;">, </span><span style="color:#B56959;">&quot;/etc/coredns/Corefile&quot;</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">        volumeMounts:</span></span>
<span class="line"><span style="color:#393A34;">        - name: config-volume</span></span>
<span class="line"><span style="color:#393A34;">          mountPath: /etc/coredns</span></span>
<span class="line"><span style="color:#393A34;">          readOnly: </span><span style="color:#B58451;">true</span></span>
<span class="line"><span style="color:#393A34;">        ports:</span></span>
<span class="line"><span style="color:#393A34;">        - containerPort: 53</span></span>
<span class="line"><span style="color:#393A34;">          name: dns</span></span>
<span class="line"><span style="color:#393A34;">          protocol: UDP</span></span>
<span class="line"><span style="color:#393A34;">        - containerPort: 53</span></span>
<span class="line"><span style="color:#393A34;">          name: dns-tcp</span></span>
<span class="line"><span style="color:#393A34;">          protocol: TCP</span></span>
<span class="line"><span style="color:#393A34;">        - containerPort: 9153</span></span>
<span class="line"><span style="color:#393A34;">          name: metrics</span></span>
<span class="line"><span style="color:#393A34;">          protocol: TCP</span></span>
<span class="line"><span style="color:#393A34;">        livenessProbe:</span></span>
<span class="line"><span style="color:#393A34;">          httpGet:</span></span>
<span class="line"><span style="color:#393A34;">            path: /health</span></span>
<span class="line"><span style="color:#393A34;">            port: 8080</span></span>
<span class="line"><span style="color:#393A34;">            scheme: HTTP</span></span>
<span class="line"><span style="color:#393A34;">          initialDelaySeconds: 60</span></span>
<span class="line"><span style="color:#393A34;">          timeoutSeconds: 5</span></span>
<span class="line"><span style="color:#393A34;">          successThreshold: 1</span></span>
<span class="line"><span style="color:#393A34;">          failureThreshold: 5</span></span>
<span class="line"><span style="color:#393A34;">        readinessProbe:</span></span>
<span class="line"><span style="color:#393A34;">          httpGet:</span></span>
<span class="line"><span style="color:#393A34;">            path: /ready</span></span>
<span class="line"><span style="color:#393A34;">            port: 8181</span></span>
<span class="line"><span style="color:#393A34;">            scheme: HTTP</span></span>
<span class="line"><span style="color:#393A34;">        securityContext:</span></span>
<span class="line"><span style="color:#393A34;">          allowPrivilegeEscalation: </span><span style="color:#B58451;">false</span></span>
<span class="line"><span style="color:#393A34;">          capabilities:</span></span>
<span class="line"><span style="color:#393A34;">            add:</span></span>
<span class="line"><span style="color:#393A34;">            - NET_BIND_SERVICE</span></span>
<span class="line"><span style="color:#393A34;">            drop:</span></span>
<span class="line"><span style="color:#393A34;">            - all</span></span>
<span class="line"><span style="color:#393A34;">          readOnlyRootFilesystem: </span><span style="color:#B58451;">true</span></span>
<span class="line"><span style="color:#393A34;">      dnsPolicy: Default</span></span>
<span class="line"><span style="color:#393A34;">      volumes:</span></span>
<span class="line"><span style="color:#393A34;">        - name: config-volume</span></span>
<span class="line"><span style="color:#393A34;">          configMap:</span></span>
<span class="line"><span style="color:#393A34;">            name: coredns</span></span>
<span class="line"><span style="color:#393A34;">            items:</span></span>
<span class="line"><span style="color:#393A34;">            - key: Corefile</span></span>
<span class="line"><span style="color:#393A34;">              path: Corefile</span></span>
<span class="line"><span style="color:#393A34;">---</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: Service</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: kube-dns</span></span>
<span class="line"><span style="color:#393A34;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#393A34;">  annotations:</span></span>
<span class="line"><span style="color:#393A34;">    prometheus.io/port: </span><span style="color:#B56959;">&quot;9153&quot;</span></span>
<span class="line"><span style="color:#393A34;">    prometheus.io/scrape: </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">    k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#393A34;">    kubernetes.io/cluster-service: </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">    addonmanager.kubernetes.io/mode: Reconcile</span></span>
<span class="line"><span style="color:#393A34;">    kubernetes.io/name: </span><span style="color:#B56959;">&quot;CoreDNS&quot;</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#393A34;">  selector:</span></span>
<span class="line"><span style="color:#393A34;">    k8s-app: kube-dns</span></span>
<span class="line"><span style="color:#393A34;">  clusterIP: 10.0.0.2 </span></span>
<span class="line"><span style="color:#393A34;">  ports:</span></span>
<span class="line"><span style="color:#393A34;">  - name: dns</span></span>
<span class="line"><span style="color:#393A34;">    port: 53</span></span>
<span class="line"><span style="color:#393A34;">    protocol: UDP</span></span>
<span class="line"><span style="color:#393A34;">  - name: dns-tcp</span></span>
<span class="line"><span style="color:#393A34;">    port: 53</span></span>
<span class="line"><span style="color:#393A34;">    protocol: TCP</span></span>
<span class="line"><span style="color:#393A34;">  - name: metrics</span></span>
<span class="line"><span style="color:#393A34;">    port: 9153</span></span>
<span class="line"><span style="color:#393A34;">    protocol: TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u90E8\u7F72coredns</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl apply -f coredns.yaml </span></span>
<span class="line"><span style="color:#393A34;">serviceaccount/coredns created</span></span>
<span class="line"><span style="color:#393A34;">clusterrole.rbac.authorization.k8s.io/system:coredns created</span></span>
<span class="line"><span style="color:#393A34;">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span></span>
<span class="line"><span style="color:#393A34;">configmap/coredns created</span></span>
<span class="line"><span style="color:#393A34;">deployment.apps/coredns created</span></span>
<span class="line"><span style="color:#393A34;">service/kube-dns created</span></span>
<span class="line"></span></code></pre></div><h3 id="_9-2-\u8FD0\u884C\u4E00\u4E2Abusybox\u5BB9\u5668\u6D4B\u8BD5dns" tabindex="-1">9.2.\u8FD0\u884C\u4E00\u4E2Abusybox\u5BB9\u5668\u6D4B\u8BD5dns <a class="header-anchor" href="#_9-2-\u8FD0\u884C\u4E00\u4E2Abusybox\u5BB9\u5668\u6D4B\u8BD5dns" aria-hidden="true">#</a></h3><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl run -it --rm dns-test --image=busybox:1.28.4 sh</span></span>
<span class="line"><span style="color:#DBD7CA;">If you don</span><span style="color:#C98A7D;">&#39;t see a command prompt, try pressing enter.</span></span>
<span class="line"><span style="color:#C98A7D;">/ # nslookup kubernetes</span></span>
<span class="line"><span style="color:#C98A7D;">Server:    10.0.0.2</span></span>
<span class="line"><span style="color:#C98A7D;">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D;">Name:      kubernetes</span></span>
<span class="line"><span style="color:#C98A7D;">Address 1: 10.0.0.1 kubernetes.default.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D;">/ # nslookup kube-dns.kube-system</span></span>
<span class="line"><span style="color:#C98A7D;">Server:    10.0.0.2</span></span>
<span class="line"><span style="color:#C98A7D;">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D;">Name:      kube-dns.kube-system</span></span>
<span class="line"><span style="color:#C98A7D;">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"><span style="color:#C98A7D;">/ # exit</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl run -it --rm dns-test --image=busybox:1.28.4 sh</span></span>
<span class="line"><span style="color:#393A34;">If you don</span><span style="color:#B56959;">&#39;t see a command prompt, try pressing enter.</span></span>
<span class="line"><span style="color:#B56959;">/ # nslookup kubernetes</span></span>
<span class="line"><span style="color:#B56959;">Server:    10.0.0.2</span></span>
<span class="line"><span style="color:#B56959;">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B56959;">Name:      kubernetes</span></span>
<span class="line"><span style="color:#B56959;">Address 1: 10.0.0.1 kubernetes.default.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B56959;">/ # nslookup kube-dns.kube-system</span></span>
<span class="line"><span style="color:#B56959;">Server:    10.0.0.2</span></span>
<span class="line"><span style="color:#B56959;">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B56959;">Name:      kube-dns.kube-system</span></span>
<span class="line"><span style="color:#B56959;">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"><span style="color:#B56959;">/ # exit</span></span>
<span class="line"></span></code></pre></div><h2 id="_10-\u6269\u5BB9master\u8282\u70B9\u7EC4\u5EFAkubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4" tabindex="-1">10.\u6269\u5BB9master\u8282\u70B9\u7EC4\u5EFAkubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4 <a class="header-anchor" href="#_10-\u6269\u5BB9master\u8282\u70B9\u7EC4\u5EFAkubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4" aria-hidden="true">#</a></h2><h3 id="_10-1-kubernetes\u9AD8\u53EF\u7528\u67B6\u6784\u6982\u5FF5" tabindex="-1">10.1.kubernetes\u9AD8\u53EF\u7528\u67B6\u6784\u6982\u5FF5 <a class="header-anchor" href="#_10-1-kubernetes\u9AD8\u53EF\u7528\u67B6\u6784\u6982\u5FF5" aria-hidden="true">#</a></h3><p>kubernetes\u96C6\u7FA4\u901A\u8FC7\u5065\u5EB7\u68C0\u67E5\u548C\u91CD\u542F\u7B56\u7565\u5B9E\u73B0\u4E86Pod\u6545\u969C\u81EA\u6108\u80FD\u529B\uFF0C\u4E5F\u901A\u8FC7\u8C03\u5EA6\u7B97\u6CD5\u5B9E\u73B0\u5C06Pod\u5206\u5E03\u5F0F\u90E8\u7F72\uFF0C\u5E76\u53EF\u4EE5\u901A\u8FC7\u8BBE\u7F6EPod\u7684\u526F\u672C\u6570\uFF0C\u5B9E\u73B0\u9AD8\u5E76\u53D1\u80FD\u529B\uFF0C\u5373\u4F7FNode\u8282\u70B9\u51FA\u73B0\u6545\u969C\uFF0CMaster\u8282\u70B9\u4E5F\u4F1A\u5C06\u6545\u969C\u7684Node\u8282\u70B9\u4E0A\u7684Pod\u8FC1\u79FB\u5230\u6B63\u5E38\u5DE5\u4F5C\u7684Node\u8282\u70B9\u4E0A\uFF0C\u5B9E\u73B0\u5E94\u7528\u5C42\u7684\u9AD8\u53EF\u7528\u6027</p><p>\u9488\u5BF9Kubernetes\u96C6\u7FA4\uFF0C\u9AD8\u53EF\u7528\u6027\u5305\u62ECEtcd\u6570\u636E\u5E93\u9AD8\u53EF\u7528\u3001Matser\u8282\u70B9\u7EC4\u4EF6\u7684\u9AD8\u53EF\u7528\uFF0CEtcd\u53EF\u4EE5\u901A\u8FC7\u96C6\u7FA4\u65B9\u5F0F\u5B9E\u73B0\u9AD8\u53EF\u7528\uFF0C\u800C\u53EA\u6709\u5355\u53F0Master\u8282\u70B9\uFF0C\u4E00\u65E6Master\u8282\u70B9\u4E0A\u7684\u7EC4\u4EF6\u51FA\u73B0\u4E86\u6545\u969C\uFF0C\u6574\u4E2A\u96C6\u7FA4\u5C06\u4F1A\u4E0D\u53EF\u7528\u3002</p><p>Master\u8282\u70B9\u662F\u5C5E\u4E8E\u63A7\u5236\u6574\u4E2A\u96C6\u7FA4\u7684\u89D2\u8272\uFF0C\u6240\u6709\u7684\u7EC4\u4EF6\u90FD\u9700\u8981\u4E0EMaster\u8282\u70B9\u7684ApiServer\u8FDB\u884C\u4EA4\u4E92\uFF0C\u4E0D\u65AD\u4E0ENode\u8282\u70B9\u4E0A\u7684Kubelet\u548CKube-Proxy\u8FDB\u884C\u901A\u4FE1\u6765\u7EF4\u62A4\u6574\u4E2A\u96C6\u7FA4\u7684\u5DE5\u4F5C\u72B6\u6001\uFF0C\u5982\u679CApiServer\u53D1\u751F\u6545\u969C\uFF0C\u5C06\u65E0\u6CD5\u4E0ENode\u8282\u70B9\u8FDB\u884C\u901A\u4FE1\uFF0C\u4E5F\u5C31\u65E0\u6CD5\u7BA1\u7406\u96C6\u7FA4\u3002</p><p>\u56E0\u6B64Kubernetes\u96C6\u7FA4\u6700\u4E3B\u8981\u7684\u5C31\u662F\u5BF9Master\u8282\u70B9\u8FDB\u884C\u9AD8\u53EF\u7528\u914D\u7F6E\u3002</p><p>Master\u8282\u70B9\u4E3B\u8981\u6709\u4E09\u4E2A\u670D\u52A1\uFF1Akube-apiserver\u3001kube-controller-manage\u3001kube-scheduler\uFF0C\u5F53\u96C6\u7FA4\u6709\u591A\u53F0Master\u8282\u70B9\u65F6\uFF0C\u5176\u4E2Dkube-controller-manage\u548Ckube-scheduler\u90FD\u53EF\u4EE5\u901A\u8FC7\u81EA\u8EAB\u7684\u9009\u4E3E\u673A\u5236\u5B9E\u73B0\u9AD8\u53EF\u7528\uFF0C\u4F46\u662Fkube-apiserver\u5C31\u6CA1\u6709\u8FD9\u79CD\u673A\u5236\uFF0C\u56E0\u6B64\u4E3B\u8981\u9488\u5BF9kube-apiserver\u914D\u7F6E\u9AD8\u53EF\u7528\u5373\u53EF\uFF0Ckube-apiserver\u63D0\u4F9B\u7684\u662FHTTP API\u63A5\u53E3\u670D\u52A1\uFF0C\u56E0\u6B64\u53EF\u4EE5\u50CFweb\u670D\u52A1\u90A3\u79CD\uFF0C\u4F7F\u7528nginx+keepalived\u65B9\u5F0F\u5B9E\u73B0Master\u8282\u70B9\u9AD8\u53EF\u7528\uFF0C\u5E76\u4E14\u4E5F\u53EF\u4EE5\u6C34\u5E73\u6269\u5BB9\u3002</p><p>\u914D\u7F6Ekubernetes\u96C6\u7FA4\u9AD8\u53EF\u7528\u7684\u4E3B\u8981\u6B65\u9AA4\u5C31\u662F\uFF1A</p><p>1\u3001\u589E\u52A0\u4E00\u53F0\u6216\u591A\u53F0Master\u8282\u70B9\uFF0C\u90E8\u7F72Master\u8282\u70B9\u76F8\u5173\u7EC4\u4EF6\uFF0C\u5728\u8FD9\u4E2Amaster\u8282\u70B9\u4E0A\u914D\u7F6E\u7684\u76D1\u542C\u5730\u5740\u8FD8\u662F\u81EA\u8EAB\u7684\u5730\u5740\uFF1B</p><p>2\u3001\u5728\u65B0\u589E\u7684Master\u8282\u70B9\u4E0A\u90E8\u7F72etcd\uFF0C\u4F7Fetcd\u52A0\u5165\u73B0\u6709\u7684etcd\u96C6\u7FA4\uFF0C\u4F7Fetcd\u7684\u6027\u80FD\u66F4\u5F3A\uFF1B</p><p>3\u3001\u914D\u7F6Enginx+keepalived\u5B9E\u73B0Apiserver\u7EC4\u4EF6\u9AD8\u53EF\u7528\uFF1B</p><p>4\u3001\u914D\u7F6E\u6240\u6709\u7684Node\u8282\u70B9\uFF0C\u5C06\u6240\u914D\u7F6E\u7684Apiserver\u5730\u5740\u6539\u6210keepalived\u865A\u62DF\u51FA\u6765\u7684VIP\u5730\u5740\uFF0C\u5B9E\u73B0\u96C6\u7FA4\u9AD8\u53EF\u7528\uFF1B</p><p>\u9AD8\u53EF\u7528kubernetes\u96C6\u7FA4\u4E00\u822C3\u53F0master\u8282\u70B9\u8DB3\u77E3\uFF0C\u4F46\u662Fetcd\u6570\u636E\u5E93\u4E00\u5B9A\u8981\u591A\u591A\u76CA\u5584</p><h3 id="_10-2-\u5728\u96C6\u7FA4\u4E2D\u65B0\u589E\u4E00\u4E2Aetcd\u8282\u70B9" tabindex="-1">10.2.\u5728\u96C6\u7FA4\u4E2D\u65B0\u589E\u4E00\u4E2Aetcd\u8282\u70B9 <a class="header-anchor" href="#_10-2-\u5728\u96C6\u7FA4\u4E2D\u65B0\u589E\u4E00\u4E2Aetcd\u8282\u70B9" aria-hidden="true">#</a></h3><p>\u6269\u5BB9etcd\u6B65\u9AA4\uFF1A</p><p>1\u3001\u90E8\u7F72\u4E00\u53F0\u5355\u8282\u70B9\u7684etcd\uFF0C\u80FD\u591F\u6B63\u5E38\u542F\u52A8\u670D\u52A1</p><p>2\u3001\u5728\u73B0\u6709etcd\u96C6\u7FA4\u4E2D\u589E\u52A0\u65B0\u7684etcd\u8282\u70B9</p><p>3\u3001\u5C06\u5355\u70B9\u7684etcd\u914D\u7F6E\u6210\u96C6\u7FA4\u6A21\u5F0F</p><p>4\u3001\u5220\u9664\u5355\u70B9\u9020\u6210\u7684\u6570\u636E\u6587\u4EF6</p><p>5\u3001\u6240\u6709\u8282\u70B9\u4FEE\u6539\u914D\u7F6E\u6587\u4EF6\u589E\u52A0\u65B0\u7684etcd\u8282\u70B9\u4FE1\u606F</p><p>6\u3001\u91CD\u542F\u6240\u6709etcd\u8282\u70B9</p><h4 id="_10-2-1-\u9996\u5148\u65B0\u589E\u52A0\u4E00\u53F0\u5355\u70B9\u7684etcd" tabindex="-1">10.2.1.\u9996\u5148\u65B0\u589E\u52A0\u4E00\u53F0\u5355\u70B9\u7684etcd <a class="header-anchor" href="#_10-2-1-\u9996\u5148\u65B0\u589E\u52A0\u4E00\u53F0\u5355\u70B9\u7684etcd" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5B89\u88C5etcd\u7A0B\u5E8F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> tar xf etcd-v3.4.9-linux-amd64.tar.gz </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mkdir /data/etcd/{bin,conf,ssl,data} -p</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mv etcd-v3.4.9-linux-amd64/etcd</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;"> /data/etcd/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u521B\u5EFA\u5355\u70B9\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#758575;">#[Service]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_NAME=</span><span style="color:#C98A7D;">&quot;etcd-4&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_DATA_DIR=</span><span style="color:#C98A7D;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;">#[cluster]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER=</span><span style="color:#C98A7D;">&quot;etcd-4=https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#C98A7D;">&quot;new&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u62F7\u8D1D\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp root@192.168.20.10:/data/etcd/ssl/</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;"> /data/etcd/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.\u62F7\u8D1Dsystemctl\u7BA1\u7406\u811A\u672C</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp root@192.168.20.10:/usr/lib/systemd/system/etcd.service /usr/lib/systemd/system/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">6.\u542F\u52A8etcd\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;">  systemctl start etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">7.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep etcd</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.11:2379      0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      15753/etcd          </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 127.0.0.1:2379          0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      15753/etcd          </span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 192.168.20.11:2380      0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      15753/etcd </span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">8.\u67E5\u770B\u8282\u70B9\u72B6\u6001</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> /data/etcd/bin/etcdctl endpoint health --write-out=table</span></span>
<span class="line"><span style="color:#DBD7CA;">+----------------+--------+------------+-------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">    ENDPOINT    </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> HEALTH </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">    TOOK    </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> ERROR </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+----------------+--------+------------+-------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 127.0.0.1:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">   </span><span style="color:#E0A569;">true</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 7.146222ms </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">       </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+----------------+--------+------------+-------+</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5B89\u88C5etcd\u7A0B\u5E8F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> tar xf etcd-v3.4.9-linux-amd64.tar.gz </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mkdir /data/etcd/{bin,conf,ssl,data} -p</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mv etcd-v3.4.9-linux-amd64/etcd</span><span style="color:#AB5959;">*</span><span style="color:#393A34;"> /data/etcd/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u521B\u5EFA\u5355\u70B9\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#A0ADA0;">#[Service]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_NAME=</span><span style="color:#B56959;">&quot;etcd-4&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_DATA_DIR=</span><span style="color:#B56959;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">#[cluster]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER=</span><span style="color:#B56959;">&quot;etcd-4=https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#B56959;">&quot;new&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u62F7\u8D1D\u8BC1\u4E66\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp root@192.168.20.10:/data/etcd/ssl/</span><span style="color:#AB5959;">*</span><span style="color:#393A34;"> /data/etcd/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.\u62F7\u8D1Dsystemctl\u7BA1\u7406\u811A\u672C</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp root@192.168.20.10:/usr/lib/systemd/system/etcd.service /usr/lib/systemd/system/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">6.\u542F\u52A8etcd\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;">  systemctl start etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">7.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep etcd</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.11:2379      0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      15753/etcd          </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 127.0.0.1:2379          0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      15753/etcd          </span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 192.168.20.11:2380      0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      15753/etcd </span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">8.\u67E5\u770B\u8282\u70B9\u72B6\u6001</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> /data/etcd/bin/etcdctl endpoint health --write-out=table</span></span>
<span class="line"><span style="color:#393A34;">+----------------+--------+------------+-------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;">    ENDPOINT    </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> HEALTH </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">    TOOK    </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> ERROR </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+----------------+--------+------------+-------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 127.0.0.1:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">   </span><span style="color:#B58451;">true</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 7.146222ms </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">       </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+----------------+--------+------------+-------+</span></span>
<span class="line"></span></code></pre></div><h4 id="_10-2-2-\u5728\u73B0\u6709etcd\u96C6\u7FA4\u4EFB\u610F\u4E00\u4E2A\u8282\u70B9\u4E0A\u589E\u52A0\u65B0etcd\u8282\u70B9" tabindex="-1">10.2.2.\u5728\u73B0\u6709etcd\u96C6\u7FA4\u4EFB\u610F\u4E00\u4E2A\u8282\u70B9\u4E0A\u589E\u52A0\u65B0etcd\u8282\u70B9 <a class="header-anchor" href="#_10-2-2-\u5728\u73B0\u6709etcd\u96C6\u7FA4\u4EFB\u610F\u4E00\u4E2A\u8282\u70B9\u4E0A\u589E\u52A0\u65B0etcd\u8282\u70B9" aria-hidden="true">#</a></h4><blockquote><p>\u589E\u52A0\u8282\u70B9\u7684\u547D\u4EE4\u4E3A\uFF1A<code>/data/etcd/bin/etcdctl member add \u8282\u70B9\u540D\u79F0 --peer-urls=&quot;\u901A\u4FE1\u5730\u5740&quot;</code></p></blockquote><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u589E\u52A0etcd-4\u8282\u70B9</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> /data/etcd/bin/etcdctl member add etcd-4 --peer-urls=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">Member aae107adddd0d3d8 added to cluster 20b119eb5f91aa4b</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_NAME=</span><span style="color:#C98A7D;">&quot;etcd-4&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER=</span><span style="color:#C98A7D;">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#C98A7D;">&quot;existing&quot;</span></span>
<span class="line"><span style="color:#758575;">#\u8F93\u51FA\u7684\u914D\u7F6E\u4FE1\u606F\u4E00\u5B9A\u8981\u5728\u65B0\u7684etcd-4\u8282\u70B9\u7684\u914D\u7F6E\u6587\u4EF6\u5199\u5165\uFF0C\u5426\u5219\u4F1A\u52A0\u5165\u96C6\u7FA4\u5931\u8D25</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u67E5\u770B\u96C6\u7FA4\u8282\u70B9\u5217\u8868</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> /data/etcd/bin/etcdctl member list --write-out=table</span></span>
<span class="line"><span style="color:#DBD7CA;">+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">        ID        </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">  STATUS   </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">  NAME  </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">         PEER ADDRS         </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">                   CLIENT ADDRS                   </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> IS LEARNER </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 12446003b2a53d43 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">   started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-2 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.12:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> http://127.0.0.1:2379,https://192.168.20.12:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 51ae3f86f3783687 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">   started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-1 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.10:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> http://127.0.0.1:2379,https://192.168.20.10:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 667c9c7ba890c3f7 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">   started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-3 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.13:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> http://127.0.0.1:2379,https://192.168.20.13:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> aae107adddd0d3d8 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> unstarted </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">        </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.11:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">                                                  </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#758575;">#\u53D1\u73B0\u521A\u521A\u65B0\u52A0\u5165\u7684etcd-4\u8282\u70B9\u5904\u4E8Eunstarted\u72B6\u6001\uFF0C\u6211\u4EEC\u9700\u8981\u518D\u914D\u7F6Eetcd-4\u8282\u70B9\u4F7F\u7528\u80FD\u591F\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u589E\u52A0etcd-4\u8282\u70B9</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> /data/etcd/bin/etcdctl member add etcd-4 --peer-urls=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">Member aae107adddd0d3d8 added to cluster 20b119eb5f91aa4b</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">ETCD_NAME=</span><span style="color:#B56959;">&quot;etcd-4&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER=</span><span style="color:#B56959;">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#B56959;">&quot;existing&quot;</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u8F93\u51FA\u7684\u914D\u7F6E\u4FE1\u606F\u4E00\u5B9A\u8981\u5728\u65B0\u7684etcd-4\u8282\u70B9\u7684\u914D\u7F6E\u6587\u4EF6\u5199\u5165\uFF0C\u5426\u5219\u4F1A\u52A0\u5165\u96C6\u7FA4\u5931\u8D25</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u67E5\u770B\u96C6\u7FA4\u8282\u70B9\u5217\u8868</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> /data/etcd/bin/etcdctl member list --write-out=table</span></span>
<span class="line"><span style="color:#393A34;">+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;">        ID        </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">  STATUS   </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">  NAME  </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">         PEER ADDRS         </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">                   CLIENT ADDRS                   </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> IS LEARNER </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 12446003b2a53d43 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">   started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-2 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.12:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> http://127.0.0.1:2379,https://192.168.20.12:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 51ae3f86f3783687 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">   started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-1 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.10:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> http://127.0.0.1:2379,https://192.168.20.10:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 667c9c7ba890c3f7 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">   started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-3 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.13:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> http://127.0.0.1:2379,https://192.168.20.13:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> aae107adddd0d3d8 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> unstarted </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">        </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.11:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">                                                  </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u53D1\u73B0\u521A\u521A\u65B0\u52A0\u5165\u7684etcd-4\u8282\u70B9\u5904\u4E8Eunstarted\u72B6\u6001\uFF0C\u6211\u4EEC\u9700\u8981\u518D\u914D\u7F6Eetcd-4\u8282\u70B9\u4F7F\u7528\u80FD\u591F\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"></span></code></pre></div><h4 id="_10-2-3-\u914D\u7F6E\u65B0\u589E\u7684etcd\u8282\u70B9\u52A0\u5165\u96C6\u7FA4" tabindex="-1">10.2.3.\u914D\u7F6E\u65B0\u589E\u7684etcd\u8282\u70B9\u52A0\u5165\u96C6\u7FA4 <a class="header-anchor" href="#_10-2-3-\u914D\u7F6E\u65B0\u589E\u7684etcd\u8282\u70B9\u52A0\u5165\u96C6\u7FA4" aria-hidden="true">#</a></h4><p>\u5728\u5DF2\u6709\u96C6\u7FA4\u589E\u52A0\u5B8C\u65B0\u8282\u70B9\u4E4B\u540E\uFF0C\u8FD8\u9700\u8981\u5C06\u65B0\u7684etcd\u8282\u70B9\u914D\u7F6E\u6587\u4EF6\u589E\u52A0\u96C6\u7FA4\u76F8\u5173\u5C5E\u6027\uFF0C\u7136\u540E\u5220\u9664\u7531\u5355\u70B9\u65F6\u9020\u6210\u7684etcd\u6570\u636E\u6587\u4EF6\uFF0C\u6700\u540E\u5728\u6240\u6709\u8282\u70B9\u7684\u914D\u7F6E\u6587\u4EF6\u4E2D\u589E\u52A0\u65B0\u8282\u70B9\u7684\u901A\u4FE1\u5730\u5740\uFF0C\u91CD\u542F\u6240\u6709\u8282\u70B9\u7684etcd\u670D\u52A1\uFF0C\u5230\u6B64\u6269\u5BB9\u6210\u529F\u3002</p><p>\u4E3B\u8981\u5728\u65B0\u7684etcd\u8282\u70B9\u4E2D\u914D\u7F6EETCD_NAME\u3001ETCD_INITIAL_CLUSTER\u3001ETCD_INITIAL_CLUSTER_TOKEN\u3001ETCD_INITIAL_CLUSTER_STATE\u8FD9\u4E09\u4E2A\u53C2\u6570\u3002</p><p>ETCD_NAME\uFF1A\u96C6\u7FA4\u8282\u70B9\u540D\u79F0</p><p>ETCD_INITIAL_CLUSTER\uFF1A\u7531\u5355\u70B9\u7684\u4E00\u4E2A\u8282\u70B9\u4FE1\u606F\u6539\u6210\u96C6\u7FA4\u6240\u6709\u8282\u70B9\u7684\u4FE1\u606F</p><p>ETCD_INITIAL_CLUSTER_TOKEN\uFF1A\u586B\u5199\u96C6\u7FA4\u7684\u552F\u4E00\u6807\u8BC6\uFF0C\u8868\u793A\u52A0\u5165\u54EA\u4E2Aetcd\u96C6\u7FA4</p><p>ETCD_INITIAL_CLUSTER_STATE\uFF1A\u96C6\u7FA4\u72B6\u6001\u8C03\u6574\u4E3A\u52A0\u5165\u5DF2\u5B58\u5728\u7684\u96C6\u7FA4</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u4FEE\u6539etcd\u914D\u7F6E\u6587\u4EF6\uFF0C\u589E\u52A0\u96C6\u7FA4\u914D\u7F6E\u53C2\u6570</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#758575;">#[Service]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_NAME=</span><span style="color:#C98A7D;">&quot;etcd-4&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_DATA_DIR=</span><span style="color:#C98A7D;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;">#[cluster]</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#C98A7D;">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER=</span><span style="color:#C98A7D;">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#C98A7D;">&quot;etcd-cluster&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#C98A7D;">&quot;existing&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5220\u9664\u7531\u5355\u70B9\u65F6\u4EA7\u751F\u7684\u6570\u636E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#758575;">#\u5982\u679C\u4E0D\u5220\u9664\uFF0C\u52A0\u5165\u96C6\u7FA4\u65F6\u4F1A\u5931\u8D25</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> rm -rf /data/etcd/data/</span><span style="color:#CB7676;">*</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u6240\u6709etcd\u7684\u914D\u7F6E\u6587\u4EF6\u4E2D\u589E\u52A0\u65B0\u8282\u70B9\u7684\u901A\u4FE1\u5730\u5740</span></span>
<span class="line"><span style="color:#DBD7CA;">\u6CE8\u610F\uFF1A\u6240\u6709etcd\u8282\u70B9\u7684\u914D\u7F6E\u6587\u4EF6\u90FD\u8981\u589E\u52A0\u8FD9\u4E00\u884C\u914D\u7F6E</span></span>
<span class="line"><span style="color:#DBD7CA;">vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">ETCD_INITIAL_CLUSTER=</span><span style="color:#C98A7D;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u91CD\u542F\u6240\u6709\u8282\u70B9\u7684ectd\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart etcd</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart etcd</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart etcd</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.\u518D\u6B21\u67E5\u770B\u96C6\u7FA4\u7684\u8282\u70B9\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> /data/etcd/bin/etcdctl member list --write-out=table</span></span>
<span class="line"><span style="color:#DBD7CA;">+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">        ID        </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> STATUS  </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">  NAME  </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">         PEER ADDRS         </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">                   CLIENT ADDRS                   </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> IS LEARNER </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 12446003b2a53d43 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-2 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.12:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> http://127.0.0.1:2379,https://192.168.20.12:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 51ae3f86f3783687 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-1 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.10:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> http://127.0.0.1:2379,https://192.168.20.10:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> 667c9c7ba890c3f7 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-3 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.13:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> http://127.0.0.1:2379,https://192.168.20.13:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> aae107adddd0d3d8 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> started </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> etcd-4 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> https://192.168.20.11:2380 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> http://127.0.0.1:2379,https://192.168.20.11:2379 </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;">      </span><span style="color:#E0A569;">false</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#758575;">#etcd\u5230\u6B64\u6269\u5BB9\u6210\u529F</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u4FEE\u6539etcd\u914D\u7F6E\u6587\u4EF6\uFF0C\u589E\u52A0\u96C6\u7FA4\u914D\u7F6E\u53C2\u6570</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#A0ADA0;">#[Service]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_NAME=</span><span style="color:#B56959;">&quot;etcd-4&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_DATA_DIR=</span><span style="color:#B56959;">&quot;/data/etcd/data&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_LISTEN_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">#[cluster]</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_ADVERTISE_PEER_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_ADVERTISE_CLIENT_URLS=</span><span style="color:#B56959;">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER=</span><span style="color:#B56959;">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_TOKEN=</span><span style="color:#B56959;">&quot;etcd-cluster&quot;</span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER_STATE=</span><span style="color:#B56959;">&quot;existing&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u5220\u9664\u7531\u5355\u70B9\u65F6\u4EA7\u751F\u7684\u6570\u636E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5982\u679C\u4E0D\u5220\u9664\uFF0C\u52A0\u5165\u96C6\u7FA4\u65F6\u4F1A\u5931\u8D25</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> rm -rf /data/etcd/data/</span><span style="color:#AB5959;">*</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u6240\u6709etcd\u7684\u914D\u7F6E\u6587\u4EF6\u4E2D\u589E\u52A0\u65B0\u8282\u70B9\u7684\u901A\u4FE1\u5730\u5740</span></span>
<span class="line"><span style="color:#393A34;">\u6CE8\u610F\uFF1A\u6240\u6709etcd\u8282\u70B9\u7684\u914D\u7F6E\u6587\u4EF6\u90FD\u8981\u589E\u52A0\u8FD9\u4E00\u884C\u914D\u7F6E</span></span>
<span class="line"><span style="color:#393A34;">vim /data/etcd/conf/etcd.conf </span></span>
<span class="line"><span style="color:#393A34;">ETCD_INITIAL_CLUSTER=</span><span style="color:#B56959;">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u91CD\u542F\u6240\u6709\u8282\u70B9\u7684ectd\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart etcd</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart etcd</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart etcd</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.\u518D\u6B21\u67E5\u770B\u96C6\u7FA4\u7684\u8282\u70B9\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> /data/etcd/bin/etcdctl member list --write-out=table</span></span>
<span class="line"><span style="color:#393A34;">+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;">        ID        </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> STATUS  </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">  NAME  </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">         PEER ADDRS         </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">                   CLIENT ADDRS                   </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> IS LEARNER </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 12446003b2a53d43 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-2 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.12:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> http://127.0.0.1:2379,https://192.168.20.12:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 51ae3f86f3783687 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-1 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.10:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> http://127.0.0.1:2379,https://192.168.20.10:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> 667c9c7ba890c3f7 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-3 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.13:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> http://127.0.0.1:2379,https://192.168.20.13:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#AB5959;">|</span><span style="color:#393A34;"> aae107adddd0d3d8 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> started </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> etcd-4 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> https://192.168.20.11:2380 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> http://127.0.0.1:2379,https://192.168.20.11:2379 </span><span style="color:#AB5959;">|</span><span style="color:#393A34;">      </span><span style="color:#B58451;">false</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+</span></span>
<span class="line"><span style="color:#A0ADA0;">#etcd\u5230\u6B64\u6269\u5BB9\u6210\u529F</span></span>
<span class="line"></span></code></pre></div><h4 id="_10-2-4-\u914D\u7F6Ekube-apiserver\u589E\u52A0\u65B0\u7684etcd\u8282\u70B9" tabindex="-1">10.2.4.\u914D\u7F6Ekube-apiserver\u589E\u52A0\u65B0\u7684etcd\u8282\u70B9 <a class="header-anchor" href="#_10-2-4-\u914D\u7F6Ekube-apiserver\u589E\u52A0\u65B0\u7684etcd\u8282\u70B9" aria-hidden="true">#</a></h4><p>etcd\u8282\u70B9\u65B0\u589E\u5B8C\uFF0C\u9700\u8981\u914D\u7F6E\u4E0Bkube-apiserver\u7EC4\u4EF6\uFF0C\u589E\u52A0\u65B0\u7684etcd\u8282\u70B9\u4FE1\u606F\u3002</p><p>\u6CE8\u610F\u6240\u6709k8s master\u8282\u70B9\u90FD\u5FC5\u987B\u4FEE\u6539\u914D\u7F6Ekube-apiserver.conf\u6587\u4EF6\u589E\u52A0\u65B0\u7684etcd\u8282\u70B9\uFF0C\u5426\u5219etcd\u4E5F\u4E0D\u4F1A\u4E3Ak8s\u6240\u7528\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.master\u8282\u70B9\u4FEE\u6539\u914D\u7F6E\u6587\u4EF6\u589E\u52A0\u65B0\u7684etcd\u8282\u70B9</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-apiserver.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#DBD7CA;">--etcd-servers=https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379,https://192.168.20.11:2379 \\</span></span>
<span class="line"><span style="color:#DBD7CA;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u91CD\u542Fapiserver\u7EC4\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart kube-apiserver</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u67E5\u770B\u7EC4\u4EF6\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get cs -o wide</span></span>
<span class="line"><span style="color:#DBD7CA;">Warning: v1 ComponentStatus is deprecated </span><span style="color:#4D9375;">in</span><span style="color:#DBD7CA;"> v1.19+</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 STATUS    MESSAGE             ERROR</span></span>
<span class="line"><span style="color:#DBD7CA;">controller-manager   Healthy   ok                  </span></span>
<span class="line"><span style="color:#DBD7CA;">scheduler            Healthy   ok                  </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-2               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-0               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-3               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-1               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.master\u8282\u70B9\u4FEE\u6539\u914D\u7F6E\u6587\u4EF6\u589E\u52A0\u65B0\u7684etcd\u8282\u70B9</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-apiserver.conf </span></span>
<span class="line"><span style="color:#393A34;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#393A34;">--etcd-servers=https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379,https://192.168.20.11:2379 \\</span></span>
<span class="line"><span style="color:#393A34;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u91CD\u542Fapiserver\u7EC4\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart kube-apiserver</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u67E5\u770B\u7EC4\u4EF6\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get cs -o wide</span></span>
<span class="line"><span style="color:#393A34;">Warning: v1 ComponentStatus is deprecated </span><span style="color:#1C6B48;">in</span><span style="color:#393A34;"> v1.19+</span></span>
<span class="line"><span style="color:#393A34;">NAME                 STATUS    MESSAGE             ERROR</span></span>
<span class="line"><span style="color:#393A34;">controller-manager   Healthy   ok                  </span></span>
<span class="line"><span style="color:#393A34;">scheduler            Healthy   ok                  </span></span>
<span class="line"><span style="color:#393A34;">etcd-2               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"><span style="color:#393A34;">etcd-0               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"><span style="color:#393A34;">etcd-3               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"><span style="color:#393A34;">etcd-1               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"></span></code></pre></div><h3 id="_10-3-\u90E8\u7F72master-2\u8282\u70B9" tabindex="-1">10.3.\u90E8\u7F72master-2\u8282\u70B9 <a class="header-anchor" href="#_10-3-\u90E8\u7F72master-2\u8282\u70B9" aria-hidden="true">#</a></h3><p>\u7531\u4E8E\u6240\u6709\u7EC4\u4EF6\u90FD\u662F\u4E8C\u8FDB\u5236\u65B9\u5F0F\u90E8\u7F72\u7684\uFF0C\u56E0\u6B64\u53EF\u4EE5\u5728master1\u4E0A\u5C06\u76EE\u5F55\u76F4\u63A5\u62F7\u8D1D\u81F3master2\u4E0A\u5373\u53EF\u4F7F\u7528\u3002</p><h4 id="_10-3-1-\u90E8\u7F72docker" tabindex="-1">10.3.1.\u90E8\u7F72docker <a class="header-anchor" href="#_10-3-1-\u90E8\u7F72docker" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5B89\u88C5docker</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> tar xf docker-19.03.9.tgz </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp docker/</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;"> /usr/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u62F7\u8D1Dmaster1\u8282\u70B9\u4E0A\u7684docker\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp root@binary-k8s-master1:/etc/docker /etc/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u62F7\u8D1Dmaster1\u8282\u70B9\u4E0A\u7684docker systemctl\u811A\u672C</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp root@binary-k8s-master1:/usr/lib/systemd/system/docker.service /usr/lib/systemd/system/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u542F\u52A8docker</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start docker</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> docker</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5B89\u88C5docker</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> tar xf docker-19.03.9.tgz </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp docker/</span><span style="color:#AB5959;">*</span><span style="color:#393A34;"> /usr/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u62F7\u8D1Dmaster1\u8282\u70B9\u4E0A\u7684docker\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp root@binary-k8s-master1:/etc/docker /etc/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u62F7\u8D1Dmaster1\u8282\u70B9\u4E0A\u7684docker systemctl\u811A\u672C</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp root@binary-k8s-master1:/usr/lib/systemd/system/docker.service /usr/lib/systemd/system/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u542F\u52A8docker</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start docker</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> docker</span></span>
<span class="line"></span></code></pre></div><h4 id="_10-3-2-\u90E8\u7F72kubernetes\u5404\u4E2A\u7EC4\u4EF6" tabindex="-1">10.3.2.\u90E8\u7F72kubernetes\u5404\u4E2A\u7EC4\u4EF6 <a class="header-anchor" href="#_10-3-2-\u90E8\u7F72kubernetes\u5404\u4E2A\u7EC4\u4EF6" aria-hidden="true">#</a></h4><p>\u7531\u4E8E\u662F\u4E8C\u8FDB\u5236\u90E8\u7F72\uFF0C\u76F4\u63A5\u62F7\u8D1Dmaster1\u8282\u70B9\u4E0A\u7684/data/kubernetes\u76EE\u5F55\u5373\u53EF\uFF0C/data/kubernetes\u76EE\u5F55\u4E0B\u5305\u542B\u4E86\u6240\u6709\u7684master\u4EE5\u53CAnode\u76F8\u5173\u7EC4\u4EF6</p><p>master\u8282\u70B9\u9700\u8981\u5B89\u88C5\u6240\u6709\u7684master\u7EC4\u4EF6\u548Cnode\u7EC4\u4EF6\u3002</p><p><strong>1.\u51C6\u5907\u4E8C\u8FDB\u5236\u7A0B\u5E8F</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u62F7\u8D1D\u7EC4\u4EF6\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /data/kubernetes root@binary-k8s-master2:/data</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp /usr/bin/kubectl root@binary-k8s-master2:/usr/bin</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /usr/lib/systemd/system/kube</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;"> root@binary-k8s-master2:/usr/lib/systemd/system/</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp .kube root@binary-k8s-master2:/root</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5982\u679C\u6CA1\u6709\u6269\u5BB9\u65B0\u7684etcd\u8282\u70B9\u7684\u60C5\u51B5\u9700\u8981\u62F7\u8D1Detcd\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> scp -rp /data/etcd/ssl root@binary-k8s-master2:/data/etcd/ss</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u5220\u9664kubelet\u6587\u4EF6</span></span>
<span class="line"><span style="color:#758575;">#kubelet\u67D0\u4E9B\u95EE\u9898\u90FD\u662F\u52A8\u6001\u751F\u6210\u7684\uFF0C\u4E14\u6BCF\u4E2A\u8282\u70B9\u90FD\u4E0D\u76F8\u540C\uFF0C\u56E0\u6B64\u9700\u8981\u5220\u9664\u91CD\u65B0\u751F\u6210</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> rm -rf /data/kubernetes/config/kubelet.kubeconfig </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> rm -rf /data/kubernetes/ssl/kubelet-client-</span><span style="color:#CB7676;">*</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u62F7\u8D1D\u7EC4\u4EF6\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /data/kubernetes root@binary-k8s-master2:/data</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp /usr/bin/kubectl root@binary-k8s-master2:/usr/bin</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /usr/lib/systemd/system/kube</span><span style="color:#AB5959;">*</span><span style="color:#393A34;"> root@binary-k8s-master2:/usr/lib/systemd/system/</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp .kube root@binary-k8s-master2:/root</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u5982\u679C\u6CA1\u6709\u6269\u5BB9\u65B0\u7684etcd\u8282\u70B9\u7684\u60C5\u51B5\u9700\u8981\u62F7\u8D1Detcd\u8BC1\u4E66</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> scp -rp /data/etcd/ssl root@binary-k8s-master2:/data/etcd/ss</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u5220\u9664kubelet\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A0ADA0;">#kubelet\u67D0\u4E9B\u95EE\u9898\u90FD\u662F\u52A8\u6001\u751F\u6210\u7684\uFF0C\u4E14\u6BCF\u4E2A\u8282\u70B9\u90FD\u4E0D\u76F8\u540C\uFF0C\u56E0\u6B64\u9700\u8981\u5220\u9664\u91CD\u65B0\u751F\u6210</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> rm -rf /data/kubernetes/config/kubelet.kubeconfig </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> rm -rf /data/kubernetes/ssl/kubelet-client-</span><span style="color:#AB5959;">*</span></span>
<span class="line"></span></code></pre></div><p><strong>2.\u4FEE\u6539\u5404\u4E2A\u7EC4\u4EF6\u7684\u914D\u7F6E\u6587\u4EF6</strong></p><p>\u4E3B\u8981\u5C31\u662F\u4FEE\u6539\u5404\u4E2A\u7EC4\u4EF6\u76D1\u542C\u7684\u672C\u673Aip\u5730\u5740\u548C\u8282\u70B9\u540D\u79F0\uFF0C\u751F\u6210\u7684kubeconfig\u6587\u4EF6\u4E2D\u7684apiserver\u5730\u5740\u65E0\u9700\u66F4\u6539\uFF0C\u4FDD\u6301master1\u5373\u53EF\uFF0C\u56E0\u4E3A\u6700\u540E\u9AD8\u53EF\u7528\u7684\u65F6\u5019\u8FD8\u662F\u4F1A\u6539\u6210VIP\u5730\u5740\uFF0C\u5F53\u524D\u65E0\u9700\u66F4\u6539\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u4FEE\u6539kube-apiserver\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-apiserver.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#DBD7CA;">--bind-address=192.168.20.11  \\</span></span>
<span class="line"><span style="color:#DBD7CA;">--advertise-address=192.168.20.11 \\</span></span>
<span class="line"><span style="color:#DBD7CA;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u4FEE\u6539kube-controller-manager\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-controller-manager.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#DBD7CA;">--bind-address=192.168.20.11 \\</span></span>
<span class="line"><span style="color:#DBD7CA;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u4FEE\u6539kube-scheduler\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /data/kubernetes/config/kube-scheduler.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#DBD7CA;">--bind-address=192.168.20.11</span><span style="color:#C98A7D;">&quot;</span></span>
<span class="line"><span style="color:#C98A7D;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D;">4.\u4FEE\u6539kubelet\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#C98A7D;">[root@binary-k8s-master2 ~]\\# vim /data/kubernetes/config/kubelet.conf </span></span>
<span class="line"><span style="color:#C98A7D;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#C98A7D;">--hostname-override=binary-k8s-master2 </span><span style="color:#D4976C;">\\</span></span>
<span class="line"><span style="color:#C98A7D;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D;">5.\u4FEE\u6539kube-apiserver\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#C98A7D;">[root@binary-k8s-master2 ~]\\# vim /data/kubernetes/config/kube-proxy-config.yml </span></span>
<span class="line"><span style="color:#C98A7D;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#C98A7D;">hostnameOverride: binary-k8s-master2</span></span>
<span class="line"><span style="color:#C98A7D;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u4FEE\u6539kube-apiserver\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-apiserver.conf </span></span>
<span class="line"><span style="color:#393A34;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#393A34;">--bind-address=192.168.20.11  \\</span></span>
<span class="line"><span style="color:#393A34;">--advertise-address=192.168.20.11 \\</span></span>
<span class="line"><span style="color:#393A34;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u4FEE\u6539kube-controller-manager\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-controller-manager.conf </span></span>
<span class="line"><span style="color:#393A34;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#393A34;">--bind-address=192.168.20.11 \\</span></span>
<span class="line"><span style="color:#393A34;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u4FEE\u6539kube-scheduler\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /data/kubernetes/config/kube-scheduler.conf </span></span>
<span class="line"><span style="color:#393A34;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#393A34;">--bind-address=192.168.20.11</span><span style="color:#B56959;">&quot;</span></span>
<span class="line"><span style="color:#B56959;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B56959;">4.\u4FEE\u6539kubelet\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#B56959;">[root@binary-k8s-master2 ~]\\# vim /data/kubernetes/config/kubelet.conf </span></span>
<span class="line"><span style="color:#B56959;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#B56959;">--hostname-override=binary-k8s-master2 </span><span style="color:#A65E2B;">\\</span></span>
<span class="line"><span style="color:#B56959;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B56959;">5.\u4FEE\u6539kube-apiserver\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684IP\u5730\u5740</span></span>
<span class="line"><span style="color:#B56959;">[root@binary-k8s-master2 ~]\\# vim /data/kubernetes/config/kube-proxy-config.yml </span></span>
<span class="line"><span style="color:#B56959;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"><span style="color:#B56959;">hostnameOverride: binary-k8s-master2</span></span>
<span class="line"><span style="color:#B56959;">\xB7\xB7\xB7\xB7\xB7\xB7</span></span>
<span class="line"></span></code></pre></div><p><strong>3.\u542F\u52A8\u5404\u4E2A\u7EC4\u4EF6</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl daemon-reload </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-apiserver</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-controller-manager</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-scheduler</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kubelet</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start kube-proxy</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-apiserver</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-controller-manager</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-scheduler</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kubelet</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> kube-proxy</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl daemon-reload </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-apiserver</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-controller-manager</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-scheduler</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kubelet</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start kube-proxy</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-apiserver</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-controller-manager</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-scheduler</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kubelet</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> kube-proxy</span></span>
<span class="line"></span></code></pre></div><h4 id="_10-3-3-\u6388\u6743master2\u8282\u70B9\u52A0\u5165\u96C6\u7FA4" tabindex="-1">10.3.3.\u6388\u6743master2\u8282\u70B9\u52A0\u5165\u96C6\u7FA4 <a class="header-anchor" href="#_10-3-3-\u6388\u6743master2\u8282\u70B9\u52A0\u5165\u96C6\u7FA4" aria-hidden="true">#</a></h4><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u67E5\u770B\u6388\u6743\u65B0\u7CFB\u5217\u8868</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get csr</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION</span></span>
<span class="line"><span style="color:#DBD7CA;">node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE   4m45s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u6388\u6743\u901A\u8FC7</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl certificate approve node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE</span></span>
<span class="line"><span style="color:#DBD7CA;">certificatesigningrequest.certificates.k8s.io/node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE approved</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u67E5\u770B\u662F\u5426\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get node</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 STATUS   ROLES    AGE     VERSION</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-master1   Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   4d21h   v1.20.4</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-master2   Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   4m33s   v1.20.4</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-node1     Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   2d3h    v1.20.4</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-node2     Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   45h     v1.20.4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u67E5\u770B\u6838\u5FC3\u7EC4\u4EF6\u72B6\u6001</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get cs</span></span>
<span class="line"><span style="color:#DBD7CA;">Warning: v1 ComponentStatus is deprecated </span><span style="color:#4D9375;">in</span><span style="color:#DBD7CA;"> v1.19+</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 STATUS    MESSAGE             ERROR</span></span>
<span class="line"><span style="color:#DBD7CA;">controller-manager   Healthy   ok                  </span></span>
<span class="line"><span style="color:#DBD7CA;">scheduler            Healthy   ok                  </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-1               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-2               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-0               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u67E5\u770B\u6388\u6743\u65B0\u7CFB\u5217\u8868</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get csr</span></span>
<span class="line"><span style="color:#393A34;">NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION</span></span>
<span class="line"><span style="color:#393A34;">node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE   4m45s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u6388\u6743\u901A\u8FC7</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl certificate approve node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE</span></span>
<span class="line"><span style="color:#393A34;">certificatesigningrequest.certificates.k8s.io/node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE approved</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u67E5\u770B\u662F\u5426\u52A0\u5165\u96C6\u7FA4</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get node</span></span>
<span class="line"><span style="color:#393A34;">NAME                 STATUS   ROLES    AGE     VERSION</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-master1   Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   4d21h   v1.20.4</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-master2   Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   4m33s   v1.20.4</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-node1     Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   2d3h    v1.20.4</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-node2     Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   45h     v1.20.4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u67E5\u770B\u6838\u5FC3\u7EC4\u4EF6\u72B6\u6001</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get cs</span></span>
<span class="line"><span style="color:#393A34;">Warning: v1 ComponentStatus is deprecated </span><span style="color:#1C6B48;">in</span><span style="color:#393A34;"> v1.19+</span></span>
<span class="line"><span style="color:#393A34;">NAME                 STATUS    MESSAGE             ERROR</span></span>
<span class="line"><span style="color:#393A34;">controller-manager   Healthy   ok                  </span></span>
<span class="line"><span style="color:#393A34;">scheduler            Healthy   ok                  </span></span>
<span class="line"><span style="color:#393A34;">etcd-1               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"><span style="color:#393A34;">etcd-2               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"><span style="color:#393A34;">etcd-0               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"></span></code></pre></div><h3 id="_10-4-\u90E8\u7F72nginx-keepalived\u5B9E\u73B0kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4" tabindex="-1">10.4.\u90E8\u7F72Nginx+Keepalived\u5B9E\u73B0kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4 <a class="header-anchor" href="#_10-4-\u90E8\u7F72nginx-keepalived\u5B9E\u73B0kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4" aria-hidden="true">#</a></h3><p>keepalived\u662F\u4E3B\u6D41\u7684\u9AD8\u53EF\u7528\u8F6F\u4EF6\uFF0C\u57FA\u4E8EVIP\u7ED1\u5B9A\u5B9E\u73B0\u670D\u52A1\u5668\u7684\u53CC\u673A\u70ED\u5907\uFF0C\u53EF\u4EE5\u7406\u89E3\u4E3Akeepalived\u662F\u9488\u5BF9\u670D\u52A1\u5668IP\u7684\u9AD8\u53EF\u7528\u96C6\u7FA4\uFF0C\u5982\u679CA\u673A\u5668\u5B95\u673A\u4E86\uFF0CB\u673A\u5668\u4F1A\u7ACB\u523B\u6210\u4E3Amaster\u89D2\u8272\uFF0C\u62A2\u5360VIP\u5730\u5740\uFF0C\u4F7F\u5176\u4E0D\u95F4\u65AD\u7684\u63D0\u4F9B\u670D\u52A1\uFF0C\u4ECE\u800C\u5F62\u6210\u9AD8\u53EF\u7528\u96C6\u7FA4\u3002</p><p>\u4F7F\u7528nginx+keepalived\u505A\u5F97k8s master\u8282\u70B9\u9AD8\u53EF\u7528\u96C6\u7FA4\uFF0C\u53EA\u8981master\u8282\u70B9\u4E0A\u9762\u6CA1\u6709etcd\u7EC4\u4EF6\uFF0C\u90A3\u4E48\u6574\u4E2A\u96C6\u7FA4master\u8282\u70B9\u53EA\u8981\u6709\u4E00\u4E2A\u5DE5\u4F5C\u6B63\u5E38\uFF0C\u6574\u4E2A\u96C6\u7FA4\u5C31\u4E0D\u4F1A\u5B95\u673A\u3002</p><p>\u751F\u4EA7\u73AF\u5883\u4E2Dnginx+keepalived\u662F\u72EC\u7ACB\u4E8E\u96C6\u7FA4\u4E4B\u5916\u7684\u4E24\u53F0\u670D\u52A1\u5668\uFF0C\u9AD8\u53EF\u7528\u96C6\u7FA4\u4E00\u822C\u60C5\u51B5\u4E0B\u90FD\u662F\u4E00\u4E3B\u4E00\u5907\uFF0C\u4E24\u4E2A\u8282\u70B9\u5C31\u53EF\u4EE5\u6EE1\u8DB3\u6B63\u5E38\u9700\u6C42\uFF0C\u6B63\u597Dmaster\u8282\u70B9\u67092\u4E2A\uFF0C\u53EF\u4EE5\u5728\u4E24\u4E2Amaster\u4E0A\u90FD\u90E8\u7F72nginx\u548Ckeepalived\u5F62\u6210\u9AD8\u53EF\u7528\u96C6\u7FA4\u3002</p><p>\u6211\u4EEC\u91C7\u7528nginx\u56DB\u5C42\u8D1F\u8F7D\u5747\u8861\uFF0C\u56DB\u5C42\u8D1F\u8F7D\u5747\u8861\u7684\u4F5C\u7528\u5C31\u662F\u5BF9IP\u8FDB\u884C\u8D1F\u8F7D\uFF0C\u4E0D\u6D89\u53CA\u5E94\u7528\u5C42\uFF0C\u7531\u4E8E\u6211\u4EEC\u4F7F\u7528keepalived\u505A\u9AD8\u53EF\u7528\u96C6\u7FA4\uFF0Ckeepalived\u5C31\u662F\u9488\u5BF9IP\u5730\u5740\u5B9E\u73B0\u9AD8\u53EF\u7528\uFF0C\u56E0\u6B64\u9700\u8981\u914D\u5408nginx\u56DB\u5C42\u8D1F\u8F7D\u5747\u8861\u6765\u5B9E\u73B0\uFF0C\u5F53\u7528\u6237\u8BBF\u95EEkeepalived\u7684VIP\u65F6\uFF0C\u76F4\u63A5\u5C06\u8BF7\u6C42\u8F6C\u53D1\u5230\u5BF9\u5E94\u7684master\u89D2\u8272\u4E3B\u673A\u4E0A\uFF0C\u5C06VIP\u5730\u5740\u8F6C\u6362\u6210master\u8282\u70B9IP+\u7AEF\u53E3\uFF0C\u8FD9\u6837\u4E00\u6765\uFF0C\u5373\u4F7Fmaster1\u6302\u6389\u4E86\uFF0Cmaster2\u6210\u4E3A\u4E86master\u89D2\u8272\uFF0C\u8BF7\u6C42\u8F6C\u53D1\u8FDB\u6765\uFF0C\u4E5F\u4F1A\u5C06VIP\u8F6C\u6362\u6210master2\u8282\u70B9\u7684\u5730\u5740\uFF0C\u9AD8\u53EF\u7528\u4E5F\u5C31\u5B9E\u73B0\u4E86\u3002</p><p><strong>kube-apiserver\u9AD8\u53EF\u7528\u67B6\u6784\u56FE</strong></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/4166bf6696044bc1b4f47efb7cf03acd.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h4 id="_10-4-1-\u90E8\u7F72nginx\u8D1F\u8F7D\u5747\u8861" tabindex="-1">10.4.1.\u90E8\u7F72Nginx\u8D1F\u8F7D\u5747\u8861 <a class="header-anchor" href="#_10-4-1-\u90E8\u7F72nginx\u8D1F\u8F7D\u5747\u8861" aria-hidden="true">#</a></h4><p>master1\u548Cmaster2\u4E0A\u7684nginx\u90E8\u7F72\u548C\u914D\u7F6E\u6587\u4EF6\u5185\u5BB9\u4E00\u6837\uFF0C\u8FD9\u91CC\u53EA\u5199master1\u7684\u64CD\u4F5C\u6B65\u9AA4\u3002</p><p>nginx\u8D1F\u8F7D\u5747\u8861\u91C7\u7528\u56DB\u5C42\u8D1F\u8F7D\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5B89\u88C5nginx\u548Ckeepalived\u53CAnginx\u56DB\u5C42\u8D1F\u8F7D\u5747\u8861\u6A21\u5757\u7B49\u8F6F\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;">  yum -y install nginx keepalived nginx-mod-stream</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u4FEE\u6539nginx\u4E3B\u914D\u7F6E\u6587\u4EF6\u589E\u52A0include\u6A21\u5757\u5F15\u51654\u5C42\u8D1F\u8F7D\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /etc/nginx/nginx.conf</span></span>
<span class="line"><span style="color:#DBD7CA;">include /etc/nginx/conf.c/</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">.conf</span><span style="color:#CB7676;">;</span><span style="color:#DBD7CA;">			</span><span style="color:#758575;">#17\u884C\u5DE6\u53F3\uFF0C\u4E0Ehttp\u6A21\u5757\u540C\u7EA7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u7F16\u5199\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mkdir /etc/nginx/conf.c</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /etc/nginx/conf.c/k8s-apiserver.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">stream </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">	log_format  main  </span><span style="color:#C98A7D;">&#39;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#39;</span><span style="color:#CB7676;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">	access_log /var/log/nginx/k8s-apiserver.log main</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">	</span></span>
<span class="line"><span style="color:#DBD7CA;">	upstream k8s-apiserver </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">		server 192.168.20.11:6443</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">		server 192.168.20.12:6443</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">	</span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">	</span></span>
<span class="line"><span style="color:#DBD7CA;">	server </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">		listen 16443</span><span style="color:#CB7676;">;</span><span style="color:#DBD7CA;">			</span><span style="color:#758575;">#\u7531\u4E8E\u6211\u4EEC\u7684nginx\u4E0Ek8s master\u5728\u540C\u4E00\u53F0\u673A\u5668\u4E0A\uFF0C\u9632\u6B62\u7AEF\u53E3\u51B2\u7A81\uFF0C\u56E0\u6B64\u6539\u4E3A16443\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#DBD7CA;">		proxy_pass k8s-apiserver</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">	</span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u542F\u52A8nginx</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> nginx -t</span></span>
<span class="line"><span style="color:#DBD7CA;">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span></span>
<span class="line"><span style="color:#DBD7CA;">nginx: configuration file /etc/nginx/nginx.conf </span><span style="color:#E0A569;">test</span><span style="color:#DBD7CA;"> is successful</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> nginx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep 16443</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp        0      0 0.0.0.0:16443           0.0.0.0:</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">               LISTEN      3181/nginx: worker </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5B89\u88C5nginx\u548Ckeepalived\u53CAnginx\u56DB\u5C42\u8D1F\u8F7D\u5747\u8861\u6A21\u5757\u7B49\u8F6F\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;">  yum -y install nginx keepalived nginx-mod-stream</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u4FEE\u6539nginx\u4E3B\u914D\u7F6E\u6587\u4EF6\u589E\u52A0include\u6A21\u5757\u5F15\u51654\u5C42\u8D1F\u8F7D\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /etc/nginx/nginx.conf</span></span>
<span class="line"><span style="color:#393A34;">include /etc/nginx/conf.c/</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">.conf</span><span style="color:#AB5959;">;</span><span style="color:#393A34;">			</span><span style="color:#A0ADA0;">#17\u884C\u5DE6\u53F3\uFF0C\u4E0Ehttp\u6A21\u5757\u540C\u7EA7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u7F16\u5199\u914D\u7F6E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mkdir /etc/nginx/conf.c</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /etc/nginx/conf.c/k8s-apiserver.conf </span></span>
<span class="line"><span style="color:#393A34;">stream </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">	log_format  main  </span><span style="color:#B56959;">&#39;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#39;</span><span style="color:#AB5959;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">	access_log /var/log/nginx/k8s-apiserver.log main</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">	</span></span>
<span class="line"><span style="color:#393A34;">	upstream k8s-apiserver </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">		server 192.168.20.11:6443</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">		server 192.168.20.12:6443</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">	</span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">	</span></span>
<span class="line"><span style="color:#393A34;">	server </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">		listen 16443</span><span style="color:#AB5959;">;</span><span style="color:#393A34;">			</span><span style="color:#A0ADA0;">#\u7531\u4E8E\u6211\u4EEC\u7684nginx\u4E0Ek8s master\u5728\u540C\u4E00\u53F0\u673A\u5668\u4E0A\uFF0C\u9632\u6B62\u7AEF\u53E3\u51B2\u7A81\uFF0C\u56E0\u6B64\u6539\u4E3A16443\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#393A34;">		proxy_pass k8s-apiserver</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">	</span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u542F\u52A8nginx</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> nginx -t</span></span>
<span class="line"><span style="color:#393A34;">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span></span>
<span class="line"><span style="color:#393A34;">nginx: configuration file /etc/nginx/nginx.conf </span><span style="color:#B58451;">test</span><span style="color:#393A34;"> is successful</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> nginx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.\u67E5\u770B\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep 16443</span></span>
<span class="line"><span style="color:#393A34;">tcp        0      0 0.0.0.0:16443           0.0.0.0:</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">               LISTEN      3181/nginx: worker </span></span>
<span class="line"></span></code></pre></div><h4 id="_10-4-2-\u90E8\u7F72keepalived\u53CC\u673A\u70ED\u5907" tabindex="-1">10.4.2.\u90E8\u7F72keepalived\u53CC\u673A\u70ED\u5907 <a class="header-anchor" href="#_10-4-2-\u90E8\u7F72keepalived\u53CC\u673A\u70ED\u5907" aria-hidden="true">#</a></h4><p>\u5728\u914D\u7F6Ekeepalived\u7684\u65F6\u5019\u4E5F\u9700\u8981\u914D\u7F6E\u4E00\u4E2A<strong>vrrp_script</strong>\u6A21\u5757\uFF0Ckeepalived\u53EA\u80FD\u505A\u5230\u5BF9\u7F51\u7EDC\u6545\u969C\u548Ckeepalived\u672C\u8EAB\u7684\u76D1\u63A7\uFF0C\u5373\u5F53\u51FA\u73B0\u7F51\u7EDC\u6545\u969C\u6216\u8005keepalived\u672C\u8EAB\u51FA\u73B0\u95EE\u9898\u65F6\uFF0C\u8FDB\u884C\u5207\u6362\u3002\u4F46\u662F\u8FD9\u4E9B\u8FD8\u4E0D\u591F\uFF0C\u6211\u4EEC\u8FD8\u9700\u8981\u76D1\u63A7keepalived\u6240\u5728\u670D\u52A1\u5668\u4E0A\u7684\u5176\u4ED6\u4E1A\u52A1\u8FDB\u7A0B\uFF0C\u6BD4\u5982\u8BF4nginx\uFF0Ckeepalived+nginx\u5B9E\u73B0nginx\u7684\u8D1F\u8F7D\u5747\u8861\u9AD8\u53EF\u7528\uFF0C\u5982\u679Cnginx\u5F02\u5E38\uFF0C\u4EC5\u4EC5keepalived\u4FDD\u6301\u6B63\u5E38\uFF0C\u662F\u65E0\u6CD5\u5B8C\u6210\u7CFB\u7EDF\u7684\u6B63\u5E38\u5DE5\u4F5C\u7684\uFF0C\u56E0\u6B64\u9700\u8981\u6839\u636E\u4E1A\u52A1\u8FDB\u7A0B\u7684\u8FD0\u884C\u72B6\u6001\u51B3\u5B9A\u662F\u5426\u9700\u8981\u8FDB\u884C\u4E3B\u5907\u5207\u6362\u3002\u8FD9\u4E2A\u65F6\u5019\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u7F16\u5199\u811A\u672C\u5BF9nginx\u8FDB\u7A0B\u8FDB\u884C\u68C0\u6D4B\u76D1\u63A7\u3002</p><p><strong>1.MASTER\u8282\u70B9\u90E8\u7F72</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5B89\u88C5keepalived</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;">  yum -y install keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u914D\u7F6Ekeepalived</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /etc/keepalived/keepalived.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">global_defs </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">   notification_email </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#DBD7CA;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#DBD7CA;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#DBD7CA;">   </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#DBD7CA;">   smtp_server 127.0.0.1</span></span>
<span class="line"><span style="color:#DBD7CA;">   smtp_connect_timeout 30</span></span>
<span class="line"><span style="color:#DBD7CA;">   router_id NGINX_MASTER</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">vrrp_script check_nginx </span><span style="color:#858585;">{</span><span style="color:#DBD7CA;">				</span><span style="color:#758575;">#\u5B9A\u4E49\u5065\u5EB7\u68C0\u67E5\u811A\u672C</span></span>
<span class="line"><span style="color:#DBD7CA;">    script </span><span style="color:#C98A7D;">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">vrrp_instance VI_1 </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    state MASTER					</span><span style="color:#758575;">#\u72B6\u6001\u4E3AMASTER</span></span>
<span class="line"><span style="color:#DBD7CA;">    interface ens192				</span><span style="color:#758575;">#\u5C06VIP\u7ED1\u5B9A\u5728\u54EA\u5757\u7F51\u5361\u4E0A</span></span>
<span class="line"><span style="color:#DBD7CA;">    virtual_router_id 51			</span><span style="color:#758575;">#\u5B9E\u4F8BID\uFF0C\u96C6\u7FA4\u6240\u6709\u8282\u70B9\u90FD\u8981\u4FDD\u6301\u4E00\u81F4</span></span>
<span class="line"><span style="color:#DBD7CA;">    priority 100					</span><span style="color:#758575;">#\u4F18\u5148\u7EA7\uFF0C255\u6700\u9AD8</span></span>
<span class="line"><span style="color:#DBD7CA;">    advert_int 1					</span><span style="color:#758575;">#\u6307\u5B9AVRRP\u5FC3\u8DF3\u5305\u901A\u544A\u95F4\u9694\u65F6\u95F4\uFF0C\u9ED8\u8BA41\u79D2</span></span>
<span class="line"><span style="color:#DBD7CA;">    authentication </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        auth_type PASS</span></span>
<span class="line"><span style="color:#DBD7CA;">        auth_pass 1111</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    virtual_ipaddress </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        192.168.20.9/23					</span><span style="color:#758575;">#\u5B9A\u4E49VIP\u5730\u5740</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    track_script </span><span style="color:#858585;">{</span><span style="color:#DBD7CA;">	</span></span>
<span class="line"><span style="color:#DBD7CA;">        check_nginx					</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u7F16\u5199\u68C0\u67E5nginx\u72B6\u6001\u7684\u68C0\u67E5\u811A\u672C</span></span>
<span class="line"><span style="color:#758575;">#\u5F53nginx\u5F02\u5E38\u65F6\uFF0C\u81EA\u52A8\u5C06\u5F53\u524D\u4E3B\u673A\u7684keepalived\u8FDB\u7A0B\u5173\u95ED\uFF0C\u4F7FBACKUP\u4E0A\u7684keepalived\u6210\u4E3AMASTER\u7EE7\u7EED\u63D0\u4F9B\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /etc/keepalived/check_nginx.sh </span></span>
<span class="line"><span style="color:#DBD7CA;">nginx_ch=</span><span style="color:#C98A7D;">\`netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#C98A7D;"> grep 16443</span><span style="color:#CB7676;">|</span><span style="color:#C98A7D;"> egrep -cv grep\`</span></span>
<span class="line"><span style="color:#4D9375;">if</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">$</span><span style="color:#B8A965;">nginx_ch</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">-eq</span><span style="color:#DBD7CA;"> 0 </span><span style="color:#858585;">]</span><span style="color:#CB7676;">;</span><span style="color:#4D9375;">then</span></span>
<span class="line"><span style="color:#DBD7CA;">	systemctl stop keepalived</span></span>
<span class="line"><span style="color:#DBD7CA;">	</span><span style="color:#E0A569;">exit</span><span style="color:#DBD7CA;"> 1</span></span>
<span class="line"><span style="color:#4D9375;">else</span></span>
<span class="line"><span style="color:#DBD7CA;">	</span><span style="color:#E0A569;">exit</span><span style="color:#DBD7CA;"> 0</span></span>
<span class="line"><span style="color:#4D9375;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u542F\u52A8keepalived</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start keepalived</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">5.\u67E5\u770BVIP\u5730\u5740</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ip a </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep ens192</span></span>
<span class="line"><span style="color:#DBD7CA;">2: ens192: </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">BROADCAST,MULTICAST,UP,LOWER_UP</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;"> mtu 1500 qdisc mq state UP group default qlen 1000</span></span>
<span class="line"><span style="color:#DBD7CA;">    inet 192.168.20.10/23 brd 192.168.21.255 scope global noprefixroute ens192</span></span>
<span class="line"><span style="color:#DBD7CA;">    inet 192.168.20.9/23 scope global secondary ens192</span></span>
<span class="line"><span style="color:#758575;">#VIP\u5DF2\u7ECF\u51C6\u5907\u5C31\u7EEA</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5B89\u88C5keepalived</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;">  yum -y install keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u914D\u7F6Ekeepalived</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /etc/keepalived/keepalived.conf </span></span>
<span class="line"><span style="color:#393A34;">global_defs </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">   notification_email </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#393A34;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#393A34;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#393A34;">   </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#393A34;">   smtp_server 127.0.0.1</span></span>
<span class="line"><span style="color:#393A34;">   smtp_connect_timeout 30</span></span>
<span class="line"><span style="color:#393A34;">   router_id NGINX_MASTER</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">vrrp_script check_nginx </span><span style="color:#8E8F8B;">{</span><span style="color:#393A34;">				</span><span style="color:#A0ADA0;">#\u5B9A\u4E49\u5065\u5EB7\u68C0\u67E5\u811A\u672C</span></span>
<span class="line"><span style="color:#393A34;">    script </span><span style="color:#B56959;">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">vrrp_instance VI_1 </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    state MASTER					</span><span style="color:#A0ADA0;">#\u72B6\u6001\u4E3AMASTER</span></span>
<span class="line"><span style="color:#393A34;">    interface ens192				</span><span style="color:#A0ADA0;">#\u5C06VIP\u7ED1\u5B9A\u5728\u54EA\u5757\u7F51\u5361\u4E0A</span></span>
<span class="line"><span style="color:#393A34;">    virtual_router_id 51			</span><span style="color:#A0ADA0;">#\u5B9E\u4F8BID\uFF0C\u96C6\u7FA4\u6240\u6709\u8282\u70B9\u90FD\u8981\u4FDD\u6301\u4E00\u81F4</span></span>
<span class="line"><span style="color:#393A34;">    priority 100					</span><span style="color:#A0ADA0;">#\u4F18\u5148\u7EA7\uFF0C255\u6700\u9AD8</span></span>
<span class="line"><span style="color:#393A34;">    advert_int 1					</span><span style="color:#A0ADA0;">#\u6307\u5B9AVRRP\u5FC3\u8DF3\u5305\u901A\u544A\u95F4\u9694\u65F6\u95F4\uFF0C\u9ED8\u8BA41\u79D2</span></span>
<span class="line"><span style="color:#393A34;">    authentication </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        auth_type PASS</span></span>
<span class="line"><span style="color:#393A34;">        auth_pass 1111</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    virtual_ipaddress </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        192.168.20.9/23					</span><span style="color:#A0ADA0;">#\u5B9A\u4E49VIP\u5730\u5740</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    track_script </span><span style="color:#8E8F8B;">{</span><span style="color:#393A34;">	</span></span>
<span class="line"><span style="color:#393A34;">        check_nginx					</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u7F16\u5199\u68C0\u67E5nginx\u72B6\u6001\u7684\u68C0\u67E5\u811A\u672C</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5F53nginx\u5F02\u5E38\u65F6\uFF0C\u81EA\u52A8\u5C06\u5F53\u524D\u4E3B\u673A\u7684keepalived\u8FDB\u7A0B\u5173\u95ED\uFF0C\u4F7FBACKUP\u4E0A\u7684keepalived\u6210\u4E3AMASTER\u7EE7\u7EED\u63D0\u4F9B\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /etc/keepalived/check_nginx.sh </span></span>
<span class="line"><span style="color:#393A34;">nginx_ch=</span><span style="color:#B56959;">\`netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#B56959;"> grep 16443</span><span style="color:#AB5959;">|</span><span style="color:#B56959;"> egrep -cv grep\`</span></span>
<span class="line"><span style="color:#1C6B48;">if</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">nginx_ch</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">-eq</span><span style="color:#393A34;"> 0 </span><span style="color:#8E8F8B;">]</span><span style="color:#AB5959;">;</span><span style="color:#1C6B48;">then</span></span>
<span class="line"><span style="color:#393A34;">	systemctl stop keepalived</span></span>
<span class="line"><span style="color:#393A34;">	</span><span style="color:#B58451;">exit</span><span style="color:#393A34;"> 1</span></span>
<span class="line"><span style="color:#1C6B48;">else</span></span>
<span class="line"><span style="color:#393A34;">	</span><span style="color:#B58451;">exit</span><span style="color:#393A34;"> 0</span></span>
<span class="line"><span style="color:#1C6B48;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u542F\u52A8keepalived</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start keepalived</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">5.\u67E5\u770BVIP\u5730\u5740</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ip a </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep ens192</span></span>
<span class="line"><span style="color:#393A34;">2: ens192: </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">BROADCAST,MULTICAST,UP,LOWER_UP</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> mtu 1500 qdisc mq state UP group default qlen 1000</span></span>
<span class="line"><span style="color:#393A34;">    inet 192.168.20.10/23 brd 192.168.21.255 scope global noprefixroute ens192</span></span>
<span class="line"><span style="color:#393A34;">    inet 192.168.20.9/23 scope global secondary ens192</span></span>
<span class="line"><span style="color:#A0ADA0;">#VIP\u5DF2\u7ECF\u51C6\u5907\u5C31\u7EEA</span></span>
<span class="line"></span></code></pre></div><p><strong>2.BACKUP\u8282\u70B9\u90E8\u7F72</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5B89\u88C5keepalived</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;">  yum -y install keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u914D\u7F6Ekeepalived</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /etc/keepalived/keepalived.conf </span></span>
<span class="line"><span style="color:#DBD7CA;">global_defs </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">   notification_email </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#DBD7CA;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#DBD7CA;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#DBD7CA;">   </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#DBD7CA;">   smtp_server 127.0.0.1</span></span>
<span class="line"><span style="color:#DBD7CA;">   smtp_connect_timeout 30</span></span>
<span class="line"><span style="color:#DBD7CA;">   router_id NGINX_MASTER</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">vrrp_script check_nginx </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    script </span><span style="color:#C98A7D;">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">vrrp_instance VI_1 </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    state BACKUP				</span><span style="color:#758575;">#\u72B6\u6001\u4E3ABACKUP</span></span>
<span class="line"><span style="color:#DBD7CA;">    interface ens192</span></span>
<span class="line"><span style="color:#DBD7CA;">    virtual_router_id 51</span></span>
<span class="line"><span style="color:#DBD7CA;">    priority 90				</span><span style="color:#758575;">#\u4F18\u5148\u7EA7\u8981\u6BD4MASTER\u4F4E</span></span>
<span class="line"><span style="color:#DBD7CA;">    advert_int 1</span></span>
<span class="line"><span style="color:#DBD7CA;">    authentication </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        auth_type PASS</span></span>
<span class="line"><span style="color:#DBD7CA;">        auth_pass 1111</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    virtual_ipaddress </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        192.168.20.9/23</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#DBD7CA;">    track_script </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        check_nginx</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u7F16\u5199\u68C0\u67E5nginx\u72B6\u6001\u7684\u68C0\u67E5\u811A\u672C</span></span>
<span class="line"><span style="color:#758575;">#\u5F53nginx\u5F02\u5E38\u65F6\uFF0C\u81EA\u52A8\u5C06\u5F53\u524D\u4E3B\u673A\u7684keepalived\u8FDB\u7A0B\u5173\u95ED\uFF0C\u4F7FBACKUP\u4E0A\u7684keepalived\u6210\u4E3AMASTER\u7EE7\u7EED\u63D0\u4F9B\u670D\u52A1</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /etc/keepalived/check_nginx.sh </span></span>
<span class="line"><span style="color:#DBD7CA;">nginx_ch=</span><span style="color:#C98A7D;">\`netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#C98A7D;"> grep 16443</span><span style="color:#CB7676;">|</span><span style="color:#C98A7D;"> egrep -cv grep\`</span></span>
<span class="line"><span style="color:#4D9375;">if</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">$</span><span style="color:#B8A965;">nginx_ch</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">-eq</span><span style="color:#DBD7CA;"> 0 </span><span style="color:#858585;">]</span><span style="color:#CB7676;">;</span><span style="color:#4D9375;">then</span></span>
<span class="line"><span style="color:#DBD7CA;">	systemctl stop keepalived</span></span>
<span class="line"><span style="color:#DBD7CA;">	</span><span style="color:#E0A569;">exit</span><span style="color:#DBD7CA;"> 1</span></span>
<span class="line"><span style="color:#4D9375;">else</span></span>
<span class="line"><span style="color:#DBD7CA;">	</span><span style="color:#E0A569;">exit</span><span style="color:#DBD7CA;"> 0</span></span>
<span class="line"><span style="color:#4D9375;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u542F\u52A8keepalived</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl start keepalived</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> keepalived</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5B89\u88C5keepalived</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;">  yum -y install keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u914D\u7F6Ekeepalived</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /etc/keepalived/keepalived.conf </span></span>
<span class="line"><span style="color:#393A34;">global_defs </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">   notification_email </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#393A34;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#393A34;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#393A34;">   </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#393A34;">   smtp_server 127.0.0.1</span></span>
<span class="line"><span style="color:#393A34;">   smtp_connect_timeout 30</span></span>
<span class="line"><span style="color:#393A34;">   router_id NGINX_MASTER</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">vrrp_script check_nginx </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    script </span><span style="color:#B56959;">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">vrrp_instance VI_1 </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    state BACKUP				</span><span style="color:#A0ADA0;">#\u72B6\u6001\u4E3ABACKUP</span></span>
<span class="line"><span style="color:#393A34;">    interface ens192</span></span>
<span class="line"><span style="color:#393A34;">    virtual_router_id 51</span></span>
<span class="line"><span style="color:#393A34;">    priority 90				</span><span style="color:#A0ADA0;">#\u4F18\u5148\u7EA7\u8981\u6BD4MASTER\u4F4E</span></span>
<span class="line"><span style="color:#393A34;">    advert_int 1</span></span>
<span class="line"><span style="color:#393A34;">    authentication </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        auth_type PASS</span></span>
<span class="line"><span style="color:#393A34;">        auth_pass 1111</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    virtual_ipaddress </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        192.168.20.9/23</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#393A34;">    track_script </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        check_nginx</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u7F16\u5199\u68C0\u67E5nginx\u72B6\u6001\u7684\u68C0\u67E5\u811A\u672C</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u5F53nginx\u5F02\u5E38\u65F6\uFF0C\u81EA\u52A8\u5C06\u5F53\u524D\u4E3B\u673A\u7684keepalived\u8FDB\u7A0B\u5173\u95ED\uFF0C\u4F7FBACKUP\u4E0A\u7684keepalived\u6210\u4E3AMASTER\u7EE7\u7EED\u63D0\u4F9B\u670D\u52A1</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /etc/keepalived/check_nginx.sh </span></span>
<span class="line"><span style="color:#393A34;">nginx_ch=</span><span style="color:#B56959;">\`netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#B56959;"> grep 16443</span><span style="color:#AB5959;">|</span><span style="color:#B56959;"> egrep -cv grep\`</span></span>
<span class="line"><span style="color:#1C6B48;">if</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">nginx_ch</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">-eq</span><span style="color:#393A34;"> 0 </span><span style="color:#8E8F8B;">]</span><span style="color:#AB5959;">;</span><span style="color:#1C6B48;">then</span></span>
<span class="line"><span style="color:#393A34;">	systemctl stop keepalived</span></span>
<span class="line"><span style="color:#393A34;">	</span><span style="color:#B58451;">exit</span><span style="color:#393A34;"> 1</span></span>
<span class="line"><span style="color:#1C6B48;">else</span></span>
<span class="line"><span style="color:#393A34;">	</span><span style="color:#B58451;">exit</span><span style="color:#393A34;"> 0</span></span>
<span class="line"><span style="color:#1C6B48;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u542F\u52A8keepalived</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl start keepalived</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> keepalived</span></span>
<span class="line"></span></code></pre></div><h4 id="_10-4-3-\u4F7F\u7528vip\u8BBF\u95EEkubernetes\u670D\u52A1" tabindex="-1">10.4.3.\u4F7F\u7528VIP\u8BBF\u95EEkubernetes\u670D\u52A1 <a class="header-anchor" href="#_10-4-3-\u4F7F\u7528vip\u8BBF\u95EEkubernetes\u670D\u52A1" aria-hidden="true">#</a></h4><p>\u53EF\u4EE5\u6B63\u786E\u83B7\u53D6\u5230K8s\u7248\u672C\u4FE1\u606F\uFF0C\u8BF4\u660E\u8D1F\u8F7D\u5747\u8861\u5668\u642D\u5EFA\u6B63\u5E38\u3002\u8BE5\u8BF7\u6C42\u6570\u636E\u6D41\u7A0B\uFF1Acurl -&gt; vip(nginx) -&gt; apiserver\u3002</p><p>\u65E5\u5FD7\u4E2D\u4E5F\u4F1A\u8BB0\u5F55\u8BBF\u95EE\u8BB0\u5F55\u3002</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> curl -k https://192.168.20.9:16443/version</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;major&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;1&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;minor&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;20&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;gitVersion&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;v1.20.4&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;gitCommit&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;e87da0bd6e03ec3fea7933c4b5263d151aafd07c&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;gitTreeState&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;clean&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;buildDate&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;2021-02-18T16:03:00Z&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;goVersion&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;go1.15.8&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;compiler&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;gc&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;platform&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;linux/amd64&quot;</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> tail -f /var/log/nginx/k8s-apiserver.log </span></span>
<span class="line"><span style="color:#DBD7CA;">127.0.0.1 192.168.20.11:6443 - </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">09/Sep/2021:11:28:15 +0800</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> 200 79</span></span>
<span class="line"><span style="color:#DBD7CA;">127.0.0.1 192.168.20.11:6443 - </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">09/Sep/2021:11:28:20 +0800</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> 200 178</span></span>
<span class="line"><span style="color:#DBD7CA;">192.168.20.10 192.168.20.11:6443 - </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">09/Sep/2021:15:20:29 +0800</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> 200 178</span></span>
<span class="line"><span style="color:#DBD7CA;">192.168.20.10 192.168.20.12:6443, 192.168.20.11:6443 - </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">09/Sep/2021:16:19:00 +0800</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;"> 200 0, 420</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> curl -k https://192.168.20.9:16443/version</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;major&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;1&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;minor&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;20&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;gitVersion&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;v1.20.4&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;gitCommit&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;e87da0bd6e03ec3fea7933c4b5263d151aafd07c&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;gitTreeState&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;clean&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;buildDate&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;2021-02-18T16:03:00Z&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;goVersion&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;go1.15.8&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;compiler&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;gc&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;platform&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;linux/amd64&quot;</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> tail -f /var/log/nginx/k8s-apiserver.log </span></span>
<span class="line"><span style="color:#393A34;">127.0.0.1 192.168.20.11:6443 - </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">09/Sep/2021:11:28:15 +0800</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> 200 79</span></span>
<span class="line"><span style="color:#393A34;">127.0.0.1 192.168.20.11:6443 - </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">09/Sep/2021:11:28:20 +0800</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> 200 178</span></span>
<span class="line"><span style="color:#393A34;">192.168.20.10 192.168.20.11:6443 - </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">09/Sep/2021:15:20:29 +0800</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> 200 178</span></span>
<span class="line"><span style="color:#393A34;">192.168.20.10 192.168.20.12:6443, 192.168.20.11:6443 - </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">09/Sep/2021:16:19:00 +0800</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;"> 200 0, 420</span></span>
<span class="line"></span></code></pre></div><h4 id="_10-4-4-\u6D4B\u8BD5keepalived\u9AD8\u53EF\u7528" tabindex="-1">10.4.4.\u6D4B\u8BD5keepalived\u9AD8\u53EF\u7528 <a class="header-anchor" href="#_10-4-4-\u6D4B\u8BD5keepalived\u9AD8\u53EF\u7528" aria-hidden="true">#</a></h4><p><strong>1.\u505C\u6389master1\u4E0A\u7684keepalived\uFF0C\u67E5\u770BVIP\u662F\u5426\u4F1A\u5207\u6362\u5230master2\u8282\u70B9</strong></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/dba9f62a2a0744c3b3ccc86981ad86a4.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>2.\u91CD\u65B0\u542F\u52A8master1\u4E0A\u7684keepalived\uFF0C\u67E5\u770BVIP\u662F\u5426\u4F1A\u81EA\u52A8\u5207\u6362\u5230master1</strong></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/54cdc63de7c040519287127263385c0c.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_10-5-\u5207\u6362kubernetes\u96C6\u7FA4\u4E3A\u9AD8\u53EF\u7528\u6A21\u5F0F" tabindex="-1">10.5.\u5207\u6362kubernetes\u96C6\u7FA4\u4E3A\u9AD8\u53EF\u7528\u6A21\u5F0F <a class="header-anchor" href="#_10-5-\u5207\u6362kubernetes\u96C6\u7FA4\u4E3A\u9AD8\u53EF\u7528\u6A21\u5F0F" aria-hidden="true">#</a></h3><p>\u867D\u7136\u6211\u4EEC\u589E\u52A0\u4E86Master2 Node\u548C\u8D1F\u8F7D\u5747\u8861\u5668\uFF0C\u4F46\u662F\u6211\u4EEC\u662F\u4ECE\u5355Master\u67B6\u6784\u6269\u5BB9\u7684\uFF0C\u4E5F\u5C31\u662F\u8BF4\u76EE\u524D\u6240\u6709\u7684Worker Node\u7EC4\u4EF6\u8FDE\u63A5\u90FD\u8FD8\u662FMaster1 Node\uFF0C\u5982\u679C\u4E0D\u6539\u4E3A\u8FDE\u63A5VIP\u8D70\u8D1F\u8F7D\u5747\u8861\u5668\uFF0C\u90A3\u4E48Master\u8FD8\u662F\u5355\u70B9\u6545\u969C\u3002</p><p>\u7531\u4E8E\u5DF2\u7ECF\u53EF\u4EE5\u901A\u8FC7keepalived\u7684VIP\u5730\u5740\u8BBF\u95EE\u5230apiserver\uFF0C\u9AD8\u53EF\u7528\u6548\u679C\u5DF2\u8FBE\u6210\uFF0C\u76EE\u524D\u53EA\u9700\u8981\u5C06\u96C6\u7FA4\u7684\u6240\u6709\u8282\u70B9\uFF08kubectl get node\uFF09\u80FD\u770B\u5230\u7684\u4E00\u5207\u8282\u70B9\uFF0C\u5C06\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684apiserver\u7684\u5730\u5740\u6362\u6210VIP\u5730\u5740\u52A0\u7AEF\u53E3\uFF0C\u624D\u80FD\u771F\u6B63\u7684\u5B9E\u73B0kubernetes\u9AD8\u53EF\u7528\u3002</p><p>\u4E4B\u524D\u524D\u671F\u4F7F\u7528VIP\u6D4B\u8BD5kube-apiserver\u6CA1\u95EE\u9898\uFF0C\u5373\u4F7F\u5728\u5207\u6362\u9AD8\u53EF\u7528\u7684\u60C5\u51B5\u4E0B\uFF0C\u6240\u6709\u8282\u70B9\u4E5F\u4E0D\u4F1A\u5904\u4E8ENotReady\u72B6\u6001\u3002</p><p><strong>1.\u5207\u6362\u9AD8\u53EF\u7528\u73AF\u5883</strong></p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.binary-k8s-master1\u8282\u70B9\u5207\u6362</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> sed -ri </span><span style="color:#C98A7D;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#DBD7CA;"> /data/kubernetes/config/</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> sed -ri </span><span style="color:#C98A7D;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#DBD7CA;"> /root/.kube/config </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.binary-k8s-master2\u5207\u6362</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> sed -ri </span><span style="color:#C98A7D;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#DBD7CA;"> /data/kubernetes/config/</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> sed -ri </span><span style="color:#C98A7D;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#DBD7CA;"> /root/.kube/config</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.binary-k8s-node1\u5207\u6362</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> sed -ri </span><span style="color:#C98A7D;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#DBD7CA;"> /data/kubernetes/config/</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart kubelet kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.binary-k8s-node2\u5207\u6362</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> sed -ri </span><span style="color:#C98A7D;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#DBD7CA;"> /data/kubernetes/config/</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-node2 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart kubelet kube-proxy</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.binary-k8s-master1\u8282\u70B9\u5207\u6362</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> sed -ri </span><span style="color:#B56959;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#393A34;"> /data/kubernetes/config/</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> sed -ri </span><span style="color:#B56959;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#393A34;"> /root/.kube/config </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.binary-k8s-master2\u5207\u6362</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> sed -ri </span><span style="color:#B56959;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#393A34;"> /data/kubernetes/config/</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> sed -ri </span><span style="color:#B56959;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#393A34;"> /root/.kube/config</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.binary-k8s-node1\u5207\u6362</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> sed -ri </span><span style="color:#B56959;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#393A34;"> /data/kubernetes/config/</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart kubelet kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.binary-k8s-node2\u5207\u6362</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> sed -ri </span><span style="color:#B56959;">&#39;s#192.168.20.10:6443#192.168.20.9:16443#&#39;</span><span style="color:#393A34;"> /data/kubernetes/config/</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-node2 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart kubelet kube-proxy</span></span>
<span class="line"></span></code></pre></div><p><strong>2.\u67E5\u770B\u96C6\u7FA4\u72B6\u6001\u53CA\u8D44\u6E90</strong></p><p>\u5230\u6B64\u4E3A\u6B62kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4\u5B9E\u73B0\u5B8C\u6BD5</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get node</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 STATUS   ROLES    AGE     VERSION</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-master1   Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   5d22h   v1.20.4</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-master2   Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   25h     v1.20.4</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-node1     Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   3d5h    v1.20.4</span></span>
<span class="line"><span style="color:#DBD7CA;">binary-k8s-node2     Ready    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">   2d23h   v1.20.4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get cs</span></span>
<span class="line"><span style="color:#DBD7CA;">Warning: v1 ComponentStatus is deprecated </span><span style="color:#4D9375;">in</span><span style="color:#DBD7CA;"> v1.19+</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 STATUS    MESSAGE             ERROR</span></span>
<span class="line"><span style="color:#DBD7CA;">controller-manager   Healthy   ok                  </span></span>
<span class="line"><span style="color:#DBD7CA;">scheduler            Healthy   ok                  </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-0               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-1               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">}   </span></span>
<span class="line"><span style="color:#DBD7CA;">etcd-2               Healthy   {</span><span style="color:#C98A7D;">&quot;health&quot;</span><span style="color:#DBD7CA;">:</span><span style="color:#C98A7D;">&quot;true&quot;</span><span style="color:#DBD7CA;">} </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get node</span></span>
<span class="line"><span style="color:#393A34;">NAME                 STATUS   ROLES    AGE     VERSION</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-master1   Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   5d22h   v1.20.4</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-master2   Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   25h     v1.20.4</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-node1     Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   3d5h    v1.20.4</span></span>
<span class="line"><span style="color:#393A34;">binary-k8s-node2     Ready    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">   2d23h   v1.20.4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get cs</span></span>
<span class="line"><span style="color:#393A34;">Warning: v1 ComponentStatus is deprecated </span><span style="color:#1C6B48;">in</span><span style="color:#393A34;"> v1.19+</span></span>
<span class="line"><span style="color:#393A34;">NAME                 STATUS    MESSAGE             ERROR</span></span>
<span class="line"><span style="color:#393A34;">controller-manager   Healthy   ok                  </span></span>
<span class="line"><span style="color:#393A34;">scheduler            Healthy   ok                  </span></span>
<span class="line"><span style="color:#393A34;">etcd-0               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"><span style="color:#393A34;">etcd-1               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">}   </span></span>
<span class="line"><span style="color:#393A34;">etcd-2               Healthy   {</span><span style="color:#B56959;">&quot;health&quot;</span><span style="color:#393A34;">:</span><span style="color:#B56959;">&quot;true&quot;</span><span style="color:#393A34;">} </span></span>
<span class="line"></span></code></pre></div><h2 id="_11-\u6D4B\u8BD5kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4" tabindex="-1">11.\u6D4B\u8BD5kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4 <a class="header-anchor" href="#_11-\u6D4B\u8BD5kubernetes\u9AD8\u53EF\u7528\u96C6\u7FA4" aria-hidden="true">#</a></h2><p><strong>1.\u505C\u6389master1\u4E0A\u7684keepalived\u9A8C\u8BC1\u96C6\u7FA4\u662F\u5426\u53EF\u7528</strong></p><p>\u72B6\u6001\uFF1A\u201Cok\u201D</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/c146811a76994c2eb7ecea1a95bae2ab.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>2.\u505C\u6389master1\u4E0A\u6240\u6709k8s\u7EC4\u4EF6\u9A8C\u8BC1\u96C6\u7FA4\u662F\u5426\u53EF\u7528</strong></p><p>\u72B6\u6001\uFF1A\u201Cok\u201D</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/a5cfe03d354441798591ae5add26898e.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h2 id="_12-\u5728kubernetes\u96C6\u7FA4\u8FD0\u884C\u4E00\u5957\u670D\u52A1\u9A8C\u8BC1\u96C6\u7FA4\u7684\u53EF\u7528\u6027" tabindex="-1">12.\u5728kubernetes\u96C6\u7FA4\u8FD0\u884C\u4E00\u5957\u670D\u52A1\u9A8C\u8BC1\u96C6\u7FA4\u7684\u53EF\u7528\u6027 <a class="header-anchor" href="#_12-\u5728kubernetes\u96C6\u7FA4\u8FD0\u884C\u4E00\u5957\u670D\u52A1\u9A8C\u8BC1\u96C6\u7FA4\u7684\u53EF\u7528\u6027" aria-hidden="true">#</a></h2><p>\u7B80\u5355\u90E8\u7F72\u4E00\u4E2A\u57FA\u4E8Enginx\u7684web\u670D\u52A1\u3002</p><h3 id="_12-1-\u521B\u5EFA\u8D44\u6E90yaml\u6587\u4EF6" tabindex="-1">12.1.\u521B\u5EFA\u8D44\u6E90yaml\u6587\u4EF6 <a class="header-anchor" href="#_12-1-\u521B\u5EFA\u8D44\u6E90yaml\u6587\u4EF6" aria-hidden="true">#</a></h3><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim know-system.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: apps/v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: Deployment</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: deploy-know-system</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">  replicas: 3</span></span>
<span class="line"><span style="color:#DBD7CA;">  selector:</span></span>
<span class="line"><span style="color:#DBD7CA;">    matchLabels:</span></span>
<span class="line"><span style="color:#DBD7CA;">      app: know-system-pod</span></span>
<span class="line"><span style="color:#DBD7CA;">  template:</span></span>
<span class="line"><span style="color:#DBD7CA;">    metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">      labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">        app: know-system-pod</span></span>
<span class="line"><span style="color:#DBD7CA;">    spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">      containers:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - name: know-system</span></span>
<span class="line"><span style="color:#DBD7CA;">        image: know-system:v1</span></span>
<span class="line"><span style="color:#DBD7CA;">        ports:</span></span>
<span class="line"><span style="color:#DBD7CA;">        - containerPort: 80</span></span>
<span class="line"><span style="color:#DBD7CA;">      nodeName: binary-k8s-master1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">---</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: Service</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: know-system-service</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">  selector:</span></span>
<span class="line"><span style="color:#DBD7CA;">    app: know-system-pod</span></span>
<span class="line"><span style="color:#DBD7CA;">  type: NodePort</span></span>
<span class="line"><span style="color:#DBD7CA;">  ports:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - port: 80</span></span>
<span class="line"><span style="color:#DBD7CA;">    targetPort: 80</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim know-system.yaml </span></span>
<span class="line"><span style="color:#393A34;">apiVersion: apps/v1</span></span>
<span class="line"><span style="color:#393A34;">kind: Deployment</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: deploy-know-system</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#393A34;">  replicas: 3</span></span>
<span class="line"><span style="color:#393A34;">  selector:</span></span>
<span class="line"><span style="color:#393A34;">    matchLabels:</span></span>
<span class="line"><span style="color:#393A34;">      app: know-system-pod</span></span>
<span class="line"><span style="color:#393A34;">  template:</span></span>
<span class="line"><span style="color:#393A34;">    metadata:</span></span>
<span class="line"><span style="color:#393A34;">      labels:</span></span>
<span class="line"><span style="color:#393A34;">        app: know-system-pod</span></span>
<span class="line"><span style="color:#393A34;">    spec:</span></span>
<span class="line"><span style="color:#393A34;">      containers:</span></span>
<span class="line"><span style="color:#393A34;">      - name: know-system</span></span>
<span class="line"><span style="color:#393A34;">        image: know-system:v1</span></span>
<span class="line"><span style="color:#393A34;">        ports:</span></span>
<span class="line"><span style="color:#393A34;">        - containerPort: 80</span></span>
<span class="line"><span style="color:#393A34;">      nodeName: binary-k8s-master1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">---</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: Service</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: know-system-service</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#393A34;">  selector:</span></span>
<span class="line"><span style="color:#393A34;">    app: know-system-pod</span></span>
<span class="line"><span style="color:#393A34;">  type: NodePort</span></span>
<span class="line"><span style="color:#393A34;">  ports:</span></span>
<span class="line"><span style="color:#393A34;">  - port: 80</span></span>
<span class="line"><span style="color:#393A34;">    targetPort: 80</span></span>
<span class="line"></span></code></pre></div><h3 id="_12-2-\u521B\u5EFA\u8D44\u6E90\u5E76\u8FDB\u884C\u6D4B\u8BD5" tabindex="-1">12.2.\u521B\u5EFA\u8D44\u6E90\u5E76\u8FDB\u884C\u6D4B\u8BD5 <a class="header-anchor" href="#_12-2-\u521B\u5EFA\u8D44\u6E90\u5E76\u8FDB\u884C\u6D4B\u8BD5" aria-hidden="true">#</a></h3><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl apply -f know-system.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">deployment.apps/deploy-know-system created</span></span>
<span class="line"><span style="color:#DBD7CA;">service/know-system-service created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get pod,svc</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                     READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">pod/deploy-know-system-b4c9c55d7-5mf2f   1/1     Running   0          47s</span></span>
<span class="line"><span style="color:#DBD7CA;">pod/deploy-know-system-b4c9c55d7-97ckx   1/1     Running   0          48s</span></span>
<span class="line"><span style="color:#DBD7CA;">pod/deploy-know-system-b4c9c55d7-kb97t   1/1     Running   0          47s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">NAME                          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">S</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;">        AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">service/know-system-service   NodePort    10.0.0.38    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">        80:32702/TCP   47s</span></span>
<span class="line"><span style="color:#DBD7CA;">service/kubernetes            ClusterIP   10.0.0.1     </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">        443/TCP        10d</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl apply -f know-system.yaml </span></span>
<span class="line"><span style="color:#393A34;">deployment.apps/deploy-know-system created</span></span>
<span class="line"><span style="color:#393A34;">service/know-system-service created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get pod,svc</span></span>
<span class="line"><span style="color:#393A34;">NAME                                     READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#393A34;">pod/deploy-know-system-b4c9c55d7-5mf2f   1/1     Running   0          47s</span></span>
<span class="line"><span style="color:#393A34;">pod/deploy-know-system-b4c9c55d7-97ckx   1/1     Running   0          48s</span></span>
<span class="line"><span style="color:#393A34;">pod/deploy-know-system-b4c9c55d7-kb97t   1/1     Running   0          47s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">NAME                          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">S</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;">        AGE</span></span>
<span class="line"><span style="color:#393A34;">service/know-system-service   NodePort    10.0.0.38    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">        80:32702/TCP   47s</span></span>
<span class="line"><span style="color:#393A34;">service/kubernetes            ClusterIP   10.0.0.1     </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">        443/TCP        10d</span></span>
<span class="line"></span></code></pre></div><p>\u8BBF\u95EEhttps://\u96C6\u7FA4\u4EFB\u610F\u8282\u70B9+32702\u7AEF\u53E3\u5373\u53EF\u6D4F\u89C8web\u670D\u52A1\u3002</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/8c7dc7f2aad14d74a07b8ab6c35e09a9.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h2 id="_13-\u90E8\u7F72kubernetes-dashboard" tabindex="-1">13.\u90E8\u7F72kubernetes dashboard <a class="header-anchor" href="#_13-\u90E8\u7F72kubernetes-dashboard" aria-hidden="true">#</a></h2><h3 id="_13-1-\u90E8\u7F72dashboard" tabindex="-1">13.1.\u90E8\u7F72dashboard <a class="header-anchor" href="#_13-1-\u90E8\u7F72dashboard" aria-hidden="true">#</a></h3><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u90E8\u7F72yaml</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl apply -f kubernetes-dashboard.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">namespace/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#DBD7CA;">serviceaccount/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#DBD7CA;">service/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#DBD7CA;">secret/kubernetes-dashboard-certs created</span></span>
<span class="line"><span style="color:#DBD7CA;">secret/kubernetes-dashboard-csrf created</span></span>
<span class="line"><span style="color:#DBD7CA;">secret/kubernetes-dashboard-key-holder created</span></span>
<span class="line"><span style="color:#DBD7CA;">configmap/kubernetes-dashboard-settings created</span></span>
<span class="line"><span style="color:#DBD7CA;">role.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#DBD7CA;">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#DBD7CA;">deployment.apps/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#DBD7CA;">service/dashboard-metrics-scraper created</span></span>
<span class="line"><span style="color:#DBD7CA;">deployment.apps/dashboard-metrics-scraper created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u521B\u5EFA\u6388\u6743\u8D26\u53F7</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create serviceaccount dashboard-admin -n kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">serviceaccount/dashboard-admin created</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">3.\u67E5\u770B\u767B\u9646\u4F7F\u7528\u7684token\u5B57\u7B26\u4E32</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl describe secrets -n kube-system </span><span style="color:#C98A7D;">$(kubectl -n kube-system get secret </span><span style="color:#CB7676;">|</span><span style="color:#C98A7D;"> awk &#39;/dashboard-admin/{print $1}&#39;)</span></span>
<span class="line"><span style="color:#DBD7CA;">Name:         dashboard-admin-token-lnm2r</span></span>
<span class="line"><span style="color:#DBD7CA;">Namespace:    kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">Labels:       </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span></span>
<span class="line"><span style="color:#DBD7CA;">Annotations:  kubernetes.io/service-account.name: dashboard-admin</span></span>
<span class="line"><span style="color:#DBD7CA;">              kubernetes.io/service-account.uid: 73b370c9-b1b4-4418-b02d-fee9b6cf6342</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">Type:  kubernetes.io/service-account-token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">Data</span></span>
<span class="line"><span style="color:#DBD7CA;">====</span></span>
<span class="line"><span style="color:#DBD7CA;">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkgwWGJXQ1duVVI4eFh4Ykw2U25JVk9fa2hDOGZVRTRRMVZyVmdwWXM1Nk0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tbG5tMnIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNzNiMzcwYzktYjFiNC00NDE4LWIwMmQtZmVlOWI2Y2Y2MzQyIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.XWJLZDB7mNk_NNpXVv64LrbKy5f1hB2PS5qER5YFATzl3U9ISX05PCrnCEY-6uVSbPkRGZbTQZTBwiGjOfsyLZljvY3cbmGlH2oW2shUS8LDqli4MKA14JyUX1ubbQ8vq9uSqkQMCQBzZTUGIuZt95jw3-IMv2rfZ9ET8_uVuXIoZXbckY6VHFy8QOB6sy1n9j0j4qcOttyKHVXN8Q5KjsIlb44Y5HtiveKxpw_LA81eTwml_aiVvO9rgMKVdSHIg8CY1Mcp06ezz0kD0jsBLt7xaAujSNZnCiXzmpg51xujbR0k-4BVlwPBBpQLaSWGoHR3X7z5E02onXttbbX6-w</span></span>
<span class="line"><span style="color:#DBD7CA;">ca.crt:     1359 bytes</span></span>
<span class="line"><span style="color:#DBD7CA;">namespace:  11 bytes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">4.\u67E5\u770Bpod\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@binary-k8s-master1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get pod,svc -n kubernetes-dashboard</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                             READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">pod/dashboard-metrics-scraper-7445d59dfd-bg9c8   1/1     Running   0          8m51s</span></span>
<span class="line"><span style="color:#DBD7CA;">pod/kubernetes-dashboard-5ddcdf9c99-nkgqw        1/1     Running   0          8m52s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">S</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;">         AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">service/dashboard-metrics-scraper   ClusterIP   10.0.0.83    </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">        8000/TCP        8m52s</span></span>
<span class="line"><span style="color:#DBD7CA;">service/kubernetes-dashboard        NodePort    10.0.0.153   </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">        443:30001/TCP   8m53s</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u90E8\u7F72yaml</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl apply -f kubernetes-dashboard.yaml </span></span>
<span class="line"><span style="color:#393A34;">namespace/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#393A34;">serviceaccount/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#393A34;">service/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#393A34;">secret/kubernetes-dashboard-certs created</span></span>
<span class="line"><span style="color:#393A34;">secret/kubernetes-dashboard-csrf created</span></span>
<span class="line"><span style="color:#393A34;">secret/kubernetes-dashboard-key-holder created</span></span>
<span class="line"><span style="color:#393A34;">configmap/kubernetes-dashboard-settings created</span></span>
<span class="line"><span style="color:#393A34;">role.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#393A34;">clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#393A34;">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#393A34;">clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#393A34;">deployment.apps/kubernetes-dashboard created</span></span>
<span class="line"><span style="color:#393A34;">service/dashboard-metrics-scraper created</span></span>
<span class="line"><span style="color:#393A34;">deployment.apps/dashboard-metrics-scraper created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u521B\u5EFA\u6388\u6743\u8D26\u53F7</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create serviceaccount dashboard-admin -n kube-system</span></span>
<span class="line"><span style="color:#393A34;">serviceaccount/dashboard-admin created</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span></span>
<span class="line"><span style="color:#393A34;">clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">3.\u67E5\u770B\u767B\u9646\u4F7F\u7528\u7684token\u5B57\u7B26\u4E32</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl describe secrets -n kube-system </span><span style="color:#B56959;">$(kubectl -n kube-system get secret </span><span style="color:#AB5959;">|</span><span style="color:#B56959;"> awk &#39;/dashboard-admin/{print $1}&#39;)</span></span>
<span class="line"><span style="color:#393A34;">Name:         dashboard-admin-token-lnm2r</span></span>
<span class="line"><span style="color:#393A34;">Namespace:    kube-system</span></span>
<span class="line"><span style="color:#393A34;">Labels:       </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span></span>
<span class="line"><span style="color:#393A34;">Annotations:  kubernetes.io/service-account.name: dashboard-admin</span></span>
<span class="line"><span style="color:#393A34;">              kubernetes.io/service-account.uid: 73b370c9-b1b4-4418-b02d-fee9b6cf6342</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">Type:  kubernetes.io/service-account-token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">Data</span></span>
<span class="line"><span style="color:#393A34;">====</span></span>
<span class="line"><span style="color:#393A34;">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkgwWGJXQ1duVVI4eFh4Ykw2U25JVk9fa2hDOGZVRTRRMVZyVmdwWXM1Nk0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tbG5tMnIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNzNiMzcwYzktYjFiNC00NDE4LWIwMmQtZmVlOWI2Y2Y2MzQyIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.XWJLZDB7mNk_NNpXVv64LrbKy5f1hB2PS5qER5YFATzl3U9ISX05PCrnCEY-6uVSbPkRGZbTQZTBwiGjOfsyLZljvY3cbmGlH2oW2shUS8LDqli4MKA14JyUX1ubbQ8vq9uSqkQMCQBzZTUGIuZt95jw3-IMv2rfZ9ET8_uVuXIoZXbckY6VHFy8QOB6sy1n9j0j4qcOttyKHVXN8Q5KjsIlb44Y5HtiveKxpw_LA81eTwml_aiVvO9rgMKVdSHIg8CY1Mcp06ezz0kD0jsBLt7xaAujSNZnCiXzmpg51xujbR0k-4BVlwPBBpQLaSWGoHR3X7z5E02onXttbbX6-w</span></span>
<span class="line"><span style="color:#393A34;">ca.crt:     1359 bytes</span></span>
<span class="line"><span style="color:#393A34;">namespace:  11 bytes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">4.\u67E5\u770Bpod\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@binary-k8s-master1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get pod,svc -n kubernetes-dashboard</span></span>
<span class="line"><span style="color:#393A34;">NAME                                             READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#393A34;">pod/dashboard-metrics-scraper-7445d59dfd-bg9c8   1/1     Running   0          8m51s</span></span>
<span class="line"><span style="color:#393A34;">pod/kubernetes-dashboard-5ddcdf9c99-nkgqw        1/1     Running   0          8m52s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">S</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;">         AGE</span></span>
<span class="line"><span style="color:#393A34;">service/dashboard-metrics-scraper   ClusterIP   10.0.0.83    </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">        8000/TCP        8m52s</span></span>
<span class="line"><span style="color:#393A34;">service/kubernetes-dashboard        NodePort    10.0.0.153   </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">        443:30001/TCP   8m53s</span></span>
<span class="line"></span></code></pre></div><h3 id="_13-2-\u8BBF\u95EEdashboard" tabindex="-1">13.2.\u8BBF\u95EEdashboard <a class="header-anchor" href="#_13-2-\u8BBF\u95EEdashboard" aria-hidden="true">#</a></h3><p>\u8BBF\u95EEhttps://\u96C6\u7FA4\u4EFB\u610F\u8282\u70B9+30001\u7AEF\u53E3\uFF0C\u7136\u540E\u586B\u5199\u521A\u521A\u67E5\u5230\u7684token\u503C\uFF0C\u70B9\u51FB\u767B\u9646\u3002</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/2c6c6346e8854ffcb85a23d3569c056e.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>\u4EEA\u8868\u76D8</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/f2dfdb9364bb4b0e875851131d711e34.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><blockquote><p>\u26A0\uFE0F\u8F6C\u8F7D\u81EA\uFF1A<a href="https://jiangxl.blog.csdn.net/article/details/120428703" target="_blank" rel="noopener noreferrer">https://jiangxl.blog.csdn.net/article/details/120428703</a></p><p>\u4EC5\u7565\u4F5C\u4FEE\u6539\u3002</p></blockquote>`,325),e=[o];function t(c,r,y,i,A,D){return n(),a("div",null,e)}var d=s(p,[["render",t]]);export{u as __pageData,d as default};
