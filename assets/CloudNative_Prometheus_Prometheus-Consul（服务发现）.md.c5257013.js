import{_ as s,o as n,c as a,a as l}from"./app.1e6146c3.js";const B=JSON.parse('{"title":"Prometheus + Consul(\u670D\u52A1\u53D1\u73B0)","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u5355\u673A\u90E8\u7F72\u6D4B\u8BD5","slug":"\u5355\u673A\u90E8\u7F72\u6D4B\u8BD5"},{"level":3,"title":"Consul \u5206\u5E03\u5F0F\u96C6\u7FA4\u642D\u5EFA","slug":"consul-\u5206\u5E03\u5F0F\u96C6\u7FA4\u642D\u5EFA"},{"level":3,"title":"\u914D\u7F6E Prom \u5B9E\u73B0\u81EA\u52A8\u670D\u52A1\u53D1\u73B0","slug":"\u914D\u7F6E-prom-\u5B9E\u73B0\u81EA\u52A8\u670D\u52A1\u53D1\u73B0"},{"level":3,"title":"\u914D\u7F6E\u5E76\u542F\u52A8 Prom","slug":"\u914D\u7F6E\u5E76\u542F\u52A8-prom"},{"level":3,"title":"\u62D3\u5C55\uFF1A\u914D\u7F6E nginx \u8D1F\u8F7D\u5747\u8861 Consul \u96C6\u7FA4","slug":"\u62D3\u5C55\uFF1A\u914D\u7F6E-nginx-\u8D1F\u8F7D\u5747\u8861-consul-\u96C6\u7FA4"},{"level":2,"title":"\u4F7F\u7528 Docker \u90E8\u7F72","slug":"\u4F7F\u7528-docker-\u90E8\u7F72"},{"level":3,"title":"\u8FC7\u6EE4\u6807\u7B7E","slug":"\u8FC7\u6EE4\u6807\u7B7E"},{"level":3,"title":"\u6DFB\u52A0\u6807\u7B7E","slug":"\u6DFB\u52A0\u6807\u7B7E"},{"level":3,"title":"\u670D\u52A1\u6807\u7B7E\u5206\u7C7B","slug":"\u670D\u52A1\u6807\u7B7E\u5206\u7C7B"},{"level":2,"title":"\u53C2\u8003\u94FE\u63A5","slug":"\u53C2\u8003\u94FE\u63A5"}],"relativePath":"CloudNative/Prometheus/Prometheus-Consul\uFF08\u670D\u52A1\u53D1\u73B0\uFF09.md","lastUpdated":1657272051000}'),p={name:"CloudNative/Prometheus/Prometheus-Consul\uFF08\u670D\u52A1\u53D1\u73B0\uFF09.md"},o=l(`<h1 id="prometheus-consul-\u670D\u52A1\u53D1\u73B0" tabindex="-1">Prometheus + Consul(\u670D\u52A1\u53D1\u73B0) <a class="header-anchor" href="#prometheus-consul-\u670D\u52A1\u53D1\u73B0" aria-hidden="true">#</a></h1><h2 id="\u5355\u673A\u90E8\u7F72\u6D4B\u8BD5" tabindex="-1">\u5355\u673A\u90E8\u7F72\u6D4B\u8BD5 <a class="header-anchor" href="#\u5355\u673A\u90E8\u7F72\u6D4B\u8BD5" aria-hidden="true">#</a></h2><h3 id="consul-\u5206\u5E03\u5F0F\u96C6\u7FA4\u642D\u5EFA" tabindex="-1">Consul \u5206\u5E03\u5F0F\u96C6\u7FA4\u642D\u5EFA <a class="header-anchor" href="#consul-\u5206\u5E03\u5F0F\u96C6\u7FA4\u642D\u5EFA" aria-hidden="true">#</a></h3><p>Consul \u4E0B\u8F7D\u4E0E\u57FA\u7840\u914D\u7F6E\u53C2\u8003 [Consul \u5165\u95E8](./Consul <a href="http://xn--y5q338n.md" target="_blank" rel="noopener noreferrer">\u5165\u95E8.md</a>)</p><p>\u7531\u4E8E\u624B\u5934\u8D44\u6E90\u6709\u9650\uFF0C\u6545\u5C06\u96C6\u7FA4\u90E8\u7F72\u5230\u4E00\u53F0\u4E3B\u673A\u4E4B\u4E0A\u7684\u4E0D\u540C\u7AEF\u53E3\u6765\u6A21\u62DF\u96C6\u7FA4.</p><p>\u73AF\u5883\uFF1A</p><table><thead><tr><th>\u89D2\u8272</th><th>\u4E3B\u673A</th></tr></thead><tbody><tr><td>leader\u3001node01</td><td>172.16.1.132:8500</td></tr><tr><td>follower01\u3001node02</td><td>172.16.1.132:8501</td></tr><tr><td>follower02\u3001node03</td><td>172.16.1.132:8502</td></tr></tbody></table><p>\u9996\u5148\u5EFA\u7ACB\u5B58\u653E\u6570\u636E\u76EE\u5F55\uFF1A<code> mkdir -pv /data/prometheus/consul/consul0{1..3}</code></p><p>\u26A0\uFE0F**\u6CE8\u610F\uFF1A**\u4EE5\u4E0B json \u683C\u5F0F\u6587\u4EF6\u4E2D\u7684\u6CE8\u91CA\u5185\u5BB9\u9700\u8981\u5728\u5E94\u7528\u7684\u65F6\u5019\u53BB\u6389\uFF0C\u5728\u6B64\u4EC5\u4E3A\u4E86\u65B9\u4FBF\u7406\u89E3.</p><p>\u914D\u7F6E leader \u5B9E\u4F8B\uFF0C\u65B0\u5EFA\u914D\u7F6E\u6587\u4EF6 <code>consul01.json</code> \uFF0C\u5185\u5BB9\u5982\u4E0B \uFF1A</p><div class="language-json"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">datacenter</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;dc1&quot;</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">data_dir</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;/data/prometheus/consul/consul01&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">   </span><span style="color:#758575;">// \u672C\u5730\u5B58\u653E\u6570\u636E\u7684\u76EE\u5F55</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">log_level</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;INFO&quot;</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">server</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#D4976C;">true</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">     </span><span style="color:#758575;">// \u4EE5server\u8EAB\u4EFD\u542F\u52A8\u5B9E\u4F8B</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">node_name</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;node1&quot;</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">ui</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#D4976C;">true</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">     </span><span style="color:#758575;">// \u662F\u5426\u53EF\u4EE5\u8BBF\u95EEui\u754C\u9762</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">bind_addr</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;172.16.1.132&quot;</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">client_addr</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;0.0.0.0&quot;</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">advertise_addr</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;172.16.1.132&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">     </span><span style="color:#758575;">// \u96C6\u7FA4\u5E7F\u64AD\u5730\u5740</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">bootstrap_expect</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">3</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">      </span><span style="color:#758575;">// \u96C6\u7FA4\u6700\u5C11\u6210\u5458\u6570</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">ports</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">http</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8500</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">dns</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8600</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">server</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8300</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">serf_lan</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8301</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">serf_wan</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8302</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">datacenter</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;dc1&quot;</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">data_dir</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;/data/prometheus/consul/consul01&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">   </span><span style="color:#A0ADA0;">// \u672C\u5730\u5B58\u653E\u6570\u636E\u7684\u76EE\u5F55</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">log_level</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;INFO&quot;</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">server</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">true</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">     </span><span style="color:#A0ADA0;">// \u4EE5server\u8EAB\u4EFD\u542F\u52A8\u5B9E\u4F8B</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">node_name</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;node1&quot;</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">ui</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">true</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">     </span><span style="color:#A0ADA0;">// \u662F\u5426\u53EF\u4EE5\u8BBF\u95EEui\u754C\u9762</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">bind_addr</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;172.16.1.132&quot;</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">client_addr</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;0.0.0.0&quot;</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">advertise_addr</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;172.16.1.132&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">     </span><span style="color:#A0ADA0;">// \u96C6\u7FA4\u5E7F\u64AD\u5730\u5740</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">bootstrap_expect</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">3</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">      </span><span style="color:#A0ADA0;">// \u96C6\u7FA4\u6700\u5C11\u6210\u5458\u6570</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">ports</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">http</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8500</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">dns</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8600</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">server</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8300</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">serf_lan</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8301</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">serf_wan</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8302</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span></code></pre></div><p>\u540E\u53F0\u542F\u52A8<code>node01</code>\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">nohup consul agent -config-dir=consul01.json </span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;"> ./consul01.log </span><span style="color:#CB7676;">2&gt;&amp;1</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">&amp;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">nohup consul agent -config-dir=consul01.json </span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> ./consul01.log </span><span style="color:#AB5959;">2&gt;&amp;1</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span></span>
<span class="line"></span></code></pre></div><p>\u914D\u7F6E<code>follower01</code>\uFF0C\u65B0\u5EFA\u914D\u7F6E\u6587\u4EF6<code>consul02.json</code>\uFF0C\u5185\u5BB9\u5982\u4E0B\uFF1A</p><div class="language-json"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">datacenter</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;dc1&quot;</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">data_dir</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;/data/prometheus/consul/consul02&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">   </span><span style="color:#758575;">// \u6539\u4E3Aconsul03</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">log_level</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;INFO&quot;</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">server</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#D4976C;">true</span><span style="color:#858585;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">node_name</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;node2&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">     </span><span style="color:#758575;">// \u6539\u4E3Anode03</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">ui</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#D4976C;">true</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">bind_addr</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;172.16.1.132&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">client_addr</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;0.0.0.0&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">advertise_addr</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;172.16.1.132&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">bootstrap_expect</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">3</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">ports</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">http</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8501</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">   </span><span style="color:#758575;">// \u6539\u4E3A8502</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">dns</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8601</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">    </span><span style="color:#758575;">// \u6539\u4E3A8602</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">server</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8310</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;">   </span><span style="color:#758575;">// \u6539\u4E3A8320</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">serf_lan</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8311</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;"> </span><span style="color:#758575;">// \u6539\u4E3A8321</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">&quot;</span><span style="color:#E0A569;">serf_wan</span><span style="color:#858585;">&quot;</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">8312</span><span style="color:#DBD7CA;">  </span><span style="color:#758575;">// \u6539\u4E3A8322</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">datacenter</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;dc1&quot;</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">data_dir</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;/data/prometheus/consul/consul02&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">   </span><span style="color:#A0ADA0;">// \u6539\u4E3Aconsul03</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">log_level</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;INFO&quot;</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">server</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">true</span><span style="color:#8E8F8B;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">node_name</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;node2&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">     </span><span style="color:#A0ADA0;">// \u6539\u4E3Anode03</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">ui</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">true</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">bind_addr</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;172.16.1.132&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">client_addr</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;0.0.0.0&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">advertise_addr</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;172.16.1.132&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">bootstrap_expect</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">3</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">ports</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">http</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8501</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">   </span><span style="color:#A0ADA0;">// \u6539\u4E3A8502</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">dns</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8601</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">// \u6539\u4E3A8602</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">server</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8310</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;">   </span><span style="color:#A0ADA0;">// \u6539\u4E3A8320</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">serf_lan</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8311</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u6539\u4E3A8321</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">&quot;</span><span style="color:#B58451;">serf_wan</span><span style="color:#8E8F8B;">&quot;</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">8312</span><span style="color:#393A34;">  </span><span style="color:#A0ADA0;">// \u6539\u4E3A8322</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span></code></pre></div><p>\u914D\u7F6E<code>follower02</code>\u4E0E\u4E0A\u9762\u914D\u7F6E<code>follower01</code>\u7C7B\u4F3C\uFF0C\u4E0D\u518D\u8D58\u8FF0</p><p>\u540E\u53F0\u542F\u52A8<code>follower01</code>\u548C<code>follower02</code>\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">nohup consul agent -config-dir=consul02.json -join 172.16.1.132:8301 </span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;"> ./consul02.log </span><span style="color:#CB7676;">2&gt;&amp;1</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">&amp;</span></span>
<span class="line"><span style="color:#DBD7CA;">nohup consul agent -config-dir=consul03.json -join 172.16.1.132:8301 </span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;"> ./consul03.log </span><span style="color:#CB7676;">2&gt;&amp;1</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">&amp;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">nohup consul agent -config-dir=consul02.json -join 172.16.1.132:8301 </span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> ./consul02.log </span><span style="color:#AB5959;">2&gt;&amp;1</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span></span>
<span class="line"><span style="color:#393A34;">nohup consul agent -config-dir=consul03.json -join 172.16.1.132:8301 </span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> ./consul03.log </span><span style="color:#AB5959;">2&gt;&amp;1</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span></span>
<span class="line"></span></code></pre></div><p>\u67E5\u770B\u5404\u6210\u5458\u542F\u52A8\u72B6\u6001\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@master consul</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> consul members</span></span>
<span class="line"><span style="color:#DBD7CA;">Node    Address            Status  Type    Build  Protocol  DC   Segment</span></span>
<span class="line"><span style="color:#DBD7CA;">node01  172.16.1.132:8301  alive   server  1.7.2  2         dc1  </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">all</span><span style="color:#CB7676;">&gt;</span></span>
<span class="line"><span style="color:#DBD7CA;">node02  172.16.1.132:8311  alive   server  1.7.2  2         dc1  </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">all</span><span style="color:#CB7676;">&gt;</span></span>
<span class="line"><span style="color:#DBD7CA;">node03  172.16.1.132:8321  alive   server  1.7.2  2         dc1  </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">all</span><span style="color:#CB7676;">&gt;</span></span>
<span class="line"><span style="color:#758575;"># \u67E5\u770B\u96C6\u7FA4\u72B6\u6001\u53CA\u89D2\u8272\u4FE1\u606F</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@master consul</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> consul operator raft list-peers</span></span>
<span class="line"><span style="color:#DBD7CA;">Node    ID                                    Address            State     Voter  RaftProtocol</span></span>
<span class="line"><span style="color:#DBD7CA;">node01  767fbfc2-0c11-0c23-989a-cbf51c6af15b  172.16.1.132:8300  leader    </span><span style="color:#E0A569;">true</span><span style="color:#DBD7CA;">   3</span></span>
<span class="line"><span style="color:#DBD7CA;">node02  4a0a188a-aafe-24c2-1dc5-62f321671573  172.16.1.132:8310  follower  </span><span style="color:#E0A569;">true</span><span style="color:#DBD7CA;">   3</span></span>
<span class="line"><span style="color:#DBD7CA;">node03  77926cab-0bbb-5c4a-5976-e3b354915c1e  172.16.1.132:8320  follower  </span><span style="color:#E0A569;">true</span><span style="color:#DBD7CA;">   3</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@master consul</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> consul members</span></span>
<span class="line"><span style="color:#393A34;">Node    Address            Status  Type    Build  Protocol  DC   Segment</span></span>
<span class="line"><span style="color:#393A34;">node01  172.16.1.132:8301  alive   server  1.7.2  2         dc1  </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">all</span><span style="color:#AB5959;">&gt;</span></span>
<span class="line"><span style="color:#393A34;">node02  172.16.1.132:8311  alive   server  1.7.2  2         dc1  </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">all</span><span style="color:#AB5959;">&gt;</span></span>
<span class="line"><span style="color:#393A34;">node03  172.16.1.132:8321  alive   server  1.7.2  2         dc1  </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">all</span><span style="color:#AB5959;">&gt;</span></span>
<span class="line"><span style="color:#A0ADA0;"># \u67E5\u770B\u96C6\u7FA4\u72B6\u6001\u53CA\u89D2\u8272\u4FE1\u606F</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@master consul</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> consul operator raft list-peers</span></span>
<span class="line"><span style="color:#393A34;">Node    ID                                    Address            State     Voter  RaftProtocol</span></span>
<span class="line"><span style="color:#393A34;">node01  767fbfc2-0c11-0c23-989a-cbf51c6af15b  172.16.1.132:8300  leader    </span><span style="color:#B58451;">true</span><span style="color:#393A34;">   3</span></span>
<span class="line"><span style="color:#393A34;">node02  4a0a188a-aafe-24c2-1dc5-62f321671573  172.16.1.132:8310  follower  </span><span style="color:#B58451;">true</span><span style="color:#393A34;">   3</span></span>
<span class="line"><span style="color:#393A34;">node03  77926cab-0bbb-5c4a-5976-e3b354915c1e  172.16.1.132:8320  follower  </span><span style="color:#B58451;">true</span><span style="color:#393A34;">   3</span></span>
<span class="line"></span></code></pre></div><p>\u6B64\u65F6\uFF0C\u4F60\u53EF\u4EE5\u8BBF\u95EE\u4EFB\u610F\u4E00\u4E2A\u8282\u70B9\uFF0C\u67E5\u770B\u5176\u5065\u5EB7\u72B6\u51B5\uFF0C<a href="http://127.0.0.1:8500" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8500</a> \u6216 <a href="http://127.0.0.1:8501" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8501</a> \u6216 <a href="http://127.0.0.1:8502" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8502</a></p><p><img src="http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/promethues%20%2B%20consul/consul-01.png" alt=""></p><h3 id="\u914D\u7F6E-prom-\u5B9E\u73B0\u81EA\u52A8\u670D\u52A1\u53D1\u73B0" tabindex="-1">\u914D\u7F6E Prom \u5B9E\u73B0\u81EA\u52A8\u670D\u52A1\u53D1\u73B0 <a class="header-anchor" href="#\u914D\u7F6E-prom-\u5B9E\u73B0\u81EA\u52A8\u670D\u52A1\u53D1\u73B0" aria-hidden="true">#</a></h3><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u914D\u7F6E<code>Prometheus </code>\u6765\u4F7F\u7528<code> Consul \u96C6\u7FA4</code>\u6765\u5B9E\u73B0\u81EA\u52A8\u670D\u52A1\u53D1\u73B0\uFF0C\u76EE\u7684\u5C31\u662F\u80FD\u591F\u5C06\u6DFB\u52A0\u7684\u670D\u52A1\u81EA\u52A8\u53D1\u73B0\u5230 <code>Prometheus </code>\u7684 <code>Targets</code> \u4E2D\uFF0C Prometheus \u901A\u8FC7 consul \u5B9E\u73B0\u81EA\u52A8\u670D\u52A1\u53D1\u73B0 \u4E2D\u7684\u914D\u7F6E\uFF0C\u5728\u4FEE\u6539 Prometheus \u914D\u7F6E\u4E4B\u524D\uFF0C\u6211\u4EEC\u9700\u8981\u5F80 Consul \u96C6\u7FA4\u4E2D\u6CE8\u518C\u4E00\u4E9B\u6570\u636E\u3002\u9996\u5148\uFF0C\u6211\u4EEC\u6CE8\u518C\u4E00\u4E2A<code>node-exporter-172.16.1.132</code>\u7684\u670D\u52A1\uFF0C\u65B0\u5EFA <code>service-1.json </code>\u5982\u4E0B\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;ID&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;node-exporter&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Name&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;node-exporter-172.16.1.132&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Tags&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;node-exporter&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Address&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;172.16.1.132&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Port&quot;</span><span style="color:#DBD7CA;">: 9100,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Meta&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;app&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;spring-boot&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;team&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;appgroup&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;project&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;bigdata&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;EnableTagOverride&quot;</span><span style="color:#DBD7CA;">: false,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Check&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;HTTP&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;http://172.16.1.132:9100/metrics&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Interval&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Weights&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Passing&quot;</span><span style="color:#DBD7CA;">: 10,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Warning&quot;</span><span style="color:#DBD7CA;">: 1</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;"># \u8C03\u7528 API \u6CE8\u518C\u670D\u52A1</span></span>
<span class="line"><span style="color:#DBD7CA;">curl --request PUT --data @service-1.json http://172.16.1.132:8500/v1/agent/service/register</span><span style="color:#CB7676;">?</span><span style="color:#DBD7CA;">replace-existing-checks=1</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;ID&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;node-exporter&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Name&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;node-exporter-172.16.1.132&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Tags&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;node-exporter&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Address&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;172.16.1.132&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Port&quot;</span><span style="color:#393A34;">: 9100,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Meta&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;app&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;spring-boot&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;team&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;appgroup&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;project&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;bigdata&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;EnableTagOverride&quot;</span><span style="color:#393A34;">: false,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Check&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;HTTP&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;http://172.16.1.132:9100/metrics&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Interval&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Weights&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Passing&quot;</span><span style="color:#393A34;">: 10,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Warning&quot;</span><span style="color:#393A34;">: 1</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;"># \u8C03\u7528 API \u6CE8\u518C\u670D\u52A1</span></span>
<span class="line"><span style="color:#393A34;">curl --request PUT --data @service-1.json http://172.16.1.132:8500/v1/agent/service/register</span><span style="color:#AB5959;">?</span><span style="color:#393A34;">replace-existing-checks=1</span></span>
<span class="line"></span></code></pre></div><p>\u7136\u540E\uFF0C\u6211\u4EEC\u518D\u6CE8\u518C\u4E00\u4E2A <code>cadvisor-exporter-172.16.1.132</code> \u7684\u670D\u52A1\uFF0C\u65B0\u5EFA <code>service-2.json</code> \u5E76\u6267\u884C\u5982\u4E0B\u547D\u4EE4\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;ID&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;cadvisor-exporter&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Name&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;cadvisor-exporter-172.16.1.132&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Tags&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;cadvisor-exporter&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Address&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;172.16.1.132&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Port&quot;</span><span style="color:#DBD7CA;">: 8080,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Meta&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;app&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;docker&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;team&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;cloudgroup&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;project&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;docker-service&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;EnableTagOverride&quot;</span><span style="color:#DBD7CA;">: false,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Check&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;HTTP&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;http://172.16.1.132:8080/metrics&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Interval&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Weights&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Passing&quot;</span><span style="color:#DBD7CA;">: 10,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Warning&quot;</span><span style="color:#DBD7CA;">: 1</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;"># \u8C03\u7528 API \u6CE8\u518C\u670D\u52A1</span></span>
<span class="line"><span style="color:#DBD7CA;">curl --request PUT --data @service-2.json http://172.16.1.132:8500/v1/agent/service/register</span><span style="color:#CB7676;">?</span><span style="color:#DBD7CA;">replace-existing-checks=1</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;ID&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;cadvisor-exporter&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Name&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;cadvisor-exporter-172.16.1.132&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Tags&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;cadvisor-exporter&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Address&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;172.16.1.132&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Port&quot;</span><span style="color:#393A34;">: 8080,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Meta&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;app&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;docker&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;team&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;cloudgroup&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;project&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;docker-service&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;EnableTagOverride&quot;</span><span style="color:#393A34;">: false,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Check&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;HTTP&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;http://172.16.1.132:8080/metrics&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Interval&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Weights&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Passing&quot;</span><span style="color:#393A34;">: 10,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Warning&quot;</span><span style="color:#393A34;">: 1</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;"># \u8C03\u7528 API \u6CE8\u518C\u670D\u52A1</span></span>
<span class="line"><span style="color:#393A34;">curl --request PUT --data @service-2.json http://172.16.1.132:8500/v1/agent/service/register</span><span style="color:#AB5959;">?</span><span style="color:#393A34;">replace-existing-checks=1</span></span>
<span class="line"></span></code></pre></div><p>\u6CE8\u610F\uFF0C\u6CE8\u518C API \u4E4B\u524D\uFF0C\u8981\u5148\u5C06\u670D\u52A1\u542F\u52A8\u8D77\u6765\uFF0C\u8FD9\u91CC\u4E3A\u4E86\u65B9\u4FBF\u8D77\u89C1\uFF0C\u4F7F\u7528 Docker \u542F\u52A8\u8FD9\u4E24\u4E2A\u6D4B\u8BD5\u670D\u52A1\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">docker run -d -p 9100:9100 --name node-exporter prom/node-exporter </span></span>
<span class="line"><span style="color:#DBD7CA;">docker run -d -p 8080:8080 --name cadvisor-exporter google/cadvisor</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">docker run -d -p 9100:9100 --name node-exporter prom/node-exporter </span></span>
<span class="line"><span style="color:#393A34;">docker run -d -p 8080:8080 --name cadvisor-exporter google/cadvisor</span></span>
<span class="line"></span></code></pre></div><p>\u6CE8\u518C\u5B8C\u6BD5\u540E\uFF0C\u6253\u5F00 Consul \u7684 web \u754C\u9762\u8FDB\u884C\u67E5\u770B\uFF0C<a href="http://127.0.0.1:8500" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8500</a></p><p><img src="http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/promethues%20%2B%20consul/consul-02.png" alt=""></p><h3 id="\u914D\u7F6E\u5E76\u542F\u52A8-prom" tabindex="-1">\u914D\u7F6E\u5E76\u542F\u52A8 Prom <a class="header-anchor" href="#\u914D\u7F6E\u5E76\u542F\u52A8-prom" aria-hidden="true">#</a></h3><p>\u4FEE\u6539 Prom \u7684\u914D\u7F6E\u6587\u4EF6<code>prometheus.yml</code>\uFF0C\u5185\u5BB9\u5982\u4E0B\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">global:</span></span>
<span class="line"><span style="color:#DBD7CA;">  scrape_interval:     15s </span></span>
<span class="line"><span style="color:#DBD7CA;">  evaluation_interval: 15s </span></span>
<span class="line"><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">scrape_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - job_name: </span><span style="color:#C98A7D;">&#39;prometheus&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">    scrape_interval:     5s</span></span>
<span class="line"><span style="color:#DBD7CA;">    static_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - targets: </span><span style="color:#858585;">[</span><span style="color:#C98A7D;">&#39;localhost:9090&#39;</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">  - job_name: </span><span style="color:#C98A7D;">&#39;consul-node-exporter&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">    consul_sd_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - server: </span><span style="color:#C98A7D;">&#39;172.16.1.132:8500&#39;</span><span style="color:#DBD7CA;">		</span><span style="color:#758575;"># nginx\u8D1F\u8F7D\u5747\u8861\uFF0C\u6539\u4E3A172.16.1.132</span></span>
<span class="line"><span style="color:#DBD7CA;">        services: </span><span style="color:#858585;">[]</span><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">    relabel_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - source_labels: </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">__meta_consul_tags</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">        regex: .</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">node-exporter.</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#DBD7CA;">        action: keep</span></span>
<span class="line"><span style="color:#DBD7CA;">      - regex: __meta_consul_service_metadata_</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">.+</span><span style="color:#858585;">)</span></span>
<span class="line"><span style="color:#DBD7CA;">        action: labelmap</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">  - job_name: </span><span style="color:#C98A7D;">&#39;consul-cadvisor-exproter&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">    consul_sd_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - server: </span><span style="color:#C98A7D;">&#39;172.16.1.132:8501&#39;</span><span style="color:#DBD7CA;">		</span><span style="color:#758575;"># nginx\u8D1F\u8F7D\u5747\u8861\uFF0C\u6539\u4E3A172.16.1.132</span></span>
<span class="line"><span style="color:#DBD7CA;">        services: </span><span style="color:#858585;">[]</span></span>
<span class="line"><span style="color:#DBD7CA;">      - server: </span><span style="color:#C98A7D;">&#39;172.16.1.132:8502&#39;</span><span style="color:#DBD7CA;">		</span><span style="color:#758575;"># </span></span>
<span class="line"><span style="color:#DBD7CA;">        services: </span><span style="color:#858585;">[]</span></span>
<span class="line"><span style="color:#DBD7CA;">    relabel_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - source_labels: </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">__meta_consul_tags</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">        regex: .</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">cadvisor-exporter.</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#DBD7CA;">        action: keep</span></span>
<span class="line"><span style="color:#DBD7CA;">      - action: labelmap</span></span>
<span class="line"><span style="color:#DBD7CA;">        regex: __meta_consul_service_metadata_</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">.+</span><span style="color:#858585;">)</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">global:</span></span>
<span class="line"><span style="color:#393A34;">  scrape_interval:     15s </span></span>
<span class="line"><span style="color:#393A34;">  evaluation_interval: 15s </span></span>
<span class="line"><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">scrape_configs:</span></span>
<span class="line"><span style="color:#393A34;">  - job_name: </span><span style="color:#B56959;">&#39;prometheus&#39;</span></span>
<span class="line"><span style="color:#393A34;">    scrape_interval:     5s</span></span>
<span class="line"><span style="color:#393A34;">    static_configs:</span></span>
<span class="line"><span style="color:#393A34;">      - targets: </span><span style="color:#8E8F8B;">[</span><span style="color:#B56959;">&#39;localhost:9090&#39;</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">  - job_name: </span><span style="color:#B56959;">&#39;consul-node-exporter&#39;</span></span>
<span class="line"><span style="color:#393A34;">    consul_sd_configs:</span></span>
<span class="line"><span style="color:#393A34;">      - server: </span><span style="color:#B56959;">&#39;172.16.1.132:8500&#39;</span><span style="color:#393A34;">		</span><span style="color:#A0ADA0;"># nginx\u8D1F\u8F7D\u5747\u8861\uFF0C\u6539\u4E3A172.16.1.132</span></span>
<span class="line"><span style="color:#393A34;">        services: </span><span style="color:#8E8F8B;">[]</span><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">    relabel_configs:</span></span>
<span class="line"><span style="color:#393A34;">      - source_labels: </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">__meta_consul_tags</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">        regex: .</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">node-exporter.</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#393A34;">        action: keep</span></span>
<span class="line"><span style="color:#393A34;">      - regex: __meta_consul_service_metadata_</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">.+</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"><span style="color:#393A34;">        action: labelmap</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  - job_name: </span><span style="color:#B56959;">&#39;consul-cadvisor-exproter&#39;</span></span>
<span class="line"><span style="color:#393A34;">    consul_sd_configs:</span></span>
<span class="line"><span style="color:#393A34;">      - server: </span><span style="color:#B56959;">&#39;172.16.1.132:8501&#39;</span><span style="color:#393A34;">		</span><span style="color:#A0ADA0;"># nginx\u8D1F\u8F7D\u5747\u8861\uFF0C\u6539\u4E3A172.16.1.132</span></span>
<span class="line"><span style="color:#393A34;">        services: </span><span style="color:#8E8F8B;">[]</span></span>
<span class="line"><span style="color:#393A34;">      - server: </span><span style="color:#B56959;">&#39;172.16.1.132:8502&#39;</span><span style="color:#393A34;">		</span><span style="color:#A0ADA0;"># </span></span>
<span class="line"><span style="color:#393A34;">        services: </span><span style="color:#8E8F8B;">[]</span></span>
<span class="line"><span style="color:#393A34;">    relabel_configs:</span></span>
<span class="line"><span style="color:#393A34;">      - source_labels: </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">__meta_consul_tags</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">        regex: .</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">cadvisor-exporter.</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#393A34;">        action: keep</span></span>
<span class="line"><span style="color:#393A34;">      - action: labelmap</span></span>
<span class="line"><span style="color:#393A34;">        regex: __meta_consul_service_metadata_</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">.+</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"></span></code></pre></div><p>\u542F\u52A8<code>Prom</code> \u670D\u52A1\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">./prometheus --config.file=prometheus.yml</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">./prometheus --config.file=prometheus.yml</span></span>
<span class="line"></span></code></pre></div><p>\u6253\u5F00\u6D4F\u89C8\u5668\uFF0C\u8BBF\u95EE <a href="http://127.0.0.1:9090" target="_blank" rel="noopener noreferrer">http://127.0.0.1:9090</a> \u8FDB\u884C\u67E5\u770B</p><p><img src="http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/promethues%20%2B%20consul/consul-03.png" alt=""></p><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u59A5\u59A5\u6CA1\u6709\u95EE\u9898\uFF0C\u8FD9\u91CC <code>consul-node-exporter </code>\u6211\u914D\u7F6E\u6307\u5411\u4E86 <code>node1 Consul</code> \u670D\u52A1\u5730\u5740\uFF0C<code>consul-cadvisor-exproter</code> \u914D\u7F6E\u6307\u5411\u4E86<code>node2\u3001node3 Consul </code>\u670D\u52A1\uFF0C\u4E8C\u8005\u90FD\u80FD\u591F\u6B63\u786E\u53D1\u73B0\u4E4B\u524D\u6CE8\u518C\u7684\u670D\u52A1\uFF0C\u56E0\u4E3A Consul \u96C6\u7FA4\u6570\u636E\u662F\u4FDD\u6301\u540C\u6B65\u7684\uFF0C\u65E0\u8BBA\u8FDE\u63A5\u54EA\u4E00\u4E2A\u8282\u70B9\uFF0C\u90FD\u80FD\u591F\u83B7\u53D6\u5230\u6CE8\u518C\u7684\u670D\u52A1\u4FE1\u606F\uFF0C\u540C\u7406\uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u6307\u5B9A <code>consul_sd_configs </code>\u5206\u522B\u6307\u5411\u96C6\u7FA4\u6240\u6709\u8282\u70B9\uFF0C\u8FD9\u6837\u5373\u4F7F\u67D0\u4E2A\u8282\u70B9\u6302\u6389\uFF0C\u4E5F\u4E0D\u4F1A\u5F71\u54CD Prometheus \u4ECE Consul \u96C6\u7FA4\u5176\u4ED6\u8282\u70B9\u83B7\u53D6\u6CE8\u518C\u7684\u670D\u52A1\uFF0C\u4ECE\u800C\u5B9E\u73B0\u670D\u52A1\u7684\u9AD8\u53EF\u7528\u3002</p><h3 id="\u62D3\u5C55\uFF1A\u914D\u7F6E-nginx-\u8D1F\u8F7D\u5747\u8861-consul-\u96C6\u7FA4" tabindex="-1">\u62D3\u5C55\uFF1A\u914D\u7F6E nginx \u8D1F\u8F7D\u5747\u8861 Consul \u96C6\u7FA4 <a class="header-anchor" href="#\u62D3\u5C55\uFF1A\u914D\u7F6E-nginx-\u8D1F\u8F7D\u5747\u8861-consul-\u96C6\u7FA4" aria-hidden="true">#</a></h3><p>\u867D\u7136\u6211\u4EEC\u53EF\u4EE5\u5C06\u6574\u4E2A Consul \u96C6\u7FA4 IP \u6DFB\u52A0\u5230 Prometheus \u7684\u914D\u7F6E\u4E2D\uFF0C\u4ECE\u800C\u5B9E\u73B0 Prometheus \u4ECE Consul \u96C6\u7FA4\u83B7\u53D6\u6CE8\u518C\u7684\u670D\u52A1\uFF0C\u5B9E\u73B0\u670D\u52A1\u7684\u9AD8\u53EF\u7528\uFF0C\u4F46\u662F\u8FD9\u91CC\u6709\u4E2A\u95EE\u9898\uFF0C\u5982\u679C Consul \u96C6\u7FA4\u8282\u70B9\u65B0\u589E\u6216\u8005\u51CF\u5C11\uFF0C\u90A3\u4E48 Prometheus \u914D\u7F6E\u4E5F\u5F97\u8DDF\u7740\u4FEE\u6539\u4E86\uFF0C\u8FD9\u6837\u4E0D\u662F\u5F88\u53CB\u597D\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5728 Consul \u96C6\u7FA4\u524D\u9762\u4F7F\u7528 nginx \u53CD\u5411\u4EE3\u7406\u5C06\u8BF7\u6C42\u8D1F\u8F7D\u5747\u8861\u5230\u540E\u7AEF Consul \u96C6\u7FA4\u5404\u8282\u70B9\u670D\u52A1\u4E0A\uFF0C\u8FD9\u6837 Prometheus \u53EA\u9700\u8981\u914D\u7F6E\u4EE3\u7406\u5730\u5740\u5373\u53EF\uFF0C\u540E\u671F\u4E0D\u9700\u8981\u66F4\u6539\u4E86\u3002</p><p>\u7F16\u8F91 NGX \u7684\u914D\u7F6E\u6587\u4EF6<code>nginx.conf</code>\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">upstream service_consul </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    server 172.16.1.132:8500</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">    server 172.16.1.132:8501</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">    server 172.16.1.132:8502</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">    ip_hash</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">server </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    listen       80</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">    server_name _</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">    index  index.html index.htm</span><span style="color:#CB7676;">;</span><span style="color:#DBD7CA;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">    </span><span style="color:#758575;">#access_log  /var/log/nginx/host.access.log  main;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">    location / </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        add_header Access-Control-Allow-Origin </span><span style="color:#CB7676;">*;</span></span>
<span class="line"><span style="color:#DBD7CA;">        proxy_next_upstream http_502 http_504 error timeout invalid_header</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">        proxy_set_header Host </span><span style="color:#858585;">$</span><span style="color:#B8A965;">host</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">        proxy_set_header X-Real-IP </span><span style="color:#858585;">$</span><span style="color:#B8A965;">remote_addr</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">        proxy_set_header X-Forwarded-For </span><span style="color:#858585;">$</span><span style="color:#B8A965;">proxy_add_x_forwarded_for</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">        proxy_pass http://service_consul</span><span style="color:#CB7676;">;</span><span style="color:#DBD7CA;">    </span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">    access_log /var/log/consul.access.log</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">    error_log /var/log/consul.error.log</span><span style="color:#CB7676;">;</span><span style="color:#DBD7CA;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">    error_page  404              /404.html</span><span style="color:#CB7676;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">    error_page   500 502 503 504  /50x.html</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">    location = /50x.html </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">        root   /usr/share/nginx/html</span><span style="color:#CB7676;">;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">upstream service_consul </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    server 172.16.1.132:8500</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">    server 172.16.1.132:8501</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">    server 172.16.1.132:8502</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">    ip_hash</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">server </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    listen       80</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">    server_name _</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">    index  index.html index.htm</span><span style="color:#AB5959;">;</span><span style="color:#393A34;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">    </span><span style="color:#A0ADA0;">#access_log  /var/log/nginx/host.access.log  main;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    location / </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        add_header Access-Control-Allow-Origin </span><span style="color:#AB5959;">*;</span></span>
<span class="line"><span style="color:#393A34;">        proxy_next_upstream http_502 http_504 error timeout invalid_header</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">        proxy_set_header Host </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">host</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">        proxy_set_header X-Real-IP </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">remote_addr</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">        proxy_set_header X-Forwarded-For </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">proxy_add_x_forwarded_for</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">        proxy_pass http://service_consul</span><span style="color:#AB5959;">;</span><span style="color:#393A34;">    </span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    access_log /var/log/consul.access.log</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">    error_log /var/log/consul.error.log</span><span style="color:#AB5959;">;</span><span style="color:#393A34;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    error_page  404              /404.html</span><span style="color:#AB5959;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    error_page   500 502 503 504  /50x.html</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">    location = /50x.html </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">        root   /usr/share/nginx/html</span><span style="color:#AB5959;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span></code></pre></div><p>\u542F\u52A8 NGX \u670D\u52A1\uFF1A<code>systemctl start nginx</code></p><p>\u7136\u540E\u5C06 Server \u5730\u5740\u6307\u5411 NGX \u8D1F\u8F7D\u5747\u8861\u5668\uFF0C\u4FEE\u6539 Prom \u914D\u7F6E\u6587\u4EF6\uFF1A</p><div class="language-"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#dbd7ca;">\u538B\u7F29\u7BC7\u5E45\uFF0C\u53C2\u8003\u4E0A\u9762\u5B8C\u6574\u7684\`prometheus.yml\`\u6CE8\u91CA\u4FE1\u606F</span></span>
<span class="line"><span style="color:#dbd7ca;"></span></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393a34;">\u538B\u7F29\u7BC7\u5E45\uFF0C\u53C2\u8003\u4E0A\u9762\u5B8C\u6574\u7684\`prometheus.yml\`\u6CE8\u91CA\u4FE1\u606F</span></span>
<span class="line"><span style="color:#393a34;"></span></span></code></pre></div><p>\u6700\u540E\u91CD\u542F<code>prometheus</code>\u670D\u52A1\u5373\u53EF.</p><h2 id="\u4F7F\u7528-docker-\u90E8\u7F72" tabindex="-1">\u4F7F\u7528 Docker \u90E8\u7F72 <a class="header-anchor" href="#\u4F7F\u7528-docker-\u90E8\u7F72" aria-hidden="true">#</a></h2><ol><li>\u9996\u5148\u4ECE Docker Hub \u4E0A\u62C9\u53D6\u955C\u50CF\uFF1A<code>docker pull consul</code></li></ol><p>\u5728\u672C\u5730\u542F\u52A8 Consul \u96C6\u7FA4\u8FDB\u884C\u6D4B\u8BD5\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#758575;"># docker run --name consul -d -p 8500:8500 consul</span></span>
<span class="line"><span style="color:#DBD7CA;">docker run --name consul1 -d -p 8500:8500 -p 8300:8300 -p 8301:8301 -p 8302:8302 -p 8600:8600 consul agent -server -bootstrap-expect 2 -ui -bind=0.0.0.0 -client=0.0.0.0</span></span>
<span class="line"><span style="color:#758575;"># \u52A0\u5165consul1</span></span>
<span class="line"><span style="color:#DBD7CA;">docker run --name consul2 -d -p 8501:8500 consul agent -server -ui -bind=0.0.0.0 -client=0.0.0.0 -join 172.17.0.2</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#A0ADA0;"># docker run --name consul -d -p 8500:8500 consul</span></span>
<span class="line"><span style="color:#393A34;">docker run --name consul1 -d -p 8500:8500 -p 8300:8300 -p 8301:8301 -p 8302:8302 -p 8600:8600 consul agent -server -bootstrap-expect 2 -ui -bind=0.0.0.0 -client=0.0.0.0</span></span>
<span class="line"><span style="color:#A0ADA0;"># \u52A0\u5165consul1</span></span>
<span class="line"><span style="color:#393A34;">docker run --name consul2 -d -p 8501:8500 consul agent -server -ui -bind=0.0.0.0 -client=0.0.0.0 -join 172.17.0.2</span></span>
<span class="line"></span></code></pre></div><p>\u6D4F\u89C8\u5668\u8BBF\u95EE\uFF1A<a href="http://172.16.1.132:8500" target="_blank" rel="noopener noreferrer">http://172.16.1.132:8500</a> \u8FDB\u884C\u9A8C\u8BC1</p><ol start="2"><li>\u542F\u52A8<code>node-exporter</code>\u548C<code>prometheus</code></li></ol><p>\u53C2\u8003[Prometheus + Docker](./Prometheus + <a href="http://Docker.md" target="_blank" rel="noopener noreferrer">Docker.md</a>)</p><p>\u5BB9\u5668\u5168\u90E8\u542F\u52A8\u5B8C\u6BD5\u53EA\u6709\uFF0C\u5DEE\u4E0D\u591A\u5927\u6982\u662F\u8FD9\u6837\u5B50\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@master </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> docker ps</span></span>
<span class="line"><span style="color:#DBD7CA;">CONTAINER ID        IMAGE                COMMAND                  CREATED                  STATUS                  PORTS                                                                                                       NAMES</span></span>
<span class="line"><span style="color:#DBD7CA;">594b53c2689c        prom/prometheus      </span><span style="color:#C98A7D;">&quot;/bin/prometheus --c\u2026&quot;</span><span style="color:#DBD7CA;">   Less than a second ago   Up 26 minutes           0.0.0.0:9090-</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">9090/tcp                                                                                      silly_jang</span></span>
<span class="line"><span style="color:#DBD7CA;">f32263fec6a9        prom/node-exporter   </span><span style="color:#C98A7D;">&quot;/bin/node_exporter&quot;</span><span style="color:#DBD7CA;">     Less than a second ago   Up Less than a second                                                                                                               naughty_pascal</span></span>
<span class="line"><span style="color:#DBD7CA;">8da8b27d331b        consul               </span><span style="color:#C98A7D;">&quot;docker-entrypoint.s\u2026&quot;</span><span style="color:#DBD7CA;">   5 minutes ago            Up 4 minutes            8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8502-</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">8500/tcp                                    consul2</span></span>
<span class="line"><span style="color:#DBD7CA;">99b657a2e7a5        consul               </span><span style="color:#C98A7D;">&quot;docker-entrypoint.s\u2026&quot;</span><span style="color:#DBD7CA;">   6 minutes ago            Up 6 minutes            0.0.0.0:8300-8302-</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">8300-8302/tcp, 8301-8302/udp, 0.0.0.0:8500-</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">8500/tcp, 0.0.0.0:8600-</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">8600/tcp, 8600/udp   consul1</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@master </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> docker ps</span></span>
<span class="line"><span style="color:#393A34;">CONTAINER ID        IMAGE                COMMAND                  CREATED                  STATUS                  PORTS                                                                                                       NAMES</span></span>
<span class="line"><span style="color:#393A34;">594b53c2689c        prom/prometheus      </span><span style="color:#B56959;">&quot;/bin/prometheus --c\u2026&quot;</span><span style="color:#393A34;">   Less than a second ago   Up 26 minutes           0.0.0.0:9090-</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">9090/tcp                                                                                      silly_jang</span></span>
<span class="line"><span style="color:#393A34;">f32263fec6a9        prom/node-exporter   </span><span style="color:#B56959;">&quot;/bin/node_exporter&quot;</span><span style="color:#393A34;">     Less than a second ago   Up Less than a second                                                                                                               naughty_pascal</span></span>
<span class="line"><span style="color:#393A34;">8da8b27d331b        consul               </span><span style="color:#B56959;">&quot;docker-entrypoint.s\u2026&quot;</span><span style="color:#393A34;">   5 minutes ago            Up 4 minutes            8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8502-</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">8500/tcp                                    consul2</span></span>
<span class="line"><span style="color:#393A34;">99b657a2e7a5        consul               </span><span style="color:#B56959;">&quot;docker-entrypoint.s\u2026&quot;</span><span style="color:#393A34;">   6 minutes ago            Up 6 minutes            0.0.0.0:8300-8302-</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">8300-8302/tcp, 8301-8302/udp, 0.0.0.0:8500-</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">8500/tcp, 0.0.0.0:8600-</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">8600/tcp, 8600/udp   consul1</span></span>
<span class="line"></span></code></pre></div><ol start="3"><li>API \u6CE8\u518C\u670D\u52A1\u5230 Consul\uFF1A</li></ol><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">curl -X PUT -d </span><span style="color:#C98A7D;">&#39;{&quot;id&quot;: &quot;node-exporter&quot;,&quot;name&quot;: &quot;node-exporter-172.16.1.132&quot;,&quot;address&quot;: &quot;172.16.1.132&quot;,&quot;port&quot;: 9100,&quot;tags&quot;: [&quot;test&quot;],&quot;checks&quot;: [{&quot;http&quot;: &quot;http://172.16.1.132:9100/metrics&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#DBD7CA;">  http://172.16.1.132:8500/v1/agent/service/register</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">curl -X PUT -d </span><span style="color:#B56959;">&#39;{&quot;id&quot;: &quot;node-exporter&quot;,&quot;name&quot;: &quot;node-exporter-172.16.1.132&quot;,&quot;address&quot;: &quot;172.16.1.132&quot;,&quot;port&quot;: 9100,&quot;tags&quot;: [&quot;test&quot;],&quot;checks&quot;: [{&quot;http&quot;: &quot;http://172.16.1.132:9100/metrics&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#393A34;">  http://172.16.1.132:8500/v1/agent/service/register</span></span>
<span class="line"></span></code></pre></div><p>\u6253\u5F00\u6D4F\u89C8\u5668\u8BBF\u95EE <a href="http://172.16.1.132:8500/ui/dc1/services" target="_blank" rel="noopener noreferrer">http://172.16.1.132:8500/ui/dc1/services</a> \u67E5\u770B\u662F\u5426\u6210\u529F\u6CE8\u518C.</p><p><img src="http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/promethues%20%2B%20consul/consul-1.png" alt=""></p><p>\u5982\u679C\u60F3\u8981\u6CE8\u9500\u8BE5\u670D\u52A1\uFF0C\u9700\u8981\u4F7F\u7528\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">curl -X PUT http://172.16.1.132:8500/v1/agent/service/deregister/node-exporter </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">curl -X PUT http://172.16.1.132:8500/v1/agent/service/deregister/node-exporter </span></span>
<span class="line"></span></code></pre></div><ol start="4"><li>\u914D\u7F6E <code>Prometheus </code>\u5B9E\u73B0\u81EA\u52A8\u670D\u52A1\u53D1\u73B0</li></ol><p>\u73B0\u5728 Consul \u670D\u52A1\u5DF2\u7ECF\u542F\u52A8\u5B8C\u6BD5\uFF0C\u5E76\u6210\u529F\u6CE8\u518C\u4E86\u4E00\u4E2A\u670D\u52A1\uFF0C\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u9700\u8981\u914D\u7F6E Prometheus \u6765\u4F7F\u7528 Consul \u81EA\u52A8\u670D\u52A1\u53D1\u73B0\uFF0C\u76EE\u7684\u5C31\u662F\u80FD\u591F\u5C06\u4E0A\u8FB9\u6DFB\u52A0\u7684\u670D\u52A1\u81EA\u52A8\u53D1\u73B0\u5230 Prometheus \u7684 Targets \u4E2D\uFF0C\u589E\u52A0 <code>prometheus.yml</code> \u914D\u7F6E\u5982\u4E0B\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">...</span></span>
<span class="line"><span style="color:#DBD7CA;">- job_name: </span><span style="color:#C98A7D;">&#39;consul-prometheus&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">  consul_sd_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - server: </span><span style="color:#C98A7D;">&#39;172.16.1.132:8500&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">    services: </span><span style="color:#858585;">[]</span><span style="color:#DBD7CA;">  </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">...</span></span>
<span class="line"><span style="color:#393A34;">- job_name: </span><span style="color:#B56959;">&#39;consul-prometheus&#39;</span></span>
<span class="line"><span style="color:#393A34;">  consul_sd_configs:</span></span>
<span class="line"><span style="color:#393A34;">  - server: </span><span style="color:#B56959;">&#39;172.16.1.132:8500&#39;</span></span>
<span class="line"><span style="color:#393A34;">    services: </span><span style="color:#8E8F8B;">[]</span><span style="color:#393A34;">  </span></span>
<span class="line"></span></code></pre></div><p>\u91CD\u542F<code>Promtheus</code>\u7684 Docker \u5BB9\u5668\uFF1A<code>docker restart 594b53c2689c </code>\uFF0C\u540E\u9762\u90A3\u4E2A\u77EDID\u4E3A Prom \u5BB9\u5668\u7684ID.</p><ol start="5"><li>\u6253\u5F00\u6D4F\u89C8\u5668\u8BBF\u95EE <a href="http://172.16.1.132:9090/targets" target="_blank" rel="noopener noreferrer">http://172.16.1.132:9090/targets</a></li></ol><p><img src="http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/promethues%20%2B%20consul/consul-2.png" alt=""></p><hr><p>\u2139\uFE0F-----------\u4EE5\u4E0B\u5185\u5BB9\u4E3A\u8F6C\u8F7D</p><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u5728 Targets \u4E2D\u80FD\u591F\u6210\u529F\u7684\u81EA\u52A8\u53D1\u73B0 Consul \u4E2D\u7684 Services \u4FE1\u606F\uFF0C\u540E\u671F\u9700\u8981\u6DFB\u52A0\u65B0\u7684 Targets \u65F6\uFF0C\u53EA\u9700\u8981\u901A\u8FC7 API \u5F80 Consul \u4E2D\u6CE8\u518C\u670D\u52A1\u5373\u53EF\uFF0CPrometheus \u5C31\u80FD\u81EA\u52A8\u53D1\u73B0\u8BE5\u670D\u52A1\uFF0C\u662F\u4E0D\u662F\u5F88\u65B9\u4FBF\u3002</p><p>\u4E0D\u8FC7\uFF0C\u6211\u4EEC\u4F1A\u53D1\u73B0\u6709\u5982\u4E0B\u51E0\u4E2A\u95EE\u9898\uFF1A</p><ol><li>\u4F1A\u53D1\u73B0 Prometheus \u540C\u65F6\u52A0\u8F7D\u51FA\u6765\u4E86\u9ED8\u8BA4\u670D\u52A1 consul\uFF0C\u8FD9\u4E2A\u662F\u4E0D\u9700\u8981\u7684\u3002</li><li>\u9ED8\u8BA4\u53EA\u663E\u793A job \u53CA instance \u4E24\u4E2A\u6807\u7B7E\uFF0C\u5176\u4ED6\u6807\u7B7E\u90FD\u9ED8\u8BA4\u5C5E\u4E8E before relabeling \u4E0B\uFF0C\u6709\u4E9B\u5FC5\u8981\u7684\u670D\u52A1\u4FE1\u606F\uFF0C\u4E5F\u60F3\u8981\u5728\u6807\u7B7E\u4E2D\u5C55\u793A\uFF0C\u8BE5\u5982\u4F55\u64CD\u4F5C\u5462\uFF1F</li><li>\u5982\u679C\u9700\u8981\u81EA\u5B9A\u4E49\u4E00\u4E9B\u6807\u7B7E\uFF0C\u4F8B\u5982 team\u3001group\u3001project \u7B49\u5173\u952E\u5206\u7EC4\u4FE1\u606F\uFF0C\u65B9\u4FBF\u540E\u8FB9 alertmanager \u8FDB\u884C\u544A\u8B66\u89C4\u5219\u5339\u914D\uFF0C\u8BE5\u5982\u4F55\u5904\u7406\u5462\uFF1F</li><li>\u6240\u6709 Consul \u4E2D\u6CE8\u518C\u7684 Service \u90FD\u4F1A\u9ED8\u8BA4\u52A0\u8F7D\u5230 Prometheus \u4E0B\u914D\u7F6E\u7684 consul_prometheus \u7EC4\uFF0C\u5982\u679C\u6709\u591A\u79CD\u7C7B\u578B\u7684 exporter\uFF0C\u5982\u4F55\u5728 Prometheus \u4E2D\u914D\u7F6E\u5206\u914D\u7ED9\u6307\u5B9A\u7C7B\u578B\u7684\u7EC4\uFF0C\u65B9\u4FBF\u76F4\u89C2\u7684\u533A\u522B\u5B83\u4EEC\uFF1F</li></ol><p>\u4EE5\u4E0A\u95EE\u9898\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7 Prometheus \u914D\u7F6E\u4E2D\u7684 relabel_configs \u53C2\u6570\u6765\u89E3\u51B3\u3002</p><h3 id="\u8FC7\u6EE4\u6807\u7B7E" tabindex="-1">\u8FC7\u6EE4\u6807\u7B7E <a class="header-anchor" href="#\u8FC7\u6EE4\u6807\u7B7E" aria-hidden="true">#</a></h3><p>1\uFE0F\u20E3 \u95EE\u9898\u4E00\uFF0C\u6211\u4EEC\u53EF\u4EE5\u914D\u7F6E<code> relabel_configs</code> \u6765\u5B9E\u73B0\u6807\u7B7E\u8FC7\u6EE4\uFF0C\u53EA\u52A0\u8F7D\u7B26\u5408\u89C4\u5219\u7684\u670D\u52A1\u3002\u4EE5\u4E0A\u8FB9\u4E3A\u4F8B\uFF0C\u53EF\u4EE5\u901A\u8FC7\u8FC7\u6EE4 <code>__meta_consul_tags</code> \u6807\u7B7E\u4E3A <code>test </code>\u7684\u670D\u52A1\uFF0Crelabel_config \u5411 Consul \u6CE8\u518C\u670D\u52A1\u7684\u65F6\u5019\uFF0C\u53EA\u52A0\u8F7D\u5339\u914D regex \u8868\u8FBE\u5F0F\u7684\u6807\u7B7E\u7684\u670D\u52A1\u5230\u81EA\u5DF1\u7684\u914D\u7F6E\u6587\u4EF6\u3002\u4FEE\u6539 <code>prometheus.yml </code>\u914D\u7F6E\u5982\u4E0B\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">...</span></span>
<span class="line"><span style="color:#DBD7CA;">- job_name: </span><span style="color:#C98A7D;">&#39;consul-prometheus&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">  consul_sd_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - server: </span><span style="color:#C98A7D;">&#39;172.30.12.167:8500&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">      services: </span><span style="color:#858585;">[]</span><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">  relabel_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - source_labels: </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">__meta_consul_tags</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">      regex: .</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">test.</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#DBD7CA;">      action: keep</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">...</span></span>
<span class="line"><span style="color:#393A34;">- job_name: </span><span style="color:#B56959;">&#39;consul-prometheus&#39;</span></span>
<span class="line"><span style="color:#393A34;">  consul_sd_configs:</span></span>
<span class="line"><span style="color:#393A34;">    - server: </span><span style="color:#B56959;">&#39;172.30.12.167:8500&#39;</span></span>
<span class="line"><span style="color:#393A34;">      services: </span><span style="color:#8E8F8B;">[]</span><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">  relabel_configs:</span></span>
<span class="line"><span style="color:#393A34;">    - source_labels: </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">__meta_consul_tags</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">      regex: .</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">test.</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#393A34;">      action: keep</span></span>
<span class="line"></span></code></pre></div><p>\u89E3\u91CA\u4E0B\uFF0C\u8FD9\u91CC\u7684<code>relabel_configs</code>\u914D\u7F6E\u4F5C\u7528\u4E3A\u4E22\u5F03\u6E90\u6807\u7B7E\u4E2D <code>__meta_consul_tags</code> \u4E0D\u5305\u542B test \u6807\u7B7E\u7684\u670D\u52A1\uFF0C<code>__meta_consul_tags </code>\u5BF9\u5E94\u5230 Consul \u670D\u52A1\u4E2D\u7684\u503C\u4E3A <code>&quot;tags&quot;: [&quot;test&quot;]</code>\uFF0C\u9ED8\u8BA4 consul \u670D\u52A1\u662F\u4E0D\u5E26\u8BE5\u6807\u7B7E\u7684\uFF0C\u4ECE\u800C\u5B9E\u73B0\u8FC7\u6EE4\u3002\u91CD\u542F Prometheus \u53EF\u4EE5\u770B\u5230\u73B0\u5728\u53EA\u83B7\u53D6\u4E86 node-exporter-172.30.12.167 \u8FD9\u4E2A\u670D\u52A1\u4E86\u3002</p><p><img src="https://img-blog.csdnimg.cn/20191112092557226.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70" alt=""></p><h3 id="\u6DFB\u52A0\u6807\u7B7E" tabindex="-1">\u6DFB\u52A0\u6807\u7B7E <a class="header-anchor" href="#\u6DFB\u52A0\u6807\u7B7E" aria-hidden="true">#</a></h3><p>2\uFE0F\u20E3&amp;3\uFE0F\u20E3\u95EE\u9898\u4E8C\u548C\u95EE\u9898\u4E09\u53EF\u4EE5\u5F52\u4E3A\u4E00\u7C7B\uFF0C\u5C31\u662F\u5C06\u7CFB\u7EDF\u9ED8\u8BA4\u6807\u7B7E\u6216\u8005\u7528\u6237\u81EA\u5B9A\u4E49\u6807\u7B7E\u8F6C\u6362\u6210\u53EF\u89C6\u5316\u6807\u7B7E\uFF0C\u65B9\u4FBF\u67E5\u770B\u53CA\u540E\u7EED <code>Alertmanager </code>\u8FDB\u884C\u544A\u8B66\u89C4\u5219\u5339\u914D\u5206\u7EC4\u3002\u4E0D\u8FC7\u8981\u5B9E\u73B0\u7ED9\u670D\u52A1\u6DFB\u52A0\u81EA\u5B9A\u4E49\u6807\u7B7E\uFF0C\u6211\u4EEC\u8FD8\u5F97\u505A\u4E00\u4E0B\u4FEE\u6539\uFF0C\u5C31\u662F\u5728\u6CE8\u518C\u670D\u52A1\u65F6\uFF0C\u5C06\u81EA\u5B9A\u4E49\u6807\u7B7E\u4FE1\u606F\u6DFB\u52A0\u5230 Meta Data \u6570\u636E\u4E2D\uFF0C\u5177\u4F53\u53EF\u4EE5\u53C2\u8003 [\u8FD9\u91CC](Consul Service - Agent HTTP API) \u5B98\u7F51\u8BF4\u660E\uFF0C\u4E0B\u8FB9\u6765\u6F14\u793A\u4E00\u4E0B\u5982\u4F55\u64CD\u4F5C\u3002</p><p>\u65B0\u5EFA <code>consul-0.json</code> \u5982\u4E0B\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">$ vim consul-0.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;ID&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;node-exporter&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Name&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;node-exporter-172.30.12.167&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Tags&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;test&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Address&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;172.30.12.167&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Port&quot;</span><span style="color:#DBD7CA;">: 9100,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Meta&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;app&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;spring-boot&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;team&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;appgroup&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;project&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;bigdata&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;EnableTagOverride&quot;</span><span style="color:#DBD7CA;">: false,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Check&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;HTTP&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;http://172.30.12.167:9100/metrics&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Interval&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Weights&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Passing&quot;</span><span style="color:#DBD7CA;">: 10,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Warning&quot;</span><span style="color:#DBD7CA;">: 1</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">$ vim consul-0.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;ID&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;node-exporter&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Name&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;node-exporter-172.30.12.167&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Tags&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;test&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Address&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;172.30.12.167&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Port&quot;</span><span style="color:#393A34;">: 9100,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Meta&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;app&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;spring-boot&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;team&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;appgroup&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;project&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;bigdata&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;EnableTagOverride&quot;</span><span style="color:#393A34;">: false,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Check&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;HTTP&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;http://172.30.12.167:9100/metrics&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Interval&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Weights&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Passing&quot;</span><span style="color:#393A34;">: 10,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Warning&quot;</span><span style="color:#393A34;">: 1</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span></code></pre></div><p>\u8BF4\u660E\u4E00\u4E0B\uFF1A\u8BE5 Json \u6587\u4EF6\u4E3A\u8981\u6CE8\u518C\u7684\u670D\u52A1\u4FE1\u606F\uFF0C\u540C\u65F6\u5F80 Meta \u4FE1\u606F\u4E2D\u6DFB\u52A0\u4E86 <code>app=spring-boot</code>\uFF0C<code>team=appgroup</code>\uFF0C<code>project=bigdata</code> \u4E09\u7EC4\u6807\u7B7E\uFF0C\u76EE\u7684\u5C31\u662F\u4E3A\u4E86\u65B9\u4FBF\u544A\u8B66\u5206\u7EC4\u4F7F\u7528\u3002\u6267\u884C\u5982\u4E0B\u547D\u4EE4\u8FDB\u884C\u6CE8\u518C\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">$ curl --request PUT --data @consul-0.json http://172.30.12.167:8500/v1/agent/service/register</span><span style="color:#CB7676;">?</span><span style="color:#DBD7CA;">replace-existing-checks=1</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">$ curl --request PUT --data @consul-0.json http://172.30.12.167:8500/v1/agent/service/register</span><span style="color:#AB5959;">?</span><span style="color:#393A34;">replace-existing-checks=1</span></span>
<span class="line"></span></code></pre></div><p><img src="https://img-blog.csdnimg.cn/20191112092615107.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70" alt=""></p><p>\u7136\u540E\u4FEE\u6539 <code>prometheus.yml</code> \u914D\u7F6E\u5982\u4E0B\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">...</span></span>
<span class="line"><span style="color:#DBD7CA;">- job_name: </span><span style="color:#C98A7D;">&#39;consul-prometheus&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">  consul_sd_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - server: </span><span style="color:#C98A7D;">&#39;172.30.12.167:8500&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">      services: </span><span style="color:#858585;">[]</span><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">  relabel_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - source_labels: </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">__meta_consul_tags</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">      regex: .</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">test.</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#DBD7CA;">      action: keep</span></span>
<span class="line"><span style="color:#DBD7CA;">    - regex: __meta_consul_service_metadata_</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">.+</span><span style="color:#858585;">)</span></span>
<span class="line"><span style="color:#DBD7CA;">      action: labelmap</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">...</span></span>
<span class="line"><span style="color:#393A34;">- job_name: </span><span style="color:#B56959;">&#39;consul-prometheus&#39;</span></span>
<span class="line"><span style="color:#393A34;">  consul_sd_configs:</span></span>
<span class="line"><span style="color:#393A34;">    - server: </span><span style="color:#B56959;">&#39;172.30.12.167:8500&#39;</span></span>
<span class="line"><span style="color:#393A34;">      services: </span><span style="color:#8E8F8B;">[]</span><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">  relabel_configs:</span></span>
<span class="line"><span style="color:#393A34;">    - source_labels: </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">__meta_consul_tags</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">      regex: .</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">test.</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#393A34;">      action: keep</span></span>
<span class="line"><span style="color:#393A34;">    - regex: __meta_consul_service_metadata_</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">.+</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"><span style="color:#393A34;">      action: labelmap</span></span>
<span class="line"></span></code></pre></div><p>\u89E3\u91CA\u4E00\u4E0B\uFF0C\u589E\u52A0\u7684\u914D\u7F6E\u4F5C\u7528\u4E3A\u5339\u914D <code>__meta_consul_service_metadata_ </code>\u5F00\u5934\u7684\u6807\u7B7E\uFF0C\u5C06\u6355\u83B7\u5230\u7684\u5185\u5BB9\u4F5C\u4E3A\u65B0\u7684\u6807\u7B7E\u540D\u79F0\uFF0C\u5339\u914D\u5230\u6807\u7B7E\u7684\u7684\u503C\u4F5C\u4E3A\u65B0\u6807\u7B7E\u7684\u503C\uFF0C\u800C\u6211\u4EEC\u521A\u6DFB\u52A0\u7684\u4E09\u4E2A\u81EA\u5B9A\u4E49\u6807\u7B7E\uFF0C\u7CFB\u7EDF\u4F1A\u81EA\u52A8\u6DFB\u52A0 <code>__meta_consul_service_metadata_app=spring-boot</code>\u3001<code>__meta_consul_service_metadata_team=appgroup</code>\u3001<code>__meta_consul_service_metadata_project=bigdata</code> \u4E09\u4E2A\u6807\u7B7E\uFF0C\u7ECF\u8FC7 relabel \u540E\uFF0CPrometheus \u5C06\u4F1A\u65B0\u589E <code>app=spring-boot</code>\u3001<code>team=appgroup</code>\u3001<code>project=bigdata </code>\u4E09\u4E2A\u6807\u7B7E\u3002\u91CD\u542F Prometheus \u670D\u52A1\uFF0C\u53EF\u4EE5\u770B\u5230\u65B0\u589E\u4E86\u5BF9\u5E94\u4E86\u4E09\u4E2A\u81EA\u5B9A\u4E49\u6807\u7B7E\u3002</p><p><img src="https://img-blog.csdnimg.cn/20191112092629349.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70" alt=""></p><h3 id="\u670D\u52A1\u6807\u7B7E\u5206\u7C7B" tabindex="-1">\u670D\u52A1\u6807\u7B7E\u5206\u7C7B <a class="header-anchor" href="#\u670D\u52A1\u6807\u7B7E\u5206\u7C7B" aria-hidden="true">#</a></h3><p>4\uFE0F\u20E3\u95EE\u9898\u56DB\uFF0C\u5C06\u81EA\u52A8\u53D1\u73B0\u7684\u670D\u52A1\u8FDB\u884C\u5206\u7C7B\uFF0C\u672C\u8D28\u4E0A\u8DDF\u4E0A\u8FB9\u7684\u5904\u7406\u65B9\u5F0F\u4E00\u81F4\uFF0C\u53EF\u4EE5\u6DFB\u52A0\u81EA\u5B9A\u4E49\u7684\u6807\u7B7E\u65B9\u5F0F\uFF0C\u901A\u8FC7\u6807\u7B7E\u6765\u533A\u5206\uFF0C\u4E8C\u53EF\u4EE5\u901A\u8FC7\u670D\u52A1 Tag \u6765\u8FDB\u884C\u5339\u914D\u6765\u521B\u5EFA\u4E0D\u540C\u7684\u7C7B\u578B exporter \u5206\u7EC4\u3002\u8FD9\u91CC\u6211\u4EE5\u7B2C\u4E8C\u79CD\u4E3A\u4F8B\uFF0C\u901A\u8FC7\u7ED9\u6BCF\u4E2A\u670D\u52A1\u6807\u8BB0\u4E0D\u540C\u7684 Tag\uFF0C\u7136\u540E\u901A\u8FC7 <code>relabel_configs </code>\u6765\u8FDB\u884C\u5339\u914D\u533A\u5206\u3002\u6211\u4EEC\u6765\u66F4\u65B0\u4E00\u4E0B\u539F <code>node-exporter-172.30.12.167 </code>\u670D\u52A1\u6807\u7B7E\uFF0C\u540C\u65F6\u6CE8\u518C\u4E00\u4E2A\u5176\u4ED6\u7C7B\u578B exporter \u7684\u670D\u52A1\u5982\u4E0B\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">$ vim consul-1.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;ID&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;node-exporter&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Name&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;node-exporter-172.30.12.167&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Tags&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;node-exporter&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Address&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;172.30.12.167&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Port&quot;</span><span style="color:#DBD7CA;">: 9100,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Meta&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;app&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;spring-boot&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;team&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;appgroup&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;project&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;bigdata&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;EnableTagOverride&quot;</span><span style="color:#DBD7CA;">: false,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Check&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;HTTP&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;http://172.30.12.167:9100/metrics&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Interval&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Weights&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Passing&quot;</span><span style="color:#DBD7CA;">: 10,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Warning&quot;</span><span style="color:#DBD7CA;">: 1</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;"># \u66F4\u65B0\u6CE8\u518C\u670D\u52A1</span></span>
<span class="line"><span style="color:#DBD7CA;">$ curl --request PUT --data @consul-1.json http://172.30.12.167:8500/v1/agent/service/register</span><span style="color:#CB7676;">?</span><span style="color:#DBD7CA;">replace-existing-checks=1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">$ vim consul-2.json</span></span>
<span class="line"><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;ID&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;cadvisor-exporter&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Name&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;cadvisor-exporter-172.30.12.167&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Tags&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">[</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;cadvisor-exporter&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">]</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Address&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;172.30.12.167&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Port&quot;</span><span style="color:#DBD7CA;">: 8080,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Meta&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;app&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;docker&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;team&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;cloudgroup&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;project&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;docker-service&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;EnableTagOverride&quot;</span><span style="color:#DBD7CA;">: false,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Check&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;HTTP&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;http://172.30.12.167:8080/metrics&quot;</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Interval&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#C98A7D;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span><span style="color:#DBD7CA;">,</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#C98A7D;">&quot;Weights&quot;</span><span style="color:#DBD7CA;">: </span><span style="color:#858585;">{</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Passing&quot;</span><span style="color:#DBD7CA;">: 10,</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#C98A7D;">&quot;Warning&quot;</span><span style="color:#DBD7CA;">: 1</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">}</span></span>
<span class="line"><span style="color:#858585;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575;"># \u6CE8\u518C\u670D\u52A1</span></span>
<span class="line"><span style="color:#DBD7CA;">$ curl --request PUT --data @consul-2.json http://172.30.12.167:8500/v1/agent/service/register</span><span style="color:#CB7676;">?</span><span style="color:#DBD7CA;">replace-existing-checks=1</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">$ vim consul-1.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;ID&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;node-exporter&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Name&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;node-exporter-172.30.12.167&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Tags&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;node-exporter&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Address&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;172.30.12.167&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Port&quot;</span><span style="color:#393A34;">: 9100,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Meta&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;app&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;spring-boot&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;team&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;appgroup&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;project&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;bigdata&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;EnableTagOverride&quot;</span><span style="color:#393A34;">: false,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Check&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;HTTP&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;http://172.30.12.167:9100/metrics&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Interval&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Weights&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Passing&quot;</span><span style="color:#393A34;">: 10,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Warning&quot;</span><span style="color:#393A34;">: 1</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;"># \u66F4\u65B0\u6CE8\u518C\u670D\u52A1</span></span>
<span class="line"><span style="color:#393A34;">$ curl --request PUT --data @consul-1.json http://172.30.12.167:8500/v1/agent/service/register</span><span style="color:#AB5959;">?</span><span style="color:#393A34;">replace-existing-checks=1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">$ vim consul-2.json</span></span>
<span class="line"><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;ID&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;cadvisor-exporter&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Name&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;cadvisor-exporter-172.30.12.167&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Tags&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;cadvisor-exporter&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Address&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;172.30.12.167&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Port&quot;</span><span style="color:#393A34;">: 8080,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Meta&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;app&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;docker&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;team&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;cloudgroup&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;project&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;docker-service&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;EnableTagOverride&quot;</span><span style="color:#393A34;">: false,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Check&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;HTTP&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;http://172.30.12.167:8080/metrics&quot;</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Interval&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959;">&quot;10s&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959;">&quot;Weights&quot;</span><span style="color:#393A34;">: </span><span style="color:#8E8F8B;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Passing&quot;</span><span style="color:#393A34;">: 10,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959;">&quot;Warning&quot;</span><span style="color:#393A34;">: 1</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">}</span></span>
<span class="line"><span style="color:#8E8F8B;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;"># \u6CE8\u518C\u670D\u52A1</span></span>
<span class="line"><span style="color:#393A34;">$ curl --request PUT --data @consul-2.json http://172.30.12.167:8500/v1/agent/service/register</span><span style="color:#AB5959;">?</span><span style="color:#393A34;">replace-existing-checks=1</span></span>
<span class="line"></span></code></pre></div><p>\u8BF4\u660E\u4E00\u4E0B\uFF0C\u6211\u4EEC\u66F4\u65B0\u4E86\u539F <code>node-exporter-172.30.12.167</code> \u670D\u52A1\u7684\u6807\u7B7E\u4E3A<code> node-exporter</code>\uFF0C\u540C\u65F6\u6CE8\u518C\u4E00\u4E2A\u65B0\u7C7B\u578B <code>cadvisor-exporter-172.30.12.167</code> \u670D\u52A1\uFF0C\u5E76\u8BBE\u7F6E\u6807\u7B7E\u4E3A<code> cadvisor-exporter</code>\uFF0C\u4EE5\u793A\u533A\u522B\u3002\u6CE8\u518C\u5B8C\u6BD5\uFF0C\u901A\u8FC7 Consul Web \u63A7\u5236\u53F0\u53EF\u4EE5\u770B\u5230\u6210\u529F\u6CE8\u518C\u4E86\u8FD9\u4E24\u4E2A\u670D\u52A1\u3002</p><p><img src="https://img-blog.csdnimg.cn/20191112092651357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70" alt=""></p><p>\u6700\u540E\uFF0C\u6211\u4EEC\u4FEE\u6539 <code>prometheus.yml</code> \u914D\u7F6E\u5982\u4E0B\uFF1A</p><div class="language-bash"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">...</span></span>
<span class="line"><span style="color:#DBD7CA;">  - job_name: </span><span style="color:#C98A7D;">&#39;consul-node-exporter&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">    consul_sd_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - server: </span><span style="color:#C98A7D;">&#39;172.30.12.167:8500&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">        services: </span><span style="color:#858585;">[]</span><span style="color:#DBD7CA;">  </span></span>
<span class="line"><span style="color:#DBD7CA;">    relabel_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - source_labels: </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">__meta_consul_tags</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">        regex: .</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">node-exporter.</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#DBD7CA;">        action: keep</span></span>
<span class="line"><span style="color:#DBD7CA;">      - regex: __meta_consul_service_metadata_</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">.+</span><span style="color:#858585;">)</span></span>
<span class="line"><span style="color:#DBD7CA;">        action: labelmap</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">  - job_name: </span><span style="color:#C98A7D;">&#39;consul-cadvisor-exproter&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">    consul_sd_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - server: </span><span style="color:#C98A7D;">&#39;172.30.12.167:8500&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">        services: </span><span style="color:#858585;">[]</span></span>
<span class="line"><span style="color:#DBD7CA;">    relabel_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - source_labels: </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">__meta_consul_tags</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">        regex: .</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">cadvisor-exporter.</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#DBD7CA;">        action: keep</span></span>
<span class="line"><span style="color:#DBD7CA;">      - regex: __meta_consul_service_metadata_</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">.+</span><span style="color:#858585;">)</span></span>
<span class="line"><span style="color:#DBD7CA;">        action: labelmap</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">...</span></span>
<span class="line"><span style="color:#393A34;">  - job_name: </span><span style="color:#B56959;">&#39;consul-node-exporter&#39;</span></span>
<span class="line"><span style="color:#393A34;">    consul_sd_configs:</span></span>
<span class="line"><span style="color:#393A34;">      - server: </span><span style="color:#B56959;">&#39;172.30.12.167:8500&#39;</span></span>
<span class="line"><span style="color:#393A34;">        services: </span><span style="color:#8E8F8B;">[]</span><span style="color:#393A34;">  </span></span>
<span class="line"><span style="color:#393A34;">    relabel_configs:</span></span>
<span class="line"><span style="color:#393A34;">      - source_labels: </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">__meta_consul_tags</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">        regex: .</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">node-exporter.</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#393A34;">        action: keep</span></span>
<span class="line"><span style="color:#393A34;">      - regex: __meta_consul_service_metadata_</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">.+</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"><span style="color:#393A34;">        action: labelmap</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  - job_name: </span><span style="color:#B56959;">&#39;consul-cadvisor-exproter&#39;</span></span>
<span class="line"><span style="color:#393A34;">    consul_sd_configs:</span></span>
<span class="line"><span style="color:#393A34;">      - server: </span><span style="color:#B56959;">&#39;172.30.12.167:8500&#39;</span></span>
<span class="line"><span style="color:#393A34;">        services: </span><span style="color:#8E8F8B;">[]</span></span>
<span class="line"><span style="color:#393A34;">    relabel_configs:</span></span>
<span class="line"><span style="color:#393A34;">      - source_labels: </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">__meta_consul_tags</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">        regex: .</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">cadvisor-exporter.</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#393A34;">        action: keep</span></span>
<span class="line"><span style="color:#393A34;">      - regex: __meta_consul_service_metadata_</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">.+</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"><span style="color:#393A34;">        action: labelmap</span></span>
<span class="line"></span></code></pre></div><p>\u8FD9\u91CC\u9700\u8981\u6839\u636E\u6BCF\u79CD\u7C7B\u578B\u7684 exporter \u65B0\u589E\u4E00\u4E2A\u5173\u8054 job\uFF0C\u540C\u65F6 <code>relabel_configs</code> \u4E2D\u914D\u7F6E\u4EE5 Tag \u6765\u505A\u5339\u914D\u533A\u5206\u3002\u91CD\u542F Prometheus \u670D\u52A1\uFF0C\u53EF\u4EE5\u770B\u5230\u670D\u52A1\u5DF2\u7ECF\u6309\u7167\u7C7B\u578B\u5206\u7C7B\u4E86\uFF0C\u65B9\u4FBF\u67E5\u770B\u3002</p><p><img src="https://img-blog.csdnimg.cn/20191112092709119.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70" alt=""></p><h2 id="\u53C2\u8003\u94FE\u63A5" tabindex="-1">\u53C2\u8003\u94FE\u63A5 <a class="header-anchor" href="#\u53C2\u8003\u94FE\u63A5" aria-hidden="true">#</a></h2><ul><li>relabel_config \uFF1A<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config" target="_blank" rel="noopener noreferrer">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config</a></li><li>Consul Service - Agent HTTP API\uFF1A<a href="https://www.consul.io/api/agent/service.html" target="_blank" rel="noopener noreferrer">https://www.consul.io/api/agent/service.html</a>)</li><li>CSDN @aixiaoyang168 \uFF1A<a href="https://blog.csdn.net/aixiaoyang168/article/details/103022342" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/aixiaoyang168/article/details/103022342</a></li></ul>`,101),e=[o];function t(c,r,y,A,i,u){return n(),a("div",null,e)}var d=s(p,[["render",t]]);export{B as __pageData,d as default};
