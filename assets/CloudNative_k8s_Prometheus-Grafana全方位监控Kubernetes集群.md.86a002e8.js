import{_ as s,o as a,c as n,a as l}from"./app.1e6146c3.js";const m=JSON.parse('{"title":"Prometheus+Grafana\u5168\u65B9\u4F4D\u76D1\u63A7Kubernetes\u96C6\u7FA4","description":"","frontmatter":{},"headers":[{"level":3,"title":"\u6587\u7AE0\u76EE\u5F55","slug":"\u6587\u7AE0\u76EE\u5F55"},{"level":2,"title":"1.k8s\u76D1\u63A7\u6307\u6807","slug":"_1-k8s\u76D1\u63A7\u6307\u6807"},{"level":2,"title":"2.k8s\u57FA\u7840\u73AF\u5883\u51C6\u5907","slug":"_2-k8s\u57FA\u7840\u73AF\u5883\u51C6\u5907"},{"level":3,"title":"2.1.\u73AF\u5883\u51C6\u5907","slug":"_2-1-\u73AF\u5883\u51C6\u5907"},{"level":3,"title":"2.2.\u90E8\u7F72nfs\u4F5C\u4E3Aprometheus\u5B58\u50A8","slug":"_2-2-\u90E8\u7F72nfs\u4F5C\u4E3Aprometheus\u5B58\u50A8"},{"level":3,"title":"2.3.\u83B7\u53D6prometheus yaml\u6587\u4EF6","slug":"_2-3-\u83B7\u53D6prometheus-yaml\u6587\u4EF6"},{"level":3,"title":"2.4.\u521B\u5EFA\u547D\u540D\u7A7A\u95F4prometheus","slug":"_2-4-\u521B\u5EFA\u547D\u540D\u7A7A\u95F4prometheus"},{"level":2,"title":"3.\u5728k8s\u4E2D\u90E8\u7F72prometheus","slug":"_3-\u5728k8s\u4E2D\u90E8\u7F72prometheus"},{"level":3,"title":"3.1.prometheus-yaml\u51C6\u5907","slug":"_3-1-prometheus-yaml\u51C6\u5907"},{"level":3,"title":"3.2.\u521B\u5EFArbac\u8D44\u6E90","slug":"_3-2-\u521B\u5EFArbac\u8D44\u6E90"},{"level":3,"title":"3.3.\u521B\u5EFAconfigmap\u8D44\u6E90","slug":"_3-3-\u521B\u5EFAconfigmap\u8D44\u6E90"},{"level":3,"title":"3.4.\u521B\u5EFAstatefulset\u8D44\u6E90","slug":"_3-4-\u521B\u5EFAstatefulset\u8D44\u6E90"},{"level":3,"title":"3.5.\u521B\u5EFAservice\u8D44\u6E90","slug":"_3-5-\u521B\u5EFAservice\u8D44\u6E90"},{"level":3,"title":"3.6.\u67E5\u770B\u521B\u5EFA\u7684prometheus\u6240\u6709\u8D44\u6E90\u7C7B\u578B","slug":"_3-6-\u67E5\u770B\u521B\u5EFA\u7684prometheus\u6240\u6709\u8D44\u6E90\u7C7B\u578B"},{"level":3,"title":"3.7.\u8BBF\u95EEprometheus","slug":"_3-7-\u8BBF\u95EEprometheus"},{"level":3,"title":"3.8.prometheus\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA","slug":"_3-8-prometheus\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA"},{"level":3,"title":"3.9.k8s metrics\u9875\u9762","slug":"_3-9-k8s-metrics\u9875\u9762"},{"level":2,"title":"4.\u5728k8s\u4E2D\u90E8\u7F72grafana","slug":"_4-\u5728k8s\u4E2D\u90E8\u7F72grafana"},{"level":3,"title":"4.1.\u7F16\u5199granfana-pv-pvc\u8D44\u6E90","slug":"_4-1-\u7F16\u5199granfana-pv-pvc\u8D44\u6E90"},{"level":3,"title":"4.2.\u7F16\u5199granfana-statefulset\u8D44\u6E90","slug":"_4-2-\u7F16\u5199granfana-statefulset\u8D44\u6E90"},{"level":3,"title":"4.3.\u7F16\u5199granfana-svc\u8D44\u6E90","slug":"_4-3-\u7F16\u5199granfana-svc\u8D44\u6E90"},{"level":3,"title":"4.4.k8s\u521B\u5EFAgrafana","slug":"_4-4-k8s\u521B\u5EFAgrafana"},{"level":3,"title":"4.5.\u67E5\u770B\u8D44\u6E90\u8FD0\u884C\u72B6\u6001","slug":"_4-5-\u67E5\u770B\u8D44\u6E90\u8FD0\u884C\u72B6\u6001"},{"level":3,"title":"4.6.\u767B\u9646grafana","slug":"_4-6-\u767B\u9646grafana"},{"level":3,"title":"4.7.\u5BFC\u5165k8s\u8D44\u6E90\u76D1\u63A7pod\u8D44\u6E90\u6A21\u677F","slug":"_4-7-\u5BFC\u5165k8s\u8D44\u6E90\u76D1\u63A7pod\u8D44\u6E90\u6A21\u677F"},{"level":3,"title":"4.8.\u89E3\u51B3\u6A21\u677F\u8868\u8FBE\u5F0F\u95EE\u9898\u65E0\u6CD5\u5C55\u73B0\u6240\u6709pod","slug":"_4-8-\u89E3\u51B3\u6A21\u677F\u8868\u8FBE\u5F0F\u95EE\u9898\u65E0\u6CD5\u5C55\u73B0\u6240\u6709pod"},{"level":2,"title":"5.\u76D1\u63A7k8s node\u8282\u70B9","slug":"_5-\u76D1\u63A7k8s-node\u8282\u70B9"},{"level":3,"title":"5.1.\u7F16\u5199\u4E00\u952E\u90E8\u7F72node_exporter\u811A\u672C","slug":"_5-1-\u7F16\u5199\u4E00\u952E\u90E8\u7F72node-exporter\u811A\u672C"},{"level":3,"title":"5.2.\u5BF9k8s\u7684node\u8FDB\u884C\u6267\u884Cnode_exporter\u811A\u672C","slug":"_5-2-\u5BF9k8s\u7684node\u8FDB\u884C\u6267\u884Cnode-exporter\u811A\u672C"},{"level":3,"title":"5.3.\u5728prometheus\u7684configmap\u8D44\u6E90\u4E2D\u589E\u52A0node\u8282\u70B9\u914D\u7F6E","slug":"_5-3-\u5728prometheus\u7684configmap\u8D44\u6E90\u4E2D\u589E\u52A0node\u8282\u70B9\u914D\u7F6E"},{"level":3,"title":"5.4.\u5BFC\u5165k8s node\u4E3B\u673A\u76D1\u63A7\u6A21\u677F","slug":"_5-4-\u5BFC\u5165k8s-node\u4E3B\u673A\u76D1\u63A7\u6A21\u677F"},{"level":2,"title":"6.k8s\u4F7F\u7528kube-state-metrics-\u76D1\u63A7\u8D44\u6E90\u72B6\u6001","slug":"_6-k8s\u4F7F\u7528kube-state-metrics-\u76D1\u63A7\u8D44\u6E90\u72B6\u6001"},{"level":3,"title":"6.1.\u521B\u5EFArbac\u8D44\u6E90","slug":"_6-1-\u521B\u5EFArbac\u8D44\u6E90"},{"level":3,"title":"6.2.\u521B\u5EFAdeployment\u8D44\u6E90","slug":"_6-2-\u521B\u5EFAdeployment\u8D44\u6E90"},{"level":3,"title":"6.3.\u521B\u5EFAservice\u8D44\u6E90","slug":"_6-3-\u521B\u5EFAservice\u8D44\u6E90"},{"level":3,"title":"6.4.\u8D44\u6E90\u51C6\u5907\u5C31\u7EEA","slug":"_6-4-\u8D44\u6E90\u51C6\u5907\u5C31\u7EEA"},{"level":3,"title":"6.5.\u5728prometheus\u67E5\u770B\u662F\u5426\u83B7\u53D6\u76D1\u63A7\u6307\u6807","slug":"_6-5-\u5728prometheus\u67E5\u770B\u662F\u5426\u83B7\u53D6\u76D1\u63A7\u6307\u6807"},{"level":3,"title":"6.6.\u5BFC\u5165k8s \u8D44\u6E90\u72B6\u6001\u6A21\u677F","slug":"_6-6-\u5BFC\u5165k8s-\u8D44\u6E90\u72B6\u6001\u6A21\u677F"},{"level":2,"title":"7.\u5728k8s\u4E2D\u90E8\u7F72alertmanager\u5B9E\u73B0\u544A\u8B66\u7CFB\u7EDF","slug":"_7-\u5728k8s\u4E2D\u90E8\u7F72alertmanager\u5B9E\u73B0\u544A\u8B66\u7CFB\u7EDF"},{"level":3,"title":"7.1.\u521B\u5EFAalertmanager-pv-pvc\u8D44\u6E90","slug":"_7-1-\u521B\u5EFAalertmanager-pv-pvc\u8D44\u6E90"},{"level":3,"title":"7.2.\u521B\u5EFAalertmanager-cm\u8D44\u6E90\u589E\u52A0\u5FAE\u4FE1\u544A\u8B66\u914D\u7F6E","slug":"_7-2-\u521B\u5EFAalertmanager-cm\u8D44\u6E90\u589E\u52A0\u5FAE\u4FE1\u544A\u8B66\u914D\u7F6E"},{"level":3,"title":"7.3.\u521B\u5EFAalertmanager-deployment\u8D44\u6E90","slug":"_7-3-\u521B\u5EFAalertmanager-deployment\u8D44\u6E90"},{"level":3,"title":"7.4.\u521B\u5EFAalertmanager-service\u8D44\u6E90","slug":"_7-4-\u521B\u5EFAalertmanager-service\u8D44\u6E90"},{"level":3,"title":"7.5\u67E5\u770Balertmanager\u6240\u6709\u8D44\u6E90","slug":"_7-5\u67E5\u770Balertmanager\u6240\u6709\u8D44\u6E90"},{"level":3,"title":"7.6.\u8BBF\u95EEalertmanager","slug":"_7-6-\u8BBF\u95EEalertmanager"},{"level":2,"title":"8.\u914D\u7F6Ealertmanager\u5B9E\u73B0k8s\u544A\u8B66\u7CFB\u7EDF","slug":"_8-\u914D\u7F6Ealertmanager\u5B9E\u73B0k8s\u544A\u8B66\u7CFB\u7EDF"},{"level":3,"title":"8.1.\u5728NFS\u4E0A\u51C6\u5907\u4E24\u4E2A\u544A\u8B66\u89C4\u5219\u6587\u4EF6","slug":"_8-1-\u5728nfs\u4E0A\u51C6\u5907\u4E24\u4E2A\u544A\u8B66\u89C4\u5219\u6587\u4EF6"},{"level":3,"title":"8.2.\u7F16\u5199rules\u544A\u8B66\u89C4\u5219\u7684pv\u3001pvcyaml\u6587\u4EF6","slug":"_8-2-\u7F16\u5199rules\u544A\u8B66\u89C4\u5219\u7684pv\u3001pvcyaml\u6587\u4EF6"},{"level":3,"title":"8.3.\u4FEE\u6539prometheus\u7684statefulset\u8D44\u6E90\u96C6\u6210rules","slug":"_8-3-\u4FEE\u6539prometheus\u7684statefulset\u8D44\u6E90\u96C6\u6210rules"},{"level":3,"title":"8.4.\u66F4\u65B0prometheus-statefulset\u8D44\u6E90","slug":"_8-4-\u66F4\u65B0prometheus-statefulset\u8D44\u6E90"},{"level":3,"title":"8.5.\u4FEE\u6539prometheus-configmap\u8D44\u6E90\u914D\u7F6Ealertmanager\u5730\u5740","slug":"_8-5-\u4FEE\u6539prometheus-configmap\u8D44\u6E90\u914D\u7F6Ealertmanager\u5730\u5740"},{"level":3,"title":"8.5.\u67E5\u770B\u9875\u9762\u662F\u5426\u589E\u52A0\u544A\u8B66\u89C4\u5219","slug":"_8-5-\u67E5\u770B\u9875\u9762\u662F\u5426\u589E\u52A0\u544A\u8B66\u89C4\u5219"},{"level":3,"title":"8.6.\u6A21\u62DFnode\u4E3B\u673A\u5B95\u673A\u5E76\u67E5\u770B\u5FAE\u4FE1\u544A\u8B66\u5185\u5BB9","slug":"_8-6-\u6A21\u62DFnode\u4E3B\u673A\u5B95\u673A\u5E76\u67E5\u770B\u5FAE\u4FE1\u544A\u8B66\u5185\u5BB9"}],"relativePath":"CloudNative/k8s/Prometheus-Grafana\u5168\u65B9\u4F4D\u76D1\u63A7Kubernetes\u96C6\u7FA4.md","lastUpdated":1657272051000}'),p={name:"CloudNative/k8s/Prometheus-Grafana\u5168\u65B9\u4F4D\u76D1\u63A7Kubernetes\u96C6\u7FA4.md"},e=l(`<h1 id="prometheus-grafana\u5168\u65B9\u4F4D\u76D1\u63A7kubernetes\u96C6\u7FA4" tabindex="-1">Prometheus+Grafana\u5168\u65B9\u4F4D\u76D1\u63A7Kubernetes\u96C6\u7FA4 <a class="header-anchor" href="#prometheus-grafana\u5168\u65B9\u4F4D\u76D1\u63A7kubernetes\u96C6\u7FA4" aria-hidden="true">#</a></h1><h3 id="\u6587\u7AE0\u76EE\u5F55" tabindex="-1">\u6587\u7AE0\u76EE\u5F55 <a class="header-anchor" href="#\u6587\u7AE0\u76EE\u5F55" aria-hidden="true">#</a></h3><nav class="table-of-contents"><ul><li><a href="#\u6587\u7AE0\u76EE\u5F55">\u6587\u7AE0\u76EE\u5F55</a></li><li><a href="#_1-k8s\u76D1\u63A7\u6307\u6807">1.k8s\u76D1\u63A7\u6307\u6807</a></li><li><a href="#_2-k8s\u57FA\u7840\u73AF\u5883\u51C6\u5907">2.k8s\u57FA\u7840\u73AF\u5883\u51C6\u5907</a><ul><li><a href="#_2-1-\u73AF\u5883\u51C6\u5907">2.1.\u73AF\u5883\u51C6\u5907</a></li><li><a href="#_2-2-\u90E8\u7F72nfs\u4F5C\u4E3Aprometheus\u5B58\u50A8">2.2.\u90E8\u7F72nfs\u4F5C\u4E3Aprometheus\u5B58\u50A8</a></li><li><a href="#_2-3-\u83B7\u53D6prometheus-yaml\u6587\u4EF6">2.3.\u83B7\u53D6prometheus yaml\u6587\u4EF6</a></li><li><a href="#_2-4-\u521B\u5EFA\u547D\u540D\u7A7A\u95F4prometheus">2.4.\u521B\u5EFA\u547D\u540D\u7A7A\u95F4prometheus</a></li></ul></li><li><a href="#_3-\u5728k8s\u4E2D\u90E8\u7F72prometheus">3.\u5728k8s\u4E2D\u90E8\u7F72prometheus</a><ul><li><a href="#_3-1-prometheus-yaml\u51C6\u5907">3.1.prometheus-yaml\u51C6\u5907</a></li><li><a href="#_3-2-\u521B\u5EFArbac\u8D44\u6E90">3.2.\u521B\u5EFArbac\u8D44\u6E90</a></li><li><a href="#_3-3-\u521B\u5EFAconfigmap\u8D44\u6E90">3.3.\u521B\u5EFAconfigmap\u8D44\u6E90</a></li><li><a href="#_3-4-\u521B\u5EFAstatefulset\u8D44\u6E90">3.4.\u521B\u5EFAstatefulset\u8D44\u6E90</a><ul></ul></li><li><a href="#_3-5-\u521B\u5EFAservice\u8D44\u6E90">3.5.\u521B\u5EFAservice\u8D44\u6E90</a><ul></ul></li><li><a href="#_3-6-\u67E5\u770B\u521B\u5EFA\u7684prometheus\u6240\u6709\u8D44\u6E90\u7C7B\u578B">3.6.\u67E5\u770B\u521B\u5EFA\u7684prometheus\u6240\u6709\u8D44\u6E90\u7C7B\u578B</a></li><li><a href="#_3-7-\u8BBF\u95EEprometheus">3.7.\u8BBF\u95EEprometheus</a></li><li><a href="#_3-8-prometheus\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA">3.8.prometheus\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA</a><ul></ul></li><li><a href="#_3-9-k8s-metrics\u9875\u9762">3.9.k8s metrics\u9875\u9762</a></li></ul></li><li><a href="#_4-\u5728k8s\u4E2D\u90E8\u7F72grafana">4.\u5728k8s\u4E2D\u90E8\u7F72grafana</a><ul><li><a href="#_4-1-\u7F16\u5199granfana-pv-pvc\u8D44\u6E90">4.1.\u7F16\u5199granfana-pv-pvc\u8D44\u6E90</a></li><li><a href="#_4-2-\u7F16\u5199granfana-statefulset\u8D44\u6E90">4.2.\u7F16\u5199granfana-statefulset\u8D44\u6E90</a></li><li><a href="#_4-3-\u7F16\u5199granfana-svc\u8D44\u6E90">4.3.\u7F16\u5199granfana-svc\u8D44\u6E90</a></li><li><a href="#_4-4-k8s\u521B\u5EFAgrafana">4.4.k8s\u521B\u5EFAgrafana</a></li><li><a href="#_4-5-\u67E5\u770B\u8D44\u6E90\u8FD0\u884C\u72B6\u6001">4.5.\u67E5\u770B\u8D44\u6E90\u8FD0\u884C\u72B6\u6001</a></li><li><a href="#_4-6-\u767B\u9646grafana">4.6.\u767B\u9646grafana</a></li><li><a href="#_4-7-\u5BFC\u5165k8s\u8D44\u6E90\u76D1\u63A7pod\u8D44\u6E90\u6A21\u677F">4.7.\u5BFC\u5165k8s\u8D44\u6E90\u76D1\u63A7pod\u8D44\u6E90\u6A21\u677F</a></li><li><a href="#_4-8-\u89E3\u51B3\u6A21\u677F\u8868\u8FBE\u5F0F\u95EE\u9898\u65E0\u6CD5\u5C55\u73B0\u6240\u6709pod">4.8.\u89E3\u51B3\u6A21\u677F\u8868\u8FBE\u5F0F\u95EE\u9898\u65E0\u6CD5\u5C55\u73B0\u6240\u6709pod</a><ul></ul></li></ul></li><li><a href="#_5-\u76D1\u63A7k8s-node\u8282\u70B9">5.\u76D1\u63A7k8s node\u8282\u70B9</a><ul><li><a href="#_5-1-\u7F16\u5199\u4E00\u952E\u90E8\u7F72node-exporter\u811A\u672C">5.1.\u7F16\u5199\u4E00\u952E\u90E8\u7F72node_exporter\u811A\u672C</a></li><li><a href="#_5-2-\u5BF9k8s\u7684node\u8FDB\u884C\u6267\u884Cnode-exporter\u811A\u672C">5.2.\u5BF9k8s\u7684node\u8FDB\u884C\u6267\u884Cnode_exporter\u811A\u672C</a></li><li><a href="#_5-3-\u5728prometheus\u7684configmap\u8D44\u6E90\u4E2D\u589E\u52A0node\u8282\u70B9\u914D\u7F6E">5.3.\u5728prometheus\u7684configmap\u8D44\u6E90\u4E2D\u589E\u52A0node\u8282\u70B9\u914D\u7F6E</a></li><li><a href="#_5-4-\u5BFC\u5165k8s-node\u4E3B\u673A\u76D1\u63A7\u6A21\u677F">5.4.\u5BFC\u5165k8s node\u4E3B\u673A\u76D1\u63A7\u6A21\u677F</a></li></ul></li><li><a href="#_6-k8s\u4F7F\u7528kube-state-metrics-\u76D1\u63A7\u8D44\u6E90\u72B6\u6001">6.k8s\u4F7F\u7528kube-state-metrics-\u76D1\u63A7\u8D44\u6E90\u72B6\u6001</a><ul><li><a href="#_6-1-\u521B\u5EFArbac\u8D44\u6E90">6.1.\u521B\u5EFArbac\u8D44\u6E90</a></li><li><a href="#_6-2-\u521B\u5EFAdeployment\u8D44\u6E90">6.2.\u521B\u5EFAdeployment\u8D44\u6E90</a></li><li><a href="#_6-3-\u521B\u5EFAservice\u8D44\u6E90">6.3.\u521B\u5EFAservice\u8D44\u6E90</a></li><li><a href="#_6-4-\u8D44\u6E90\u51C6\u5907\u5C31\u7EEA">6.4.\u8D44\u6E90\u51C6\u5907\u5C31\u7EEA</a></li><li><a href="#_6-5-\u5728prometheus\u67E5\u770B\u662F\u5426\u83B7\u53D6\u76D1\u63A7\u6307\u6807">6.5.\u5728prometheus\u67E5\u770B\u662F\u5426\u83B7\u53D6\u76D1\u63A7\u6307\u6807</a></li><li><a href="#_6-6-\u5BFC\u5165k8s-\u8D44\u6E90\u72B6\u6001\u6A21\u677F">6.6.\u5BFC\u5165k8s \u8D44\u6E90\u72B6\u6001\u6A21\u677F</a></li></ul></li><li><a href="#_7-\u5728k8s\u4E2D\u90E8\u7F72alertmanager\u5B9E\u73B0\u544A\u8B66\u7CFB\u7EDF">7.\u5728k8s\u4E2D\u90E8\u7F72alertmanager\u5B9E\u73B0\u544A\u8B66\u7CFB\u7EDF</a><ul><li><a href="#_7-1-\u521B\u5EFAalertmanager-pv-pvc\u8D44\u6E90">7.1.\u521B\u5EFAalertmanager-pv-pvc\u8D44\u6E90</a></li><li><a href="#_7-2-\u521B\u5EFAalertmanager-cm\u8D44\u6E90\u589E\u52A0\u5FAE\u4FE1\u544A\u8B66\u914D\u7F6E">7.2.\u521B\u5EFAalertmanager-cm\u8D44\u6E90\u589E\u52A0\u5FAE\u4FE1\u544A\u8B66\u914D\u7F6E</a></li><li><a href="#_7-3-\u521B\u5EFAalertmanager-deployment\u8D44\u6E90">7.3.\u521B\u5EFAalertmanager-deployment\u8D44\u6E90</a></li><li><a href="#_7-4-\u521B\u5EFAalertmanager-service\u8D44\u6E90">7.4.\u521B\u5EFAalertmanager-service\u8D44\u6E90</a></li><li><a href="#_7-5\u67E5\u770Balertmanager\u6240\u6709\u8D44\u6E90">7.5\u67E5\u770Balertmanager\u6240\u6709\u8D44\u6E90</a></li><li><a href="#_7-6-\u8BBF\u95EEalertmanager">7.6.\u8BBF\u95EEalertmanager</a></li></ul></li><li><a href="#_8-\u914D\u7F6Ealertmanager\u5B9E\u73B0k8s\u544A\u8B66\u7CFB\u7EDF">8.\u914D\u7F6Ealertmanager\u5B9E\u73B0k8s\u544A\u8B66\u7CFB\u7EDF</a><ul><li><a href="#_8-1-\u5728nfs\u4E0A\u51C6\u5907\u4E24\u4E2A\u544A\u8B66\u89C4\u5219\u6587\u4EF6">8.1.\u5728NFS\u4E0A\u51C6\u5907\u4E24\u4E2A\u544A\u8B66\u89C4\u5219\u6587\u4EF6</a></li><li><a href="#_8-2-\u7F16\u5199rules\u544A\u8B66\u89C4\u5219\u7684pv\u3001pvcyaml\u6587\u4EF6">8.2.\u7F16\u5199rules\u544A\u8B66\u89C4\u5219\u7684pv\u3001pvcyaml\u6587\u4EF6</a></li><li><a href="#_8-3-\u4FEE\u6539prometheus\u7684statefulset\u8D44\u6E90\u96C6\u6210rules">8.3.\u4FEE\u6539prometheus\u7684statefulset\u8D44\u6E90\u96C6\u6210rules</a></li><li><a href="#_8-4-\u66F4\u65B0prometheus-statefulset\u8D44\u6E90">8.4.\u66F4\u65B0prometheus-statefulset\u8D44\u6E90</a></li><li><a href="#_8-5-\u4FEE\u6539prometheus-configmap\u8D44\u6E90\u914D\u7F6Ealertmanager\u5730\u5740">8.5.\u4FEE\u6539prometheus-configmap\u8D44\u6E90\u914D\u7F6Ealertmanager\u5730\u5740</a></li><li><a href="#_8-5-\u67E5\u770B\u9875\u9762\u662F\u5426\u589E\u52A0\u544A\u8B66\u89C4\u5219">8.5.\u67E5\u770B\u9875\u9762\u662F\u5426\u589E\u52A0\u544A\u8B66\u89C4\u5219</a></li><li><a href="#_8-6-\u6A21\u62DFnode\u4E3B\u673A\u5B95\u673A\u5E76\u67E5\u770B\u5FAE\u4FE1\u544A\u8B66\u5185\u5BB9">8.6.\u6A21\u62DFnode\u4E3B\u673A\u5B95\u673A\u5E76\u67E5\u770B\u5FAE\u4FE1\u544A\u8B66\u5185\u5BB9</a></li></ul></li></ul></nav><h2 id="_1-k8s\u76D1\u63A7\u6307\u6807" tabindex="-1">1.k8s\u76D1\u63A7\u6307\u6807 <a class="header-anchor" href="#_1-k8s\u76D1\u63A7\u6307\u6807" aria-hidden="true">#</a></h2><p><strong>kubernetes\u672C\u8EAB\u76D1\u63A7</strong></p><ul><li>Node\u8D44\u6E90\u5229\u7528\u7387</li><li>Node\u6570\u91CF</li><li>Pods\u6570\u91CF</li><li>\u8D44\u6E90\u5BF9\u8C61\u72B6\u6001</li></ul><p><strong>Pod\u76D1\u63A7</strong></p><ul><li>pod\u6570\u91CF</li><li>\u5BB9\u5668\u8D44\u6E90\u5229\u7528\u7387</li><li>\u5E94\u7528\u7A0B\u5E8F</li></ul><p><strong>\u5B9E\u73B0\u601D\u8DEF</strong></p><ul><li>pod\u6027\u80FD <ul><li>\u4F7F\u7528cadvisor\u8FDB\u884C\u5B9E\u73B0\uFF0C\u76D1\u63A7\u5BB9\u5668\u7684CPU\u3001\u5185\u5B58\u5229\u7528\u7387</li></ul></li><li>Node\u6027\u80FD <ul><li>\u4F7F\u7528node-exporter\u5B9E\u73B0\uFF0C\u4E3B\u8981\u76D1\u63A7\u8282\u70B9CPU\u3001\u5185\u5B58\u5229\u7528\u7387</li></ul></li><li>K8S\u8D44\u6E90\u5BF9\u8C61 <ul><li>\u4F7F\u7528kube-state-metrics\u5B9E\u73B0\uFF0C\u4E3B\u8981\u7528\u4E8E\u76D1\u63A7pod\u3001deployment\u3001service</li></ul></li></ul><p>k8s\u670D\u52A1\u53D1\u73B0\u53C2\u8003\u6587\u6863\uFF1A <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config" target="_blank" rel="noopener noreferrer">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config</a></p><p>\u672C\u6587\u5C06\u4F1A\u5B9E\u73B0k8s\u5168\u65B9\u4F4D\u76D1\u63A7\uFF0C\u5E76\u914D\u5408grafana\u5C55\u793Ak8s\u8D44\u6E90\u5BF9\u8C61\u7684\u4F7F\u7528\u72B6\u6001\uFF0C\u4EE5\u53CA\u914D\u5408alertmanager\u544A\u8B66</p><h2 id="_2-k8s\u57FA\u7840\u73AF\u5883\u51C6\u5907" tabindex="-1">2.k8s\u57FA\u7840\u73AF\u5883\u51C6\u5907 <a class="header-anchor" href="#_2-k8s\u57FA\u7840\u73AF\u5883\u51C6\u5907" aria-hidden="true">#</a></h2><h3 id="_2-1-\u73AF\u5883\u51C6\u5907" tabindex="-1">2.1.\u73AF\u5883\u51C6\u5907 <a class="header-anchor" href="#_2-1-\u73AF\u5883\u51C6\u5907" aria-hidden="true">#</a></h3><table><thead><tr><th>IP</th><th>\u89D2\u8272</th></tr></thead><tbody><tr><td>192.168.16.106</td><td>k8s-master</td></tr><tr><td>192.168.16.104</td><td>k8s-node1</td></tr><tr><td>192.168.16.107</td><td>k8s-node2</td></tr><tr><td>192.168.16.105</td><td>nfs</td></tr></tbody></table><h3 id="_2-2-\u90E8\u7F72nfs\u4F5C\u4E3Aprometheus\u5B58\u50A8" tabindex="-1">2.2.\u90E8\u7F72nfs\u4F5C\u4E3Aprometheus\u5B58\u50A8 <a class="header-anchor" href="#_2-2-\u90E8\u7F72nfs\u4F5C\u4E3Aprometheus\u5B58\u50A8" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mkdir /data/prometheus</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> yum -y install nfs-utils</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim /etc/exports</span></span>
<span class="line"><span style="color:#DBD7CA;">/data/prometheus   192.168.16.0/24</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">rw,sync,no_root_squash</span><span style="color:#858585;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl restart nfs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> showmount -e</span></span>
<span class="line"><span style="color:#DBD7CA;">Export list </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CA;"> nfs:</span></span>
<span class="line"><span style="color:#DBD7CA;">/data/prometheus 192.168.16.0/24</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> chomd -R 777 /data</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mkdir /data/prometheus</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> yum -y install nfs-utils</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim /etc/exports</span></span>
<span class="line"><span style="color:#393A34;">/data/prometheus   192.168.16.0/24</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">rw,sync,no_root_squash</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl restart nfs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> showmount -e</span></span>
<span class="line"><span style="color:#393A34;">Export list </span><span style="color:#1C6B48;">for</span><span style="color:#393A34;"> nfs:</span></span>
<span class="line"><span style="color:#393A34;">/data/prometheus 192.168.16.0/24</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> chomd -R 777 /data</span></span>
<span class="line"></span></code></pre></div><h3 id="_2-3-\u83B7\u53D6prometheus-yaml\u6587\u4EF6" tabindex="-1">2.3.\u83B7\u53D6prometheus yaml\u6587\u4EF6 <a class="header-anchor" href="#_2-3-\u83B7\u53D6prometheus-yaml\u6587\u4EF6" aria-hidden="true">#</a></h3><blockquote><p>\u5728\u8FD9\u91CC\u4E0B\u8F7D</p><p><a href="https://github.com/kubernetes/kubernetes/tree/release-1.16/cluster/addons/prometheus" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/tree/release-1.16/cluster/addons/prometheus</a></p><p>\u76F4\u63A5\u514B\u9686\u5B8C\u6574\u76EE\u5F55\u4E5F\u53EF\u4EE5</p><p><a href="https://github.com/kubernetes/kubernetes.git" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes.git</a></p><p>\u26A0\uFE0F\u4FEE\u6539\uFF1A<a href="https://gitlab.com/AGou-ops/k8s_prometheus_yaml.git" target="_blank" rel="noopener noreferrer">https://gitlab.com/AGou-ops/k8s_prometheus_yaml.git</a></p><p>prometheus\u5728github\u7684k8s\u76EE\u5F55\u4E2Dmaster\u5206\u652F\u5DF2\u7ECF\u627E\u4E0D\u5230\u4E86\uFF0C\u53EF\u4EE5\u5728release-1.16\u8FD9\u91CC\u627E\u5230</p></blockquote><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u62C9\u53D6prometheus yaml\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> git clone https://github.com/kubernetes/kubernetes.git</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u5C06prometheus yaml\u6587\u4EF6\u590D\u5236\u5230\u5176\u4ED6\u76EE\u5F55</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> cp -rp kubernetes/cluster/addons/prometheus/ </span><span style="color:#E0A569;">.</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u62C9\u53D6prometheus yaml\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> git clone https://github.com/kubernetes/kubernetes.git</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u5C06prometheus yaml\u6587\u4EF6\u590D\u5236\u5230\u5176\u4ED6\u76EE\u5F55</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> cp -rp kubernetes/cluster/addons/prometheus/ </span><span style="color:#B58451;">.</span><span style="color:#393A34;"> </span></span>
<span class="line"></span></code></pre></div><p><strong>\u672C\u4EBA\u7684yaml\u6587\u4EF6</strong></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106165528931.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>\u5B98\u65B9yaml\u6587\u4EF6</strong></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106165536705.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>\u6587\u4EF6\u8BF4\u660E</strong></p><p>\u4E3B\u8981\u5206\u4E3A\u56DB\u90E8\u5206\uFF1Aprometheus\u90E8\u7F72\u3001alertmanager\u90E8\u7F72\u3001kube-state-metrics\u90E8\u7F72\u3001node-exporter\u90E8\u7F72</p><table><thead><tr><th>\u6587\u4EF6\u540D</th><th>\u4F5C\u7528</th></tr></thead><tbody><tr><td>alertmanager-configmap.yaml</td><td>alertmanager\u914D\u7F6E\u96C6\u5408\u7684yaml\u6587\u4EF6</td></tr><tr><td>alertmanager-deployment.yaml</td><td>alertmanager\u521B\u5EFApod\u7684yaml\u6587\u4EF6</td></tr><tr><td>alertmanager-pvc.yaml</td><td>alertmanager\u6302\u8F7D\u5B58\u50A8\u5377\u7684yaml\u6587\u4EF6</td></tr><tr><td>alertmanager-service.yaml</td><td>alertmanager\u5BF9\u5916\u66B4\u9732\u7AEF\u53E3\u7684yaml\u6587\u4EF6</td></tr><tr><td>grafana_pv_pvc.yaml</td><td>grafana\u6302\u8F7D\u5B58\u50A8\u5377\u7684yaml\u6587\u4EF6</td></tr><tr><td>grafana_statefulset.yaml</td><td>grafana\u53D1\u5E03pod\u7684yaml\u6587\u4EF6\uFF0C\u91C7\u7528statefulset\u8D44\u6E90</td></tr><tr><td>grafana_svc.yaml</td><td>grafana\u5BF9\u5916\u66B4\u9732\u7AEF\u53E3\u7684yaml\u6587\u4EF6</td></tr><tr><td>install_node_exportes.sh</td><td>\u6279\u91CF\u5728node\u8282\u70B9\u5B89\u88C5node_exporter\u7684\u811A\u672C</td></tr><tr><td>k8s_time.yaml</td><td>k8s\u540C\u6B65\u5BBF\u4E3B\u673A\u65F6\u95F4\u7684yaml\u6587\u4EF6</td></tr><tr><td>kube-state-metrics-deployment.yaml</td><td>k8s\u91C7\u96C6\u8D44\u6E90\u72B6\u6001\u6307\u6807\u7A0B\u5E8F\u7684yaml\u6587\u4EF6</td></tr><tr><td>kube-state-metrics-rbac.yaml</td><td>8s\u91C7\u96C6\u7A0B\u5E8F\u6388\u6743\u7684yaml\u6587\u4EF6</td></tr><tr><td>kube-state-metrics-service.yaml</td><td>k8s\u91C7\u96C6\u7A0B\u5E8F\u5BF9\u5916\u66B4\u9732\u7684yaml\u6587\u4EF6</td></tr><tr><td>node-exporter-ds.yml</td><td>node_exporter\u90E8\u7F72\u7684yaml\u6587\u4EF6</td></tr><tr><td>node-exporter-service.yaml</td><td>node_exporter\u5BF9\u5916\u66B4\u9732\u7684yaml\u6587\u4EF6</td></tr><tr><td>prometheus-configmap.yaml</td><td>prometheus\u7684\u914D\u7F6E\u6587\u4EF6\u96C6</td></tr><tr><td>prometheus-pv-pvc.yaml</td><td>prometheus\u6302\u8F7D\u5B58\u50A8\u7684yaml\u6587\u4EF6</td></tr><tr><td>prometheus-rbac.yaml</td><td>prometheus\u6388\u6743\u8BBF\u95EEapi\u7684yaml\u6587\u4EF6</td></tr><tr><td>prometheus-rules-pvc.yaml</td><td>prometheus\u544A\u8B66\u89C4\u5219\u5B58\u50A8\u5377\u7684yaml\u6587\u4EF6</td></tr><tr><td>prometheus-rules.yaml</td><td>prometheus\u5C06rule\u505A\u6210cm\u8D44\u6E90\u7684yaml\u6587\u4EF6</td></tr><tr><td>prometheus-service.yaml</td><td>prometheus\u5BF9\u5916\u63D0\u4F9B\u8BBF\u95EE\u7684yaml\u6587\u4EF6</td></tr><tr><td>prometheus-statefulset-static-pv.yaml</td><td>prometheus\u7A0B\u5E8F\u90E8\u7F72\u7684yaml\u6587\u4EF6</td></tr></tbody></table><h3 id="_2-4-\u521B\u5EFA\u547D\u540D\u7A7A\u95F4prometheus" tabindex="-1">2.4.\u521B\u5EFA\u547D\u540D\u7A7A\u95F4prometheus <a class="header-anchor" href="#_2-4-\u521B\u5EFA\u547D\u540D\u7A7A\u95F4prometheus" aria-hidden="true">#</a></h3><p>\u521B\u5EFA\u4E00\u4E2Ans\u4E3Aprometheus\uFF0C\u5C06\u9664\u4E86kube-state-metrics\u5916\u7684yaml\u4E2D\u7684namespace\u4FEE\u6539\u4E3Aprometheus</p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u521B\u5EFAns</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create namespace prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">namespace/prometheus created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u4FEE\u6539</span></span>
<span class="line"><span style="color:#DBD7CA;">\u7528vim\u6253\u5F00\u8F93\u5165\u4EE5\u4E0B\u547D\u4EE4</span></span>
<span class="line"><span style="color:#DBD7CA;">:%s/namespace: kube-system/namespace: prometheus/g</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u521B\u5EFAns</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create namespace prometheus</span></span>
<span class="line"><span style="color:#393A34;">namespace/prometheus created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u4FEE\u6539</span></span>
<span class="line"><span style="color:#393A34;">\u7528vim\u6253\u5F00\u8F93\u5165\u4EE5\u4E0B\u547D\u4EE4</span></span>
<span class="line"><span style="color:#393A34;">:%s/namespace: kube-system/namespace: prometheus/g</span></span>
<span class="line"></span></code></pre></div><h2 id="_3-\u5728k8s\u4E2D\u90E8\u7F72prometheus" tabindex="-1">3.\u5728k8s\u4E2D\u90E8\u7F72prometheus <a class="header-anchor" href="#_3-\u5728k8s\u4E2D\u90E8\u7F72prometheus" aria-hidden="true">#</a></h2><h3 id="_3-1-prometheus-yaml\u51C6\u5907" tabindex="-1">3.1.prometheus-yaml\u51C6\u5907 <a class="header-anchor" href="#_3-1-prometheus-yaml\u51C6\u5907" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">\u4E3B\u8981\u7528\u5230\u4EE5\u4E0B\u51E0\u4E2Ayaml</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> ls prometheus-</span><span style="color:#CB7676;">*</span></span>
<span class="line"><span style="color:#DBD7CA;">prometheus-configmap.yaml  prometheus-rbac.yaml  prometheus-service.yaml  prometheus-statefulset.yaml</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">\u4E3B\u8981\u7528\u5230\u4EE5\u4E0B\u51E0\u4E2Ayaml</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> ls prometheus-</span><span style="color:#AB5959;">*</span></span>
<span class="line"><span style="color:#393A34;">prometheus-configmap.yaml  prometheus-rbac.yaml  prometheus-service.yaml  prometheus-statefulset.yaml</span></span>
<span class="line"></span></code></pre></div><p>\u521B\u5EFA\u987A\u5E8F</p><blockquote><p>\u5148\u521B\u5EFAprometheus-rbac.yaml</p><p>\u5728\u521B\u5EFAprometheus-configmap.yaml</p><p>\u5728\u521B\u5EFAprometheus-statefulset.yaml</p><p>\u6700\u540E\u521B\u5EFAprometheus-service.yaml</p></blockquote><h3 id="_3-2-\u521B\u5EFArbac\u8D44\u6E90" tabindex="-1">3.2.\u521B\u5EFArbac\u8D44\u6E90 <a class="header-anchor" href="#_3-2-\u521B\u5EFArbac\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f prometheus-rbac.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">serviceaccount/prometheus created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrole.rbac.authorization.k8s.io/prometheus created</span></span>
<span class="line"><span style="color:#DBD7CA;">clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f prometheus-rbac.yaml </span></span>
<span class="line"><span style="color:#393A34;">serviceaccount/prometheus created</span></span>
<span class="line"><span style="color:#393A34;">clusterrole.rbac.authorization.k8s.io/prometheus created</span></span>
<span class="line"><span style="color:#393A34;">clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-3-\u521B\u5EFAconfigmap\u8D44\u6E90" tabindex="-1">3.3.\u521B\u5EFAconfigmap\u8D44\u6E90 <a class="header-anchor" href="#_3-3-\u521B\u5EFAconfigmap\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f prometheus-configmap.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">configmap/prometheus-config created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f prometheus-configmap.yaml </span></span>
<span class="line"><span style="color:#393A34;">configmap/prometheus-config created</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-4-\u521B\u5EFAstatefulset\u8D44\u6E90" tabindex="-1">3.4.\u521B\u5EFAstatefulset\u8D44\u6E90 <a class="header-anchor" href="#_3-4-\u521B\u5EFAstatefulset\u8D44\u6E90" aria-hidden="true">#</a></h3><p>github\u4E0A\u7684statefulset\u8D44\u6E90\u4F7F\u7528\u7684\u662Fstorageclasee\u52A8\u6001\u521B\u5EFApv\uFF0C\u7531\u4E8E\u4E0D\u4F1A\u4F7F\u7528storageclass\uFF0C\u56E0\u6B64\u5C06statefulset\u8D44\u6E90\u8FDB\u884C\u6539\u9020\uFF0C\u4F7F\u7528\u9759\u6001pv\u505A\u5B58\u50A8</p><h4 id="_3-4-1-\u6539\u9020statefulst\u8D44\u6E90\u652F\u6301\u9759\u6001pv" tabindex="-1">3.4.1.\u6539\u9020statefulst\u8D44\u6E90\u652F\u6301\u9759\u6001pv <a class="header-anchor" href="#_3-4-1-\u6539\u9020statefulst\u8D44\u6E90\u652F\u6301\u9759\u6001pv" aria-hidden="true">#</a></h4><p>\u6539\u9020\u601D\u8DEF\uFF1A\u5728yaml\u4E2D\u589E\u52A0pv\u3001pvc\u7684\u914D\u7F6E\uFF0C\u5728\u5C06\u539F\u6765\u7684storageclass\u914D\u7F6E\u9879\u5220\u9664\uFF0C\u5728120\u884C\u7684volume\u4E2D\u589E\u52A0pvc\u7684\u914D\u7F6E\u5373\u53EF</p><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#C98A7D;">root@k8s-master ~/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#C98A7D;">\\# vim prometheus-statefulset-static-pv.yaml</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#429988;">apiVersion</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">v1</span></span>
<span class="line"><span style="color:#429988;">kind</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#429988;">metadata</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus-data</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">namespace</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"><span style="color:#429988;">spec</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">accessModes</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">resources</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">requests</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">storage</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">16Gi</span></span>
<span class="line"><span style="color:#A1B567;">---</span></span>
<span class="line"><span style="color:#429988;">apiVersion</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">v1</span></span>
<span class="line"><span style="color:#429988;">kind</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">PersistentVolume</span></span>
<span class="line"><span style="color:#429988;">metadata</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">pv-prometheus</span></span>
<span class="line"><span style="color:#429988;">spec</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">capacity</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">storage</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">16Gi</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">accessModes</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">nfs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">path</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/data/prometheus/prometheus_data</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">server</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">192.168.16.105</span></span>
<span class="line"><span style="color:#A1B567;">---</span></span>
<span class="line"><span style="color:#429988;">apiVersion</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">apps/v1</span></span>
<span class="line"><span style="color:#429988;">kind</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">StatefulSet</span></span>
<span class="line"><span style="color:#429988;">metadata</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">namespace</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">k8s-app</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">kubernetes.io/cluster-service</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">addonmanager.kubernetes.io/mode</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">Reconcile</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">version</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">v2.2.1</span></span>
<span class="line"><span style="color:#429988;">spec</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">serviceName</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;prometheus&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">replicas</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">1</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">podManagementPolicy</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;Parallel&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">updateStrategy</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">   </span><span style="color:#429988;">type</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;RollingUpdate&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">selector</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">matchLabels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">k8s-app</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">template</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">metadata</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#429988;">k8s-app</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">spec</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">priorityClassName</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">system-cluster-critical</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">serviceAccountName</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">initContainers</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;init-chown-data&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#429988;">image</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;busybox:latest&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#429988;">imagePullPolicy</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;IfNotPresent&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#429988;">command</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">[</span><span style="color:#C98A7D;">&quot;chown&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;-R&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;65534:65534&quot;</span><span style="color:#858585;">,</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;/data&quot;</span><span style="color:#858585;">]</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#429988;">volumeMounts</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus-data</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">mountPath</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/data</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">subPath</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">containers</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus-server-configmap-reload</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">image</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;jimmidyson/configmap-reload:v0.1&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">imagePullPolicy</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;IfNotPresent&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">args</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">--volume-dir=/etc/config</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">--webhook-url=http://127.0.0.1:9090/-/reload</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">volumeMounts</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">config-volume</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">mountPath</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/etc/config</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">readOnly</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#4D9375;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">resources</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">limits</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">cpu</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">10m</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">memory</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">10Mi</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">requests</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">cpu</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">10m</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">memory</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">10Mi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus-server</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">image</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;prom/prometheus:v2.23.0&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">imagePullPolicy</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;IfNotPresent&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">args</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">--config.file=/etc/config/prometheus.yml</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">--storage.tsdb.path=/data</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">--web.console.libraries=/etc/prometheus/console_libraries</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">--web.console.templates=/etc/prometheus/consoles</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">--web.enable-lifecycle</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">ports</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">containerPort</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">9090</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">readinessProbe</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">httpGet</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">path</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/-/ready</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">port</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">9090</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">initialDelaySeconds</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">30</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">timeoutSeconds</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">30</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">livenessProbe</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">httpGet</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">path</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/-/healthy</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">port</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">9090</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">initialDelaySeconds</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">30</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">timeoutSeconds</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">30</span></span>
<span class="line"><span style="color:#858585;">          </span><span style="color:#758575;"># based on 10 running nodes with 30 pods each</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">resources</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">limits</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">cpu</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">200m</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">memory</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">1000Mi</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">requests</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">cpu</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">200m</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">memory</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">1000Mi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">volumeMounts</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">config-volume</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">mountPath</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/etc/config</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus-data</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">mountPath</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/data</span></span>
<span class="line"><span style="color:#DBD7CA;">              </span><span style="color:#429988;">subPath</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">terminationGracePeriodSeconds</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">300</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">volumes</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">config-volume</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">configMap</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus-config</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus-data</span></span>
<span class="line"><span style="color:#DBD7CA;">          </span><span style="color:#429988;">persistentVolumeClaim</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">            </span><span style="color:#429988;">claimName</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus-data</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#B56959;">root@k8s-master ~/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#B56959;">\\# vim prometheus-statefulset-static-pv.yaml</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#2F8A89;">apiVersion</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">v1</span></span>
<span class="line"><span style="color:#2F8A89;">kind</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#2F8A89;">metadata</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus-data</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">namespace</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"><span style="color:#2F8A89;">spec</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">accessModes</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">resources</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">requests</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">storage</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">16Gi</span></span>
<span class="line"><span style="color:#6C7834;">---</span></span>
<span class="line"><span style="color:#2F8A89;">apiVersion</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">v1</span></span>
<span class="line"><span style="color:#2F8A89;">kind</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">PersistentVolume</span></span>
<span class="line"><span style="color:#2F8A89;">metadata</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">pv-prometheus</span></span>
<span class="line"><span style="color:#2F8A89;">spec</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">capacity</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">storage</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">16Gi</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">accessModes</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">nfs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">path</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/data/prometheus/prometheus_data</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">server</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">192.168.16.105</span></span>
<span class="line"><span style="color:#6C7834;">---</span></span>
<span class="line"><span style="color:#2F8A89;">apiVersion</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">apps/v1</span></span>
<span class="line"><span style="color:#2F8A89;">kind</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">StatefulSet</span></span>
<span class="line"><span style="color:#2F8A89;">metadata</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">namespace</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">kube-system</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">k8s-app</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">kubernetes.io/cluster-service</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">addonmanager.kubernetes.io/mode</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">Reconcile</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">version</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">v2.2.1</span></span>
<span class="line"><span style="color:#2F8A89;">spec</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">serviceName</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;prometheus&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">replicas</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">1</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">podManagementPolicy</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;Parallel&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">updateStrategy</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">   </span><span style="color:#2F8A89;">type</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;RollingUpdate&quot;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">selector</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">matchLabels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">k8s-app</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">template</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">metadata</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#2F8A89;">k8s-app</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">spec</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">priorityClassName</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">system-cluster-critical</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">serviceAccountName</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">initContainers</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;init-chown-data&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#2F8A89;">image</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;busybox:latest&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#2F8A89;">imagePullPolicy</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;IfNotPresent&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#2F8A89;">command</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">[</span><span style="color:#B56959;">&quot;chown&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;-R&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;65534:65534&quot;</span><span style="color:#8E8F8B;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;/data&quot;</span><span style="color:#8E8F8B;">]</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#2F8A89;">volumeMounts</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus-data</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">mountPath</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/data</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">subPath</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;&quot;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">containers</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus-server-configmap-reload</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">image</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;jimmidyson/configmap-reload:v0.1&quot;</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">imagePullPolicy</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;IfNotPresent&quot;</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">args</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">--volume-dir=/etc/config</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">--webhook-url=http://127.0.0.1:9090/-/reload</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">volumeMounts</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">config-volume</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">mountPath</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/etc/config</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">readOnly</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#1C6B48;">true</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">resources</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">limits</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">cpu</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">10m</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">memory</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">10Mi</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">requests</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">cpu</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">10m</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">memory</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">10Mi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus-server</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">image</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;prom/prometheus:v2.23.0&quot;</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">imagePullPolicy</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;IfNotPresent&quot;</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">args</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">--config.file=/etc/config/prometheus.yml</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">--storage.tsdb.path=/data</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">--web.console.libraries=/etc/prometheus/console_libraries</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">--web.console.templates=/etc/prometheus/consoles</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">--web.enable-lifecycle</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">ports</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">containerPort</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">9090</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">readinessProbe</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">httpGet</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">path</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/-/ready</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">port</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">9090</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">initialDelaySeconds</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">30</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">timeoutSeconds</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">30</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">livenessProbe</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">httpGet</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">path</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/-/healthy</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">port</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">9090</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">initialDelaySeconds</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">30</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">timeoutSeconds</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">30</span></span>
<span class="line"><span style="color:#8E8F8B;">          </span><span style="color:#A0ADA0;"># based on 10 running nodes with 30 pods each</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">resources</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">limits</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">cpu</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">200m</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">memory</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">1000Mi</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">requests</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">cpu</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">200m</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">memory</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">1000Mi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">volumeMounts</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">config-volume</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">mountPath</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/etc/config</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus-data</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">mountPath</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/data</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#2F8A89;">subPath</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;&quot;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">terminationGracePeriodSeconds</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">300</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">volumes</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">config-volume</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">configMap</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus-config</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus-data</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#2F8A89;">persistentVolumeClaim</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#2F8A89;">claimName</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus-data</span></span>
<span class="line"></span></code></pre></div><h4 id="_3-4-2-\u521B\u5EFAstatefulset\u8D44\u6E90" tabindex="-1">3.4.2.\u521B\u5EFAstatefulset\u8D44\u6E90 <a class="header-anchor" href="#_3-4-2-\u521B\u5EFAstatefulset\u8D44\u6E90" aria-hidden="true">#</a></h4><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f  prometheus-statefulset-static-pv.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolumeclaim/prometheus-data created</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolume/pv-prometheus created</span></span>
<span class="line"><span style="color:#DBD7CA;">statefulset.apps/prometheus created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f  prometheus-statefulset-static-pv.yaml </span></span>
<span class="line"><span style="color:#393A34;">persistentvolumeclaim/prometheus-data created</span></span>
<span class="line"><span style="color:#393A34;">persistentvolume/pv-prometheus created</span></span>
<span class="line"><span style="color:#393A34;">statefulset.apps/prometheus created</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-5-\u521B\u5EFAservice\u8D44\u6E90" tabindex="-1">3.5.\u521B\u5EFAservice\u8D44\u6E90 <a class="header-anchor" href="#_3-5-\u521B\u5EFAservice\u8D44\u6E90" aria-hidden="true">#</a></h3><h4 id="_3-5-1-\u4FEE\u6539service\u8D44\u6E90\u652F\u6301nodeport" tabindex="-1">3.5.1.\u4FEE\u6539service\u8D44\u6E90\u652F\u6301nodeport <a class="header-anchor" href="#_3-5-1-\u4FEE\u6539service\u8D44\u6E90\u652F\u6301nodeport" aria-hidden="true">#</a></h4><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#C98A7D;">root@k8s-master ~/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#C98A7D;">\\# vim prometheus-service.yaml</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#429988;">kind</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">Service</span></span>
<span class="line"><span style="color:#429988;">apiVersion</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">v1</span></span>
<span class="line"><span style="color:#429988;">metadata</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">namespace</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">kubernetes.io/name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;Prometheus&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">kubernetes.io/cluster-service</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">addonmanager.kubernetes.io/mode</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">Reconcile</span></span>
<span class="line"><span style="color:#429988;">spec</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">type</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">NodePort</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">ports</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">http</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">port</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">9090</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">protocol</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">TCP</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">targetPort</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">9090</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">selector</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">k8s-app</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#B56959;">root@k8s-master ~/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#B56959;">\\# vim prometheus-service.yaml</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#2F8A89;">kind</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">Service</span></span>
<span class="line"><span style="color:#2F8A89;">apiVersion</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">v1</span></span>
<span class="line"><span style="color:#2F8A89;">metadata</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">namespace</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">kubernetes.io/name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;Prometheus&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">kubernetes.io/cluster-service</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">addonmanager.kubernetes.io/mode</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">Reconcile</span></span>
<span class="line"><span style="color:#2F8A89;">spec</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">type</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">NodePort</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">ports</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">http</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">port</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">9090</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">protocol</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">TCP</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">targetPort</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">9090</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">selector</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">k8s-app</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"></span></code></pre></div><h4 id="_3-5-2-\u521B\u5EFAservice\u8D44\u6E90" tabindex="-1">3.5.2.\u521B\u5EFAservice\u8D44\u6E90 <a class="header-anchor" href="#_3-5-2-\u521B\u5EFAservice\u8D44\u6E90" aria-hidden="true">#</a></h4><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f prometheus-service.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">service/prometheus created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f prometheus-service.yaml </span></span>
<span class="line"><span style="color:#393A34;">service/prometheus created</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-6-\u67E5\u770B\u521B\u5EFA\u7684prometheus\u6240\u6709\u8D44\u6E90\u7C7B\u578B" tabindex="-1">3.6.\u67E5\u770B\u521B\u5EFA\u7684prometheus\u6240\u6709\u8D44\u6E90\u7C7B\u578B <a class="header-anchor" href="#_3-6-\u67E5\u770B\u521B\u5EFA\u7684prometheus\u6240\u6709\u8D44\u6E90\u7C7B\u578B" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get pod,svc,pv,pvc -n prometheus -o wide</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get pod,svc,pv,pvc -n prometheus -o wide</span></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171837694.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>\u4E3B\u8981\u8BBF\u95EE30387\u7AEF\u53E3\u770B\u5230prometheus</p><h3 id="_3-7-\u8BBF\u95EEprometheus" tabindex="-1">3.7.\u8BBF\u95EEprometheus <a class="header-anchor" href="#_3-7-\u8BBF\u95EEprometheus" aria-hidden="true">#</a></h3><p>\u4F7F\u7528\u4EFB\u610Fnode\u8282\u70B9\u7684ip\u52A030387\u7AEF\u53E3\u5373\u53EF\u8BBF\u95EE\uFF1A<a href="http://192.168.16.106:30387/" target="_blank" rel="noopener noreferrer">http://192.168.16.106:30387/</a></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171846551.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>\u67E5\u770B\u76D1\u63A7\u4E3B\u673A</p><p>\u53EF\u4EE5\u770B\u5230\u5DF2\u7ECF\u6709\u5F88\u591A\u4E86\uFF0C\u8FD9\u4E9B\u914D\u7F6E\u90FD\u662Fconfigmap\u8D44\u6E90\u4E2D\u914D\u7F6E\u7684 <img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171854253.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_3-8-prometheus\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA" tabindex="-1">3.8.prometheus\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA <a class="header-anchor" href="#_3-8-prometheus\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA" aria-hidden="true">#</a></h3><h4 id="_3-8-1-\u8FDB\u5165prometheus\u5BB9\u5668" tabindex="-1">3.8.1.\u8FDB\u5165prometheus\u5BB9\u5668 <a class="header-anchor" href="#_3-8-1-\u8FDB\u5165prometheus\u5BB9\u5668" aria-hidden="true">#</a></h4><p>\u8BED\u6CD5\uFF1Akubectl exec -it pod\u540D \u8FDB\u5165\u7684\u73AF\u5883 -c \u5BB9\u5668\u540D\u79F0 -n \u547D\u540D\u7A7A\u95F4</p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl </span><span style="color:#E0A569;">exec</span><span style="color:#DBD7CA;"> -it prometheus-0 sh -c prometheus-server -n prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">/prometheus $ </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl </span><span style="color:#B58451;">exec</span><span style="color:#393A34;"> -it prometheus-0 sh -c prometheus-server -n prometheus</span></span>
<span class="line"><span style="color:#393A34;">/prometheus $ </span></span>
<span class="line"></span></code></pre></div><p>\u914D\u7F6E\u6587\u4EF6\u4F4D\u4E8E:/etc/config/prometheus.yml</p><p>tsdb\u5B58\u50A8\u4F4D\u4E8E:/data</p><h4 id="_3-8-2-\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA" tabindex="-1">3.8.2.\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA <a class="header-anchor" href="#_3-8-2-\u914D\u7F6E\u6587\u4EF6\u89E3\u91CA" aria-hidden="true">#</a></h4><p>/prometheus $ more /etc/config/prometheus.yml</p><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#429988;">scrape_configs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">job_name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">prometheus</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">static_configs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">targets</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">localhost:9090</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span></span>
<span class="line"><span style="color:#C98A7D;">\u9759\u6001\u914D\u7F6E\uFF0C\u5C06\u672C\u673A\u52A0\u5230\u4E86prometheus\u76D1\u63A7\uFF0C\u8FD9\u4E2Alocalhost\u5C31\u662F\u8FD0\u884Cprometheus\u5BB9\u5668\u7684\u5730\u5740</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#2F8A89;">scrape_configs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">job_name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">prometheus</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">static_configs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">targets</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">localhost:9090</span></span>
<span class="line"><span style="color:#393A34;">    </span></span>
<span class="line"><span style="color:#B56959;">\u9759\u6001\u914D\u7F6E\uFF0C\u5C06\u672C\u673A\u52A0\u5230\u4E86prometheus\u76D1\u63A7\uFF0C\u8FD9\u4E2Alocalhost\u5C31\u662F\u8FD0\u884Cprometheus\u5BB9\u5668\u7684\u5730\u5740</span></span>
<span class="line"></span></code></pre></div><p><strong>kubernetes-apiservers\u81EA\u52A8\u53D1\u73B0</strong></p><p>\u5C06apiserver\u7684\u5730\u5740\u8FDB\u884C\u66B4\u9732\u5E76\u83B7\u53D6\u76D1\u63A7\u6307\u6807</p><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">job_name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">kubernetes-apiservers</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">kubernetes_sd_configs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">role</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">endpoints</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">relabel_configs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">keep</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">regex</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">default;kubernetes;https</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_namespace</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_name</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_endpoint_port_name</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">scheme</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">https</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">tls_config</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">ca_file</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">insecure_skip_verify</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#4D9375;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">bearer_token_file</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">job_name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">kubernetes-apiservers</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">kubernetes_sd_configs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">role</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">endpoints</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">relabel_configs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">keep</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">regex</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">default;kubernetes;https</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_namespace</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_name</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_endpoint_port_name</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">scheme</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">https</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">tls_config</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">ca_file</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">insecure_skip_verify</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#1C6B48;">true</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">bearer_token_file</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171909965.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>k8s\u7684node\u8282\u70B9\u81EA\u52A8\u53D1\u73B0</strong></p><p>\u81EA\u52A8\u53D1\u73B0k8s\u4E2D\u7684\u6240\u6709node\u8282\u70B9\u5E76\u8FDB\u884C\u76D1\u63A7</p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">- job_name: kubernetes-nodes-cadvisor</span></span>
<span class="line"><span style="color:#DBD7CA;">  kubernetes_sd_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - role: node</span></span>
<span class="line"><span style="color:#DBD7CA;">  relabel_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - action: labelmap</span></span>
<span class="line"><span style="color:#DBD7CA;">    regex: __meta_kubernetes_node_label_</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">.+</span><span style="color:#858585;">)</span></span>
<span class="line"><span style="color:#DBD7CA;">  - target_label: __metrics_path__</span></span>
<span class="line"><span style="color:#DBD7CA;">    replacement: /metrics/cadvisor</span></span>
<span class="line"><span style="color:#DBD7CA;">  scheme: https</span></span>
<span class="line"><span style="color:#DBD7CA;">  tls_config:</span></span>
<span class="line"><span style="color:#DBD7CA;">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#DBD7CA;">    insecure_skip_verify: </span><span style="color:#E0A569;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">- job_name: kubernetes-nodes-cadvisor</span></span>
<span class="line"><span style="color:#393A34;">  kubernetes_sd_configs:</span></span>
<span class="line"><span style="color:#393A34;">  - role: node</span></span>
<span class="line"><span style="color:#393A34;">  relabel_configs:</span></span>
<span class="line"><span style="color:#393A34;">  - action: labelmap</span></span>
<span class="line"><span style="color:#393A34;">    regex: __meta_kubernetes_node_label_</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">.+</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"><span style="color:#393A34;">  - target_label: __metrics_path__</span></span>
<span class="line"><span style="color:#393A34;">    replacement: /metrics/cadvisor</span></span>
<span class="line"><span style="color:#393A34;">  scheme: https</span></span>
<span class="line"><span style="color:#393A34;">  tls_config:</span></span>
<span class="line"><span style="color:#393A34;">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#393A34;">    insecure_skip_verify: </span><span style="color:#B58451;">true</span></span>
<span class="line"><span style="color:#393A34;">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171919584.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>\u53D1\u73B0endpoint\u7684\u8D44\u6E90</strong></p><p>\u4E3B\u8981\u662F\u53D1\u73B0endpoint\u8D44\u6E90\u7C7B\u578B\u7684pod\uFF0C\u53EF\u4EE5\u901A\u8FC7kubectl get ep\u67E5\u770B\u8C01\u662Fendpoint\u8D44\u6E90</p><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">job_name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">kubernetes-service-endpoints</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">kubernetes_sd_configs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">role</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">endpoints</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">relabel_configs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">keep</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">regex</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#4D9375;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_annotation_prometheus_io_scrape</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">replace</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">regex</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">(https?)</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_annotation_prometheus_io_scheme</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__scheme__</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">replace</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">regex</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">(.+)</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_annotation_prometheus_io_path</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__metrics_path__</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">replace</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">regex</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">([^:]+)(?::\\d+)?;(\\d+)</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">replacement</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">$1:$2</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__address__</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_annotation_prometheus_io_port</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__address__</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">labelmap</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">regex</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">replace</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_namespace</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">replace</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_name</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">kubernetes_name</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">job_name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">kubernetes-service-endpoints</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">kubernetes_sd_configs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">role</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">endpoints</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">relabel_configs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">keep</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">regex</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#1C6B48;">true</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_annotation_prometheus_io_scrape</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">replace</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">regex</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">(https?)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_annotation_prometheus_io_scheme</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__scheme__</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">replace</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">regex</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">(.+)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_annotation_prometheus_io_path</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__metrics_path__</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">replace</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">regex</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">([^:]+)(?::\\d+)?;(\\d+)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">replacement</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">$1:$2</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__address__</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_annotation_prometheus_io_port</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__address__</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">labelmap</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">regex</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">replace</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_namespace</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">replace</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_name</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">kubernetes_name</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171929948.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>\u53D1\u73B0services</strong></p><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">job_name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">kubernetes-services</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">kubernetes_sd_configs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">role</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">service</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">metrics_path</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/probe</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">params</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">module</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">http_2xx</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">relabel_configs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">keep</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">regex</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#4D9375;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_annotation_prometheus_io_probe</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__address__</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__param_target</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">replacement</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">blackbox</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__address__</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__param_target</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">instance</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">action</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">labelmap</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">regex</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_namespace</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">source_labels</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">__meta_kubernetes_service_name</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">target_label</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">kubernetes_name</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">job_name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">kubernetes-services</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">kubernetes_sd_configs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">role</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">service</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">metrics_path</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/probe</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">params</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">module</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">http_2xx</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">relabel_configs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">keep</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">regex</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#1C6B48;">true</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_annotation_prometheus_io_probe</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__address__</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__param_target</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">replacement</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">blackbox</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__address__</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__param_target</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">instance</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">action</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">labelmap</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">regex</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_namespace</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">source_labels</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">__meta_kubernetes_service_name</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">target_label</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">kubernetes_name</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><strong>\u53D1\u73B0pod</strong></p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">- job_name: kubernetes-pods</span></span>
<span class="line"><span style="color:#DBD7CA;">  kubernetes_sd_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - role: pod</span></span>
<span class="line"><span style="color:#DBD7CA;">  relabel_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - action: keep</span></span>
<span class="line"><span style="color:#DBD7CA;">    regex: </span><span style="color:#E0A569;">true</span></span>
<span class="line"><span style="color:#DBD7CA;">    source_labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - __meta_kubernetes_pod_annotation_prometheus_io_scrape</span></span>
<span class="line"><span style="color:#DBD7CA;">  - action: replace</span></span>
<span class="line"><span style="color:#DBD7CA;">    regex: </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">.+</span><span style="color:#858585;">)</span></span>
<span class="line"><span style="color:#DBD7CA;">    source_labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - __meta_kubernetes_pod_annotation_prometheus_io_path</span></span>
<span class="line"><span style="color:#DBD7CA;">    target_label: __metrics_path__</span></span>
<span class="line"><span style="color:#DBD7CA;">  - action: replace</span></span>
<span class="line"><span style="color:#DBD7CA;">    regex: </span><span style="color:#858585;">([</span><span style="color:#DBD7CA;">^:</span><span style="color:#858585;">]</span><span style="color:#DBD7CA;">+</span><span style="color:#858585;">)(</span><span style="color:#CB7676;">?</span><span style="color:#DBD7CA;">::</span><span style="color:#D4976C;">\\d</span><span style="color:#DBD7CA;">+</span><span style="color:#858585;">)</span><span style="color:#CB7676;">?;</span><span style="color:#858585;">(</span><span style="color:#D4976C;">\\d</span><span style="color:#DBD7CA;">+</span><span style="color:#858585;">)</span></span>
<span class="line"><span style="color:#DBD7CA;">    replacement: </span><span style="color:#858585;">$</span><span style="color:#B8A965;">1</span><span style="color:#DBD7CA;">:</span><span style="color:#858585;">$</span><span style="color:#B8A965;">2</span></span>
<span class="line"><span style="color:#DBD7CA;">    source_labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - __address__</span></span>
<span class="line"><span style="color:#DBD7CA;">    - __meta_kubernetes_pod_annotation_prometheus_io_port</span></span>
<span class="line"><span style="color:#DBD7CA;">    target_label: __address__</span></span>
<span class="line"><span style="color:#DBD7CA;">  - action: labelmap</span></span>
<span class="line"><span style="color:#DBD7CA;">    regex: __meta_kubernetes_pod_label_</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">.+</span><span style="color:#858585;">)</span></span>
<span class="line"><span style="color:#DBD7CA;">  - action: replace</span></span>
<span class="line"><span style="color:#DBD7CA;">    source_labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - __meta_kubernetes_namespace</span></span>
<span class="line"><span style="color:#DBD7CA;">    target_label: kubernetes_namespace</span></span>
<span class="line"><span style="color:#DBD7CA;">  - action: replace</span></span>
<span class="line"><span style="color:#DBD7CA;">    source_labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - __meta_kubernetes_pod_name</span></span>
<span class="line"><span style="color:#DBD7CA;">    target_label: kubernetes_pod_name</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">- job_name: kubernetes-pods</span></span>
<span class="line"><span style="color:#393A34;">  kubernetes_sd_configs:</span></span>
<span class="line"><span style="color:#393A34;">  - role: pod</span></span>
<span class="line"><span style="color:#393A34;">  relabel_configs:</span></span>
<span class="line"><span style="color:#393A34;">  - action: keep</span></span>
<span class="line"><span style="color:#393A34;">    regex: </span><span style="color:#B58451;">true</span></span>
<span class="line"><span style="color:#393A34;">    source_labels:</span></span>
<span class="line"><span style="color:#393A34;">    - __meta_kubernetes_pod_annotation_prometheus_io_scrape</span></span>
<span class="line"><span style="color:#393A34;">  - action: replace</span></span>
<span class="line"><span style="color:#393A34;">    regex: </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">.+</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"><span style="color:#393A34;">    source_labels:</span></span>
<span class="line"><span style="color:#393A34;">    - __meta_kubernetes_pod_annotation_prometheus_io_path</span></span>
<span class="line"><span style="color:#393A34;">    target_label: __metrics_path__</span></span>
<span class="line"><span style="color:#393A34;">  - action: replace</span></span>
<span class="line"><span style="color:#393A34;">    regex: </span><span style="color:#8E8F8B;">([</span><span style="color:#393A34;">^:</span><span style="color:#8E8F8B;">]</span><span style="color:#393A34;">+</span><span style="color:#8E8F8B;">)(</span><span style="color:#AB5959;">?</span><span style="color:#393A34;">::</span><span style="color:#A65E2B;">\\d</span><span style="color:#393A34;">+</span><span style="color:#8E8F8B;">)</span><span style="color:#AB5959;">?;</span><span style="color:#8E8F8B;">(</span><span style="color:#A65E2B;">\\d</span><span style="color:#393A34;">+</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"><span style="color:#393A34;">    replacement: </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">1</span><span style="color:#393A34;">:</span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">2</span></span>
<span class="line"><span style="color:#393A34;">    source_labels:</span></span>
<span class="line"><span style="color:#393A34;">    - __address__</span></span>
<span class="line"><span style="color:#393A34;">    - __meta_kubernetes_pod_annotation_prometheus_io_port</span></span>
<span class="line"><span style="color:#393A34;">    target_label: __address__</span></span>
<span class="line"><span style="color:#393A34;">  - action: labelmap</span></span>
<span class="line"><span style="color:#393A34;">    regex: __meta_kubernetes_pod_label_</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">.+</span><span style="color:#8E8F8B;">)</span></span>
<span class="line"><span style="color:#393A34;">  - action: replace</span></span>
<span class="line"><span style="color:#393A34;">    source_labels:</span></span>
<span class="line"><span style="color:#393A34;">    - __meta_kubernetes_namespace</span></span>
<span class="line"><span style="color:#393A34;">    target_label: kubernetes_namespace</span></span>
<span class="line"><span style="color:#393A34;">  - action: replace</span></span>
<span class="line"><span style="color:#393A34;">    source_labels:</span></span>
<span class="line"><span style="color:#393A34;">    - __meta_kubernetes_pod_name</span></span>
<span class="line"><span style="color:#393A34;">    target_label: kubernetes_pod_name</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h3 id="_3-9-k8s-metrics\u9875\u9762" tabindex="-1">3.9.k8s metrics\u9875\u9762 <a class="header-anchor" href="#_3-9-k8s-metrics\u9875\u9762" aria-hidden="true">#</a></h3><p>metrics\u9875\u9762\u8BBF\u95EE\u5982\u4E0B\u4E5F\u6CA1\u5173\u7CFB\uFF0Cmetrics\u8C8C\u4F3C\u53EA\u80FD\u96C6\u7FA4\u5185\u90E8\u8FDB\u884C\u8BBF\u95EE</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171942988.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>\u53EA\u8981\u80FD\u5728prometheus\u641C\u7D22\u5230container\u6570\u636E\u5C31\u53EF\u4EE5</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171951255.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h2 id="_4-\u5728k8s\u4E2D\u90E8\u7F72grafana" tabindex="-1">4.\u5728k8s\u4E2D\u90E8\u7F72grafana <a class="header-anchor" href="#_4-\u5728k8s\u4E2D\u90E8\u7F72grafana" aria-hidden="true">#</a></h2><h3 id="_4-1-\u7F16\u5199granfana-pv-pvc\u8D44\u6E90" tabindex="-1">4.1.\u7F16\u5199granfana-pv-pvc\u8D44\u6E90 <a class="header-anchor" href="#_4-1-\u7F16\u5199granfana-pv-pvc\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#C98A7D;">1.\u7F16\u5199\u8D44\u6E90</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#C98A7D;">root@k8s-master ~/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#C98A7D;">\\# vim grafana_pv_pvc.yaml</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#429988;">apiVersion</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">v1</span></span>
<span class="line"><span style="color:#429988;">kind</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#429988;">metadata</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">grafana-ui-data</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">namespace</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">grafana-ui</span></span>
<span class="line"><span style="color:#429988;">spec</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">accessModes</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">resources</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">requests</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">storage</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">3Gi</span></span>
<span class="line"><span style="color:#A1B567;">---</span></span>
<span class="line"><span style="color:#429988;">apiVersion</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">v1</span></span>
<span class="line"><span style="color:#429988;">kind</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">PersistentVolume</span></span>
<span class="line"><span style="color:#429988;">metadata</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">pv-grafana-ui-data</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">namespace</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">grafana-ui</span></span>
<span class="line"><span style="color:#429988;">spec</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">capacity</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">storage</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">3Gi</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">accessModes</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#DBD7CA;">  </span><span style="color:#429988;">nfs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">path</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">/data/prometheus/grafana</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#429988;">server</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#6394BF;">192.168.16.105</span></span>
<span class="line"><span style="color:#DBD7CA;">    </span></span>
<span class="line"><span style="color:#C98A7D;">2.\u5728nfs\u4E0A\u521B\u5EFA\u5BF9\u5E94\u7684\u6302\u8F7D\u70B9</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#C98A7D;">root@nfs ~</span><span style="color:#858585;">]</span><span style="color:#C98A7D;">\\# mkdir /data/prometheus/grafana</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#B56959;">1.\u7F16\u5199\u8D44\u6E90</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#B56959;">root@k8s-master ~/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#B56959;">\\# vim grafana_pv_pvc.yaml</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#2F8A89;">apiVersion</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">v1</span></span>
<span class="line"><span style="color:#2F8A89;">kind</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#2F8A89;">metadata</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">grafana-ui-data</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">namespace</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">grafana-ui</span></span>
<span class="line"><span style="color:#2F8A89;">spec</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">accessModes</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">resources</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">requests</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">storage</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">3Gi</span></span>
<span class="line"><span style="color:#6C7834;">---</span></span>
<span class="line"><span style="color:#2F8A89;">apiVersion</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">v1</span></span>
<span class="line"><span style="color:#2F8A89;">kind</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">PersistentVolume</span></span>
<span class="line"><span style="color:#2F8A89;">metadata</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">pv-grafana-ui-data</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">namespace</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">grafana-ui</span></span>
<span class="line"><span style="color:#2F8A89;">spec</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">capacity</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">storage</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">3Gi</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">accessModes</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#2F8A89;">nfs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">path</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">/data/prometheus/grafana</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#2F8A89;">server</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#296AA3;">192.168.16.105</span></span>
<span class="line"><span style="color:#393A34;">    </span></span>
<span class="line"><span style="color:#B56959;">2.\u5728nfs\u4E0A\u521B\u5EFA\u5BF9\u5E94\u7684\u6302\u8F7D\u70B9</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#B56959;">root@nfs ~</span><span style="color:#8E8F8B;">]</span><span style="color:#B56959;">\\# mkdir /data/prometheus/grafana</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-2-\u7F16\u5199granfana-statefulset\u8D44\u6E90" tabindex="-1">4.2.\u7F16\u5199granfana-statefulset\u8D44\u6E90 <a class="header-anchor" href="#_4-2-\u7F16\u5199granfana-statefulset\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim grafana_statefulset.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: apps/v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: StatefulSet</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: grafana-ui</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: grafana-ui</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">  serviceName: </span><span style="color:#C98A7D;">&quot;grafana-ui&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">  replicas: 1</span></span>
<span class="line"><span style="color:#DBD7CA;">  selector:</span></span>
<span class="line"><span style="color:#DBD7CA;">    matchLabels:</span></span>
<span class="line"><span style="color:#DBD7CA;">      app: grafana-ui</span></span>
<span class="line"><span style="color:#DBD7CA;">  template:</span></span>
<span class="line"><span style="color:#DBD7CA;">    metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">      labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">        app: grafana-ui</span></span>
<span class="line"><span style="color:#DBD7CA;">    spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">      containers:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - name: grafana-ui</span></span>
<span class="line"><span style="color:#DBD7CA;">        image: grafana/grafana:6.6.2</span></span>
<span class="line"><span style="color:#DBD7CA;">        imagePullPolicy: </span><span style="color:#C98A7D;">&quot;IfNotPresent&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        ports:</span></span>
<span class="line"><span style="color:#DBD7CA;">          - containerPort: 3000</span></span>
<span class="line"><span style="color:#DBD7CA;">            protocol: TCP</span></span>
<span class="line"><span style="color:#DBD7CA;">        resources:</span></span>
<span class="line"><span style="color:#DBD7CA;">          limits:</span></span>
<span class="line"><span style="color:#DBD7CA;">            cpu: 100m</span></span>
<span class="line"><span style="color:#DBD7CA;">            memory: 256Mi</span></span>
<span class="line"><span style="color:#DBD7CA;">          requests:</span></span>
<span class="line"><span style="color:#DBD7CA;">            cpu: 100m</span></span>
<span class="line"><span style="color:#DBD7CA;">            memory: 256Mi</span></span>
<span class="line"><span style="color:#DBD7CA;">        volumeMounts:</span></span>
<span class="line"><span style="color:#DBD7CA;">          - name: grafana-ui-data</span></span>
<span class="line"><span style="color:#DBD7CA;">            mountPath: /var/lib/grafana</span></span>
<span class="line"><span style="color:#DBD7CA;">            subPath: </span><span style="color:#C98A7D;">&quot;&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      securityContext:</span></span>
<span class="line"><span style="color:#DBD7CA;">        fsGroup: 472</span></span>
<span class="line"><span style="color:#DBD7CA;">        runAsUser: 472</span></span>
<span class="line"><span style="color:#DBD7CA;">      volumes:</span></span>
<span class="line"><span style="color:#DBD7CA;">        - name: grafana-ui-data</span></span>
<span class="line"><span style="color:#DBD7CA;">          persistentVolumeClaim:</span></span>
<span class="line"><span style="color:#DBD7CA;">            claimName: grafana-ui-data</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim grafana_statefulset.yaml </span></span>
<span class="line"><span style="color:#393A34;">apiVersion: apps/v1</span></span>
<span class="line"><span style="color:#393A34;">kind: StatefulSet</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: grafana-ui</span></span>
<span class="line"><span style="color:#393A34;">  namespace: grafana-ui</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#393A34;">  serviceName: </span><span style="color:#B56959;">&quot;grafana-ui&quot;</span></span>
<span class="line"><span style="color:#393A34;">  replicas: 1</span></span>
<span class="line"><span style="color:#393A34;">  selector:</span></span>
<span class="line"><span style="color:#393A34;">    matchLabels:</span></span>
<span class="line"><span style="color:#393A34;">      app: grafana-ui</span></span>
<span class="line"><span style="color:#393A34;">  template:</span></span>
<span class="line"><span style="color:#393A34;">    metadata:</span></span>
<span class="line"><span style="color:#393A34;">      labels:</span></span>
<span class="line"><span style="color:#393A34;">        app: grafana-ui</span></span>
<span class="line"><span style="color:#393A34;">    spec:</span></span>
<span class="line"><span style="color:#393A34;">      containers:</span></span>
<span class="line"><span style="color:#393A34;">      - name: grafana-ui</span></span>
<span class="line"><span style="color:#393A34;">        image: grafana/grafana:6.6.2</span></span>
<span class="line"><span style="color:#393A34;">        imagePullPolicy: </span><span style="color:#B56959;">&quot;IfNotPresent&quot;</span></span>
<span class="line"><span style="color:#393A34;">        ports:</span></span>
<span class="line"><span style="color:#393A34;">          - containerPort: 3000</span></span>
<span class="line"><span style="color:#393A34;">            protocol: TCP</span></span>
<span class="line"><span style="color:#393A34;">        resources:</span></span>
<span class="line"><span style="color:#393A34;">          limits:</span></span>
<span class="line"><span style="color:#393A34;">            cpu: 100m</span></span>
<span class="line"><span style="color:#393A34;">            memory: 256Mi</span></span>
<span class="line"><span style="color:#393A34;">          requests:</span></span>
<span class="line"><span style="color:#393A34;">            cpu: 100m</span></span>
<span class="line"><span style="color:#393A34;">            memory: 256Mi</span></span>
<span class="line"><span style="color:#393A34;">        volumeMounts:</span></span>
<span class="line"><span style="color:#393A34;">          - name: grafana-ui-data</span></span>
<span class="line"><span style="color:#393A34;">            mountPath: /var/lib/grafana</span></span>
<span class="line"><span style="color:#393A34;">            subPath: </span><span style="color:#B56959;">&quot;&quot;</span></span>
<span class="line"><span style="color:#393A34;">      securityContext:</span></span>
<span class="line"><span style="color:#393A34;">        fsGroup: 472</span></span>
<span class="line"><span style="color:#393A34;">        runAsUser: 472</span></span>
<span class="line"><span style="color:#393A34;">      volumes:</span></span>
<span class="line"><span style="color:#393A34;">        - name: grafana-ui-data</span></span>
<span class="line"><span style="color:#393A34;">          persistentVolumeClaim:</span></span>
<span class="line"><span style="color:#393A34;">            claimName: grafana-ui-data</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-3-\u7F16\u5199granfana-svc\u8D44\u6E90" tabindex="-1">4.3.\u7F16\u5199granfana-svc\u8D44\u6E90 <a class="header-anchor" href="#_4-3-\u7F16\u5199granfana-svc\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim grafana_svc.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: Service</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: grafana-ui</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: grafana-ui</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">  type: NodePort</span></span>
<span class="line"><span style="color:#DBD7CA;">  ports:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - name: http</span></span>
<span class="line"><span style="color:#DBD7CA;">      port: 3000</span></span>
<span class="line"><span style="color:#DBD7CA;">      protocol: TCP</span></span>
<span class="line"><span style="color:#DBD7CA;">      targetPort: 3000</span></span>
<span class="line"><span style="color:#DBD7CA;">  selector:</span></span>
<span class="line"><span style="color:#DBD7CA;">    app: grafana-ui</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim grafana_svc.yaml </span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: Service</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: grafana-ui</span></span>
<span class="line"><span style="color:#393A34;">  namespace: grafana-ui</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#393A34;">  type: NodePort</span></span>
<span class="line"><span style="color:#393A34;">  ports:</span></span>
<span class="line"><span style="color:#393A34;">    - name: http</span></span>
<span class="line"><span style="color:#393A34;">      port: 3000</span></span>
<span class="line"><span style="color:#393A34;">      protocol: TCP</span></span>
<span class="line"><span style="color:#393A34;">      targetPort: 3000</span></span>
<span class="line"><span style="color:#393A34;">  selector:</span></span>
<span class="line"><span style="color:#393A34;">    app: grafana-ui</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h3 id="_4-4-k8s\u521B\u5EFAgrafana" tabindex="-1">4.4.k8s\u521B\u5EFAgrafana <a class="header-anchor" href="#_4-4-k8s\u521B\u5EFAgrafana" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f grafana_pv_pvc.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolumeclaim </span><span style="color:#C98A7D;">&quot;grafana-ui-data&quot;</span><span style="color:#DBD7CA;"> created</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolume </span><span style="color:#C98A7D;">&quot;pv-grafana-ui-data&quot;</span><span style="color:#DBD7CA;"> created</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f prometheus-statefulset-static-pv.yaml</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolumeclaim/prometheus-data created</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolume/pv-prometheus created</span></span>
<span class="line"><span style="color:#DBD7CA;">statefulset.apps/prometheus created</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f grafana_svc.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">service/grafana-ui created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f grafana_pv_pvc.yaml </span></span>
<span class="line"><span style="color:#393A34;">persistentvolumeclaim </span><span style="color:#B56959;">&quot;grafana-ui-data&quot;</span><span style="color:#393A34;"> created</span></span>
<span class="line"><span style="color:#393A34;">persistentvolume </span><span style="color:#B56959;">&quot;pv-grafana-ui-data&quot;</span><span style="color:#393A34;"> created</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f prometheus-statefulset-static-pv.yaml</span></span>
<span class="line"><span style="color:#393A34;">persistentvolumeclaim/prometheus-data created</span></span>
<span class="line"><span style="color:#393A34;">persistentvolume/pv-prometheus created</span></span>
<span class="line"><span style="color:#393A34;">statefulset.apps/prometheus created</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f grafana_svc.yaml </span></span>
<span class="line"><span style="color:#393A34;">service/grafana-ui created</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-5-\u67E5\u770B\u8D44\u6E90\u8FD0\u884C\u72B6\u6001" tabindex="-1">4.5.\u67E5\u770B\u8D44\u6E90\u8FD0\u884C\u72B6\u6001 <a class="header-anchor" href="#_4-5-\u67E5\u770B\u8D44\u6E90\u8FD0\u884C\u72B6\u6001" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get pv,pvc,pod,statefulset,svc -n grafana-ui</span></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                  CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS        CLAIM                         STORAGECLASS   REASON   AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolume/pv-grafana-ui-data   3Gi        RWO            Retain           Terminating   grafana-ui/grafana-ui-data                            151m</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolume/pv-prometheus        16Gi       RWO            Retain           Bound         kube-system/prometheus-data                           47m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">NAME                                    STATUS        VOLUME               CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolumeclaim/grafana-ui-data   Terminating   pv-grafana-ui-data   3Gi        RWO                           151m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">NAME               READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">pod/grafana-ui-0   1/1     Running   0          16m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">NAME                          READY   AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">statefulset.apps/grafana-ui   1/1     16m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">S</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;">          AGE</span></span>
<span class="line"><span style="color:#DBD7CA;">service/grafana-ui   NodePort   10.96.170.142   </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CA;">none</span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;">        3000:32040/TCP   85m</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get pv,pvc,pod,statefulset,svc -n grafana-ui</span></span>
<span class="line"><span style="color:#393A34;">NAME                                  CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS        CLAIM                         STORAGECLASS   REASON   AGE</span></span>
<span class="line"><span style="color:#393A34;">persistentvolume/pv-grafana-ui-data   3Gi        RWO            Retain           Terminating   grafana-ui/grafana-ui-data                            151m</span></span>
<span class="line"><span style="color:#393A34;">persistentvolume/pv-prometheus        16Gi       RWO            Retain           Bound         kube-system/prometheus-data                           47m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">NAME                                    STATUS        VOLUME               CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span></span>
<span class="line"><span style="color:#393A34;">persistentvolumeclaim/grafana-ui-data   Terminating   pv-grafana-ui-data   3Gi        RWO                           151m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">NAME               READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#393A34;">pod/grafana-ui-0   1/1     Running   0          16m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">NAME                          READY   AGE</span></span>
<span class="line"><span style="color:#393A34;">statefulset.apps/grafana-ui   1/1     16m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">S</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;">          AGE</span></span>
<span class="line"><span style="color:#393A34;">service/grafana-ui   NodePort   10.96.170.142   </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;">none</span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;">        3000:32040/TCP   85m</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172010434.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_4-6-\u767B\u9646grafana" tabindex="-1">4.6.\u767B\u9646grafana <a class="header-anchor" href="#_4-6-\u767B\u9646grafana" aria-hidden="true">#</a></h3><p>\u8BBF\u95EE\uFF1A\u96C6\u7FA4\u4EFB\u610Fip\u548C32040\u7AEF\u53E3\u5373\u53EF\u8BBF\u95EE</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172018940.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_4-7-\u5BFC\u5165k8s\u8D44\u6E90\u76D1\u63A7pod\u8D44\u6E90\u6A21\u677F" tabindex="-1">4.7.\u5BFC\u5165k8s\u8D44\u6E90\u76D1\u63A7pod\u8D44\u6E90\u6A21\u677F <a class="header-anchor" href="#_4-7-\u5BFC\u5165k8s\u8D44\u6E90\u76D1\u63A7pod\u8D44\u6E90\u6A21\u677F" aria-hidden="true">#</a></h3><p>\u63A8\u8350\u6A21\u677F\uFF1A</p><ul><li>\u96C6\u7FA4\u8D44\u6E90\u76D1\u63A7\uFF1A3119</li><li>\u8D44\u6E90\u72B6\u6001\u76D1\u63A7\uFF1A6417</li><li>node\u76D1\u63A7\uFF1A9276</li></ul><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172028210.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>\u5BFC\u5165\u6210\u529F</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172037255.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_4-8-\u89E3\u51B3\u6A21\u677F\u8868\u8FBE\u5F0F\u95EE\u9898\u65E0\u6CD5\u5C55\u73B0\u6240\u6709pod" tabindex="-1">4.8.\u89E3\u51B3\u6A21\u677F\u8868\u8FBE\u5F0F\u95EE\u9898\u65E0\u6CD5\u5C55\u73B0\u6240\u6709pod <a class="header-anchor" href="#_4-8-\u89E3\u51B3\u6A21\u677F\u8868\u8FBE\u5F0F\u95EE\u9898\u65E0\u6CD5\u5C55\u73B0\u6240\u6709pod" aria-hidden="true">#</a></h3><h4 id="_4-8-1-\u95EE\u9898\u63CF\u8FF0" tabindex="-1">4.8.1.\u95EE\u9898\u63CF\u8FF0 <a class="header-anchor" href="#_4-8-1-\u95EE\u9898\u63CF\u8FF0" aria-hidden="true">#</a></h4><p>\u6A21\u677F\u4E2D\u7684\u56FE\u5F62\u5173\u4E8Epod\u548Cdocker\u7684\u5168\u90E8\u6709\u95EE\u9898\uFF0C\u4EC5\u5355\u5355\u663E\u793A\u4E00\u4E2Apod</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172046186.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h4 id="_4-8-2-\u95EE\u9898\u89E3\u51B3" tabindex="-1">4.8.2.\u95EE\u9898\u89E3\u51B3 <a class="header-anchor" href="#_4-8-2-\u95EE\u9898\u89E3\u51B3" aria-hidden="true">#</a></h4><p>\u4FEE\u6539\u4ED6\u4EEC\u7684\u8868\u8FBE\u5F0F\u5C31\u53EF\u4EE5\u4E86\uFF0C\u5C06pod_name\u4FEE\u6539\u4E3Apod</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172056945.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>\u4FEE\u6539\u4E3A\u7ACB\u9A6C\u663E\u793A\u51FA\u6240\u6709pod\uFF0C\u6240\u6709\u5173\u4E8Epod\u548Cdocker\u7684\u90FD\u662F\u8FD9\u4E48\u6539</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172106157.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>\u6700\u7EC8\u5C55\u793A\u6548\u679C</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172114765.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h2 id="_5-\u76D1\u63A7k8s-node\u8282\u70B9" tabindex="-1">5.\u76D1\u63A7k8s node\u8282\u70B9 <a class="header-anchor" href="#_5-\u76D1\u63A7k8s-node\u8282\u70B9" aria-hidden="true">#</a></h2><p>\u5BF9\u4E8Enode\u8282\u70B9\u7684\u76D1\u63A7\u6211\u4EEC\u4E0D\u7528\u90E8\u7F72\u5728k8s\u91CC\uFF0C\u76F4\u63A5\u5728\u6BCF\u53F0node\u673A\u5668\u4E0A\u5B89\u88C5node_exporter\u5373\u53EF</p><h3 id="_5-1-\u7F16\u5199\u4E00\u952E\u90E8\u7F72node-exporter\u811A\u672C" tabindex="-1">5.1.\u7F16\u5199\u4E00\u952E\u90E8\u7F72node_exporter\u811A\u672C <a class="header-anchor" href="#_5-1-\u7F16\u5199\u4E00\u952E\u90E8\u7F72node-exporter\u811A\u672C" aria-hidden="true">#</a></h3><div class="language-shell"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim install_node_exportes.sh </span></span>
<span class="line"><span style="color:#758575;">#!/bin/bash</span></span>
<span class="line"><span style="color:#758575;">#\u6279\u91CF\u5B89\u88C5node_exporter</span></span>
<span class="line"><span style="color:#DBD7CA;">soft_dir=/root/soft</span></span>
<span class="line"><span style="color:#4D9375;">if</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">!</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">-e</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">$</span><span style="color:#B8A965;">soft_dir</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">]</span><span style="color:#CB7676;">;</span><span style="color:#4D9375;">then</span></span>
<span class="line"><span style="color:#DBD7CA;">        mkdir </span><span style="color:#858585;">$</span><span style="color:#B8A965;">soft_dir</span></span>
<span class="line"><span style="color:#4D9375;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep 9100</span></span>
<span class="line"><span style="color:#4D9375;">if</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">$</span><span style="color:#B8A965;">?</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">-eq</span><span style="color:#DBD7CA;"> 0 </span><span style="color:#858585;">]</span><span style="color:#CB7676;">;</span><span style="color:#4D9375;">then</span></span>
<span class="line"><span style="color:#DBD7CA;">        use=</span><span style="color:#C98A7D;">\`netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#C98A7D;"> grep 9100 </span><span style="color:#CB7676;">|</span><span style="color:#C98A7D;"> awk -F/ &#39;{print $NF}&#39;\`</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#E0A569;">echo</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">&quot;9100\u7AEF\u53E3\u5DF2\u7ECF\u88AB\u5360\u7528\uFF0C\u5360\u7528\u8005\u662F </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">use&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#E0A569;">exit</span><span style="color:#DBD7CA;"> 1</span></span>
<span class="line"><span style="color:#4D9375;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E0A569;">cd</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">$</span><span style="color:#B8A965;">soft_dir</span></span>
<span class="line"><span style="color:#DBD7CA;">wget http://192.168.16.106:888/prometheus/node_exporter-1.0.1.linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#DBD7CA;">tar xf node_exporter-1.0.1.linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#DBD7CA;">mv node_exporter-1.0.1.linux-amd64 /usr/local/node_exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">cat </span><span style="color:#CB7676;">&lt;&lt;</span><span style="color:#4D9375;">EOF</span><span style="color:#C98A7D;"> &gt;/usr/lib/systemd/system/node_exporter.service</span></span>
<span class="line"><span style="color:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="color:#C98A7D;">Description=https://prometheus.io</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D;">[Service]</span></span>
<span class="line"><span style="color:#C98A7D;">Restart=on-failure</span></span>
<span class="line"><span style="color:#C98A7D;">ExecStart=/usr/local/node_exporter/node_exporter --collector.systemd --collector.systemd.unit-whitelist=(docker|kubelet|node_exporter).service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D;">[Install]</span></span>
<span class="line"><span style="color:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="color:#4D9375;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">systemctl daemon-reload</span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl </span><span style="color:#E0A569;">enable</span><span style="color:#DBD7CA;"> node_exporter</span></span>
<span class="line"><span style="color:#DBD7CA;">systemctl restart node_exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep 9100</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">if</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">[</span><span style="color:#DBD7CA;"> </span><span style="color:#858585;">$</span><span style="color:#B8A965;">?</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">-eq</span><span style="color:#DBD7CA;"> 0 </span><span style="color:#858585;">]</span><span style="color:#CB7676;">;</span><span style="color:#4D9375;">then</span></span>
<span class="line"><span style="color:#DBD7CA;">        ehoc </span><span style="color:#C98A7D;">&quot;node_eporter install finish...&quot;</span></span>
<span class="line"><span style="color:#4D9375;">fi</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim install_node_exportes.sh </span></span>
<span class="line"><span style="color:#A0ADA0;">#!/bin/bash</span></span>
<span class="line"><span style="color:#A0ADA0;">#\u6279\u91CF\u5B89\u88C5node_exporter</span></span>
<span class="line"><span style="color:#393A34;">soft_dir=/root/soft</span></span>
<span class="line"><span style="color:#1C6B48;">if</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">-e</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">soft_dir</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">]</span><span style="color:#AB5959;">;</span><span style="color:#1C6B48;">then</span></span>
<span class="line"><span style="color:#393A34;">        mkdir </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">soft_dir</span></span>
<span class="line"><span style="color:#1C6B48;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep 9100</span></span>
<span class="line"><span style="color:#1C6B48;">if</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">?</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">-eq</span><span style="color:#393A34;"> 0 </span><span style="color:#8E8F8B;">]</span><span style="color:#AB5959;">;</span><span style="color:#1C6B48;">then</span></span>
<span class="line"><span style="color:#393A34;">        use=</span><span style="color:#B56959;">\`netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#B56959;"> grep 9100 </span><span style="color:#AB5959;">|</span><span style="color:#B56959;"> awk -F/ &#39;{print $NF}&#39;\`</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B58451;">echo</span><span style="color:#393A34;"> </span><span style="color:#B56959;">&quot;9100\u7AEF\u53E3\u5DF2\u7ECF\u88AB\u5360\u7528\uFF0C\u5360\u7528\u8005\u662F </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">use&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B58451;">exit</span><span style="color:#393A34;"> 1</span></span>
<span class="line"><span style="color:#1C6B48;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B58451;">cd</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">soft_dir</span></span>
<span class="line"><span style="color:#393A34;">wget http://192.168.16.106:888/prometheus/node_exporter-1.0.1.linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#393A34;">tar xf node_exporter-1.0.1.linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#393A34;">mv node_exporter-1.0.1.linux-amd64 /usr/local/node_exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">cat </span><span style="color:#AB5959;">&lt;&lt;</span><span style="color:#1C6B48;">EOF</span><span style="color:#B56959;"> &gt;/usr/lib/systemd/system/node_exporter.service</span></span>
<span class="line"><span style="color:#B56959;">[Unit]</span></span>
<span class="line"><span style="color:#B56959;">Description=https://prometheus.io</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B56959;">[Service]</span></span>
<span class="line"><span style="color:#B56959;">Restart=on-failure</span></span>
<span class="line"><span style="color:#B56959;">ExecStart=/usr/local/node_exporter/node_exporter --collector.systemd --collector.systemd.unit-whitelist=(docker|kubelet|node_exporter).service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B56959;">[Install]</span></span>
<span class="line"><span style="color:#B56959;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="color:#1C6B48;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">systemctl daemon-reload</span></span>
<span class="line"><span style="color:#393A34;">systemctl </span><span style="color:#B58451;">enable</span><span style="color:#393A34;"> node_exporter</span></span>
<span class="line"><span style="color:#393A34;">systemctl restart node_exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep 9100</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1C6B48;">if</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;"> </span><span style="color:#8E8F8B;">$</span><span style="color:#8C862B;">?</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">-eq</span><span style="color:#393A34;"> 0 </span><span style="color:#8E8F8B;">]</span><span style="color:#AB5959;">;</span><span style="color:#1C6B48;">then</span></span>
<span class="line"><span style="color:#393A34;">        ehoc </span><span style="color:#B56959;">&quot;node_eporter install finish...&quot;</span></span>
<span class="line"><span style="color:#1C6B48;">fi</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h3 id="_5-2-\u5BF9k8s\u7684node\u8FDB\u884C\u6267\u884Cnode-exporter\u811A\u672C" tabindex="-1">5.2.\u5BF9k8s\u7684node\u8FDB\u884C\u6267\u884Cnode_exporter\u811A\u672C <a class="header-anchor" href="#_5-2-\u5BF9k8s\u7684node\u8FDB\u884C\u6267\u884Cnode-exporter\u811A\u672C" aria-hidden="true">#</a></h3><p>\u5728\u8FD9\u91CC\u4E0B\u8F7D\u811A\u672C\u7528\u5C31\u884C\u4E86</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172136934.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> wget http://192.168.16.106:888/install_node_exportes.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> sh install_node_exportes.sh </span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;">  netstat -lnpt </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep 9100</span></span>
<span class="line"><span style="color:#DBD7CA;">tcp6       0      0 :::9100                 :::</span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">                    LISTEN      14906/node_exporter </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> wget http://192.168.16.106:888/install_node_exportes.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> sh install_node_exportes.sh </span></span>
<span class="line"></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;">  netstat -lnpt </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep 9100</span></span>
<span class="line"><span style="color:#393A34;">tcp6       0      0 :::9100                 :::</span><span style="color:#AB5959;">*</span><span style="color:#393A34;">                    LISTEN      14906/node_exporter </span></span>
<span class="line"></span></code></pre></div><h3 id="_5-3-\u5728prometheus\u7684configmap\u8D44\u6E90\u4E2D\u589E\u52A0node\u8282\u70B9\u914D\u7F6E" tabindex="-1">5.3.\u5728prometheus\u7684configmap\u8D44\u6E90\u4E2D\u589E\u52A0node\u8282\u70B9\u914D\u7F6E <a class="header-anchor" href="#_5-3-\u5728prometheus\u7684configmap\u8D44\u6E90\u4E2D\u589E\u52A0node\u8282\u70B9\u914D\u7F6E" aria-hidden="true">#</a></h3><div class="language-yaml"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#C98A7D;">root@k8s-master ~/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#C98A7D;">\\# vim prometheus-configmap.yaml</span><span style="color:#DBD7CA;"> </span></span>
<span class="line"><span style="color:#DBD7CA;">    </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">job_name</span><span style="color:#858585;">:</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">k8s-node</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#429988;">static_configs</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#429988;">targets</span><span style="color:#858585;">:</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">192.168.16.104:9100</span></span>
<span class="line"><span style="color:#DBD7CA;">        </span><span style="color:#858585;">-</span><span style="color:#DBD7CA;"> </span><span style="color:#C98A7D;">192.168.16.107:9100</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#B56959;">root@k8s-master ~/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#B56959;">\\# vim prometheus-configmap.yaml</span><span style="color:#393A34;"> </span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">job_name</span><span style="color:#8E8F8B;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959;">k8s-node</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#2F8A89;">static_configs</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#2F8A89;">targets</span><span style="color:#8E8F8B;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">192.168.16.104:9100</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#8E8F8B;">-</span><span style="color:#393A34;"> </span><span style="color:#B56959;">192.168.16.107:9100</span></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172150508.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>\u66F4\u65B0\u914D\u7F6E</strong></p><p>\u66F4\u65B0\u5B8C\u914D\u7F6E\uFF0Cprometheus\u9875\u9762\u4F1A\u7ACB\u9A6C\u663E\u793A\uFF0C\u56E0\u6B64\u6BCF\u5F53configmap\u4E00\u4FEE\u6539\uFF0Cprometheus\u5BB9\u5668\u5C31\u4F1A\u91CD\u8F7D</p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl apply -f prometheus-configmap.yaml</span></span>
<span class="line"><span style="color:#DBD7CA;">configmap/prometheus-config created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl apply -f prometheus-configmap.yaml</span></span>
<span class="line"><span style="color:#393A34;">configmap/prometheus-config created</span></span>
<span class="line"></span></code></pre></div><p>\u6210\u529F\u6DFB\u52A0node\u76D1\u63A7</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172200609.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_5-4-\u5BFC\u5165k8s-node\u4E3B\u673A\u76D1\u63A7\u6A21\u677F" tabindex="-1">5.4.\u5BFC\u5165k8s node\u4E3B\u673A\u76D1\u63A7\u6A21\u677F <a class="header-anchor" href="#_5-4-\u5BFC\u5165k8s-node\u4E3B\u673A\u76D1\u63A7\u6A21\u677F" aria-hidden="true">#</a></h3><p>node\u76D1\u63A7\uFF1A9276</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172210569.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>\u586B\u5199\u4FE1\u606F</strong></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172219328.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"><strong>\u67E5\u770B\u56FE\u5F62</strong><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172235454.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h2 id="_6-k8s\u4F7F\u7528kube-state-metrics-\u76D1\u63A7\u8D44\u6E90\u72B6\u6001" tabindex="-1">6.k8s\u4F7F\u7528kube-state-metrics-\u76D1\u63A7\u8D44\u6E90\u72B6\u6001 <a class="header-anchor" href="#_6-k8s\u4F7F\u7528kube-state-metrics-\u76D1\u63A7\u8D44\u6E90\u72B6\u6001" aria-hidden="true">#</a></h2><h3 id="_6-1-\u521B\u5EFArbac\u8D44\u6E90" tabindex="-1">6.1.\u521B\u5EFArbac\u8D44\u6E90 <a class="header-anchor" href="#_6-1-\u521B\u5EFArbac\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create kube-state-metrics-rbac.yaml </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create kube-state-metrics-rbac.yaml </span></span>
<span class="line"></span></code></pre></div><h3 id="_6-2-\u521B\u5EFAdeployment\u8D44\u6E90" tabindex="-1">6.2.\u521B\u5EFAdeployment\u8D44\u6E90 <a class="header-anchor" href="#_6-2-\u521B\u5EFAdeployment\u8D44\u6E90" aria-hidden="true">#</a></h3><p>deployment\u8D44\u6E90\u91CC\u9762\u7ED3\u5408\u4E86configmap\u8D44\u6E90</p><p>\u9700\u8981\u628A\u955C\u50CF\u7684\u5730\u5740\u4FEE\u6539\u6210lizhenliang/kube-state-metrics:v1.8.0\u3001lizhenliang/addon-resizer:1.8.6</p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f kube-state-metrics-deployment.yaml </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f kube-state-metrics-deployment.yaml </span></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172259875.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_6-3-\u521B\u5EFAservice\u8D44\u6E90" tabindex="-1">6.3.\u521B\u5EFAservice\u8D44\u6E90 <a class="header-anchor" href="#_6-3-\u521B\u5EFAservice\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f kube-state-metrics-service.yaml </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f kube-state-metrics-service.yaml </span></span>
<span class="line"></span></code></pre></div><h3 id="_6-4-\u8D44\u6E90\u51C6\u5907\u5C31\u7EEA" tabindex="-1">6.4.\u8D44\u6E90\u51C6\u5907\u5C31\u7EEA <a class="header-anchor" href="#_6-4-\u8D44\u6E90\u51C6\u5907\u5C31\u7EEA" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get all -n kube-system </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CA;"> grep kube-state</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get all -n kube-system </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> grep kube-state</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172316131.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_6-5-\u5728prometheus\u67E5\u770B\u662F\u5426\u83B7\u53D6\u76D1\u63A7\u6307\u6807" tabindex="-1">6.5.\u5728prometheus\u67E5\u770B\u662F\u5426\u83B7\u53D6\u76D1\u63A7\u6307\u6807 <a class="header-anchor" href="#_6-5-\u5728prometheus\u67E5\u770B\u662F\u5426\u83B7\u53D6\u76D1\u63A7\u6307\u6807" aria-hidden="true">#</a></h3><p>\u5B89\u88C5\u5B8Ckube-state-metrics\u4E4B\u540E\uFF0C\u76F4\u63A5\u5C31\u53EF\u4EE5\u5728prometheus\u4E0A\u67E5\u8BE2\u76D1\u63A7\u6307\u6807\uFF0C\u90FD\u662F\u4EE5kube\u5F00\u5934\u7684</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172326163.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_6-6-\u5BFC\u5165k8s-\u8D44\u6E90\u72B6\u6001\u6A21\u677F" tabindex="-1">6.6.\u5BFC\u5165k8s \u8D44\u6E90\u72B6\u6001\u6A21\u677F <a class="header-anchor" href="#_6-6-\u5BFC\u5165k8s-\u8D44\u6E90\u72B6\u6001\u6A21\u677F" aria-hidden="true">#</a></h3><p>\u8D44\u6E90\u72B6\u6001\u76D1\u63A7\uFF1A6417</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/2021010617233747.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>\u67E5\u770B\u56FE\u5F62\uFF0C\u4E5F\u662F\u6709\u5F88\u591A\u76D1\u63A7\u4E0D\u5230</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172345276.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h2 id="_7-\u5728k8s\u4E2D\u90E8\u7F72alertmanager\u5B9E\u73B0\u544A\u8B66\u7CFB\u7EDF" tabindex="-1">7.\u5728k8s\u4E2D\u90E8\u7F72alertmanager\u5B9E\u73B0\u544A\u8B66\u7CFB\u7EDF <a class="header-anchor" href="#_7-\u5728k8s\u4E2D\u90E8\u7F72alertmanager\u5B9E\u73B0\u544A\u8B66\u7CFB\u7EDF" aria-hidden="true">#</a></h2><h3 id="_7-1-\u521B\u5EFAalertmanager-pv-pvc\u8D44\u6E90" tabindex="-1">7.1.\u521B\u5EFAalertmanager-pv-pvc\u8D44\u6E90 <a class="header-anchor" href="#_7-1-\u521B\u5EFAalertmanager-pv-pvc\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u7F16\u5199yaml</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim alertmanager-pvc.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: alertmanager-data</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: alertmanager</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    kubernetes.io/cluster-service: </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    addonmanager.kubernetes.io/mode: EnsureExists</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">  accessModes:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - ReadWriteOnce</span></span>
<span class="line"><span style="color:#DBD7CA;">  resources:</span></span>
<span class="line"><span style="color:#DBD7CA;">    requests:</span></span>
<span class="line"><span style="color:#DBD7CA;">      storage: </span><span style="color:#C98A7D;">&quot;2Gi&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">---</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: PersistentVolume</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: pv-alertmanager-data</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: alertmanager</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">  capacity:</span></span>
<span class="line"><span style="color:#DBD7CA;">    storage: 2Gi</span></span>
<span class="line"><span style="color:#DBD7CA;">  accessModes:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - ReadWriteOnce</span></span>
<span class="line"><span style="color:#DBD7CA;">  nfs:</span></span>
<span class="line"><span style="color:#DBD7CA;">    path: /data/prometheus/alertmanager</span></span>
<span class="line"><span style="color:#DBD7CA;">    server: 192.168.16.105</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u521B\u5EFA</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f alertmanager-pvc.yaml</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolumeclaim/alertmanager created</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolume/pv-alertmanager-data create</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u7F16\u5199yaml</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim alertmanager-pvc.yaml </span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: alertmanager-data</span></span>
<span class="line"><span style="color:#393A34;">  namespace: alertmanager</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">    kubernetes.io/cluster-service: </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">    addonmanager.kubernetes.io/mode: EnsureExists</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#393A34;">  accessModes:</span></span>
<span class="line"><span style="color:#393A34;">    - ReadWriteOnce</span></span>
<span class="line"><span style="color:#393A34;">  resources:</span></span>
<span class="line"><span style="color:#393A34;">    requests:</span></span>
<span class="line"><span style="color:#393A34;">      storage: </span><span style="color:#B56959;">&quot;2Gi&quot;</span></span>
<span class="line"><span style="color:#393A34;">---</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: PersistentVolume</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: pv-alertmanager-data</span></span>
<span class="line"><span style="color:#393A34;">  namespace: alertmanager</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#393A34;">  capacity:</span></span>
<span class="line"><span style="color:#393A34;">    storage: 2Gi</span></span>
<span class="line"><span style="color:#393A34;">  accessModes:</span></span>
<span class="line"><span style="color:#393A34;">    - ReadWriteOnce</span></span>
<span class="line"><span style="color:#393A34;">  nfs:</span></span>
<span class="line"><span style="color:#393A34;">    path: /data/prometheus/alertmanager</span></span>
<span class="line"><span style="color:#393A34;">    server: 192.168.16.105</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u521B\u5EFA</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f alertmanager-pvc.yaml</span></span>
<span class="line"><span style="color:#393A34;">persistentvolumeclaim/alertmanager created</span></span>
<span class="line"><span style="color:#393A34;">persistentvolume/pv-alertmanager-data create</span></span>
<span class="line"></span></code></pre></div><h3 id="_7-2-\u521B\u5EFAalertmanager-cm\u8D44\u6E90\u589E\u52A0\u5FAE\u4FE1\u544A\u8B66\u914D\u7F6E" tabindex="-1">7.2.\u521B\u5EFAalertmanager-cm\u8D44\u6E90\u589E\u52A0\u5FAE\u4FE1\u544A\u8B66\u914D\u7F6E <a class="header-anchor" href="#_7-2-\u521B\u5EFAalertmanager-cm\u8D44\u6E90\u589E\u52A0\u5FAE\u4FE1\u544A\u8B66\u914D\u7F6E" aria-hidden="true">#</a></h3><p>\u589E\u52A0\u5FAE\u4FE1\u62A5\u8B66</p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u589E\u52A0\u5FAE\u4FE1\u544A\u8B66\u914D\u7F6E</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim alertmanager-configmap.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: ConfigMap</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: alertmanager-config</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: alertmanager</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">    kubernetes.io/cluster-service: </span><span style="color:#C98A7D;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">    addonmanager.kubernetes.io/mode: EnsureExists</span></span>
<span class="line"><span style="color:#DBD7CA;">data:</span></span>
<span class="line"><span style="color:#DBD7CA;">  alertmanager.yml: </span><span style="color:#CB7676;">|</span></span>
<span class="line"><span style="color:#DBD7CA;">    global:</span></span>
<span class="line"><span style="color:#DBD7CA;">      resolve_timeout: 5m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">    receivers:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - name: </span><span style="color:#C98A7D;">&#39;wechat&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">      wechat_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">        - corp_id: </span><span style="color:#C98A7D;">&#39;ww48f74fc8ed3a07ba&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">          to_party: </span><span style="color:#C98A7D;">&#39;1&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">          agent_id: </span><span style="color:#C98A7D;">&#39;1000003&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">          api_secret: </span><span style="color:#C98A7D;">&#39;j3ocaGJJM7KejlqzBIJ38b6D6t9QhqlIAh7k4fA1cT0&#39;</span></span>
<span class="line"><span style="color:#DBD7CA;">          send_resolved: </span><span style="color:#E0A569;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">    route:</span></span>
<span class="line"><span style="color:#DBD7CA;">      group_interval: 1m</span></span>
<span class="line"><span style="color:#DBD7CA;">      group_wait: 10s</span></span>
<span class="line"><span style="color:#DBD7CA;">      receiver: wechat</span></span>
<span class="line"><span style="color:#DBD7CA;">      repeat_interval: 1m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u521B\u5EFA\u8D44\u6E90</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f alertmanager-configmap.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">configmap/alertmanager-config created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u589E\u52A0\u5FAE\u4FE1\u544A\u8B66\u914D\u7F6E</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim alertmanager-configmap.yaml </span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: ConfigMap</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: alertmanager-config</span></span>
<span class="line"><span style="color:#393A34;">  namespace: alertmanager</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">    kubernetes.io/cluster-service: </span><span style="color:#B56959;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#393A34;">    addonmanager.kubernetes.io/mode: EnsureExists</span></span>
<span class="line"><span style="color:#393A34;">data:</span></span>
<span class="line"><span style="color:#393A34;">  alertmanager.yml: </span><span style="color:#AB5959;">|</span></span>
<span class="line"><span style="color:#393A34;">    global:</span></span>
<span class="line"><span style="color:#393A34;">      resolve_timeout: 5m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    receivers:</span></span>
<span class="line"><span style="color:#393A34;">    - name: </span><span style="color:#B56959;">&#39;wechat&#39;</span></span>
<span class="line"><span style="color:#393A34;">      wechat_configs:</span></span>
<span class="line"><span style="color:#393A34;">        - corp_id: </span><span style="color:#B56959;">&#39;ww48f74fc8ed3a07ba&#39;</span></span>
<span class="line"><span style="color:#393A34;">          to_party: </span><span style="color:#B56959;">&#39;1&#39;</span></span>
<span class="line"><span style="color:#393A34;">          agent_id: </span><span style="color:#B56959;">&#39;1000003&#39;</span></span>
<span class="line"><span style="color:#393A34;">          api_secret: </span><span style="color:#B56959;">&#39;j3ocaGJJM7KejlqzBIJ38b6D6t9QhqlIAh7k4fA1cT0&#39;</span></span>
<span class="line"><span style="color:#393A34;">          send_resolved: </span><span style="color:#B58451;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    route:</span></span>
<span class="line"><span style="color:#393A34;">      group_interval: 1m</span></span>
<span class="line"><span style="color:#393A34;">      group_wait: 10s</span></span>
<span class="line"><span style="color:#393A34;">      receiver: wechat</span></span>
<span class="line"><span style="color:#393A34;">      repeat_interval: 1m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u521B\u5EFA\u8D44\u6E90</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f alertmanager-configmap.yaml </span></span>
<span class="line"><span style="color:#393A34;">configmap/alertmanager-config created</span></span>
<span class="line"></span></code></pre></div><h3 id="_7-3-\u521B\u5EFAalertmanager-deployment\u8D44\u6E90" tabindex="-1">7.3.\u521B\u5EFAalertmanager-deployment\u8D44\u6E90 <a class="header-anchor" href="#_7-3-\u521B\u5EFAalertmanager-deployment\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f alertmanager-deployment.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">deployment.apps/alertmanager created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f alertmanager-deployment.yaml </span></span>
<span class="line"><span style="color:#393A34;">deployment.apps/alertmanager created</span></span>
<span class="line"></span></code></pre></div><h3 id="_7-4-\u521B\u5EFAalertmanager-service\u8D44\u6E90" tabindex="-1">7.4.\u521B\u5EFAalertmanager-service\u8D44\u6E90 <a class="header-anchor" href="#_7-4-\u521B\u5EFAalertmanager-service\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f alertmanager-service.yaml</span></span>
<span class="line"><span style="color:#DBD7CA;">service/alertmanager created</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f alertmanager-service.yaml</span></span>
<span class="line"><span style="color:#393A34;">service/alertmanager created</span></span>
<span class="line"></span></code></pre></div><h3 id="_7-5\u67E5\u770Balertmanager\u6240\u6709\u8D44\u6E90" tabindex="-1">7.5\u67E5\u770Balertmanager\u6240\u6709\u8D44\u6E90 <a class="header-anchor" href="#_7-5\u67E5\u770Balertmanager\u6240\u6709\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl get all,pv,pvc,cm -n alertmanager</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl get all,pv,pvc,cm -n alertmanager</span></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172401946.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_7-6-\u8BBF\u95EEalertmanager" tabindex="-1">7.6.\u8BBF\u95EEalertmanager <a class="header-anchor" href="#_7-6-\u8BBF\u95EEalertmanager" aria-hidden="true">#</a></h3><p>\u4EFB\u610Fnode\u8282\u70B9+31831\u7AEF\u53E3\u5373\u53EF</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172410897.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p>\u914D\u7F6E\u6587\u4EF6\u5DF2\u7ECF\u652F\u6301\u5FAE\u4FE1\u62A5\u8B66</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172419513.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h2 id="_8-\u914D\u7F6Ealertmanager\u5B9E\u73B0k8s\u544A\u8B66\u7CFB\u7EDF" tabindex="-1">8.\u914D\u7F6Ealertmanager\u5B9E\u73B0k8s\u544A\u8B66\u7CFB\u7EDF <a class="header-anchor" href="#_8-\u914D\u7F6Ealertmanager\u5B9E\u73B0k8s\u544A\u8B66\u7CFB\u7EDF" aria-hidden="true">#</a></h2><h3 id="_8-1-\u5728nfs\u4E0A\u51C6\u5907\u4E24\u4E2A\u544A\u8B66\u89C4\u5219\u6587\u4EF6" tabindex="-1">8.1.\u5728NFS\u4E0A\u51C6\u5907\u4E24\u4E2A\u544A\u8B66\u89C4\u5219\u6587\u4EF6 <a class="header-anchor" href="#_8-1-\u5728nfs\u4E0A\u51C6\u5907\u4E24\u4E2A\u544A\u8B66\u89C4\u5219\u6587\u4EF6" aria-hidden="true">#</a></h3><p>\u6211\u4EEC\u5BF9\u4E8E\u544A\u8B66\u89C4\u5219\u6587\u4EF6\u4E0D\u91C7\u7528configmap\u7684\u65B9\u5F0F\u800C\u662F\u91C7\u7528pv\u3001pvc\u7684\u65B9\u5F0F\u628A\u544A\u8B66\u89C4\u5219\u6302\u8F7D\u5230\u5BB9\u5668\u91CC</p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u5728nfs\u4E0A\u521B\u5EFApv\u5B58\u50A8\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> mkdir /data/prometheus/rules</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> chmod -R 777 /data</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> </span><span style="color:#E0A569;">cd</span><span style="color:#DBD7CA;"> /data/prometheus/rules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u51C6\u5907\u4E3B\u673A\u5B95\u673A\u7684\u544A\u8B66\u89C4\u5219\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs rules</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim hostdown.yml </span></span>
<span class="line"><span style="color:#DBD7CA;">groups:</span></span>
<span class="line"><span style="color:#DBD7CA;">- name: general.rules</span></span>
<span class="line"><span style="color:#DBD7CA;">  rules:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - alert: \u4E3B\u673A\u5B95\u673A</span></span>
<span class="line"><span style="color:#DBD7CA;">    expr: up == 0</span></span>
<span class="line"><span style="color:#DBD7CA;">    for: 1m</span></span>
<span class="line"><span style="color:#DBD7CA;">    labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">      serverity: error</span></span>
<span class="line"><span style="color:#DBD7CA;">    annotations:</span></span>
<span class="line"><span style="color:#DBD7CA;">      summary: </span><span style="color:#C98A7D;">&quot;\u4E3B\u673A {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.instance }} \u505C\u6B62\u5DE5\u4F5C&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      description: </span><span style="color:#C98A7D;">&quot;{{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.instance }} job {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.job }} \u5DF2\u7ECF\u5B95\u673A5\u5206\u949F\u4EE5\u4E0A!&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      </span></span>
<span class="line"><span style="color:#DBD7CA;">3.\u51C6\u5907\u4E3B\u673A\u57FA\u7840\u76D1\u63A7\u544A\u8B66\u89C4\u5219\u6587\u4EF6      </span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@nfs rules</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim node.yml </span></span>
<span class="line"><span style="color:#DBD7CA;">groups:</span></span>
<span class="line"><span style="color:#DBD7CA;">- name: node.rules</span></span>
<span class="line"><span style="color:#DBD7CA;">  rules:</span></span>
<span class="line"><span style="color:#DBD7CA;">  - alert: NodeFilessystemUsage</span></span>
<span class="line"><span style="color:#DBD7CA;">    expr: 100 - </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">node_filesystem_free_bytes{fstype=</span><span style="color:#CB7676;">~</span><span style="color:#C98A7D;">&quot;ext4|xfs&quot;</span><span style="color:#DBD7CA;">,mountpoint=</span><span style="color:#C98A7D;">&quot;/&quot;</span><span style="color:#DBD7CA;">} / node_filesystem_size_bytes{fstype=</span><span style="color:#CB7676;">~</span><span style="color:#C98A7D;">&quot;ext4|xfs&quot;</span><span style="color:#DBD7CA;">,mountpoint=</span><span style="color:#C98A7D;">&quot;/&quot;</span><span style="color:#DBD7CA;">} </span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">100</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;"> 80</span></span>
<span class="line"><span style="color:#DBD7CA;">    for: 1m</span></span>
<span class="line"><span style="color:#DBD7CA;">    labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">      serverity: warning</span></span>
<span class="line"><span style="color:#DBD7CA;">    annotations:</span></span>
<span class="line"><span style="color:#DBD7CA;">      summary: </span><span style="color:#C98A7D;">&quot;\u4E3B\u673A {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.instance }} : {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.mountpoint }} \u78C1\u76D8\u4F7F\u7528\u7387\u8FC7\u9AD8&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      description: </span><span style="color:#C98A7D;">&quot;{{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.instance }} : {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.mountpoint }} \u78C1\u76D8\u4F7F\u7528\u7387\u8D85\u8FC780% (\u5F53\u524D\u503C: {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">value }}) &quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">  - alert: NodeMemoryUsage</span></span>
<span class="line"><span style="color:#DBD7CA;">    expr: 100 - </span><span style="color:#C98A7D;">((node_memory_MemFree_bytes</span><span style="color:#CB7676;">+</span><span style="color:#C98A7D;">node_memory_Cached_bytes</span><span style="color:#CB7676;">+</span><span style="color:#C98A7D;">node_memory_Buffers_bytes) </span><span style="color:#CB7676;">/</span><span style="color:#C98A7D;"> node_memory_MemTotal_bytes </span><span style="color:#CB7676;">*</span><span style="color:#C98A7D;"> </span><span style="color:#6394BF;">100</span><span style="color:#C98A7D;">) </span><span style="color:#CB7676;">&gt;</span><span style="color:#C98A7D;"> </span><span style="color:#6394BF;">80</span></span>
<span class="line"><span style="color:#DBD7CA;">    for: 1m</span></span>
<span class="line"><span style="color:#DBD7CA;">    labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">      serverity: warning</span></span>
<span class="line"><span style="color:#DBD7CA;">    annotations:</span></span>
<span class="line"><span style="color:#DBD7CA;">      summary: </span><span style="color:#C98A7D;">&quot;\u4E3B\u673A {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.instance }} \u5185\u5B58\u4F7F\u7528\u7387\u8FC7\u9AD8&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      description: </span><span style="color:#C98A7D;">&quot;{{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.instance }} \u5185\u5B58\u4F7F\u7528\u7387\u8D85\u8FC780% (\u5F53\u524D\u503C: {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">value }}) &quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">  - alert: NodeCpuUsage</span></span>
<span class="line"><span style="color:#DBD7CA;">    expr: 100 - </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">avg</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">irate</span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">node_cpu_seconds_total{mode=</span><span style="color:#C98A7D;">&#39;idle&#39;</span><span style="color:#DBD7CA;">}</span><span style="color:#858585;">[</span><span style="color:#DBD7CA;">5m</span><span style="color:#858585;">]))</span><span style="color:#DBD7CA;"> by </span><span style="color:#858585;">(</span><span style="color:#DBD7CA;">instance</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">*</span><span style="color:#DBD7CA;">100</span><span style="color:#858585;">)</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CA;"> 80</span></span>
<span class="line"><span style="color:#DBD7CA;">    for: 1m</span></span>
<span class="line"><span style="color:#DBD7CA;">    labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">      serverity: warning</span></span>
<span class="line"><span style="color:#DBD7CA;">    annotations:</span></span>
<span class="line"><span style="color:#DBD7CA;">      summary: </span><span style="color:#C98A7D;">&quot;\u4E3B\u673A {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.instance }} CPU\u4F7F\u7528\u7387\u8FC7\u9AD8&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      description: </span><span style="color:#C98A7D;">&quot;{{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">labels.instance }} CPU\u4F7F\u7528\u7387\u8D85\u8FC780% (\u5F53\u524D\u503C: {{ </span><span style="color:#858585;">$</span><span style="color:#C98A7D;">value }}) &quot;</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u5728nfs\u4E0A\u521B\u5EFApv\u5B58\u50A8\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> mkdir /data/prometheus/rules</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> chmod -R 777 /data</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> </span><span style="color:#B58451;">cd</span><span style="color:#393A34;"> /data/prometheus/rules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u51C6\u5907\u4E3B\u673A\u5B95\u673A\u7684\u544A\u8B66\u89C4\u5219\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs rules</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim hostdown.yml </span></span>
<span class="line"><span style="color:#393A34;">groups:</span></span>
<span class="line"><span style="color:#393A34;">- name: general.rules</span></span>
<span class="line"><span style="color:#393A34;">  rules:</span></span>
<span class="line"><span style="color:#393A34;">  - alert: \u4E3B\u673A\u5B95\u673A</span></span>
<span class="line"><span style="color:#393A34;">    expr: up == 0</span></span>
<span class="line"><span style="color:#393A34;">    for: 1m</span></span>
<span class="line"><span style="color:#393A34;">    labels:</span></span>
<span class="line"><span style="color:#393A34;">      serverity: error</span></span>
<span class="line"><span style="color:#393A34;">    annotations:</span></span>
<span class="line"><span style="color:#393A34;">      summary: </span><span style="color:#B56959;">&quot;\u4E3B\u673A {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.instance }} \u505C\u6B62\u5DE5\u4F5C&quot;</span></span>
<span class="line"><span style="color:#393A34;">      description: </span><span style="color:#B56959;">&quot;{{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.instance }} job {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.job }} \u5DF2\u7ECF\u5B95\u673A5\u5206\u949F\u4EE5\u4E0A!&quot;</span></span>
<span class="line"><span style="color:#393A34;">      </span></span>
<span class="line"><span style="color:#393A34;">3.\u51C6\u5907\u4E3B\u673A\u57FA\u7840\u76D1\u63A7\u544A\u8B66\u89C4\u5219\u6587\u4EF6      </span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@nfs rules</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim node.yml </span></span>
<span class="line"><span style="color:#393A34;">groups:</span></span>
<span class="line"><span style="color:#393A34;">- name: node.rules</span></span>
<span class="line"><span style="color:#393A34;">  rules:</span></span>
<span class="line"><span style="color:#393A34;">  - alert: NodeFilessystemUsage</span></span>
<span class="line"><span style="color:#393A34;">    expr: 100 - </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">node_filesystem_free_bytes{fstype=</span><span style="color:#AB5959;">~</span><span style="color:#B56959;">&quot;ext4|xfs&quot;</span><span style="color:#393A34;">,mountpoint=</span><span style="color:#B56959;">&quot;/&quot;</span><span style="color:#393A34;">} / node_filesystem_size_bytes{fstype=</span><span style="color:#AB5959;">~</span><span style="color:#B56959;">&quot;ext4|xfs&quot;</span><span style="color:#393A34;">,mountpoint=</span><span style="color:#B56959;">&quot;/&quot;</span><span style="color:#393A34;">} </span><span style="color:#AB5959;">*</span><span style="color:#393A34;">100</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> 80</span></span>
<span class="line"><span style="color:#393A34;">    for: 1m</span></span>
<span class="line"><span style="color:#393A34;">    labels:</span></span>
<span class="line"><span style="color:#393A34;">      serverity: warning</span></span>
<span class="line"><span style="color:#393A34;">    annotations:</span></span>
<span class="line"><span style="color:#393A34;">      summary: </span><span style="color:#B56959;">&quot;\u4E3B\u673A {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.instance }} : {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.mountpoint }} \u78C1\u76D8\u4F7F\u7528\u7387\u8FC7\u9AD8&quot;</span></span>
<span class="line"><span style="color:#393A34;">      description: </span><span style="color:#B56959;">&quot;{{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.instance }} : {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.mountpoint }} \u78C1\u76D8\u4F7F\u7528\u7387\u8D85\u8FC780% (\u5F53\u524D\u503C: {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">value }}) &quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  - alert: NodeMemoryUsage</span></span>
<span class="line"><span style="color:#393A34;">    expr: 100 - </span><span style="color:#B56959;">((node_memory_MemFree_bytes</span><span style="color:#AB5959;">+</span><span style="color:#B56959;">node_memory_Cached_bytes</span><span style="color:#AB5959;">+</span><span style="color:#B56959;">node_memory_Buffers_bytes) </span><span style="color:#AB5959;">/</span><span style="color:#B56959;"> node_memory_MemTotal_bytes </span><span style="color:#AB5959;">*</span><span style="color:#B56959;"> </span><span style="color:#296AA3;">100</span><span style="color:#B56959;">) </span><span style="color:#AB5959;">&gt;</span><span style="color:#B56959;"> </span><span style="color:#296AA3;">80</span></span>
<span class="line"><span style="color:#393A34;">    for: 1m</span></span>
<span class="line"><span style="color:#393A34;">    labels:</span></span>
<span class="line"><span style="color:#393A34;">      serverity: warning</span></span>
<span class="line"><span style="color:#393A34;">    annotations:</span></span>
<span class="line"><span style="color:#393A34;">      summary: </span><span style="color:#B56959;">&quot;\u4E3B\u673A {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.instance }} \u5185\u5B58\u4F7F\u7528\u7387\u8FC7\u9AD8&quot;</span></span>
<span class="line"><span style="color:#393A34;">      description: </span><span style="color:#B56959;">&quot;{{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.instance }} \u5185\u5B58\u4F7F\u7528\u7387\u8D85\u8FC780% (\u5F53\u524D\u503C: {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">value }}) &quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  - alert: NodeCpuUsage</span></span>
<span class="line"><span style="color:#393A34;">    expr: 100 - </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">avg</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">irate</span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">node_cpu_seconds_total{mode=</span><span style="color:#B56959;">&#39;idle&#39;</span><span style="color:#393A34;">}</span><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">5m</span><span style="color:#8E8F8B;">]))</span><span style="color:#393A34;"> by </span><span style="color:#8E8F8B;">(</span><span style="color:#393A34;">instance</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">*</span><span style="color:#393A34;">100</span><span style="color:#8E8F8B;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> 80</span></span>
<span class="line"><span style="color:#393A34;">    for: 1m</span></span>
<span class="line"><span style="color:#393A34;">    labels:</span></span>
<span class="line"><span style="color:#393A34;">      serverity: warning</span></span>
<span class="line"><span style="color:#393A34;">    annotations:</span></span>
<span class="line"><span style="color:#393A34;">      summary: </span><span style="color:#B56959;">&quot;\u4E3B\u673A {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.instance }} CPU\u4F7F\u7528\u7387\u8FC7\u9AD8&quot;</span></span>
<span class="line"><span style="color:#393A34;">      description: </span><span style="color:#B56959;">&quot;{{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">labels.instance }} CPU\u4F7F\u7528\u7387\u8D85\u8FC780% (\u5F53\u524D\u503C: {{ </span><span style="color:#8E8F8B;">$</span><span style="color:#B56959;">value }}) &quot;</span></span>
<span class="line"></span></code></pre></div><h3 id="_8-2-\u7F16\u5199rules\u544A\u8B66\u89C4\u5219\u7684pv\u3001pvcyaml\u6587\u4EF6" tabindex="-1">8.2.\u7F16\u5199rules\u544A\u8B66\u89C4\u5219\u7684pv\u3001pvcyaml\u6587\u4EF6 <a class="header-anchor" href="#_8-2-\u7F16\u5199rules\u544A\u8B66\u89C4\u5219\u7684pv\u3001pvcyaml\u6587\u4EF6" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u7F16\u5199\u8D44\u6E90\u6587\u4EF6</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim prometheus-rules-pvc.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: prometheus-rules</span></span>
<span class="line"><span style="color:#DBD7CA;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#DBD7CA;">  labels:</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">  accessModes:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - ReadWriteOnce</span></span>
<span class="line"><span style="color:#DBD7CA;">  resources:</span></span>
<span class="line"><span style="color:#DBD7CA;">    requests:</span></span>
<span class="line"><span style="color:#DBD7CA;">      storage: </span><span style="color:#C98A7D;">&quot;2Gi&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">---</span></span>
<span class="line"><span style="color:#DBD7CA;">apiVersion: v1</span></span>
<span class="line"><span style="color:#DBD7CA;">kind: PersistentVolume</span></span>
<span class="line"><span style="color:#DBD7CA;">metadata:</span></span>
<span class="line"><span style="color:#DBD7CA;">  name: pv-prometheus-rules</span></span>
<span class="line"><span style="color:#DBD7CA;">spec:</span></span>
<span class="line"><span style="color:#DBD7CA;">  capacity:</span></span>
<span class="line"><span style="color:#DBD7CA;">    storage: 2Gi</span></span>
<span class="line"><span style="color:#DBD7CA;">  accessModes:</span></span>
<span class="line"><span style="color:#DBD7CA;">    - ReadWriteOnce</span></span>
<span class="line"><span style="color:#DBD7CA;">  nfs:</span></span>
<span class="line"><span style="color:#DBD7CA;">    path: /data/prometheus/rules</span></span>
<span class="line"><span style="color:#DBD7CA;">    server: 192.168.16.105</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u521B\u5EFA\u8D44\u6E90</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl create -f prometheus-rules-pvc.yaml</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolumeclaim/prometheus-rules created</span></span>
<span class="line"><span style="color:#DBD7CA;">persistentvolume/pv-prometheus-rules created</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u7F16\u5199\u8D44\u6E90\u6587\u4EF6</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim prometheus-rules-pvc.yaml </span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: prometheus-rules</span></span>
<span class="line"><span style="color:#393A34;">  namespace: kube-system</span></span>
<span class="line"><span style="color:#393A34;">  labels:</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#393A34;">  accessModes:</span></span>
<span class="line"><span style="color:#393A34;">    - ReadWriteOnce</span></span>
<span class="line"><span style="color:#393A34;">  resources:</span></span>
<span class="line"><span style="color:#393A34;">    requests:</span></span>
<span class="line"><span style="color:#393A34;">      storage: </span><span style="color:#B56959;">&quot;2Gi&quot;</span></span>
<span class="line"><span style="color:#393A34;">---</span></span>
<span class="line"><span style="color:#393A34;">apiVersion: v1</span></span>
<span class="line"><span style="color:#393A34;">kind: PersistentVolume</span></span>
<span class="line"><span style="color:#393A34;">metadata:</span></span>
<span class="line"><span style="color:#393A34;">  name: pv-prometheus-rules</span></span>
<span class="line"><span style="color:#393A34;">spec:</span></span>
<span class="line"><span style="color:#393A34;">  capacity:</span></span>
<span class="line"><span style="color:#393A34;">    storage: 2Gi</span></span>
<span class="line"><span style="color:#393A34;">  accessModes:</span></span>
<span class="line"><span style="color:#393A34;">    - ReadWriteOnce</span></span>
<span class="line"><span style="color:#393A34;">  nfs:</span></span>
<span class="line"><span style="color:#393A34;">    path: /data/prometheus/rules</span></span>
<span class="line"><span style="color:#393A34;">    server: 192.168.16.105</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u521B\u5EFA\u8D44\u6E90</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl create -f prometheus-rules-pvc.yaml</span></span>
<span class="line"><span style="color:#393A34;">persistentvolumeclaim/prometheus-rules created</span></span>
<span class="line"><span style="color:#393A34;">persistentvolume/pv-prometheus-rules created</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h3 id="_8-3-\u4FEE\u6539prometheus\u7684statefulset\u8D44\u6E90\u96C6\u6210rules" tabindex="-1">8.3.\u4FEE\u6539prometheus\u7684statefulset\u8D44\u6E90\u96C6\u6210rules <a class="header-anchor" href="#_8-3-\u4FEE\u6539prometheus\u7684statefulset\u8D44\u6E90\u96C6\u6210rules" aria-hidden="true">#</a></h3><p>\u5728prometheus\u7684statefulset\u8D44\u6E90\u4E2D\u589E\u52A0rules\u7684pvc\u6302\u8F7D\u8DEF\u5F84</p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim prometheus-statefulset-static-pv.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">          volumeMounts:</span></span>
<span class="line"><span style="color:#DBD7CA;">            - name: config-volume</span></span>
<span class="line"><span style="color:#DBD7CA;">              mountPath: /etc/config</span></span>
<span class="line"><span style="color:#DBD7CA;">            - name: prometheus-rules</span></span>
<span class="line"><span style="color:#DBD7CA;">              mountPath: /etc/config/rules</span></span>
<span class="line"><span style="color:#DBD7CA;">            - name: prometheus-data</span></span>
<span class="line"><span style="color:#DBD7CA;">              mountPath: /data</span></span>
<span class="line"><span style="color:#DBD7CA;">              subPath: </span><span style="color:#C98A7D;">&quot;&quot;</span></span>
<span class="line"><span style="color:#DBD7CA;">      terminationGracePeriodSeconds: 300</span></span>
<span class="line"><span style="color:#DBD7CA;">      volumes:</span></span>
<span class="line"><span style="color:#DBD7CA;">        - name: config-volume</span></span>
<span class="line"><span style="color:#DBD7CA;">          configMap:</span></span>
<span class="line"><span style="color:#DBD7CA;">            name: prometheus-config</span></span>
<span class="line"><span style="color:#DBD7CA;">        - name: prometheus-rules</span></span>
<span class="line"><span style="color:#DBD7CA;">          persistentVolumeClaim:</span></span>
<span class="line"><span style="color:#DBD7CA;">            claimName: prometheus-rules</span></span>
<span class="line"><span style="color:#DBD7CA;">        - name: prometheus-data</span></span>
<span class="line"><span style="color:#DBD7CA;">          persistentVolumeClaim:</span></span>
<span class="line"><span style="color:#DBD7CA;">            claimName: prometheus-data</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim prometheus-statefulset-static-pv.yaml </span></span>
<span class="line"><span style="color:#393A34;">          volumeMounts:</span></span>
<span class="line"><span style="color:#393A34;">            - name: config-volume</span></span>
<span class="line"><span style="color:#393A34;">              mountPath: /etc/config</span></span>
<span class="line"><span style="color:#393A34;">            - name: prometheus-rules</span></span>
<span class="line"><span style="color:#393A34;">              mountPath: /etc/config/rules</span></span>
<span class="line"><span style="color:#393A34;">            - name: prometheus-data</span></span>
<span class="line"><span style="color:#393A34;">              mountPath: /data</span></span>
<span class="line"><span style="color:#393A34;">              subPath: </span><span style="color:#B56959;">&quot;&quot;</span></span>
<span class="line"><span style="color:#393A34;">      terminationGracePeriodSeconds: 300</span></span>
<span class="line"><span style="color:#393A34;">      volumes:</span></span>
<span class="line"><span style="color:#393A34;">        - name: config-volume</span></span>
<span class="line"><span style="color:#393A34;">          configMap:</span></span>
<span class="line"><span style="color:#393A34;">            name: prometheus-config</span></span>
<span class="line"><span style="color:#393A34;">        - name: prometheus-rules</span></span>
<span class="line"><span style="color:#393A34;">          persistentVolumeClaim:</span></span>
<span class="line"><span style="color:#393A34;">            claimName: prometheus-rules</span></span>
<span class="line"><span style="color:#393A34;">        - name: prometheus-data</span></span>
<span class="line"><span style="color:#393A34;">          persistentVolumeClaim:</span></span>
<span class="line"><span style="color:#393A34;">            claimName: prometheus-data</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172451817.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_8-4-\u66F4\u65B0prometheus-statefulset\u8D44\u6E90" tabindex="-1">8.4.\u66F4\u65B0prometheus-statefulset\u8D44\u6E90 <a class="header-anchor" href="#_8-4-\u66F4\u65B0prometheus-statefulset\u8D44\u6E90" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl apply -f prometheus-statefulset-static-pv.yaml </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl apply -f prometheus-statefulset-static-pv.yaml </span></span>
<span class="line"></span></code></pre></div><h3 id="_8-5-\u4FEE\u6539prometheus-configmap\u8D44\u6E90\u914D\u7F6Ealertmanager\u5730\u5740" tabindex="-1">8.5.\u4FEE\u6539prometheus-configmap\u8D44\u6E90\u914D\u7F6Ealertmanager\u5730\u5740 <a class="header-anchor" href="#_8-5-\u4FEE\u6539prometheus-configmap\u8D44\u6E90\u914D\u7F6Ealertmanager\u5730\u5740" aria-hidden="true">#</a></h3><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">1.\u4FEE\u6539\u914D\u7F6E\u589E\u52A0alertmanager\u5730\u5740</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> vim prometheus-configmap.yaml </span></span>
<span class="line"><span style="color:#DBD7CA;">    alerting:</span></span>
<span class="line"><span style="color:#DBD7CA;">      alertmanagers:</span></span>
<span class="line"><span style="color:#DBD7CA;">      - static_configs:</span></span>
<span class="line"><span style="color:#DBD7CA;">        - targets:</span></span>
<span class="line"><span style="color:#DBD7CA;">          - 192.168.16.106:31831</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CA;">2.\u66F4\u65B0\u8D44\u6E90</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-master </span><span style="color:#CB7676;">~</span><span style="color:#DBD7CA;">/k8s/prometheus3</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> kubectl apply -f prometheus-configmap.yaml</span></span>
<span class="line"><span style="color:#DBD7CA;">configmap/prometheus-config configured      </span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">1.\u4FEE\u6539\u914D\u7F6E\u589E\u52A0alertmanager\u5730\u5740</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> vim prometheus-configmap.yaml </span></span>
<span class="line"><span style="color:#393A34;">    alerting:</span></span>
<span class="line"><span style="color:#393A34;">      alertmanagers:</span></span>
<span class="line"><span style="color:#393A34;">      - static_configs:</span></span>
<span class="line"><span style="color:#393A34;">        - targets:</span></span>
<span class="line"><span style="color:#393A34;">          - 192.168.16.106:31831</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">2.\u66F4\u65B0\u8D44\u6E90</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-master </span><span style="color:#AB5959;">~</span><span style="color:#393A34;">/k8s/prometheus3</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> kubectl apply -f prometheus-configmap.yaml</span></span>
<span class="line"><span style="color:#393A34;">configmap/prometheus-config configured      </span></span>
<span class="line"></span></code></pre></div><h3 id="_8-5-\u67E5\u770B\u9875\u9762\u662F\u5426\u589E\u52A0\u544A\u8B66\u89C4\u5219" tabindex="-1">8.5.\u67E5\u770B\u9875\u9762\u662F\u5426\u589E\u52A0\u544A\u8B66\u89C4\u5219 <a class="header-anchor" href="#_8-5-\u67E5\u770B\u9875\u9762\u662F\u5426\u589E\u52A0\u544A\u8B66\u89C4\u5219" aria-hidden="true">#</a></h3><p>\u5DF2\u7ECF\u6210\u529F\u586B\u52A0rules\u544A\u8B66\u89C4\u5219</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172502911.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><h3 id="_8-6-\u6A21\u62DFnode\u4E3B\u673A\u5B95\u673A\u5E76\u67E5\u770B\u5FAE\u4FE1\u544A\u8B66\u5185\u5BB9" tabindex="-1">8.6.\u6A21\u62DFnode\u4E3B\u673A\u5B95\u673A\u5E76\u67E5\u770B\u5FAE\u4FE1\u544A\u8B66\u5185\u5BB9 <a class="header-anchor" href="#_8-6-\u6A21\u62DFnode\u4E3B\u673A\u5B95\u673A\u5E76\u67E5\u770B\u5FAE\u4FE1\u544A\u8B66\u5185\u5BB9" aria-hidden="true">#</a></h3><p><strong>\u6A21\u62DF\u89E6\u53D1\u544A\u8B66</strong></p><div class="language-sh"><span class="copy"></span><pre class="vp-code-dark"><code><span class="line"><span style="color:#DBD7CA;">\u5C06\u4EFB\u610F\u4E00\u4E2Anode\u8282\u70B9\u7684node_exporter\u505C\u6389\u5373\u53EF</span></span>
<span class="line"><span style="color:#858585;">[</span><span style="color:#DBD7CA;">root@k8s-node1 </span><span style="color:#CB7676;">~</span><span style="color:#858585;">]</span><span style="color:#D4976C;">\\#</span><span style="color:#DBD7CA;"> systemctl stop node_exporter</span></span>
<span class="line"></span></code></pre><pre class="vp-code-light"><code><span class="line"><span style="color:#393A34;">\u5C06\u4EFB\u610F\u4E00\u4E2Anode\u8282\u70B9\u7684node_exporter\u505C\u6389\u5373\u53EF</span></span>
<span class="line"><span style="color:#8E8F8B;">[</span><span style="color:#393A34;">root@k8s-node1 </span><span style="color:#AB5959;">~</span><span style="color:#8E8F8B;">]</span><span style="color:#A65E2B;">\\#</span><span style="color:#393A34;"> systemctl stop node_exporter</span></span>
<span class="line"></span></code></pre></div><p><strong>\u544A\u8B66\u5DF2\u7ECF\u4EA7\u751F</strong></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172537744.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>\u544A\u8B66\u6D88\u606F\u5DF2\u7ECF\u53D1\u9001</strong></p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172545238.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><p><strong>\u67E5\u770B\u544A\u8B66\u5185\u5BB9</strong></p><p>\u5DF2\u7ECF\u6210\u529F\u6536\u5230\u544A\u8B66\uFF0Ck8s\u76D1\u63A7\u7CFB\u5217\u7BC7\u5230\u6B64\u7ED3\u675F</p><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172554537.png" alt="\u5728\u8FD9\u91CC\u63D2\u5165\u56FE\u7247\u63CF\u8FF0"></p><blockquote><p>\u8BE5\u6587\u7AE0\u4E3A\u8F6C\u8F7D\u5185\u5BB9\uFF0C\u4EC5\u505A\u5907\u4EFD\u79C1\u4EBA\u5B66\u4E60\u4F7F\u7528\uFF0C\u539F\u6587\uFF1A<a href="https://jiangxl.blog.csdn.net/article/details/112283085" target="_blank" rel="noopener noreferrer">https://jiangxl.blog.csdn.net/article/details/112283085</a></p></blockquote>`,210),o=[e];function t(c,r,y,i,A,D){return a(),n("div",null,o)}var u=s(p,[["render",t]]);export{m as __pageData,u as default};
